<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Gift Simulator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F3KPE0SD07"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F3KPE0SD07');
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2);
            --app-rarity-chip-text: var(--tg-theme-text-color);
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
            --app-clear-data-color: #ff3b30;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Account Sidebar Styles */
        .account-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 320px;
            background-color: var(--tg-theme-bg-color);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        }
        .account-sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            display: flex;
            align-items: center;
        }
        .sidebar-header img {
            width: 50px; height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-header .name {
            font-size: 1.1em;
            font-weight: 500;
        }
        .accounts-list {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        .accounts-list li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }
        .accounts-list li:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .accounts-list li.active {
            background-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
        }
        .accounts-list li img {
            width: 40px; height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
            overflow-y: auto;
        }
        .sidebar-footer button {
             width: 100%;
             padding: 12px;
             background: none;
             border: none;
             color: var(--tg-theme-link-color);
             text-align: left;
             font-size: 1em;
             cursor: pointer;
             border-radius: 8px;
             display: flex; align-items: center;
        }
        .sidebar-footer button svg {
            margin-right: 12px;
            width: 22px; height: 22px;
            fill: currentColor;
        }
        .sidebar-footer button:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* End Account Sidebar */

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        #profile-page > .page-header {
            background-color: transparent;
            position: absolute;
            top: 0; left:0; right:0;
            z-index: 100;
        }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }

        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .profile-top-section {
            position: relative;
            padding-top: 56px;
            background: var(--app-profile-gradient-fallback);
            transition: background 0.3s ease;
        }
        .profile-header-pattern-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            opacity: 0.07;
            pointer-events: none;
            z-index: 0;
        }
        .profile-header-content-wrapper {
             position: relative; z-index: 1;
             padding: 0 15px;
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 5px 0 8px 0;
            min-height: 30px;
        }
        .profile-top-pinned-gifts .pinned-gift-item {
            width: 30px; height: 30px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
        }
        .profile-main-info {
            display: flex;
            align-items: center;
            padding: 8px 0 20px 0;
        }
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .profile-name-status { display: flex; flex-direction: column; }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.4em; font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon-container {
            width: 24px; height: 24px; margin-left: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .profile-name-status p { font-size: 0.95em; color: var(--tg-theme-text-color); opacity: 0.7; margin-top: 3px; }
        .profile-name-status p.online { opacity: 1; color: var(--tg-theme-link-color); }

        .profile-details-section {
            background-color: var(--tg-theme-bg-color);
            padding: 15px 15px 5px 15px;
        }
        .profile-details .info-block {
            margin-bottom: 16px;
        }
        .profile-details .info-value {
            font-size: 0.95em;
            color: var(--tg-theme-text-color);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .profile-details .info-label {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-bottom: 3px;
            display: block;
        }
        .profile-details .info-value.collectible-value {
            color: var(--tg-theme-link-color);
            cursor: pointer;
        }
        #profile-bio {
             cursor: pointer;
        }
        #collectible-usernames-container {
            margin-top: 4px;
            line-height: 1.5;
        }
        #collectible-usernames-container .also-text {
            color: var(--tg-theme-hint-color);
            margin-right: 6px;
        }
        #collectible-usernames-container .collectible-username-span {
            color: var(--tg-theme-link-color);
            margin-right: 6px;
            cursor: pointer;
        }


        .profile-tabs-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            padding: 5px 0 0 0;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #gifts-tab-button .gift-preview-container {
            display: flex;
            align-items: center;
            margin-left: 8px;
            gap: 4px; /* Added for spacing */
        }
        #gifts-tab-button .gift-preview-container img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            background-color: rgba(0,0,0,0.1); /* Fallback */
            border-radius: 6px;
        }

        .profile-tabs button.active { color: var(--tg-theme-link-color); }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0px; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        .tab-content {
            display: none;
            flex-grow: 1;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .gifts-grid.reordering .gift-card[data-pinned="true"] {
            cursor: grabbing;
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%;
        }

        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }
        .gift-card.is-hidden {
            opacity: 0.5;
            filter: grayscale(80%);
        }
        .buy-gift-item { aspect-ratio: 1/1.1; }
        .gift-card.is-updating { transform: scale(0.95); opacity: 0.7; }
        .sortable-chosen, .sortable-ghost {
            cursor: grabbing !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.05);
            opacity: 0.7;
        }
        .gift-card-bg-pattern, .buy-gift-item-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none; z-index: 0;
        }
        .gift-card-pattern-overlay, .buy-gift-item-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            background-position: center;
            opacity: 0.1;
            pointer-events: none; z-index: 1;
        }
        .image-container {
            width: 70%; height: 70%;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
        }
        .buy-gift-item .image-container {
            width: 65%; max-height: 60px;
            margin-bottom: 8px; height: auto;
        }

        .static-image-fallback {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
        }
        .lottie-animation-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        /* Rotated Label - CORRECTED */
        .gift-card .top-right-label {
            position: absolute;
            top: 10px; /* Adjusted for visual balance */
            right: -28px; /* Adjusted for visual balance */
            transform: rotate(45deg);
            transform-origin: center;
            background-color: rgba(0,0,0,0.35);
            color: var(--tg-theme-text-color);
            font-size: 0.65em;
            padding: 1px 25px;
            z-index: 4;
            font-weight: 500;
            white-space: nowrap;
        }

        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg { width: 18px; height: 18px; fill: var(--tg-theme-link-color); opacity: 0.8; }

        /* Selection Mode Checkbox */
        .gift-card .selection-checkbox {
            position: absolute; top: 5px; right: 5px; /* Moved to right for consistency */
            width: 22px; height: 22px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            border-radius: 50%;
            z-index: 5; /* Higher than label */
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .gift-card.selected .selection-checkbox {
            background-color: var(--tg-theme-button-color);
        }
        .gift-card.selected .selection-checkbox::after {
            content: '✓';
            color: var(--tg-theme-button-text-color);
            font-size: 14px;
            font-weight: bold;
        }

        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            z-index: 2;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .buy-gift-item .gift-price.has-price::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png');
            background-size: 16px 16px;
            background-repeat: repeat;
            opacity: 0.08;
            border-radius: 12px;
            z-index: -1;
        }

        .buy-gift-item .gift-price .star-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .buy-gift-item .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px;
            border-radius: 8px; font-weight: 500; z-index: 3;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transform: translateY(0%); }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }

        .modal-scrollable-content { overflow-y: auto; padding: 15px 20px; flex-grow: 1; }
        .modal-buttons-footer {
            padding: 15px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            position: sticky; bottom: 0; z-index: 1;
            border-top: 1px solid var(--tg-theme-bg-color);
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            text-decoration: none;
            display: inline-block;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }
        .modal-button:disabled {
            background-color: var(--tg-theme-hint-color);
            color: var(--tg-theme-secondary-bg-color);
            cursor: not-allowed;
        }


        #gift-detail-modal .modal-gift-image-container {
            width: 120px; height: 120px;
            margin: 10px auto 15px auto; display: flex;
            align-items: center; justify-content: center;
        }
        #gift-detail-modal .modal-gift-image-static {
             max-width: 100%; max-height: 100%; object-fit: contain;
        }
        #gift-detail-modal .lottie-animation-container {
             width: 100%; height: 100%;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
        }
        #gift-detail-modal .modal-info-table .info-row:not(:last-child) { margin-bottom: 2px; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); }
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }
        #gift-detail-modal .info-value-with-action { display: flex; align-items: center; }
        #gift-detail-modal .info-value-with-action span { margin-right: 10px; color: var(--tg-theme-hint-color); }
        #gift-detail-modal .button-link-styled {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 0.95em; font-weight: 500;
            padding: 5px; cursor: pointer;
        }
        #gift-detail-modal .button-link-styled:disabled { color: var(--tg-theme-hint-color); }

        /* === COLLECTIBLE MODAL REDESIGN === */
        #collectible-detail-modal .modal-content { padding-top: 0; overflow: hidden; }
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }
        #collectible-detail-modal #collectible-menu-button {
            position: absolute; top: 10px; right: 10px; z-index: 3;
            background: rgba(0,0,0,0.2); border-radius: 50%; padding: 0;
            width: 36px; height: 36px;
        }
        #collectible-detail-modal #collectible-menu-button svg { fill: white; }

        .collectible-display-area {
            padding: 40px 0 20px 0; /* Adjusted padding */
            text-align: center;
            position: relative;
            overflow: hidden;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #pattern-container-dynamic {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            pointer-events: none;
        }
        .dynamic-pattern-instance {
            position: absolute;
            opacity: 0.1;
            width: 40px;
            height: auto;
            will-change: transform;
        }

        .modal-collectible-visual {
            width: 45%;
            max-width: 160px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-collectible-visual .static-image-fallback {
             max-width: 100%;
             max-height: 100%;
             object-fit: contain;
        }
        .modal-collectible-visual .lottie-animation-container {
            width: 80%; height: 80%; object-fit: contain; z-index: 4; position: relative;
        }

        .collectible-display-area h3 {
            font-size: 1.6em; font-weight: 600; margin-top: 20px; margin-bottom: 5px;
            color: var(--tg-theme-text-color); position: relative; z-index: 2;
        }
        .collectible-display-area p {
            font-size: 1em; color: var(--tg-theme-hint-color); margin: 0;
            position: relative; z-index: 2;
        }
        .collectible-display-area p a {
            color: var(--tg-theme-link-color); text-decoration: none; cursor: pointer;
        }
        .collectible-display-area p a:hover { text-decoration: underline; }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 20px; /* Moved padding here from display-area */
            background-color: transparent; /* No longer has its own background */
            position: relative; z-index: 2; /* Ensure buttons are on top */
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: rgba(0,0,0,0.25); /* Dark, transparent background */
            color: var(--tg-theme-text-color);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }
        /* === END COLLECTIBLE MODAL REDESIGN === */

        .collectible-info-section { padding: 0 20px; background-color: var(--tg-theme-secondary-bg-color); }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
        }
        .collectible-info-section .info-row:not(:last-child) { border-bottom: 1px solid var(--tg-theme-bg-color); }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value { color: var(--tg-theme-hint-color); display: flex; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .collectible-info-section .info-value a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }
        .collectible-info-section .info-value.clickable-info { cursor: pointer; }
        .collectible-info-section .info-value.clickable-info:active { opacity: 0.7; }
        .collectible-info-section .info-value img.owner-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        .rarity-chip .one-in-x {
            font-size: 0.9em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2001; /* Higher than sidebar overlay */
            padding: 6px 0; min-width: 220px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li { padding: 10px 20px; cursor: pointer; color: var(--tg-theme-text-color); font-size: 0.95em; }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li.danger { color: var(--app-clear-data-color); }
        #long-press-menu li:not(.disabled):hover { background-color: rgba(255,255,255,0.05); }

        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number] { -moz-appearance: textfield; }

        .filter-section { margin-bottom: 15px; }
        .filter-section h4 {
            font-size: 0.9em; font-weight: 500; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; padding-left: 5px;
        }
        .filter-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto;
            padding: 5px; background-color: rgba(0,0,0,0.1); border-radius: 8px;
        }
        .filter-option {
            aspect-ratio: 1/1; border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .filter-option img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .filter-option .gradient-square { width: 100%; height: 100%; }

        #filter-popup .clear-data-button {
            background-color: transparent;
            color: var(--app-clear-data-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px;
        }
        #filter-popup .clear-data-button svg { width: 20px; height: 20px; fill: currentColor; margin-right: 8px; }

        #filter-popup .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 5px;
            font-size: 1em;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--app-action-button-bg); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--tg-theme-link-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--tg-theme-link-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        /* --- Custom Buy Modal & Multi-Gift --- */
        #custom-buy-modal .filter-section, #chances-modal .filter-section { margin-bottom: 20px; }
        #custom-buy-modal .filter-options-grid, #chances-modal .filter-options-grid {
            max-height: 200px; overflow-y: auto; padding: 5px;
            background-color: rgba(0,0,0,0.1); border-radius: 8px;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }
        #custom-buy-modal .filter-option, #chances-modal .filter-option {
            background-color: var(--tg-theme-bg-color); border: 2px solid transparent;
            border-radius: 8px; padding: 5px; flex-direction: column;
            justify-content: flex-start; height: auto; aspect-ratio: auto;
            min-height: 80px;
        }
        #custom-buy-modal .filter-option.selected, #chances-modal .filter-option.selected { border-color: var(--tg-theme-link-color); }
        #custom-buy-modal .filter-option img, #custom-buy-modal .filter-option .gradient-square,
        #chances-modal .filter-option img, #chances-modal .filter-option .gradient-square {
            width: 100%; height: 60px; object-fit: contain;
            border-radius: 4px; margin-bottom: 5px;
        }
        #custom-buy-modal .filter-option .label, #chances-modal .filter-option .label {
            font-size: 0.75em; color: var(--tg-theme-text-color); text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        #gift-queue-container {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0;
            border-bottom: 1px solid var(--app-action-button-bg); margin-bottom: 15px;
        }
        .gift-queue-item {
            background-color: var(--app-action-button-bg); color: var(--tg-theme-text-color);
            padding: 8px 12px; border-radius: 16px; font-size: 0.9em; cursor: pointer;
            border: 2px solid transparent; display: flex; align-items: center; gap: 6px;
        }
        .gift-queue-item.active { border-color: var(--tg-theme-link-color); }
        .gift-queue-item .remove-queue-item {
            background-color: var(--tg-theme-hint-color); color: var(--tg-theme-bg-color);
            border: none; border-radius: 50%; width: 16px; height: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold;
        }
        .advanced-settings-toggle {
            display: block; width: 100%; text-align: center; background: none;
            border: none; color: var(--tg-theme-link-color); font-size: 0.95em;
            padding: 8px; cursor: pointer; margin-top: 10px;
        }
        #advanced-settings-container {
            margin-top: 15px; padding-top: 15px;
            border-top: 1px solid var(--app-action-button-bg);
        }
        #advanced-settings-container input {
             width: 100%; padding: 12px; border-radius: 8px;
             border: 1px solid var(--tg-theme-bg-color); background-color: var(--tg-theme-bg-color);
             color: var(--tg-theme-text-color); font-size: 1em; margin-top: 8px;
        }
        #advanced-settings-container label {
            display: block; text-align: left; font-size: 0.9em;
            color: var(--tg-theme-hint-color); margin-bottom: 4px;
        }


        #chances-probability-display {
            background-color: var(--tg-theme-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        #chances-probability-display .prob-value {
            font-size: 1.5em; font-weight: 600; color: var(--tg-theme-link-color);
            display: block; margin-bottom: 5px;
        }
        #chances-probability-display .prob-details {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }

        /* Sell Gift & Transfer Gift Modal Styles */
        #sell-gift-modal .modal-gift-preview,
        #transfer-gift-modal .modal-gift-preview {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        #sell-gift-modal .modal-gift-preview img,
        #transfer-gift-modal .modal-gift-preview img {
            width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;
        }
        #sell-gift-modal .modal-gift-preview h4,
        #transfer-gift-modal .modal-gift-preview h4 {
            font-size: 1.1em; font-weight: 500;
        }

        .price-input-container {
            position: relative;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
        }
        .price-input-container label {
            display: block; font-size: 0.8em; color: var(--tg-theme-link-color);
            margin-bottom: 5px;
        }
        .price-input-wrapper {
            display: flex; align-items: center;
        }
        .price-input-wrapper img {
            width: 24px; height: 24px; margin-right: 10px;
        }
        .price-input-wrapper input {
            background: none; border: none; color: var(--tg-theme-text-color);
            font-size: 1.2em; width: 100%; outline: none;
        }
        .price-input-wrapper input::-webkit-outer-spin-button,
        .price-input-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .price-input-wrapper input[type=number] { -moz-appearance: textfield; }
        .price-details { text-align: center; font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 10px; }

        #transfer-comment-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
            margin-top: 15px;
            resize: vertical;
        }


        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }

        /* Collectible Numbers/Usernames Modal */
        #numbers-modal .collectible-list, #usernames-modal .collectible-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        #numbers-modal .collectible-list-item, #usernames-modal .collectible-list-item {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid var(--tg-theme-bg-color);
            cursor: pointer;
            color: var(--tg-theme-link-color);
            font-family: monospace;
        }
        #usernames-modal .collectible-list-item {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--tg-theme-text-color);
        }
        #usernames-modal .collectible-list-item .at-symbol {
            color: var(--tg-theme-hint-color);
            margin-right: 2px;
        }
        #numbers-modal .collectible-list-item:hover, #usernames-modal .collectible-list-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        #usernames-modal .search-bar-container {
            padding: 10px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        #usernames-modal #username-search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
        }

        /* Settings Modal */
        #settings-modal .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 1em;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        #settings-modal .settings-row:last-of-type { border-bottom: none; }
        #settings-modal .settings-row button {
            background: none; border: none; color: var(--tg-theme-link-color);
            font-size: 1em; cursor: pointer; text-align: left;
            padding: 0; width: auto; font-weight: 400;
        }
        #settings-modal .settings-row.danger button {
            color: var(--app-clear-data-color);
        }
        #settings-modal .settings-row button.full-width { width: 100%; text-align: center; }

        /* --- GIVEAWAY MODAL --- */
        #giveaway-setup-modal .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #giveaway-setup-modal .selection-grid .gift-card {
             border: 2px solid transparent;
        }
        #giveaway-setup-modal .selection-grid .gift-card.selected {
            border-color: var(--tg-theme-link-color);
        }
        #giveaway-setup-modal .winner-rule-section {
            margin-top: 15px;
        }
        #giveaway-setup-modal .winner-rule-section label {
            display: block;
            padding: 12px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        #giveaway-setup-modal .winner-rule-section input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="account-sidebar" id="account-sidebar">
        <div class="sidebar-header">
            <img id="sidebar-current-avatar" src="" alt="Avatar">
            <span id="sidebar-current-name" class="name"></span>
        </div>
        <ul class="accounts-list" id="accounts-list"></ul>
        <div class="sidebar-footer">
            <button id="add-account-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12M5,13.28L1,10.72L2.41,9.31L5,11.9L9.6,7.3L11,8.72L5,14.72Z" /></svg>Add Account</button>
            <button id="open-numbers-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>Numbers</button>
            <button id="open-usernames-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,12C14.21,12 16,10.21 16,8C16,5.79 14.21,4 12,4C9.79,4 8,5.79 8,8C8,10.21 9.79,12 12,12M12,14C9.33,14 4,15.33 4,18V20H20V18C20,15.33 14.67,14 12,14Z" /></svg>@ Usernames</button>
            <button id="create-giveaway-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22,13H20V15H18V13H16V11H18V9H20V11H22M18,3L15,6H11L13,2H9.5C9.09,2 8.75,2.3 8.6,2.65L2,13L8,18H14L21,9V4M12.5,15.5C11.67,15.5 11,14.83 11,14C11,13.17 11.67,12.5 12.5,12.5C13.33,12.5 14,13.17 14,14C14,14.83 13.33,15.5 12.5,15.5Z" /></svg>🏆 Create Giveaway</button>
            <button id="filter-gifts-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H9.97L4.21,4.62C3.87,4.19 3.95,3.56 4.38,3.22C4.81,2.88 5.44,2.96 5.78,3.39L10,9.6V9.6L10,9.62L10,12H14Z M18.42,8.08L18.42,8.08L18.42,8.08L19.54,6.96L18.42,5.84L17.3,6.96L16.18,5.84L15.06,6.96L16.18,8.08L15.06,9.2L16.18,10.32L17.3,9.2L18.42,10.32L19.54,9.2L18.42,8.08M19.54,13.82L18.42,12.7L17.3,13.82L16.18,12.7L15.06,13.82L16.18,14.94L15.06,16.06L16.18,17.18L17.3,16.06L18.42,17.18L19.54,16.06L18.42,14.94L19.54,13.82Z" /></svg>Filter Gifts</button>
            <button id="upgrade-all-gifts-button" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,1L9,9L1,12L9,15L12,23L15,15L23,12L15,9L12,1Z" /></svg>✨ Upgrade All</button>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="app-container">
        <div id="profile-page" class="page active">
             <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
             <div class="page-header">
                <!-- Back button now handled by TG WebApp API -->
            </div>
            <div class="profile-page-content">
                <div id="profile-top-section" class="profile-top-section">
                    <div id="profile-header-pattern-overlay" class="profile-header-pattern-overlay"></div>
                    <div class="profile-header-content-wrapper">
                        <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                        <div id="profile-main-info-block" class="profile-main-info">
                            <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                            <div class="profile-name-status">
                                <div class="name-line">
                                    <h1 id="profile-name">Name</h1>
                                    <div id="worn-gift-icon-container" class="hidden lottie-animation-container"></div>
                                </div>
                                <p id="profile-gift-count-subtext">0 gifts</p>
                                <p id="profile-status" class="online">online</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-details-section">
                    <div id="profile-details" class="profile-details">
                         <div class="info-block">
                            <div class="info-label">Phone</div>
                            <div class="info-value" id="profile-phone"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Bio</div>
                            <div class="info-value" id="profile-bio"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Username</div>
                            <div class="info-value collectible-value" id="profile-username"></div>
                            <div class="info-value" id="collectible-usernames-container"></div>
                        </div>
                    </div>
                </div>
                <div class="profile-tabs-content">
                    <div class="profile-tabs">
                        <button id="posts-tab-button">Posts</button>
                        <button id="archive-tab-button">Archive</button>
                        <button class="active" id="gifts-tab-button">
                            Gifts
                            <span class="gift-preview-container" id="gifts-tab-preview-container"></span>
                        </button>
                    </div>
                    <div id="posts-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                     <div id="archive-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                    <div id="gifts-content" class="tab-content active">
                        <div id="gifts-grid" class="gifts-grid">
                            <div class="spinner hidden" id="gifts-loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <h2>Gift Shop</h2>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <!-- Modals below -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Gift Name</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="modal-gift-image-container" class="modal-gift-image-container">
                        <div id="modal-lottie-gift-original" class="lottie-animation-container"></div>
                        <img id="modal-gift-image-static" class="static-image-fallback" src="" alt="Gift" style="display:none;">
                    </div>
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-gift-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-scrollable-content">
                    <!-- Collectible Display Area - Redesigned -->
                    <div class="collectible-display-area">
                        <button class="menu-button" id="collectible-menu-button">⋮</button>
                        <div id="pattern-container-dynamic"></div>
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-lottie-collectible-model" class="lottie-animation-container"></div>
                            <img id="modal-collectible-model-img-static" class="static-image-fallback" src="" alt="Model" style="display:none;">
                        </div>
                        <h3 id="modal-collectible-main-name">Model Name</h3>
                        <p id="modal-collectible-number-subtext">Collectible #123</p>
                        <div id="modal-collectible-actions" class="modal-action-buttons-row">
                            <button id="collectible-action-wear"><span class="icon"></span><span class="text">Wear</span></button>
                            <button id="collectible-action-sell"><span class="icon"></span><span class="text">Sell</span></button>
                            <button id="collectible-action-transfer"><span class="icon"></span><span class="text">Transfer</span></button>
                        </div>
                    </div>

                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">
                        This gift is visible in your profile. <span id="hide-link-in-modal" class="link">Hide ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Too Many Pinned Gifts</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Select a gift to unpin. You can pin up to 6 collectible gifts.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Buy Gift</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">Quantity:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Buy</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="filter-popup" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Gift Filters</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section" id="filter-collections-section">
                        <h4>Collections</h4>
                        <div class="filter-options-grid" id="filter-options-collections"></div>
                    </div>
                    <div class="filter-section hidden" id="filter-models-section">
                        <h4>Models</h4>
                        <div class="filter-options-grid" id="filter-options-models"></div>
                    </div>
                    <div class="filter-section" id="filter-backdrops-section">
                        <h4>Backdrops</h4>
                        <div class="filter-options-grid" id="filter-options-backdrops"></div>
                    </div>
                    <div class="filter-section" id="filter-patterns-section">
                        <h4>Symbols</h4>
                        <div class="filter-options-grid" id="filter-options-patterns"></div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.1); border-style: solid; border-width: 1px 0 0 0; margin: 20px 0;">
                </div>
                <div class="modal-buttons-footer">
                    <button id="apply-filters-button" class="modal-button">Apply Filters</button>
                    <button id="clear-filters-button" class="modal-button secondary">Reset Filters</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Settings</h3>
                </div>
                <div class="modal-scrollable-content">
                     <div class="settings-row">
                        <label>Animations</label>
                        <label class="switch">
                            <input type="checkbox" id="animation-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Custom Gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="custom-gifts-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Show hidden gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="show-hidden-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <button id="hide-multiple-button" class="full-width">Hide Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="transfer-multiple-button" class="full-width">Transfer Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="clear-current-account-data-button" class="full-width">Clear Current Account Data</button>
                    </div>
                    <div class="settings-row danger">
                        <button id="clear-all-accounts-data-button" class="full-width">Clear All Accounts Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="chances-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Chance Calculator</h3>
                </div>
                <div class="modal-scrollable-content">
                    <p id="chances-gift-name" style="text-align: center; font-weight: 500; margin-bottom: 15px;"></p>
                    <div id="chances-probability-display"></div>
                    <div class="spinner hidden" id="chances-loading-spinner"></div>
                    <div class="filter-section hidden" id="chances-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="chances-options-models"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="chances-options-backdrops"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="chances-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-chances-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="custom-buy-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Create or Clone Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="gift-queue-container"></div>
                    <div id="gift-config-area">
                        <div class="filter-section">
                            <h4>Select base</h4>
                            <div class="filter-options-grid" id="custom-buy-base-gifts-grid"></div>
                        </div>
                        <div class="filter-section hidden" id="custom-buy-models-section">
                            <h4>Select model</h4>
                            <div class="filter-options-grid" id="custom-buy-models-grid"></div>
                        </div>
                        <div class="filter-section hidden" id="custom-buy-backdrops-section">
                            <h4>Select backdrop</h4>
                            <div class="filter-options-grid" id="custom-buy-backdrops-grid"></div>
                        </div>
                        <div class="filter-section hidden" id="custom-buy-patterns-section">
                            <h4>Select symbol</h4>
                            <div class="filter-options-grid" id="custom-buy-patterns-grid"></div>
                        </div>
                    </div>
                    <button id="add-another-gift-button" class="modal-button secondary" style="margin-top: 0; display: none;">+ Add Another Gift</button>
                    <button class="advanced-settings-toggle" id="advanced-settings-toggle">Advanced Settings</button>
                    <div id="advanced-settings-container" class="hidden">
                        <div>
                            <label for="custom-buy-quantity">Quantity to Create</label>
                            <input type="number" id="custom-buy-quantity" value="1" min="1">
                        </div>
                        <div id="custom-buy-clone-section" style="margin-top: 15px;">
                            <h4>Or Clone from Link</h4>
                            <input type="text" id="clone-url-input" placeholder="t.me/nft/..., Name #Number, etc.">
                            <button id="clone-gift-button" class="modal-button secondary" style="margin-top: 10px;">Clone Gift</button>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="custom-buy-confirm-button" class="modal-button" disabled>Create</button>
                    <button id="custom-buy-cancel-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="generated-image-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Your Gift</h3>
                </div>
                <div class="modal-scrollable-content" style="text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div id="generated-image-container" style="width: 100%; max-width: 300px; aspect-ratio: 3 / 4; border-radius: 12px; overflow: hidden; background-color: var(--tg-theme-bg-color); display: flex; align-items: center; justify-content: center;">
                        <img id="generated-image-preview" src="" alt="Generated Gift" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <p id="generated-image-message" style="margin-top: 15px; color: var(--tg-theme-hint-color); font-size: 0.9em;"></p>
                </div>
                <div class="modal-buttons-footer" id="generated-image-footer">
                    <button id="send-generated-image-button" class="modal-button" disabled>Send to Me</button>
                    <button id="close-generated-image-modal" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="sell-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Price in Stars</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="sell-gift-image" src="" alt="Gift Preview">
                        <h4 id="sell-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter price in Stars (125 - 100,000)</label>
                        <div class="price-input-wrapper">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star">
                            <input type="number" id="sell-price-input" placeholder="125" min="125" max="100000">
                        </div>
                    </div>
                    <div class="price-details">
                        <p id="sell-receive-amount">You will receive 100 Stars.</p>
                        <p id="sell-usd-amount">≈US$1.30</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-sell-button" class="modal-button" disabled>List for Sale</button>
                    <button id="cancel-sell-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="transfer-modal-title">Transfer Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="transfer-gift-image" src="" alt="Gift Preview">
                        <h4 id="transfer-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter recipient's Telegram username</label>
                        <div class="price-input-wrapper">
                            <span style="font-size:1.2em; margin-right:10px; color:var(--tg-theme-text-color);">@</span>
                            <input type="text" id="transfer-username-input" placeholder="username">
                        </div>
                    </div>
                    <textarea id="transfer-comment-input" rows="2" placeholder="Add a comment... (optional)"></textarea>
                    <div class="price-details" id="transfer-status-message">
                        <p>Gift ownership will be transferred to this username.</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-button" class="modal-button" disabled>Confirm Transfer</button>
                    <button id="cancel-transfer-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="numbers-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Anonymous Numbers +888</h3></div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="numbers-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-numbers-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="usernames-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Collectible Usernames</h3></div>
                <div class="search-bar-container">
                    <input type="text" id="username-search-input" placeholder="Search username...">
                </div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="usernames-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-usernames-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="giveaway-setup-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Create a Giveaway</h3></div>
                <div class="modal-scrollable-content">
                    <h4>1. Select Gifts to Give Away</h4>
                    <div id="giveaway-gift-selection-grid" class="selection-grid">
                        <p class="empty-grid-message">You have no collectible gifts to give away.</p>
                    </div>
                    <h4>2. Choose Winner Rule</h4>
                    <div class="winner-rule-section">
                        <label>
                            <input type="radio" name="winner-rule" value="single" checked>
                            One winner gets all gifts
                        </label>
                        <label>
                            <input type="radio" name="winner-rule" value="multiple">
                            One winner per gift
                        </label>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-giveaway-setup" class="modal-button" disabled>Start Setup in Bot</button>
                    <button id="cancel-giveaway-setup" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-reorder-action" class="hidden">Reorder</li>
            <li id="menu-pin-action">Pin</li>
            <li id="menu-hide-action">Hide</li>
            <li id="menu-copy-link-action" class="hidden">Copy Link</li>
            <li id="menu-share-image-action" class="hidden">Share Image</li>
            <li id="menu-delete-action" class="danger">Delete</li>
        </ul>
    </div>
    <script>
        const BACKEND_BASE_URL = "https://upgrade-a57g.onrender.com";

        const APP_VERSION_SUFFIX = '_v15'; // Increment to reset UI preferences on major changes
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const PRICES_JSON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/prices.json";
        const STAR_ICON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png";

        const GIFT_LIMIT_PER_USER = 5000;
        const MAX_COLLECTIBLE_USERNAMES = 10;
        const MIN_SALE_PRICE = 125;
        const MAX_SALE_PRICE = 100000;

        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M5,4H19L12,1.5L5,4ZM6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        const MENU_DOTS_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>dots-vertical</title><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>`;

        // --- CUSTOM GIFT DATA ---
        const CUSTOM_GIFTS_DATA = {
            "Dildo": {
                "id": "custom_dildo",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_003931098.png",
                "models": [
                    {"name": "She Wants", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011319484.png"},
                    {"name": "Anal Games", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004252351.png"},
                    {"name": "Romance", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011244151.png"},
                    {"name": "Ma Boi", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012725065.png"},
                    {"name": "Twins 18", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004029718.png"},
                    {"name": "Golden Sex", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004223973.png"},
                    {"name": "Pixels", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012914349.png"},
                    {"name": "Penis Sword", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014719027.png"},
                    {"name": "Water One", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004351728.png"},
                    {"name": "Woman Place", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004416012.png"},
                    {"name": "Volcano", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011343633.png"},
                    {"name": "Telegram", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012648445.png"},
                    {"name": "Pinkie Twinkie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004004128.png"},
                    {"name": "Silver Glass", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004200179.png"},
                    {"name": "Plush", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011552827.png"},
                    {"name": "Plush Cuttie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011623951.png"},
                    {"name": "Spider Fun", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012003197.png"},
                    {"name": "Horse", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012355663.png"},
                    {"name": "Hand", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_013039090.png"},
                    {"name": "Ancient", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014521352.png"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014626463.png"},
                    {"name": "Skinny Boi", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004055652.png"},
                    {"name": "Rainbow", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004125778.png"},
                    {"name": "Russian Wood", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011527878.png"},
                    {"name": "Afterparty", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011822289.png"},
                    {"name": "Neon", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012439323.png"},
                    {"name": "Black Jack", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_013144671.png"},
                    {"name": "Galaxy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014555528.png"},
                    {"name": "Hell Red", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014650858.png"}
                ],
                "backdrops_source": "Astral Shard",
                "patterns_source": "Astral Shard"
            },
            "Skebob": {
                "id": "custom_skebob",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_034626591.png",
                "models": [
                    {"name": "Nikitka", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_145212143.png"},
                    {"name": "Gold", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220944840-min.png"},
                    {"name": "Plushy", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221053786-min.png"},
                    {"name": "XXXTentacion", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222249990-min.png"},
                    {"name": "Cactus King", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013002213-min.png"},
                    {"name": "354 KANON", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013042799-min.png"},
                    {"name": "Duck", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014036288-min.png"},
                    {"name": "Spider King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220335725-min.png"},
                    {"name": "Bitcoin", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012502725-min.png"},
                    {"name": "Move To Heaven", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012612974-min.png"},
                    {"name": "Frogie", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012824238-min.png"},
                    {"name": "The King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012931928-min.png"},
                    {"name": "Fire On Fire", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013941593-min.png"},
                    {"name": "Icy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220405846-min.png"},
                    {"name": "Pick Me", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220906007-min.png"},
                    {"name": "Black Bird", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221147963-min.png"},
                    {"name": "Pavel Durov", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222706006-min.png"},
                    {"name": "Banana", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013851152-min.png"},
                    {"name": "Mummy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014247708-min.png"},
                    {"name": "Police Man", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014319952-min.png"},
                    {"name": "Electric BDSM", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014554522-min.png"},
                    {"name": "Glassy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221020205-min.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012541910-min.png"},
                    {"name": "Business", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013214856-min.png"},
                    {"name": "Spookie", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013308503-min.png"},
                    {"name": "Minion", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013343118-min.png"},
                    {"name": "Oh Shit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013417326-min.png"},
                    {"name": "Emo Girl", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014533870-min.png"},
                    {"name": "Minecraft", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014750440-min.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            },
            "Baggin' Cat": {
                "id": "custom_baggin_cat",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/refs/heads/main/IMG_20250718_234950_164.png",
                "models": [
                    {"name": "Redo", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154505502.png"},
                    {"name": "Bored Ape", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153421320.png"},
                    {"name": "Snoop Dogg", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153800346.png"},
                    {"name": "Austronaut", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153211676.png"},
                    {"name": "Chinese Dragon", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153332160.png"},
                    {"name": "Radioactive", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154437815.png"},
                    {"name": "Pink Guard", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154725761.png"},
                    {"name": "Angel", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155859028.png"},
                    {"name": "Devil", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155937967.png"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153059849.png"},
                    {"name": "Rainbow", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153251813.png"},
                    {"name": "Spookie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153836181.png"},
                    {"name": "Spider", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154055429.png"},
                    {"name": "Dying Light", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_154537813.png"},
                    {"name": "Hippo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155053345.png"},
                    {"name": "Poo", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155200011.png"},
                    {"name": "Pikachu", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155411045.png"},
                    {"name": "XXXTentacion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155652114.png"},
                    {"name": "Electric", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155830968.png"},
                    {"name": "Glassy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160036747.png"},
                    {"name": "Alien", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160243304.png"},
                    {"name": "Piggy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160346910.png"},
                    {"name": "Panda", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153136834.png"},
                    {"name": "Capybara", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_153629360.png"},
                    {"name": "Dolphin", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155125393.png"},
                    {"name": "Rabbit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_155341280.png"},
                    {"name": "Elephant", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160003197.png"},
                    {"name": "Bee", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/main/BackgroundEraser_20250720_160317620.png"}
                ],
                "backdrops_source": "Toy Bear",
                "patterns_source": "Toy Bear"
            }
        };


        // --- Global State ---
        let allAvailableGifts = {};
        let giftPrices = {};

        let accounts = [];
        let currentAccountTgId = null;

        let ownedGifts = [];
        let currentlySortedGifts = [];
        let viewingOwnProfile = true;
        let selectionModeActive = false;
        let selectionAction = null;
        let reorderModeActive = false;
        let selectedGiftIds = new Set();

        let animationsEnabled = true;
        let showHiddenGifts = false;
        let customGiftsEnabled = false;
        let activeFilters = { collection: null, model: null, backdrop: null, pattern: null };

        let tg = window.Telegram.WebApp;

        // --- DOM Elements ---
        const appContainer = document.querySelector('.app-container');
        const accountSidebar = document.getElementById('account-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarCurrentAvatar = document.getElementById('sidebar-current-avatar');
        const sidebarCurrentName = document.getElementById('sidebar-current-name');
        const accountsList = document.getElementById('accounts-list');
        const addAccountButton = document.getElementById('add-account-button');
        const openNumbersButton = document.getElementById('open-numbers-button');
        const openUsernamesButton = document.getElementById('open-usernames-button');
        const createGiveawayButton = document.getElementById('create-giveaway-button');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');

        const profilePage = document.getElementById('profile-page');
        const profileTopSection = document.getElementById('profile-top-section');
        const profileHeaderPatternOverlay = document.getElementById('profile-header-pattern-overlay');
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const profileName = document.getElementById('profile-name');
        const wornGiftIconContainer = document.getElementById('worn-gift-icon-container');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profileDetails = document.getElementById('profile-details');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const collectibleUsernamesContainer = document.getElementById('collectible-usernames-container');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');

        const giftsTabButton = document.getElementById('gifts-tab-button');
        const giftsTabPreviewContainer = document.getElementById('gifts-tab-preview-container');
        const postsTabButton = document.getElementById('posts-tab-button');
        const archiveTabButton = document.getElementById('archive-tab-button');
        const giftsContent = document.getElementById('gifts-content');
        const postsContent = document.getElementById('posts-content');
        const archiveContent = document.getElementById('archive-content');

        const giftsGrid = document.getElementById('gifts-grid');
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');

        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');

        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalLottieGiftOriginal = document.getElementById('modal-lottie-gift-original');
        const modalGiftImageStatic = document.getElementById('modal-gift-image-static');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');

        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const collectibleDisplayArea = collectibleDetailModal.querySelector('.collectible-display-area');
        const patternContainerDynamic = document.getElementById('pattern-container-dynamic');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalLottieCollectibleModel = document.getElementById('modal-lottie-collectible-model');
        const modalCollectibleModelImgStatic = document.getElementById('modal-collectible-model-img-static');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        const collectibleMenuButton = document.getElementById('collectible-menu-button');
        const hideLinkInModal = document.getElementById('hide-link-in-modal');

        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');

        const longPressMenu = document.getElementById('long-press-menu');
        const menuReorderAction = document.getElementById('menu-reorder-action');
        const menuPinAction = document.getElementById('menu-pin-action');
        const menuHideAction = document.getElementById('menu-hide-action');
        const menuCopyLinkAction = document.getElementById('menu-copy-link-action');
        const menuDeleteAction = document.getElementById('menu-delete-action');
        const menuShareImageAction = document.getElementById('menu-share-image-action');

        const filterPopup = document.getElementById('filter-popup');
        const filterModelsSection = document.getElementById('filter-models-section');
        const filterOptionsCollections = document.getElementById('filter-options-collections');
        const filterOptionsModels = document.getElementById('filter-options-models');
        const filterOptionsBackdrops = document.getElementById('filter-options-backdrops');
        const filterOptionsPatterns = document.getElementById('filter-options-patterns');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const clearFiltersButton = document.getElementById('clear-filters-button');

        const settingsModal = document.getElementById('settings-modal');
        const animationToggle = document.getElementById('animation-toggle');
        const customGiftsToggle = document.getElementById('custom-gifts-toggle');
        const showHiddenToggle = document.getElementById('show-hidden-toggle');
        const hideMultipleButton = document.getElementById('hide-multiple-button');
        const transferMultipleButton = document.getElementById('transfer-multiple-button');
        const clearCurrentAccountDataButton = document.getElementById('clear-current-account-data-button');
        const clearAllAccountsDataButton = document.getElementById('clear-all-accounts-data-button');

        const customBuyModal = document.getElementById('custom-buy-modal');
        const giftQueueContainer = document.getElementById('gift-queue-container');
        const giftConfigArea = document.getElementById('gift-config-area');
        const customBuyBaseGiftsGrid = document.getElementById('custom-buy-base-gifts-grid');
        const customBuyModelsSection = document.getElementById('custom-buy-models-section');
        const customBuyModelsGrid = document.getElementById('custom-buy-models-grid');
        const customBuyBackdropsSection = document.getElementById('custom-buy-backdrops-section');
        const customBuyBackdropsGrid = document.getElementById('custom-buy-backdrops-grid');
        const customBuyPatternsSection = document.getElementById('custom-buy-patterns-section');
        const customBuyPatternsGrid = document.getElementById('custom-buy-patterns-grid');
        const addAnotherGiftButton = document.getElementById('add-another-gift-button');
        const advancedSettingsToggle = document.getElementById('advanced-settings-toggle');
        const advancedSettingsContainer = document.getElementById('advanced-settings-container');
        const customBuyQuantityInput = document.getElementById('custom-buy-quantity');
        const cloneUrlInput = document.getElementById('clone-url-input');
        const cloneGiftButton = document.getElementById('clone-gift-button');
        const customBuyConfirmButton = document.getElementById('custom-buy-confirm-button');
        const customBuyCancelButton = document.getElementById('custom-buy-cancel-button');

        const generatedImageModal = document.getElementById('generated-image-modal');
        const generatedImageFooter = document.getElementById('generated-image-footer');
        const generatedImagePreview = document.getElementById('generated-image-preview');
        const generatedImageMessage = document.getElementById('generated-image-message');
        const sendGeneratedImageButton = document.getElementById('send-generated-image-button');
        const closeGeneratedImageModalButton = document.getElementById('close-generated-image-modal');

        const chancesModal = document.getElementById('chances-modal');
        const chancesGiftName = document.getElementById('chances-gift-name');
        const chancesLoadingSpinner = document.getElementById('chances-loading-spinner');
        const chancesProbabilityDisplay = document.getElementById('chances-probability-display');
        const chancesModelsSection = document.getElementById('chances-models-section');
        const chancesOptionsModels = document.getElementById('chances-options-models');
        const chancesBackdropsSection = document.getElementById('chances-backdrops-section');
        const chancesOptionsBackdrops = document.getElementById('chances-options-backdrops');
        const chancesPatternsSection = document.getElementById('chances-patterns-section');
        const chancesOptionsPatterns = document.getElementById('chances-options-patterns');
        const closeChancesModalButton = document.getElementById('close-chances-modal');

        const sellGiftModal = document.getElementById('sell-gift-modal');
        const sellGiftImage = document.getElementById('sell-gift-image');
        const sellGiftName = document.getElementById('sell-gift-name');
        const sellPriceInput = document.getElementById('sell-price-input');
        const sellReceiveAmount = document.getElementById('sell-receive-amount');
        const sellUsdAmount = document.getElementById('sell-usd-amount');
        const confirmSellButton = document.getElementById('confirm-sell-button');
        const cancelSellButton = document.getElementById('cancel-sell-button');

        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferModalTitle = document.getElementById('transfer-modal-title');
        const transferGiftImage = document.getElementById('transfer-gift-image');
        const transferGiftName = document.getElementById('transfer-gift-name');
        const transferUsernameInput = document.getElementById('transfer-username-input');
        const transferCommentInput = document.getElementById('transfer-comment-input');
        const transferStatusMessage = document.getElementById('transfer-status-message');
        const confirmTransferButton = document.getElementById('confirm-transfer-button');
        const cancelTransferButton = document.getElementById('cancel-transfer-button');

        const numbersModal = document.getElementById('numbers-modal');
        const numbersList = document.getElementById('numbers-list');

        const usernamesModal = document.getElementById('usernames-modal');
        const usernameSearchInput = document.getElementById('username-search-input');
        const usernamesList = document.getElementById('usernames-list');

        const giveawaySetupModal = document.getElementById('giveaway-setup-modal');
        const giveawayGiftSelectionGrid = document.getElementById('giveaway-gift-selection-grid');
        const confirmGiveawaySetupButton = document.getElementById('confirm-giveaway-setup');

        const coolNumbers = ["+888 8888 8888", "+888 0000 0001", "+888 1234 5678", "+888 1111 1111", "+888 7777 7777", "+888 0707 6969"];
        const coolUsernames = ["durov", "admin", "king", "wallet", "crypto", "elon", "boss", "premium", "gift", "star", "diamond", "anonymous", "market", "bank", "news", "pessi", "penaldo"];

        let currentGiftToBuyMultiple = null;
        let lottieIntersectionObserver;
        
        let giftCreationQueue = [];
        let currentlyEditingGiftIndex = -1;

        let cachedCollectibleParts = {};
        let lastTap = 0;
        let tapCount = 0;
        let currentGiftToSell = null;
        let currentGiftToTransfer = null;
        let longPressAvatarTimer;
        let sortableInstance = null;
        let modalSwipeState = { startX: 0, isSwiping: false };
        let selectedGiveawayGifts = new Set();

        // --- API Utility Function ---
        async function callBackend(endpoint, method = 'GET', data = null, params = {}) {
            const queryParams = new URLSearchParams(params).toString();
            const url = `${BACKEND_BASE_URL}${endpoint}${queryParams ? '?' + queryParams : ''}`;

            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: data ? JSON.stringify(data) : null,
            };

            try {
                const response = await fetch(url, options);
                const responseData = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw { 
                        status: response.status, 
                        message: responseData.error || response.statusText || 'Unknown error',
                        reason: responseData.reason 
                    };
                }
                return response.status === 204 ? null : responseData;
            } catch (error) {
                console.error(`Backend API call failed: ${endpoint}`, error);
                if (error.status !== 403) { // Don't show generic alert for permission errors handled elsewhere
                    tg.showAlert(`Error: ${error.message}`);
                }
                throw error;
            }
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateUniqueId() { return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`; }

        function formatRarity(permille) {
            if (!permille) return 'N/A';
            const percentage = permille / 10;
            const oneInX = Math.round(1000 / percentage);
            return `${percentage}% <span class="one-in-x">(1 of ${oneInX.toLocaleString('en-US')})</span>`;
        }

        function playLottieAnimation(container, path, loop = true, isGridItem = false) {
            if (!animationsEnabled) {
                destroyLottieAnimation(container);
                const parentCard = container.closest('.gift-card, .buy-gift-item, .modal-collectible-visual');
                if (parentCard) {
                    const staticFallback = parentCard.querySelector('.static-image-fallback');
                    if(staticFallback) staticFallback.style.display = 'block';
                    container.style.display = 'none';
                }
                return;
            }
            if (!container || !path) return;
            if (container.lottieInstance) { container.lottieInstance.destroy(); delete container.lottieInstance; }
            container.innerHTML = '';
            const anim = bodymovin.loadAnimation({ container: container, path: path, renderer: 'svg', loop: loop, autoplay: true });
            container.lottieInstance = anim;
            if (isGridItem && !loop) {
                anim.addEventListener('complete', () => { if (container.lottieInstance === anim) container.dataset.playedOnce = 'true'; });
            }
        }
        function destroyLottieAnimation(container) {
            if (container && container.lottieInstance) {
                container.lottieInstance.destroy();
                delete container.lottieInstance; delete container.dataset.playedOnce; container.innerHTML = '';
            }
        }
        function handleLottieIntersection(entries, observer) {
            entries.forEach(entry => {
                const cardElement = entry.target;
                const lottieContainer = cardElement.querySelector('.lottie-animation-container');
                const staticFallback = cardElement.querySelector('.static-image-fallback');
                const lottiePath = cardElement.dataset.lottiePath;
                if (entry.isIntersecting) {
                    if (animationsEnabled && lottiePath && lottieContainer) {
                        if(staticFallback) staticFallback.style.display = 'none';
                        lottieContainer.style.display = 'flex';
                        playLottieAnimation(lottieContainer, lottiePath, false, true);
                    }
                } else {
                    if (lottieContainer) {
                        destroyLottieAnimation(lottieContainer);
                        if(staticFallback) staticFallback.style.display = 'block';
                        lottieContainer.style.display = 'none';
                    }
                }
            });
        }
        function initLottieObserver() {
            lottieIntersectionObserver = new IntersectionObserver(handleLottieIntersection, { root: null, rootMargin: '100px', threshold: 0.01 });
        }
        function observeLottieElement(element) {
            if (lottieIntersectionObserver && element.dataset.lottiePath) lottieIntersectionObserver.observe(element);
        }
        function unobserveLottieElement(element) {
             if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.unobserve(element);
                const lottieContainer = element.querySelector('.lottie-animation-container');
                if(lottieContainer) destroyLottieAnimation(lottieContainer);
            }
        }

        async function initApp() {
            tg.ready(); tg.expand();
            initLottieObserver();

            collectibleActionWear.querySelector('.icon').innerHTML = CROWN_SVG;
            collectibleActionSell.querySelector('.icon').innerHTML = LABEL_SVG;
            collectibleActionTransfer.querySelector('.icon').innerHTML = DIAMOND_SVG;
            collectibleMenuButton.innerHTML = MENU_DOTS_SVG;

            loadClientSideState();

            const startAppParam = tg.initDataUnsafe?.start_param;
            if (startAppParam) {
                await initializeTelegramUserAccount();
                if (startAppParam.startsWith('user')) {
                    const username = startAppParam.substring(4);
                    await displayUserProfile(username);
                } else if (startAppParam.startsWith('gift')) {
                    const giftString = startAppParam.substring(4);
                    const lastHyphenIndex = giftString.lastIndexOf('-');
                    if (lastHyphenIndex > -1) {
                        const giftTypeId = giftString.substring(0, lastHyphenIndex);
                        const collectibleNumber = parseInt(giftString.substring(lastHyphenIndex + 1), 10);
                        if (giftTypeId && !isNaN(collectibleNumber)) {
                            await displayDeepLinkedGift(giftTypeId, collectibleNumber);
                        } else {
                            tg.showAlert("Invalid gift format in deep link.");
                        }
                    } else {
                         tg.showAlert("Invalid gift format in deep link.");
                    }
                }
            } else {
                await initializeTelegramUserAccount();
            }

            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            tg.SettingsButton.show();
            tg.SettingsButton.onClick(openSettingsModal);

            setupEventListeners();
            await fetchGiftPrices();
            await fetchAvailableGifts();
        }

        async function initializeTelegramUserAccount() {
            manageBackButton(false);
            viewingOwnProfile = true;
            const user = tg.initDataUnsafe?.user;
            let tg_id = user?.id;

            if (!tg_id) {
                let mockAccount = JSON.parse(localStorage.getItem('giftSimMockTgUser' + APP_VERSION_SUFFIX));
                if (!mockAccount) {
                    mockAccount = {
                        tg_id: Math.floor(Math.random() * 1e9) + 1,
                        username: `mockuser_${Math.random().toString(36).substring(2, 6)}`,
                        full_name: `Mock User ${Math.floor(Math.random() * 100)}`,
                        avatar_url: `https://i.pravatar.cc/140?u=mock_${generateUniqueId()}`
                    };
                    localStorage.setItem('giftSimMockTgUser' + APP_VERSION_SUFFIX, JSON.stringify(mockAccount));
                }
                tg_id = mockAccount.tg_id;
            }

            try {
                const accountData = await callBackend('/api/account', 'POST', {
                    tg_id: tg_id,
                    username: user?.username,
                    full_name: user ? [user.first_name, user.last_name].filter(Boolean).join(' ') : 'Original User Name',
                    avatar_url: user?.photo_url || `https://i.pravatar.cc/140?u=${tg_id}`
                });

                currentAccountTgId = accountData.tg_id;
                ownedGifts = accountData.owned_gifts || [];
                customGiftsEnabled = accountData.custom_gifts_enabled || false;

                let existingAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                if (existingAccount) {
                    Object.assign(existingAccount, accountData);
                } else {
                    accounts.push(accountData);
                }
                saveClientSideAccounts();
                renderAll();
                console.log("Account data loaded successfully.");
            } catch (error) {
                console.error("Failed to initializeTelegramUserAccount:", error);
            }
        }

        async function displayDeepLinkedGift(giftTypeId, collectibleNumber) {
            try {
                const giftData = await callBackend(`/api/gift/${giftTypeId}/${collectibleNumber}`, 'GET', null, { viewer_id: currentAccountTgId });
                if (giftData) {
                    openModal(collectibleDetailModal, giftData);
                }
            } catch (error) {
                if (error.reason === 'custom_content_disabled') {
                    tg.showAlert("Sorry, you cannot see this gift.");
                }
                console.error("Error fetching deep-linked gift:", error);
            }
        }

        async function displayUserProfile(username) {
             const ownAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
             if (ownAccount && ownAccount.username && ownAccount.username.toLowerCase() === username.toLowerCase()) {
                 await initializeTelegramUserAccount();
                 return;
             }

             viewingOwnProfile = false;
             try {
                const profileData = await callBackend(`/api/profile/${username}`, 'GET', null, { viewer_id: currentAccountTgId });
                ownedGifts = profileData.owned_gifts || [];

                profileName.textContent = profileData.full_name || 'User';
                profileAvatar.src = profileData.avatar_url || '';
                profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
                profileUsername.textContent = profileData.username ? `@${profileData.username}` : 'no username';
                profileUsername.onclick = null;
                profileBio.textContent = profileData.bio || "No bio yet";
                profilePhone.textContent = profileData.phone_number || "Not specified";

                collectibleUsernamesContainer.innerHTML = '';
                if (profileData.collectible_usernames && profileData.collectible_usernames.length > 0) {
                    const alsoSpan = document.createElement('span'); alsoSpan.className = 'also-text'; alsoSpan.textContent = 'also';
                    collectibleUsernamesContainer.appendChild(alsoSpan);
                    profileData.collectible_usernames.forEach(uname => {
                        const unameSpan = document.createElement('span'); unameSpan.className = 'collectible-username-span'; unameSpan.textContent = `@${uname}`;
                        collectibleUsernamesContainer.appendChild(unameSpan);
                    });
                }

                manageBackButton(true, () => initializeTelegramUserAccount());

                profileBio.style.cursor = 'default';
                profileBio.onclick = null;
                profileAvatar.style.cursor = 'default';

                renderAll();
            } catch (error) {
                console.error("Error fetching user profile:", error);
                await initializeTelegramUserAccount();
            }
        }

        function manageBackButton(visible, onClickHandler) {
            if (visible) {
                tg.BackButton.show();
                tg.BackButton.onClick(onClickHandler);
            } else {
                tg.BackButton.hide();
                if (tg._backButtonCallback) {
                     tg.BackButton.offClick(tg._backButtonCallback);
                     delete tg._backButtonCallback;
                }
                if (onClickHandler) {
                    tg._backButtonCallback = onClickHandler;
                }
            }
        }

        function applyTheme(themeParams) {
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1');
                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                applyWornGiftStyles();
            } else console.log("Using default CSS variables as themeParams are empty.");
        }

        function loadUserData() {
            const account = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!account) return;

            profileName.textContent = account.full_name || 'User';
            profileAvatar.src = account.avatar_url || '';
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
            profileUsername.textContent = account.username ? `@${account.username}` : 'no username';
            profileUsername.onclick = () => { if(account.username) displayUserProfile(account.username); };
            profileBio.textContent = account.bio || "No bio yet";
            profilePhone.textContent = account.phone_number || "Not specified";
            profileBio.style.cursor = 'pointer';
            profileAvatar.style.cursor = 'pointer';

            collectibleUsernamesContainer.innerHTML = '';
            if (account.collectible_usernames && account.collectible_usernames.length > 0) {
                const alsoSpan = document.createElement('span');
                alsoSpan.className = 'also-text';
                alsoSpan.textContent = 'also';
                collectibleUsernamesContainer.appendChild(alsoSpan);

                account.collectible_usernames.forEach(uname => {
                    const unameSpan = document.createElement('span');
                    unameSpan.className = 'collectible-username-span';
                    unameSpan.textContent = `@${uname}`;
                    unameSpan.dataset.username = uname;
                    unameSpan.addEventListener('click', () => displayUserProfile(uname));
                    unameSpan.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleDeleteCollectibleUsername(uname);
                    });

                    collectibleUsernamesContainer.appendChild(unameSpan);
                });
            }

            // Update sidebar header
            sidebarCurrentAvatar.src = account.avatar_url;
            sidebarCurrentName.textContent = account.full_name;
        }

        // --- Account Management ---
        function loadClientSideState() {
            animationsEnabled = JSON.parse(localStorage.getItem('animationsEnabled' + APP_VERSION_SUFFIX)) ?? true;
            showHiddenGifts = JSON.parse(localStorage.getItem('showHiddenGifts' + APP_VERSION_SUFFIX)) ?? false;
            activeFilters = JSON.parse(localStorage.getItem('activeFilters' + APP_VERSION_SUFFIX)) || { collection: null, model: null, backdrop: null, pattern: null };
            accounts = JSON.parse(localStorage.getItem('giftSimAccounts' + APP_VERSION_SUFFIX)) || [];
            currentAccountTgId = localStorage.getItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX);
        }

        function saveClientSideState() {
            localStorage.setItem('activeFilters' + APP_VERSION_SUFFIX, JSON.stringify(activeFilters));
            localStorage.setItem('animationsEnabled' + APP_VERSION_SUFFIX, JSON.stringify(animationsEnabled));
            localStorage.setItem('showHiddenGifts' + APP_VERSION_SUFFIX, JSON.stringify(showHiddenGifts));
        }

        function saveClientSideAccounts() {
            try {
                // FIX: Only store essential account info, not gifts, to prevent storage overflow.
                const accountsToStore = accounts.map(acc => ({
                    tg_id: acc.tg_id,
                    username: acc.username,
                    full_name: acc.full_name,
                    avatar_url: acc.avatar_url,
                    bio: acc.bio,
                    phone_number: acc.phone_number,
                    collectible_usernames: acc.collectible_usernames
                }));
                localStorage.setItem('giftSimAccounts' + APP_VERSION_SUFFIX, JSON.stringify(accountsToStore));
                localStorage.setItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX, currentAccountTgId);
            } catch (e) {
                console.error("Error saving client side accounts:", e);
                if (e.name === 'QuotaExceededError') {
                    // This alert is now less likely to trigger, but is kept as a safeguard.
                    tg.showAlert("A storage error occurred. Please clear your browser cache or app data if the problem persists.");
                }
            }
        }

        async function handleAddAccount() {
            const newTgId = Math.floor(Math.random() * 1e12) + 1;
            const newAccountData = {
                tg_id: newTgId,
                username: `testuser_${Math.random().toString(36).substring(2, 8)}`,
                full_name: `Test User ${accounts.length + 1}`,
                avatar_url: `https://i.pravatar.cc/140?u=${newTgId}`
            };

            try {
                const createdAccount = await callBackend('/api/account', 'POST', newAccountData);
                accounts.push(createdAccount);
                await switchAccount(createdAccount.tg_id);
                closeSidebar();
            } catch (error) {
                console.error(error);
            }
        }

        async function switchAccount(tgId) {
            if (currentAccountTgId === tgId) return;
            currentAccountTgId = tgId;
            saveClientSideAccounts();
            await initializeTelegramUserAccount();
        }

        function renderAll() {
            if (viewingOwnProfile) {
                loadUserData();
            }
            renderAccountsList();
            animationToggle.checked = animationsEnabled;
            showHiddenToggle.checked = showHiddenGifts;
            customGiftsToggle.checked = customGiftsEnabled;
            applyWornGiftStyles();
            renderProfileGifts();
        }

        function renderAccountsList() {
            accountsList.innerHTML = '';
            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.dataset.accountId = acc.tg_id;
                li.innerHTML = `<img src="${acc.avatar_url}" alt="Avatar"> <span>${acc.full_name}</span>`;
                if (String(acc.tg_id) === String(currentAccountTgId)) {
                    li.classList.add('active');
                }
                li.addEventListener('click', async () => {
                    if (String(acc.tg_id) !== String(currentAccountTgId)) {
                        await switchAccount(acc.tg_id);
                    }
                    closeSidebar();
                });
                accountsList.appendChild(li);
            });
        }

        function openSidebar() {
            manageBackButton(true, closeSidebar);
            renderAccountsList();
            const hasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            upgradeAllGiftsButton.classList.toggle('hidden', !hasNonCollectible);
            accountSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            manageBackButton(false);
            accountSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }

        function applyWornGiftStyles() {
            const wornGift = ownedGifts.find(g => g.is_worn === true);

            destroyLottieAnimation(wornGiftIconContainer);
            if (wornGift && wornGift.is_collectible && wornGift.collectible_data) {
                const cd = wornGift.collectible_data;
                if (animationsEnabled && cd.lottieModelPath) {
                    playLottieAnimation(wornGiftIconContainer, cd.lottieModelPath, true);
                } else if (cd.modelImage) {
                    wornGiftIconContainer.innerHTML = `<img src="${cd.modelImage}" style="width:100%; height:100%; object-fit:contain;">`;
                }
                wornGiftIconContainer.classList.remove('hidden');
                const colors = cd.backdropColors;
                if (colors) profileTopSection.style.background = `radial-gradient(circle at 50% 0%, ${colors.centerColor} 0%, ${colors.edgeColor} 100%)`;
                else profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                if (cd.patternImage) {
                    profileHeaderPatternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                    profileHeaderPatternOverlay.style.opacity = '0.07';
                } else profileHeaderPatternOverlay.style.backgroundImage = 'none';
            } else {
                wornGiftIconContainer.classList.add('hidden');
                wornGiftIconContainer.innerHTML = '';
                profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                profileHeaderPatternOverlay.style.backgroundImage = 'none';
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId === 'buy-gifts-page') {
                renderAvailableGifts();
                manageBackButton(true, () => showPage('profile-page'));
            } else {
                manageBackButton(false);
            }
        }

        async function fetchGiftPrices() {
            try {
                const response = await fetch(PRICES_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                giftPrices = await response.json();
            } catch (error) {
                console.error("Could not fetch gift prices:", error);
                giftPrices = {};
            }
        }

        async function fetchAvailableGifts() {
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allAvailableGifts = await response.json();

                // Add all custom gifts to the end of the list
                for (const giftName in CUSTOM_GIFTS_DATA) {
                    const customGift = CUSTOM_GIFTS_DATA[giftName];
                    if (customGift && customGift.id) {
                        allAvailableGifts[customGift.id] = giftName;
                    }
                }

                populateFilterOptions();
            } catch (error) {
                console.error("Could not load available gifts:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Could not load gifts. Please try again later.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }

        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            let giftsToRender = { ...allAvailableGifts };

            if (!customGiftsEnabled) {
                giftsToRender = Object.fromEntries(
                    Object.entries(allAvailableGifts).filter(([id, name]) => !CUSTOM_GIFTS_DATA[name])
                );
            }

            if (Object.keys(giftsToRender).length === 0) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">No gifts available right now.</p>`;
                return;
            }

            for (const id in giftsToRender) {
                const name = giftsToRender[id];
                let originalImageUrl, lottiePath;

                if (CUSTOM_GIFTS_DATA[name]) {
                    originalImageUrl = CUSTOM_GIFTS_DATA[name].defaultImage;
                    lottiePath = null;
                } else {
                    originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                    lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
                }

                const price = giftPrices[name];
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id; item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;
                if (lottiePath) item.dataset.lottiePath = lottiePath;

                const priceHTML = price
                    ? `<div class="gift-price has-price"><img src="${STAR_ICON_URL}" class="star-icon" alt="Star"/> ${price}</div>`
                    : `<div class="gift-price">Free</div>`;

                item.innerHTML = `
                    <div class="image-container">
                        <div class="lottie-animation-container" style="display:none;"></div>
                        <img class="static-image-fallback" src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.innerHTML = '🖼️';">
                    </div>
                    <div class="gift-name">${name}</div>
                    ${priceHTML}
                    <div class="limited-label">Limited</div>
                `;
                item.addEventListener('click', () => buyGift(id, name, originalImageUrl, lottiePath, 1));
                let buyItemLongPressTimer;
                item.addEventListener('touchstart', (e) => { buyItemLongPressTimer = setTimeout(() => openBuyMultipleModal(id, name, originalImageUrl, lottiePath), 700); }, { passive: true });
                item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('contextmenu', (e) => { e.preventDefault(); openBuyMultipleModal(id, name, originalImageUrl, lottiePath); });
                observeLottieElement(item);
                buyGiftsGrid.appendChild(item);
            }
        }

        function getGiftCountText(count) {
            return count === 1 ? `${count} gift` : `${count} gifts`;
        }

        function updateAllAnimationsState() {
            document.querySelectorAll('.lottie-animation-container').forEach(container => {
                const parentCard = container.closest('[data-lottie-path]');
                const modal = container.closest('.modal-overlay.active');

                if (animationsEnabled) {
                    if (parentCard && parentCard.offsetParent !== null) { observeLottieElement(parentCard); }
                    else if (container.id === 'worn-gift-icon-container') { applyWornGiftStyles(); }
                    else if (modal) {
                         if (container.id === 'modal-lottie-gift-original' && giftDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === giftDetailModal.dataset.instanceId);
                             if (gift && gift.lottie_path) playLottieAnimation(container, gift.lottie_path, true);
                         }
                         if (container.id === 'modal-lottie-collectible-model' && collectibleDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                             if (gift?.collectible_data?.lottieModelPath) playLottieAnimation(container, gift.collectible_data.lottieModelPath, true);
                         }
                    } else if (container.closest('#profile-top-pinned-gifts')) { renderTopPinnedGiftsPreview(); }
                } else {
                    destroyLottieAnimation(container);
                    if (parentCard) {
                        const staticFallback = parentCard.querySelector('.static-image-fallback');
                        if (staticFallback) staticFallback.style.display = 'block';
                        container.style.display = 'none';
                    }
                }
            });
            applyWornGiftStyles();
        }

        function renderProfileGifts() {
            Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
            giftsGrid.innerHTML = '';

            const baseGifts = showHiddenGifts ? ownedGifts : ownedGifts.filter(g => !g.is_hidden);

            const filteredGifts = baseGifts.filter(gift => {
                if (activeFilters.collection && gift.gift_type_id !== activeFilters.collection) return false;
                if (gift.is_collectible && gift.collectible_data) {
                    if (activeFilters.model && gift.collectible_data.model?.name !== activeFilters.model) return false;
                    if (activeFilters.backdrop && gift.collectible_data.backdrop?.name !== activeFilters.backdrop) return false;
                    if (activeFilters.pattern && gift.collectible_data.pattern?.name !== activeFilters.pattern) return false;
                } else if (activeFilters.model || activeFilters.backdrop || activeFilters.pattern) return false;
                return true;
            });

            // Sort gifts for display: Pinned first (by order), then by date
            const sortedGifts = [...filteredGifts].sort((a, b) => {
                const aIsPinned = a.is_pinned && a.pin_order != null;
                const bIsPinned = b.is_pinned && b.pin_order != null;
                if (aIsPinned && bIsPinned) return a.pin_order - b.pin_order;
                if (aIsPinned) return -1;
                if (bIsPinned) return 1;
                return new Date(b.acquired_date) - new Date(a.acquired_date);
            });

            currentlySortedGifts = sortedGifts;

            profileGiftCountSubtext.textContent = getGiftCountText(filteredGifts.length);
            if (ownedGifts.length > 0 && filteredGifts.length !== ownedGifts.length) {
                profileGiftCountSubtext.textContent += ` of ${ownedGifts.length}`;
            }

            if (currentlySortedGifts.length === 0) {
                giftsGrid.style.display = 'flex'; giftsGrid.style.alignItems = 'center'; giftsGrid.style.justifyContent = 'center';
                let emptyMessage = "You don't have any gifts yet.";
                if (ownedGifts.length > 0) {
                    emptyMessage = "No gifts match the selected filters.";
                    if (!showHiddenGifts && ownedGifts.some(g => g.is_hidden)) {
                        emptyMessage += " Some gifts might be hidden.";
                    }
                } else if (!viewingOwnProfile) {
                     emptyMessage = "This user hasn't received any gifts yet."
                }
                giftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">${emptyMessage}</p>`;
            } else {
                giftsGrid.style.display = 'grid';
                currentlySortedGifts.forEach(gift => {
                    const card = createGiftCardDOM(gift);
                    giftsGrid.appendChild(card);
                    observeLottieElement(card);
                });
            }
            renderTopPinnedGiftsPreview();
            renderGiftsTabPreview();
        }

        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instance_id;
            card.dataset.pinned = gift.is_pinned;

            if (gift.is_hidden) card.classList.add('is-hidden');

            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none';
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
            let lottiePathForCard = null;

            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                staticImage.src = cd.modelImage || gift.original_image_url;
                staticImage.alt = cd.model?.name || gift.gift_name;
                lottiePathForCard = cd.lottieModelPath;

                const labelDiv = document.createElement('div');
                labelDiv.className = 'top-right-label';
                labelDiv.textContent = `#${gift.collectible_number.toLocaleString()}`;
                card.appendChild(labelDiv);

                const bgDiv = document.createElement('div'); bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                else bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                card.appendChild(bgDiv);

                if (cd.patternImage) { const pOverlay = document.createElement('div'); pOverlay.className = 'gift-card-pattern-overlay'; pOverlay.style.backgroundImage = `url('${cd.patternImage}')`; card.appendChild(pOverlay); }
            } else {
                staticImage.src = gift.original_image_url; staticImage.alt = gift.gift_name;
                lottiePathForCard = gift.lottie_path;
            }
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
            staticImage.onerror = function() { this.style.display='none'; lottieContainer.innerHTML = '🖼️';};
            imageContainer.appendChild(lottieContainer); imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
            if (gift.is_pinned && !selectionModeActive) {
                const pinDiv = document.createElement('div'); pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG;
                pinDiv.querySelector('svg').style.transform = 'rotate(25deg)';
                card.appendChild(pinDiv);
            }

            if (selectionModeActive) {
                const checkbox = document.createElement('div');
                checkbox.className = 'selection-checkbox';
                card.appendChild(checkbox);
                if (selectedGiftIds.has(gift.instance_id)) {
                    card.classList.add('selected');
                }
                card.onclick = () => toggleGiftSelection(gift.instance_id);
            } else if (reorderModeActive) {
                card.style.cursor = gift.is_pinned ? 'grab' : 'default';
            } else {
                card.onclick = () => openGiftDetailByInstanceId(gift.instance_id);
                if (viewingOwnProfile) setupLongPress(card, gift);
            }

            return card;
        }

        function renderTopPinnedGiftsPreview() {
            Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => destroyLottieAnimation(childLottieContainer));
            profileTopPinnedGifts.innerHTML = '';

            const pinnedGifts = ownedGifts
                .filter(g => g.is_pinned && !g.is_hidden)
                .sort((a,b) => a.pin_order - b.pin_order);

            pinnedGifts.slice(0, 7).forEach(gift => {
                const container = document.createElement('div');
                container.className = 'pinned-gift-item';
                container.dataset.instanceId = gift.instance_id;
                container.addEventListener('click', () => openGiftDetailByInstanceId(gift.instance_id));
                let lottiePathForPinned = null, imageForPinned = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    lottiePathForPinned = gift.collectible_data.lottieModelPath;
                    imageForPinned = gift.collectible_data.modelImage || gift.original_image_url;
                } else if (gift.lottie_path) {
                    lottiePathForPinned = gift.lottie_path;
                }
                if (animationsEnabled && lottiePathForPinned) {
                    container.classList.add('lottie-animation-container');
                    playLottieAnimation(container, lottiePathForPinned, true);
                } else {
                     container.innerHTML = `<img src="${imageForPinned}" alt="${gift.gift_name}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.innerHTML = '🎁'">`;
                }
                profileTopPinnedGifts.appendChild(container);
            });
        }
        
        function renderGiftsTabPreview() {
            giftsTabPreviewContainer.innerHTML = '';
            const uniqueGiftTypes = new Set();
            const giftsToShow = [];
            
            for (const gift of currentlySortedGifts) {
                if (!uniqueGiftTypes.has(gift.gift_type_id)) {
                    uniqueGiftTypes.add(gift.gift_type_id);
                    giftsToShow.push(gift);
                }
                if (giftsToShow.length >= 3) break;
            }

            giftsToShow.forEach(gift => {
                const img = document.createElement('img');
                let imageUrl = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    imageUrl = gift.collectible_data.modelImage || gift.original_image_url;
                }
                img.src = imageUrl;
                img.alt = gift.gift_name;
                img.onerror = () => { img.style.display = 'none'; };
                giftsTabPreviewContainer.appendChild(img);
            });
        }
    </script>
</body>
</html>
