<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Симулятор Подарков Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-header-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;
            --tg-theme-border-color: #232d36;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: #2b3540;
            --app-rarity-chip-text: #a3b6c9;
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%; /* For fullscreen */
            overflow: hidden; /* For fullscreen */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
            display: flex; /* For fullscreen */
            flex-direction: column; /* For fullscreen */
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            flex-grow: 1; /* For fullscreen */
            display: flex;
            flex-direction: column;
            width: 100%; /* For fullscreen */
        }

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
            overflow: hidden; /* Prevent double scrollbars on page itself */
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 0 15px; /* Adjust padding slightly */
            background-color: var(--tg-theme-header-bg-color);
            /* border-bottom: 1px solid var(--tg-theme-border-color); */ /* Removed for flatter look */
            min-height: 56px;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .page-header .back-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 1.8em;
            margin-right: 15px;
            cursor: pointer;
            padding: 8px 0px 8px 8px; /* Hit area */
        }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }
        .page-header .menu-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 1.5em;
            margin-left: auto;
            cursor: pointer;
            padding: 8px;
        }


        /* Profile Page */
        .profile-header-area {
            background-color: var(--tg-theme-header-bg-color);
            padding: 15px;
            border-bottom: 1px solid var(--tg-theme-border-color);
            flex-shrink: 0;
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: flex-start;
            gap: 6px;
            margin-bottom: 8px;
            padding-left: 70px;
            min-height: 24px;
        }
        .profile-top-pinned-gifts img {
            width: 24px; height: 24px;
            border-radius: 6px; object-fit: contain;
            background-color: var(--tg-theme-secondary-bg-color);
        }

        .profile-main-info {
            display: flex; align-items: center; margin-bottom: 15px;
        }
        .profile-avatar {
            width: 60px; height: 60px;
            border-radius: 50%; background-color: var(--tg-theme-hint-color);
            margin-right: 15px; object-fit: cover;
            border: 2px solid var(--tg-theme-bg-color);
        }
        .profile-name-status h1 {
            font-size: 1.3em; font-weight: 600; margin-bottom: 2px;
        }
        .profile-name-status p {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }
        .profile-name-status p.online { color: var(--tg-theme-link-color); }
        
        .profile-details p {
            margin-bottom: 8px; font-size: 0.95em;
        }
        .profile-details p strong {
            display: block; color: var(--tg-theme-hint-color);
            font-weight: normal; font-size: 0.85em; margin-bottom: 2px;
        }
        .profile-details p span#profile-username { color: var(--tg-theme-link-color); }


        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-header-bg-color);
            padding: 0;
            border-bottom: 1px solid var(--tg-theme-border-color);
            flex-shrink: 0;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
        }
        .profile-tabs button.active {
            color: var(--tg-theme-link-color); font-weight: 500;
        }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: -1px; left: 0; right: 0; /* -1px to cover border */
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        
        .profile-gifts-actions {
            display: flex; justify-content: flex-end;
            align-items: center; padding: 12px 15px;
            background-color: var(--tg-theme-bg-color);
            flex-shrink: 0;
        }
        .profile-gifts-actions .buy-gifts-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        
        .gifts-grid-container { /* New wrapper for scroll */
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
            padding: 10px; /* Padding for the scrollable area */
        }
        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
            gap: 8px;
        }
        .no-gifts-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; /* Fill the grid container */
            color: var(--tg-theme-hint-color);
            text-align: center;
            font-size: 1.1em;
            padding: 20px;
        }
        .no-gifts-message span { font-size: 3em; margin-bottom: 15px; }


        .gift-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px; padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
        }
        .gift-card-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none;
        }
        .gift-card-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 25% auto;
            background-position: center;
            opacity: 0.1; pointer-events: none;
        }
        .gift-card img.gift-image {
            max-width: 75%; max-height: 75%;
            object-fit: contain; z-index: 1;
        }
        .gift-card .collectible-number-badge {
            position: absolute; top: 6px; right: 6px;
            background-color: rgba(0,0,0,0.3);
            color: var(--tg-theme-text-color);
            font-size: 0.7em; padding: 2px 6px;
            border-radius: 8px; z-index: 2; font-weight: 500;
        }
        .gift-card .pin-indicator {
            position: absolute; top: 6px; left: 6px;
            font-size: 1.1em; z-index: 2;
        }

        /* Buy Gifts Page */
        .buy-gift-item img { /* Slightly smaller */
            width: 60%; height: auto; max-height: 70px;
            object-fit: contain; margin-bottom: 10px;
        }
        .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; position: relative;
        }
        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }
        .buy-gift-item .gift-price .star-icon { color: #f5a623; margin-right: 3px;}
        .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.65em; padding: 3px 8px;
            border-radius: 10px; font-weight: 500;
        }

        /* Modals Generic */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active {
            opacity: 1; visibility: visible;
            transform: translateY(0%);
        }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 10px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 10px 20px 15px 20px; text-align: center;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }
        
        .modal-scrollable-content {
            overflow-y: auto; padding: 20px; flex-grow: 1;
        }
        .modal-buttons-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--tg-theme-border-color);
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }

        /* Gift Detail Modal (Non-Collectible) */
        #gift-detail-modal .modal-gift-image {
            width: 100px; height: 100px; object-fit: contain;
            margin: 0 auto 20px auto; display: block;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between;
            padding: 10px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        #gift-detail-modal .modal-info-table .info-row:last-child { border-bottom: none; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-hint-color); }

        /* Collectible Detail Modal Specific Styles */
        #collectible-detail-modal .modal-content { padding-top: 0; }
        #collectible-detail-modal .page-header {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }
        .collectible-display-area {
            background-color: var(--tg-theme-bg-color);
            padding: 20px; text-align: center;
        }
        .collectible-display-area h3 {
            font-size: 1.4em; font-weight: 600; margin-top: 10px;
        }
        .collectible-display-area p {
            font-size: 0.9em; color: var(--tg-theme-hint-color); margin-bottom: 20px;
        }
        .modal-collectible-visual {
            width: 70%; max-width: 280px;
            aspect-ratio: 1/1; margin: 0 auto;
            border-radius: 12px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-collectible-visual .collectible-bg-gradient {
            position: absolute; top:0;left:0;right:0;bottom:0; z-index: 1;
        }
        .modal-collectible-visual .collectible-pattern-tile {
            position: absolute; top:0;left:0;right:0;bottom:0;
            background-size: 20% auto;
            background-repeat: repeat; opacity: 0.12; z-index: 2;
        }
        .modal-collectible-visual .collectible-model-img {
            max-width: 80%; max-height: 80%;
            object-fit: contain; z-index: 3; position: relative;
        }
        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: var(--app-action-button-bg);
            color: var(--app-action-button-text);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { font-size: 1.3em; margin-bottom: 4px; }
        .collectible-info-section { padding: 0 20px; }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .collectible-info-section .info-row:last-child { border-bottom: none; }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value {
            color: var(--tg-theme-hint-color); display: flex; align-items: center;
        }
        .collectible-info-section .info-value img.owner-avatar {
            width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;
        }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 3px 8px; border-radius: 12px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        /* Quantity Input Modal */
        #quantity-modal .modal-scrollable-content { text-align: center; }
        #quantity-modal input[type="number"] {
            width: 80px; padding: 10px;
            font-size: 1.2em; text-align: center;
            border-radius: 8px; border: 1px solid var(--tg-theme-border-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color); margin: 10px 0 20px;
            -moz-appearance: textfield; /* Firefox */
        }
        #quantity-modal input[type="number"]::-webkit-outer-spin-button,
        #quantity-modal input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0; /* Chrome, Safari, Edge, Opera */
        }


        /* Long Press Menu */
        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; padding: 6px 0; min-width: 180px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li {
            padding: 10px 20px; cursor: pointer;
            color: var(--tg-theme-text-color); font-size: 0.95em;
        }
        #long-press-menu li:hover { background-color: var(--tg-theme-border-color); }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li.disabled:hover { background-color: transparent; }
        
        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Profile Page -->
        <div id="profile-page" class="page active">
            <div class="profile-header-area">
                <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                <div class="profile-main-info">
                    <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                    <div class="profile-name-status">
                        <h1 id="profile-name">Имя</h1>
                        <p id="profile-gift-count-subtext">0 подарков</p>
                        <p id="profile-status" class="online">в сети</p>
                    </div>
                </div>
                <div id="profile-details" class="profile-details">
                    <p><strong>Телефон</strong><span id="profile-phone"></span></p>
                    <p><strong>О себе</strong><span id="profile-bio"></span></p>
                    <p><strong>Имя пользователя</strong><span id="profile-username"></span></p>
                </div>
            </div>

            <div class="profile-tabs">
                <button>Публикации</button>
                <button>Архив</button>
                <button class="active" id="gifts-tab-button">Подарки</button>
            </div>
            
            <div class="profile-gifts-actions">
                <button id="go-to-buy-gifts" class="buy-gifts-button">🎁 Купить подарки</button>
            </div>

            <div id="gifts-grid-container" class="gifts-grid-container">
                <div id="gifts-grid" class="gifts-grid">
                    <div class="spinner hidden" id="gifts-loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Buy Gifts Page -->
        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <button id="back-to-profile-buy" class="back-button">←</button>
                <h2>Магазин подарков</h2>
            </div>
            <div id="buy-gifts-grid-container" class="gifts-grid-container">
                <div id="buy-gifts-grid" class="gifts-grid">
                    <div class="spinner" id="buy-gifts-loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="modal-gift-name">Название подарка</h3></div>
                <div class="modal-scrollable-content">
                    <img id="modal-gift-image" class="modal-gift-image" src="" alt="Подарок">
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="upgrade-gift-button" class="modal-button">Улучшить</button>
                    <button id="close-gift-detail-modal" class="modal-button secondary">ОК</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="page-header">
                    <button id="back-from-collectible-modal" class="back-button">←</button>
                    <h2 id="modal-collectible-header-title">Коллекционный</h2>
                    <button class="menu-button">⋮</button>
                </div>
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-collectible-bg" class="collectible-bg-gradient"></div>
                            <div id="modal-collectible-pattern" class="collectible-pattern-tile"></div>
                            <img id="modal-collectible-model-img" class="collectible-model-img" src="" alt="Модель">
                        </div>
                        <h3 id="modal-collectible-main-name">Название Модели</h3>
                        <p id="modal-collectible-number-subtext">Коллекционный #123</p>
                    </div>
                    <div id="modal-collectible-actions" class="modal-action-buttons-row">
                        <button><span class="icon">💎</span>Передать</button>
                        <button><span class="icon">👑</span>Надеть</button>
                        <button><span class="icon">💰</span>Продать</button>
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">Этот подарок виден в вашем профиле. <span class="link">Скрыть ></span></div>
                </div>
                 <div class="modal-buttons-footer"><button id="close-collectible-detail-modal" class="modal-button">ОК</button></div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Слишком много закреплённых подарков</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Выберите подарок для открепления. Можно закрепить до 6 коллекционных подарков.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;"></div>
                </div>
                 <div class="modal-buttons-footer"><button id="cancel-unpin-modal" class="modal-button secondary">Отмена</button></div>
            </div>
        </div>

        <div id="quantity-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="quantity-modal-title">Купить подарок</h3></div>
                <div class="modal-scrollable-content">
                    <p>Укажите количество:</p>
                    <input type="number" id="quantity-input" value="1" min="1" max="100">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-quantity-button" class="modal-button">Купить</button>
                    <button id="cancel-quantity-button" class="modal-button secondary">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div id="long-press-menu" class="hidden"><ul><li id="menu-pin-action">Закрепить</li></ul></div>

    <script>
        // Constants and Variables
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--tg-theme-link-color)" width="16px" height="16px" style="opacity:0.7;"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 2.99.71-.71L12 2z"/></svg>`;

        let allAvailableGifts = {}; // { typeId: name }
        let ownedGifts = []; // { typeId, instanceId, name, originalImage, isCollectible, collectibleData, acquiredDate }
        let pinnedGifts = []; // array of gift instanceIds
        const MAX_PINS = 6;
        let tg = window.Telegram.WebApp;

        // DOM Elements
        const profilePage = document.getElementById('profile-page');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');
        const giftsGridContainer = document.getElementById('gifts-grid-container');
        const giftsGrid = document.getElementById('gifts-grid');
        const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
        
        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const backToProfileBuyButton = document.getElementById('back-to-profile-buy');
        const buyGiftsGridContainer = document.getElementById('buy-gifts-grid-container');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');

        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalGiftImage = document.getElementById('modal-gift-image');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const upgradeGiftButton = document.getElementById('upgrade-gift-button');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');

        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const backFromCollectibleModal = document.getElementById('back-from-collectible-modal');
        const modalCollectibleHeaderTitle = document.getElementById('modal-collectible-header-title');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalCollectibleBg = document.getElementById('modal-collectible-bg');
        const modalCollectiblePattern = document.getElementById('modal-collectible-pattern');
        const modalCollectibleModelImg = document.getElementById('modal-collectible-model-img');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        
        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const quantityModal = document.getElementById('quantity-modal');
        const quantityModalTitle = document.getElementById('quantity-modal-title');
        const quantityInput = document.getElementById('quantity-input');
        const confirmQuantityButton = document.getElementById('confirm-quantity-button');
        const cancelQuantityButton = document.getElementById('cancel-quantity-button');
        let currentGiftToBuyMultiple = null;

        const longPressMenu = document.getElementById('long-press-menu');
        const menuPinAction = document.getElementById('menu-pin-action');
        
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');
        
        const russianFirstNames = ["Кызыр", "Иван", "Алексей", "Дмитрий", "Сергей", "Андрей", "Елена", "Ольга", "Мария", "Анна", "Павел", "Максим"];
        const russianLastNames = ["Миланов", "Петров", "Иванов", "Смирнов", "Кузнецов", "Попов", "Васильев", "Зайцева", "Соколова", "Лебедева", "Орлов", "Козлов"];
        const russianBios = [ "Люблю котиков и программирование.", "Ищу смысл жизни в CSS.", "Коллекционирую баги.", "Мечтаю о рефакторинге.", "JS ❤️ Frontend" ];
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateRandomPhoneNumber() { let num = '+7 (9'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); num += ') '; for (let i = 0; i < 3; i++) num += Math.floor(Math.random() * 10); num += '-'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); num += '-'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10); return num; }
        const mockUser = { first_name: getRandomElement(russianFirstNames), last_name: getRandomElement(russianLastNames), photo_url: `https://i.pravatar.cc/120?u=${Math.random()}`, bio: getRandomElement(russianBios), phone: generateRandomPhoneNumber() };
        mockUser.username = `${mockUser.first_name.toLowerCase().replace(' ', '')}${Math.floor(Math.random() * 1000)}`;

        function generateInstanceId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function initApp() {
            tg.ready();
            tg.expand();
            if (tg.setHeaderColor && tg.themeParams.secondary_bg_color) {
                 tg.setHeaderColor(tg.themeParams.secondary_bg_color);
            } else if (tg.setHeaderColor) {
                 tg.setHeaderColor('#17212b'); // Fallback color
            }
            if (tg.requestFullscreen) {
                tg.requestFullscreen();
            }

            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            
            loadUserData();
            loadState();
            renderProfileGifts();
            setupEventListeners();
            fetchAvailableGifts();
        }
        
        function applyTheme(themeParams) { /* ... same as before ... */ }
        function loadUserData() { /* ... same as before, bio from mock ... */ }
        function saveState() { localStorage.setItem('ownedGifts_v3', JSON.stringify(ownedGifts)); localStorage.setItem('pinnedGifts_v3', JSON.stringify(pinnedGifts)); }
        function loadState() { ownedGifts = JSON.parse(localStorage.getItem('ownedGifts_v3')) || []; pinnedGifts = JSON.parse(localStorage.getItem('pinnedGifts_v3')) || []; }
        function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        async function fetchAvailableGifts() { /* ... same as before ... */ }

        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            if (Object.keys(allAvailableGifts).length === 0 && !buyGiftsLoadingSpinner.classList.contains('hidden')) {
                 buyGiftsGrid.innerHTML = `<div class="no-gifts-message"><span>🎁</span><p>Сейчас нет доступных подарков для покупки.</p></div>`;
                 return;
            }
            for (const typeId in allAvailableGifts) {
                const name = allAvailableGifts[typeId];
                const originalImageUrl = `${CDN_BASE_URL}originals/${typeId}/Original.png`;
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.typeId = typeId; // Use typeId here
                item.dataset.name = name;
                item.innerHTML = `
                    <img src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.parentNode.replaceChild(createPlaceholderImage(), this);">
                    <div class="gift-name">${name}</div>
                    <div class="gift-price"><span class="star-icon">⭐</span> Бесплатно</div>
                    <div class="limited-label">Ограничено</div>
                `;
                item.addEventListener('click', () => buySingleGift(typeId, name, originalImageUrl));
                
                // Long press for quantity
                let buyPressTimer;
                item.addEventListener('touchstart', (e) => {
                    buyPressTimer = window.setTimeout(() => {
                        e.preventDefault(); 
                        openQuantityModal(typeId, name, originalImageUrl);
                    }, 700); 
                }, { passive: false });
                item.addEventListener('touchend', () => clearTimeout(buyPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyPressTimer));
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    openQuantityModal(typeId, name, originalImageUrl);
                });

                buyGiftsGrid.appendChild(item);
            }
        }
        
        function getGiftCountText(count) { /* ... same as before ... */ }

        function renderProfileGifts() {
            giftsGrid.innerHTML = ''; // Clear previous items
            profileGiftCountSubtext.textContent = getGiftCountText(ownedGifts.length);
            
            const sortedGifts = [...ownedGifts].sort((a, b) => {
                const aIsPinned = pinnedGifts.includes(a.instanceId);
                const bIsPinned = pinnedGifts.includes(b.instanceId);
                if (aIsPinned && !bIsPinned) return -1;
                if (!aIsPinned && bIsPinned) return 1;
                return (new Date(b.acquiredDate || 0)) - (new Date(a.acquiredDate || 0));
            });

            if (sortedGifts.length === 0) {
                giftsGrid.innerHTML = `<div class="no-gifts-message"><span>💔</span><p>У вас пока нет подарков.</p><p style="font-size:0.8em; margin-top:5px;">Время что-нибудь купить в магазине!</p></div>`;
            } else {
                sortedGifts.forEach(gift => {
                    const card = document.createElement('div');
                    card.className = 'gift-card';
                    card.dataset.instanceId = gift.instanceId; // Use instanceId for identifying the card

                    const giftImage = document.createElement('img');
                    giftImage.className = 'gift-image';
                    
                    if (gift.isCollectible && gift.collectibleData) {
                        const cd = gift.collectibleData;
                        giftImage.src = cd.modelImage || gift.originalImage;
                        giftImage.alt = cd.model?.name || gift.name;

                        const bgDiv = document.createElement('div');
                        bgDiv.className = 'gift-card-bg-pattern';
                        if (cd.backdropColors) bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                        else bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                        card.appendChild(bgDiv);

                        if (cd.patternImage) {
                            const patternOverlayDiv = document.createElement('div');
                            patternOverlayDiv.className = 'gift-card-pattern-overlay';
                            patternOverlayDiv.style.backgroundImage = `url('${cd.patternImage}')`;
                            card.appendChild(patternOverlayDiv);
                        }
                        
                        const numberDiv = document.createElement('div');
                        numberDiv.className = 'collectible-number-badge';
                        numberDiv.textContent = `#${cd.number}`;
                        card.appendChild(numberDiv);
                    } else {
                        giftImage.src = gift.originalImage;
                        giftImage.alt = gift.name;
                    }
                    
                    giftImage.onerror = function() { this.parentNode.replaceChild(createPlaceholderImage(true), this); };
                    card.appendChild(giftImage);

                    if (pinnedGifts.includes(gift.instanceId)) {
                        const pinDiv = document.createElement('div');
                        pinDiv.className = 'pin-indicator';
                        pinDiv.innerHTML = PIN_ICON_SVG; 
                        card.appendChild(pinDiv);
                    }

                    card.addEventListener('click', () => openGiftDetail(gift.instanceId));
                    setupLongPress(card, gift); // Pass the full gift object
                    giftsGrid.appendChild(card);
                });
            }
            renderTopPinnedGiftsPreview();
        }
        
        function createPlaceholderImage(isCardPlaceholder = false) { /* ... same as before ... */ }
        function renderTopPinnedGiftsPreview() { /* ... same as before, uses gift.instanceId implicitly via find ... */ }
        
        function addSingleGiftToInventory(typeId, name, originalImage) {
            const instanceId = generateInstanceId();
            ownedGifts.unshift({
                typeId, instanceId, name, originalImage,
                isCollectible: false, collectibleData: null,
                acquiredDate: new Date().toISOString()
            });
        }

        function buySingleGift(typeId, name, originalImage) {
            addSingleGiftToInventory(typeId, name, originalImage);
            saveState();
            renderProfileGifts();
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(`"${name}" (1 шт.) добавлен в ваши подарки!`);
            showPage('profile-page');
        }

        function buyMultipleGiftsConfirmed(quantity) {
            if (!currentGiftToBuyMultiple || quantity <= 0) return;
            const { typeId, name, originalImage } = currentGiftToBuyMultiple;
            for (let i = 0; i < quantity; i++) {
                addSingleGiftToInventory(typeId, name, originalImage);
            }
            saveState();
            renderProfileGifts();
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(`"${name}" (${quantity} шт.) добавлено в ваши подарки!`);
            showPage('profile-page');
            closeModal(quantityModal);
        }

        function openQuantityModal(typeId, name, originalImage) {
            currentGiftToBuyMultiple = { typeId, name, originalImage };
            quantityModalTitle.textContent = `Купить "${name}"`;
            quantityInput.value = 1;
            quantityModal.classList.add('active');
            quantityInput.focus();
        }


        function openGiftDetail(instanceId) {
            const gift = ownedGifts.find(g => g.instanceId === instanceId);
            if (!gift) return;
            // The rest of this function is largely the same, but uses gift.typeId where it previously used gift.id for CDN paths
            // And sets upgradeGiftButton.dataset.instanceId = gift.instanceId;

            if (gift.isCollectible && gift.collectibleData) {
                // ... (Collectible modal population, uses gift.name for display title, cd.model.name for model title)
                // ... (Use gift.typeId for fetching model/pattern/backdrop images if needed, but they are stored in cd)
                 const cd = gift.collectibleData;
                modalCollectibleHeaderTitle.textContent = gift.name;
                modalCollectibleMainName.textContent = cd.model?.name || gift.name;
                modalCollectibleNumberSubtext.textContent = `Коллекционный #${cd.number}`;
                
                modalCollectibleBg.style.background = `radial-gradient(circle, ${cd.backdropColors?.centerColor || '#555'}, ${cd.backdropColors?.edgeColor || '#333'})`;
                modalCollectiblePattern.style.backgroundImage = cd.patternImage ? `url('${cd.patternImage}')` : 'none';
                modalCollectibleModelImg.src = cd.modelImage || gift.originalImage;
                modalCollectibleModelImg.alt = cd.model?.name || gift.name;
                modalCollectibleModelImg.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${Math.random()}`; };

                const ownerName = document.getElementById('profile-name').textContent;
                const ownerAvatar = document.getElementById('profile-avatar').src;

                modalCollectibleInfoTable.innerHTML = `
                    <div class="info-row"><span class="info-label">Владелец</span><span class="info-value"><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</span></div>
                    <div class="info-row"><span class="info-label">Модель</span><span class="info-value">${cd.model?.name || 'N/A'} <span class="rarity-chip">${(cd.model?.rarityPermille || 0) / 10}%</span></span></div>
                    <div class="info-row"><span class="info-label">Фон</span><span class="info-value">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${(cd.backdrop?.rarityPermille || 0) / 10}%</span></span></div>
                    <div class="info-row"><span class="info-label">Символ</span><span class="info-value">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${(cd.pattern?.rarityPermille || 0) / 10}%</span></span></div>
                    <div class="info-row"><span class="info-label">Количество</span><span class="info-value">#${cd.number} (Уникальный экземпляр)</span></div>`;
                collectibleDetailModal.classList.add('active');
            } else {
                modalGiftName.textContent = gift.name;
                modalGiftImage.src = gift.originalImage;
                // ... (Non-collectible modal population)
                modalGiftInfo.innerHTML = `
                    <div class="info-row"><span class="info-label">Дата получения</span><span class="info-value">${new Date(gift.acquiredDate).toLocaleDateString('ru-RU')}</span></div>
                    <div class="info-row"><span class="info-label">Стоимость</span><span class="info-value"><span class="star-icon">⭐</span> Бесплатно</span></div>
                    <div class="info-row"><span class="info-label">Доступность</span><span class="info-value">Ограничено</span></div>
                    <div class="info-row"><span class="info-label">Уникальность</span><span class="info-value" id="modal-uniqueness-value">Стандартный</span></div>`;
                upgradeGiftButton.dataset.instanceId = gift.instanceId; // Important: use instanceId
                upgradeGiftButton.disabled = false;
                upgradeGiftButton.textContent = 'Улучшить';
                giftDetailModal.classList.add('active');
            }
        }
        
        async function handleUpgradeGift(instanceId) { // Takes instanceId
            const giftIndex = ownedGifts.findIndex(g => g.instanceId === instanceId);
            if (giftIndex === -1) return;
            const gift = ownedGifts[giftIndex];

            if (!gift || gift.isCollectible) return;

            upgradeGiftButton.textContent = 'Улучшение...';
            upgradeGiftButton.disabled = true;

            try {
                // Use gift.name for display and gift.typeId for fetching CDN data
                const giftNameForCDN = allAvailableGifts[gift.typeId] || gift.name; // Get canonical name for CDN
                const giftNameEncoded = encodeURIComponent(giftNameForCDN);

                const [modelsData, backdropsData, patternsData] = await Promise.all([
                    fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`).then(res => res.ok ? res.json() : Promise.reject(new Error(`Модели для ${gift.name} не найдены.`))),
                    // ... (fetch backdrops and patterns)
                     fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`).then(res => res.ok ? res.json() : Promise.reject(new Error(`Фоны для ${gift.name} не найдены.`))),
                    fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`).then(res => res.ok ? res.json() : Promise.reject(new Error(`Символы для ${gift.name} не найдены.`)))
                ]);
                // ... (rest of upgrade logic is same, updates ownedGifts[giftIndex])
                 if (!modelsData?.length || !backdropsData?.length || !patternsData?.length) {
                    throw new Error("Отсутствуют необходимые данные для улучшения (модели, фоны или символы).");
                }

                const selectedModel = selectWeightedRandom(modelsData);
                const selectedBackdrop = selectWeightedRandom(backdropsData);
                const selectedPattern = selectWeightedRandom(patternsData);
                const randomNumber = Math.floor(Math.random() * 2000) + 1;

                ownedGifts[giftIndex].isCollectible = true;
                ownedGifts[giftIndex].collectibleData = {
                    model: selectedModel, backdrop: selectedBackdrop, pattern: selectedPattern,
                    number: randomNumber,
                    modelImage: `${CDN_BASE_URL}models/${giftNameEncoded}/png/${encodeURIComponent(selectedModel.name)}.png`,
                    patternImage: `${CDN_BASE_URL}patterns/${giftNameEncoded}/png/${encodeURIComponent(selectedPattern.name)}.png`,
                    backdropColors: selectedBackdrop.hex,
                };
                
                document.getElementById('modal-uniqueness-value').textContent = `Коллекционный #${randomNumber}`;
                saveState();
                renderProfileGifts();
                tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => {
                    closeModal(giftDetailModal);
                    openGiftDetail(gift.instanceId); 
                }, 1200);


            } catch (error) { /* ... same error handling ... */ }
        }

        function selectWeightedRandom(items) { /* ... same as before ... */ }
        function closeModal(modalElement) { modalElement.classList.remove('active'); }

        // --- Pinning Logic ---
        let currentLongPressGift = null; // This will hold the full gift object
        let longPressTimer;

        function setupLongPress(element, giftObject) { // Pass full gift object
            element.addEventListener('touchstart', (e) => {
                longPressTimer = window.setTimeout(() => {
                    if(e.touches.length === 1) { // Ensure it's not a multi-touch gesture
                        openLongPressMenu(giftObject, e.touches[0]);
                    }
                }, 500);
            }, { passive: true }); // passive true if not calling preventDefault

            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                openLongPressMenu(giftObject, e);
            });
        }
        
        function openLongPressMenu(gift, eventCoords) { // gift is the full object
            currentLongPressGift = gift; // Store the full gift object
            menuPinAction.classList.remove('disabled');

            if (!gift.isCollectible) {
                menuPinAction.textContent = 'Закрепить (только коллекционные)';
                menuPinAction.classList.add('disabled');
            } else {
                const isPinned = pinnedGifts.includes(gift.instanceId);
                menuPinAction.textContent = isPinned ? 'Открепить' : 'Закрепить';
            }
            
            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }
        
        function closeLongPressMenuOnClickOutside(event) { /* ... same ... */ }

        function handlePinAction() {
            if (!currentLongPressGift || !currentLongPressGift.isCollectible || menuPinAction.classList.contains('disabled')) {
                longPressMenu.classList.add('hidden');
                return;
            }
            
            const giftInstanceId = currentLongPressGift.instanceId;
            const isPinned = pinnedGifts.includes(giftInstanceId);

            if (isPinned) {
                pinnedGifts = pinnedGifts.filter(id => id !== giftInstanceId);
            } else {
                if (pinnedGifts.length >= MAX_PINS) {
                    showTooManyPinsModal();
                    longPressMenu.classList.add('hidden');
                    return;
                }
                pinnedGifts.push(giftInstanceId);
            }
            saveState();
            renderProfileGifts();
            longPressMenu.classList.add('hidden');
            tg.HapticFeedback.impactOccurred(isPinned ? 'light' : 'medium');
        }
        
        function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';
            const collectiblePinnedGifts = pinnedGifts
                .map(pid => ownedGifts.find(g => g.instanceId === pid && g.isCollectible))
                .filter(Boolean);

            collectiblePinnedGifts.forEach(giftToUnpin => {
                const card = document.createElement('div');
                card.className = 'gift-card';
                const img = document.createElement('img');
                img.className = 'gift-image';
                img.src = giftToUnpin.collectibleData.modelImage || giftToUnpin.originalImage;
                img.alt = giftToUnpin.name;
                img.onerror = function() { this.parentNode.replaceChild(createPlaceholderImage(true), this); };
                card.appendChild(img);
                card.addEventListener('click', () => {
                    pinnedGifts = pinnedGifts.filter(id => id !== giftToUnpin.instanceId);
                    if (currentLongPressGift && currentLongPressGift.isCollectible && !pinnedGifts.includes(currentLongPressGift.instanceId) && pinnedGifts.length < MAX_PINS) {
                         pinnedGifts.push(currentLongPressGift.instanceId);
                    }
                    saveState();
                    renderProfileGifts();
                    closeModal(tooManyPinsModal);
                    tg.HapticFeedback.impactOccurred('medium');
                });
                unpinSelectionGrid.appendChild(card);
            });
            tooManyPinsModal.classList.add('active');
        }

        // Event Listeners Setup
        function setupEventListeners() {
            goToBuyGiftsButton.addEventListener('click', () => showPage('buy-gifts-page'));
            backToProfileBuyButton.addEventListener('click', () => showPage('profile-page'));

            closeGiftDetailModalButton.addEventListener('click', () => closeModal(giftDetailModal));
            upgradeGiftButton.addEventListener('click', (e) => handleUpgradeGift(e.target.dataset.instanceId));
            
            backFromCollectibleModal.addEventListener('click', () => closeModal(collectibleDetailModal));
            closeCollectibleDetailModalButton.addEventListener('click', () => closeModal(collectibleDetailModal));
            
            menuPinAction.addEventListener('click', handlePinAction);
            cancelUnpinModal.addEventListener('click', () => closeModal(tooManyPinsModal));

            confirmQuantityButton.addEventListener('click', () => {
                const quantity = parseInt(quantityInput.value, 10);
                if (quantity > 0) buyMultipleGiftsConfirmed(quantity);
            });
            cancelQuantityButton.addEventListener('click', () => closeModal(quantityModal));

            [giftDetailModal, collectibleDetailModal, tooManyPinsModal, quantityModal].forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
            });
            giftsGridContainer.addEventListener('scroll', () => { if(!longPressMenu.classList.contains('hidden')) longPressMenu.classList.add('hidden'); });
            buyGiftsGridContainer.addEventListener('scroll', () => { if(!longPressMenu.classList.contains('hidden')) longPressMenu.classList.add('hidden'); });
        }
        
        // Auto Init
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
            initApp();
        } else {
            console.warn("Telegram WebApp не найден. Используются мок-данные и тема по умолчанию.");
            document.addEventListener('DOMContentLoaded', () => {
                 tg.initDataUnsafe = { user: mockUser };
                 tg.themeParams = {}; 
                 tg.showAlert = (message) => alert(message);
                 tg.HapticFeedback = { impactOccurred: (s) => console.log(`Тактильный: ${s}`), notificationOccurred: (t) => console.log(`Уведомление: ${t}`), };
                 tg.ready = ()=>{}; tg.expand = ()=>{}; tg.onEvent = ()=>{};
                 tg.setHeaderColor = (c) => console.log(`Set header color: ${c}`);
                 tg.requestFullscreen = () => console.log('Request fullscreen');
                 initApp();
            });
        }
    </script>
</body>
</html>
