<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Симулятор Подарков Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-header-bg-color: #17212b; /* Adjusted for profile header based on screenshots */
            --tg-theme-accent-blue: #5288c1; /* Used for "Upgrade All" button and other accents */
            --tg-theme-border-color: #232d36; /* Subtle border */

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: #2b3540; /* Darker chip bg */
            --app-rarity-chip-text: #a3b6c9; /* Lighter chip text */
            --app-action-button-bg: #232e3a; /* For modal secondary buttons */
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-header-bg-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color); /* Matches screenshot header */
            border-bottom: 1px solid var(--tg-theme-border-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        .page-header .back-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            padding: 5px; margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
        }
        .page-header .back-button svg { width: 24px; height: 24px; fill: currentColor; }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }
        .page-header .menu-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 1.8em; /* Adjusted for typical three-dot icon size */
            margin-left: auto;
            cursor: pointer;
            padding: 5px;
        }

        /* Profile Page */
        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .profile-header-area {
            background-color: var(--tg-theme-header-bg-color); /* Matches screenshots */
            padding: 0 15px; /* Removed top/bottom padding to integrate with main-info */
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: flex-start;
            gap: 6px;
            padding: 10px 0 8px 0; /* Padding around pinned gifts */
            min-height: 24px;
        }
        .profile-top-pinned-gifts img {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            object-fit: contain;
            background-color: var(--tg-theme-secondary-bg-color);
        }

        .profile-main-info {
            display: flex;
            align-items: center;
            padding: 12px 0; /* Padding for the main block */
            background: var(--app-profile-gradient-fallback); /* Fallback, dynamic gradient here */
            transition: background 0.3s ease;
        }
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid var(--tg-theme-header-bg-color); /* Border color same as header for seamless look */
        }
        .profile-name-status { display: flex; flex-direction: column; }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon {
            width: 22px; height: 22px; margin-left: 8px; object-fit: contain;
        }
        .profile-name-status p { font-size: 0.9em; color: var(--tg-theme-hint-color); margin-top: 2px; }
        .profile-name-status p.online { color: var(--tg-theme-link-color); }
        
        .profile-details { /* Info block */
            padding: 15px 0; /* Vertical padding for info block */
            background-color: var(--tg-theme-header-bg-color);
        }
        .profile-details p {
            margin-bottom: 10px; font-size: 0.95em;
        }
        .profile-details p:last-child { margin-bottom: 0; }
        .profile-details p strong { /* Label like "Mobile", "Bio" */
            display: block; color: var(--tg-theme-hint-color);
            font-weight: normal; font-size: 0.85em; margin-bottom: 3px;
        }
        .profile-details p span { color: var(--tg-theme-text-color); } /* Value */
        .profile-details p span#profile-username { color: var(--tg-theme-link-color); }

        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-header-bg-color); /* Match header */
            padding: 0;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500; /* Bolder tabs like screenshots */
        }
        .profile-tabs button.active {
            color: var(--tg-theme-link-color);
        }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: -1px; /* Align with border-bottom */
            left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        
        .profile-gifts-actions {
            display: flex; justify-content: flex-end;
            align-items: center; padding: 12px 15px;
            background-color: var(--tg-theme-bg-color); /* Main app bg */
        }
        .profile-gifts-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        #upgrade-all-gifts-button {
            background-color: var(--tg-theme-accent-blue);
            margin-right: 10px;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Adjusted for screenshot look */
            gap: 5px; /* Smaller gap */
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%; 
        }

        .gift-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
        }
        .gift-card-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none; z-index: 0;
        }
        .gift-card-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto; /* Slightly larger pattern */
            background-position: center;
            opacity: 0.1; /* Subtler pattern */
            pointer-events: none; z-index: 1;
        }
        .gift-card img.gift-image {
            max-width: 70%; max-height: 70%; /* Adjusted size */
            object-fit: contain; z-index: 2;
        }
        .gift-card .collectible-number-badge { /* For #JK style numbers */
            position: absolute; top: 5px; right: 5px;
            background-color: rgba(0,0,0,0.35);
            color: var(--tg-theme-text-color);
            font-size: 0.65em; padding: 2px 5px;
            border-radius: 8px; z-index: 3; font-weight: 500;
        }
        .gift-card .gift-rarity-badge { /* For "1 of X.XK" */
            position: absolute; bottom: 5px; left:0; right: 0;
            text-align: center;
            background-color: rgba(0,0,0,0.25);
            color: var(--tg-theme-text-color);
            font-size: 0.6em; padding: 2px 0;
            z-index: 3; font-weight: 400;
        }
        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg { width: 18px; height: 18px; fill: var(--tg-theme-link-color); opacity: 0.8; }


        /* Buy Gifts Page */
        .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; position: relative; aspect-ratio: 1/1.1; /* To make them slightly taller */
        }
        .buy-gift-item img {
            width: 65%; /* Slightly larger image */
            max-height: 60px; /* Constrain height */
            object-fit: contain; margin-bottom: 8px;
        }
        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }
        .buy-gift-item .gift-price .star-icon { color: #f5a623; margin-right: 3px;}
        .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px; /* Smaller label */
            border-radius: 8px; font-weight: 500;
        }

        /* Modals Generic */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end; /* Modals slide from bottom */
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active {
            opacity: 1; visibility: visible;
            transform: translateY(0%);
        }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0; /* Header bar will have its own padding */
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        /* Modal Header Bar (common for non-collectible) */
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            border-bottom: 1px solid var(--tg-theme-border-color);
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }
        
        .modal-scrollable-content {
            overflow-y: auto; padding: 15px 20px; flex-grow: 1;
        }
        .modal-buttons-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--tg-theme-border-color);
            background-color: var(--tg-theme-secondary-bg-color); /* Match modal bg */
            position: sticky; bottom: 0; z-index: 1;
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }

        /* Gift Detail Modal (Non-Collectible) - "Saved Gift" style */
        #gift-detail-modal .modal-gift-image {
            width: 120px; height: 120px; object-fit: contain; /* Larger image */
            margin: 10px auto 15px auto; display: block;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        #gift-detail-modal .modal-info-table .info-row:last-child { border-bottom: none; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); } /* Darker labels based on screenshot */
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }

        #gift-detail-modal .info-value-with-action {
            display: flex; align-items: center;
        }
        #gift-detail-modal .info-value-with-action span { margin-right: 10px; color: var(--tg-theme-hint-color); }
        #gift-detail-modal .button-link-styled { /* For "Улучшить" */
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 0.95em; font-weight: 500;
            padding: 5px; cursor: pointer;
        }
        #gift-detail-modal .button-link-styled:disabled { color: var(--tg-theme-hint-color); }


        /* Collectible Detail Modal Specific Styles */
        #collectible-detail-modal .modal-content {
             padding-top: 0; /* page-header handles top */
        }
        #collectible-detail-modal .page-header { /* This is the modal's header */
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: var(--tg-theme-secondary-bg-color); /* Match modal bg */
        }
        #collectible-detail-modal .modal-scrollable-content {
            padding: 0; /* Content sections will have their own padding */
        }
        .collectible-display-area {
            background-color: var(--tg-theme-bg-color); /* Matches profile grid bg */
            padding: 20px; text-align: center;
        }
        .collectible-display-area h3 { /* Snake Box etc. */
            font-size: 1.4em; font-weight: 600; margin-top: 15px; /* More space for image */
            color: var(--tg-theme-text-color);
        }
        .collectible-display-area p { /* Collectible #xxx */
            font-size: 0.95em; color: var(--tg-theme-hint-color); margin-bottom: 10px; /* Reduced bottom margin */
        }
        .modal-collectible-visual {
            width: 60%; max-width: 220px; /* Adjusted size */
            aspect-ratio: 1/1; margin: 0 auto;
            border-radius: 12px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-collectible-visual .collectible-bg-gradient {
            position: absolute; top:0;left:0;right:0;bottom:0; z-index: 1;
        }
        .modal-collectible-visual .collectible-pattern-tile {
            position: absolute; top:0;left:0;right:0;bottom:0;
            background-size: 25% auto; 
            background-repeat: repeat; opacity: 0.15; 
            z-index: 2;
        }
        .modal-collectible-visual .collectible-model-img {
            max-width: 80%; max-height: 80%;
            object-fit: contain; z-index: 3; position: relative;
        }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 15px 20px; /* Normal padding */
            background-color: var(--tg-theme-bg-color); /* Match display area bg */
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: var(--app-action-button-bg); /* Darker buttons */
            color: var(--tg-theme-text-color); /* Brighter text on dark buttons */
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }


        .collectible-info-section { padding: 0 20px; background-color: var(--tg-theme-secondary-bg-color); }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .collectible-info-section .info-row:last-child { border-bottom: none; }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value {
            color: var(--tg-theme-hint-color); display: flex; align-items: center;
        }
        .collectible-info-section .info-value img.owner-avatar {
            width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;
        }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px; /* Adjusted padding */
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        
        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color); /* Match display area bg */
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        /* Long Press Menu */
        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; padding: 6px 0; min-width: 180px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li {
            padding: 10px 20px; cursor: pointer;
            color: var(--tg-theme-text-color); font-size: 0.95em;
        }
        #long-press-menu li.disabled {
            color: var(--tg-theme-hint-color);
            cursor: default;
        }
        #long-press-menu li:not(.disabled):hover { background-color: var(--tg-theme-border-color); }
        
        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px; 
            background-color: var(--tg-theme-bg-color); 
            color: var(--tg-theme-text-color); 
            border: 1px solid var(--tg-theme-border-color); 
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number] { -moz-appearance: textfield; }

        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Profile Page -->
        <div id="profile-page" class="page active">
            <div class="profile-page-content">
                <div class="profile-header-area">
                    <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                    <div id="profile-main-info" class="profile-main-info">
                        <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                        <div class="profile-name-status">
                            <div class="name-line">
                                <h1 id="profile-name">Имя</h1>
                                <img id="worn-gift-icon" class="hidden" src="" alt="Worn Gift">
                            </div>
                            <p id="profile-gift-count-subtext">0 подарков</p>
                            <p id="profile-status" class="online">в сети</p>
                        </div>
                    </div>
                    <div id="profile-details" class="profile-details">
                        <p><strong>Телефон</strong><span id="profile-phone"></span></p>
                        <p><strong>О себе</strong><span id="profile-bio"></span></p>
                        <p><strong>Имя пользователя</strong><span id="profile-username"></span></p>
                    </div>
                </div>

                <div class="profile-tabs">
                    <button>Публикации</button>
                    <button>Архив</button>
                    <button class="active" id="gifts-tab-button">Подарки</button>
                </div>
                
                <div class="profile-gifts-actions">
                    <button id="upgrade-all-gifts-button" class="action-button" style="display: none;">✨ Улучшить все</button>
                    <button id="go-to-buy-gifts" class="action-button">🎁 Купить подарки</button>
                </div>

                <div id="gifts-grid" class="gifts-grid">
                    <div class="spinner hidden" id="gifts-loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Buy Gifts Page -->
        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <button id="back-to-profile-buy" class="back-button"></button>
                <h2>Магазин подарков</h2>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <!-- Modals -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Название подарка</h3>
                </div>
                <div class="modal-scrollable-content">
                    <img id="modal-gift-image" class="modal-gift-image" src="" alt="Подарок">
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table">
                        <!-- Info rows populated by JS -->
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-gift-detail-modal" class="modal-button">ОК</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="page-header"> <!-- Reusing page-header style for modal header -->
                    <button id="back-from-collectible-modal" class="back-button"></button>
                    <h2 id="modal-collectible-header-title">Коллекционный</h2>
                    <button class="menu-button">⋮</button>
                </div>
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-collectible-bg" class="collectible-bg-gradient"></div>
                            <div id="modal-collectible-pattern" class="collectible-pattern-tile"></div>
                            <img id="modal-collectible-model-img" class="collectible-model-img" src="" alt="Модель">
                        </div>
                        <h3 id="modal-collectible-main-name">Название Модели</h3>
                        <p id="modal-collectible-number-subtext">Коллекционный #123</p>
                    </div>

                    <div id="modal-collectible-actions" class="modal-action-buttons-row">
                        <button id="collectible-action-transfer"><span class="icon"></span><span class="text">Передать</span></button>
                        <button id="collectible-action-wear"><span class="icon"></span><span class="text">Надеть</span></button>
                        <button id="collectible-action-sell"><span class="icon"></span><span class="text">Продать</span></button>
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table">
                            <!-- Info rows: Owner, Model, Backdrop, Symbol, Quantity -->
                        </div>
                    </div>
                    <div class="modal-footer-message">
                        Этот подарок виден в вашем профиле. <span class="link">Скрыть ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">ОК</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Слишком много закреплённых подарков</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Выберите подарок для открепления. Можно закрепить до 6 коллекционных подарков.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">Отмена</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Купить подарок</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">Количество:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Купить</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-pin-action">Закрепить</li>
        </ul>
    </div>

    <script>
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;

        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const BACK_ARROW_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>arrow-left-bold-outline</title><path d="M13,22L3,12L13,2V8H21V16H13V22M6,12L11,17V14H19V10H11V7L6,12Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M15,4H17L19,7H16M11,4H13L14,7H10M7,4H9L8,7H5M6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        
        let allAvailableGifts = {};
        let ownedGifts = []; 
        let pinnedGifts = []; 
        let wornGiftInstanceId = null;
        const MAX_PINS = 6;
        let tg = window.Telegram.WebApp;

        // DOM Elements
        const profilePage = document.getElementById('profile-page');
        const profileMainInfo = document.getElementById('profile-main-info');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const wornGiftIcon = document.getElementById('worn-gift-icon');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');
        const giftsGrid = document.getElementById('gifts-grid');
        const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        
        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const backToProfileBuyButton = document.getElementById('back-to-profile-buy');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');

        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalGiftImage = document.getElementById('modal-gift-image');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        // const upgradeGiftButton = document.getElementById('upgrade-gift-button'); // This will be the inline one
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');

        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const backFromCollectibleModal = document.getElementById('back-from-collectible-modal');
        const modalCollectibleHeaderTitle = document.getElementById('modal-collectible-header-title');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalCollectibleBg = document.getElementById('modal-collectible-bg');
        const modalCollectiblePattern = document.getElementById('modal-collectible-pattern');
        const modalCollectibleModelImg = document.getElementById('modal-collectible-model-img');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        
        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');
        let currentGiftToBuyMultiple = null;

        const longPressMenu = document.getElementById('long-press-menu');
        const menuPinAction = document.getElementById('menu-pin-action');
        
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');
        
        const russianFirstNames = ["Кызыр", "Иван", "Алексей", "Дмитрий", "Сергей", "Андрей", "Елена", "Ольга", "Мария", "Анна", "Павел", "Максим"];
        const russianLastNames = ["Миланов", "Петров", "Иванов", "Смирнов", "Кузнецов", "Попов", "Васильев", "Зайцева", "Соколова", "Лебедева", "Орлов", "Козлов"];
        const russianBios = [
            "Люблю путешествовать и открывать новое.", "Просто хороший человек.", "Ищу вдохновение в каждом дне.",
            "Кофеман и книголюб.", "Никогда не сдавайся!", "Мечты сбываются, если в них верить.", "Всё только начинается."
        ];

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateRandomPhoneNumber() {
            let num = '+7 (9';
            for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10);
            num += ') ';
            for (let i = 0; i < 3; i++) num += Math.floor(Math.random() * 10);
            num += '-'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10);
            num += '-'; for (let i = 0; i < 2; i++) num += Math.floor(Math.random() * 10);
            return num;
        }
        function generateUniqueId() {
            return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`;
        }

        const mockUser = {
            first_name: getRandomElement(russianFirstNames),
            last_name: getRandomElement(russianLastNames),
            photo_url: `https://i.pravatar.cc/120?u=${generateUniqueId()}`,
            bio: getRandomElement(russianBios),
            phone: generateRandomPhoneNumber()
        };
        mockUser.username = `${mockUser.first_name.toLowerCase().replace(' ', '')}${Math.floor(Math.random() * 1000)}`;

        function initApp() {
            tg.ready();
            tg.expand();
            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            
            // Set SVG for back buttons
            backToProfileBuyButton.innerHTML = BACK_ARROW_SVG;
            backFromCollectibleModal.innerHTML = BACK_ARROW_SVG;
            
            // Set SVG for collectible action buttons
            collectibleActionTransfer.querySelector('.icon').innerHTML = DIAMOND_SVG;
            collectibleActionWear.querySelector('.icon').innerHTML = CROWN_SVG;
            collectibleActionSell.querySelector('.icon').innerHTML = LABEL_SVG;

            loadUserData();
            loadState(); // Includes wornGiftInstanceId
            applyWornGiftStyles(wornGiftInstanceId);
            renderProfileGifts();
            setupEventListeners();
            fetchAvailableGifts();
        }
        
        function applyTheme(themeParams) {
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-header-bg-color', themeParams.secondary_bg_color || themeParams.bg_color); 
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1');
                setVar('--tg-theme-border-color', themeParams.section_header_text_color || '#232d36'); // Example, or find suitable TG key

                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                
                if (upgradeAllGiftsButton) {
                    upgradeAllGiftsButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                }
                 applyWornGiftStyles(wornGiftInstanceId); // Re-apply if theme affects fallback
            } else {
                console.log("Using default CSS variables as themeParams are empty.");
            }
        }

        function loadUserData() {
            const user = tg.initDataUnsafe?.user || mockUser;
            profileName.textContent = user.first_name || mockUser.first_name;
            if (user.photo_url) {
                profileAvatar.src = user.photo_url;
            } else {
                profileAvatar.src = mockUser.photo_url;
            }
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/120?u=fallback${generateUniqueId()}`; };

            profileUsername.textContent = user.username ? `@${user.username}` : `@${mockUser.username}`;
            profileBio.textContent = user.bio || mockUser.bio; 
            profilePhone.textContent = user.phone || mockUser.phone; 
        }

        function saveState() {
            localStorage.setItem('ownedGifts_v4', JSON.stringify(ownedGifts));
            localStorage.setItem('pinnedGifts_v4', JSON.stringify(pinnedGifts));
            localStorage.setItem('wornGiftInstanceId_v4', wornGiftInstanceId);
        }
        function loadState() {
            const loadedOwnedGifts = JSON.parse(localStorage.getItem('ownedGifts_v4')) || [];
            ownedGifts = loadedOwnedGifts.map(gift => ({
                ...gift,
                instanceId: gift.instanceId || generateUniqueId() 
            }));
            pinnedGifts = JSON.parse(localStorage.getItem('pinnedGifts_v4')) || [];
            wornGiftInstanceId = localStorage.getItem('wornGiftInstanceId_v4') || null;
        }
        
        function applyWornGiftStyles(instanceId) {
            const currentWornGift = ownedGifts.find(g => g.instanceId === instanceId && g.isCollectible);
            if (currentWornGift && currentWornGift.collectibleData) {
                wornGiftIcon.src = currentWornGift.collectibleData.modelImage;
                wornGiftIcon.classList.remove('hidden');
                const colors = currentWornGift.collectibleData.backdropColors;
                if (colors) {
                    profileMainInfo.style.background = `radial-gradient(circle, ${colors.centerColor}, ${colors.edgeColor})`;
                } else {
                     profileMainInfo.style.background = 'var(--app-profile-gradient-fallback)';
                }
            } else {
                wornGiftIcon.classList.add('hidden');
                wornGiftIcon.src = '';
                profileMainInfo.style.background = 'var(--app-profile-gradient-fallback)';
            }
        }


        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        async function fetchAvailableGifts() {
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allAvailableGifts = await response.json();
                renderAvailableGifts();
            } catch (error) {
                console.error("Не удалось загрузить доступные подарки:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Не удалось загрузить подарки. Попробуйте позже.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }
        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            if (Object.keys(allAvailableGifts).length === 0 && !buyGiftsLoadingSpinner.classList.contains('hidden')) {
                 buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Сейчас нет доступных подарков.</p>`;
                 return;
            }
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id;
                item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;

                item.innerHTML = `
                    <img src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.parentNode.replaceChild(createPlaceholderImage(), this);">
                    <div class="gift-name">${name}</div>
                    <div class="gift-price"><span class="star-icon">⭐</span> Бесплатно</div>
                    <div class="limited-label">Ограничено</div>
                `;
                item.addEventListener('click', () => {
                     buyGift(id, name, originalImageUrl, 1);
                });
                
                let buyItemLongPressTimer;
                item.addEventListener('touchstart', (e) => {
                    buyItemLongPressTimer = window.setTimeout(() => {
                        openBuyMultipleModal(id, name, originalImageUrl);
                    }, 700); 
                }, { passive: true });
                item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('contextmenu', (e) => { 
                    e.preventDefault();
                    openBuyMultipleModal(id, name, originalImageUrl);
                });

                buyGiftsGrid.appendChild(item);
            }
        }
        
        function getGiftCountText(count) {
            if (count % 10 === 1 && count % 100 !== 11) return `${count} подарок`;
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return `${count} подарка`;
            return `${count} подарков`;
        }

        function renderProfileGifts() {
            giftsGrid.innerHTML = '';
            profileGiftCountSubtext.textContent = getGiftCountText(ownedGifts.length);
            
            const sortedGifts = [...ownedGifts].sort((a, b) => {
                const aIsPinned = pinnedGifts.includes(a.instanceId);
                const bIsPinned = pinnedGifts.includes(b.instanceId);
                if (aIsPinned && !bIsPinned) return -1;
                if (!aIsPinned && bIsPinned) return 1;
                return (new Date(b.acquiredDate || 0)) - (new Date(a.acquiredDate || 0));
            });

            if (sortedGifts.length === 0) {
                giftsGrid.style.display = 'flex';
                giftsGrid.style.alignItems = 'center';
                giftsGrid.style.justifyContent = 'center';
                giftsGrid.innerHTML = `<p class="empty-grid-message">У вас пока нет подарков. Время что-нибудь купить!</p>`;
            } else {
                giftsGrid.style.display = 'grid'; 
                sortedGifts.forEach(gift => giftsGrid.appendChild(createGiftCardDOM(gift)));
            }
            renderTopPinnedGiftsPreview();

            const hasNonCollectible = ownedGifts.some(g => !g.isCollectible);
            if (upgradeAllGiftsButton) {
                upgradeAllGiftsButton.style.display = hasNonCollectible ? 'inline-block' : 'none';
                if (!hasNonCollectible) {
                     upgradeAllGiftsButton.textContent = '✨ Улучшить все';
                     upgradeAllGiftsButton.disabled = false;
                }
            }
        }

        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instanceId;

            const giftImage = document.createElement('img');
            giftImage.className = 'gift-image';
            
            if (gift.isCollectible && gift.collectibleData) {
                const cd = gift.collectibleData;
                giftImage.src = cd.modelImage || gift.originalImage;
                giftImage.alt = cd.model?.name || gift.name;

                const bgDiv = document.createElement('div');
                bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) {
                     bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                } else {
                    bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                }
                card.appendChild(bgDiv);

                if (cd.patternImage) {
                    const patternOverlayDiv = document.createElement('div');
                    patternOverlayDiv.className = 'gift-card-pattern-overlay';
                    patternOverlayDiv.style.backgroundImage = `url('${cd.patternImage}')`;
                    card.appendChild(patternOverlayDiv);
                }
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'collectible-number-badge';
                numberDiv.textContent = `#${cd.number}`;
                card.appendChild(numberDiv);

                // Add rarity/total issued badge if applicable (mocking for now)
                if (cd.model?.rarityPermille) {
                    const rarityBadge = document.createElement('div');
                    rarityBadge.className = 'gift-rarity-badge';
                    const totalMock = Math.floor(1 / (cd.model.rarityPermille / 100000)) * 100; // Mock total
                    rarityBadge.textContent = `1 of ${ (totalMock / 1000).toFixed(1)}K`; // Example
                    card.appendChild(rarityBadge);
                }

            } else {
                giftImage.src = gift.originalImage;
                giftImage.alt = gift.name;
            }
            
            giftImage.onerror = function() { this.parentNode.replaceChild(createPlaceholderImage(true), this); };
            card.appendChild(giftImage);

            if (pinnedGifts.includes(gift.instanceId)) {
                const pinDiv = document.createElement('div');
                pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG; 
                pinDiv.querySelector('svg').style.fill = 'var(--tg-theme-link-color)'; // Ensure color
                card.appendChild(pinDiv);
            }

            card.addEventListener('click', () => openGiftDetailByInstanceId(gift.instanceId));
            setupLongPress(card, gift); 
            return card;
        }
        
        function createPlaceholderImage(isCardPlaceholder = false) {
            const placeholder = document.createElement('div');
            placeholder.className = 'placeholder-image';
            if (isCardPlaceholder) {
                placeholder.style.width = '70%'; placeholder.style.height = '70%';
            }
            placeholder.textContent = '🖼️';
            return placeholder;
        }

        function renderTopPinnedGiftsPreview() {
            profileTopPinnedGifts.innerHTML = '';
            pinnedGifts.slice(0, 5).forEach(instanceId => {
                const gift = ownedGifts.find(g => g.instanceId === instanceId);
                if (gift) {
                    const img = document.createElement('img');
                    img.src = gift.isCollectible && gift.collectibleData?.modelImage ? gift.collectibleData.modelImage : gift.originalImage;
                    img.alt = gift.name;
                    img.onerror = function() { this.src = `https://i.pravatar.cc/48?u=pin${generateUniqueId()}`; };
                    profileTopPinnedGifts.appendChild(img);
                }
            });
        }
        
        function openBuyMultipleModal(id, name, originalImage) {
            currentGiftToBuyMultiple = { id, name, originalImage };
            buyMultipleModalTitle.textContent = `Купить "${name}"`;
            buyMultipleGiftName.textContent = `Укажите количество для "${name}"`;
            buyMultipleQuantityInput.value = "1";
            buyMultipleModal.classList.add('active');
            buyMultipleQuantityInput.focus();
        }

        function handleConfirmBuyMultiple() {
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) {
                tg.showAlert("Пожалуйста, введите корректное количество.");
                return;
            }
            buyGift(currentGiftToBuyMultiple.id, currentGiftToBuyMultiple.name, currentGiftToBuyMultiple.originalImage, quantity);
            closeModal(buyMultipleModal);
            currentGiftToBuyMultiple = null;
        }

        function buyGift(id, name, originalImage, quantity = 1) {
            for (let i = 0; i < quantity; i++) {
                 ownedGifts.unshift({
                    id, 
                    instanceId: generateUniqueId(), 
                    name, originalImage,
                    isCollectible: false, collectibleData: null,
                    acquiredDate: new Date().toISOString()
                });
            }
            
            saveState();
            renderProfileGifts();
            tg.HapticFeedback.notificationOccurred('success');
            const message = quantity > 1 ? `"${name}" (${quantity} шт.) добавлены в ваши подарки!` : `"${name}" добавлен в ваши подарки!`;
            tg.showAlert(message);
            showPage('profile-page'); 
        }

        function openGiftDetailByInstanceId(instanceId) {
            const gift = ownedGifts.find(g => g.instanceId === instanceId);
            if (!gift) return;

            if (gift.isCollectible && gift.collectibleData) {
                const cd = gift.collectibleData;
                collectibleDetailModal.dataset.instanceId = gift.instanceId; // For wear button
                modalCollectibleHeaderTitle.textContent = gift.name; // Use original gift name for header
                modalCollectibleMainName.textContent = cd.model?.name || gift.name;
                modalCollectibleNumberSubtext.textContent = `Коллекционный #${cd.number}`;
                
                modalCollectibleBg.style.background = `radial-gradient(circle, ${cd.backdropColors?.centerColor || '#555'}, ${cd.backdropColors?.edgeColor || '#333'})`;
                modalCollectiblePattern.style.backgroundImage = cd.patternImage ? `url('${cd.patternImage}')` : 'none';
                modalCollectibleModelImg.src = cd.modelImage || gift.originalImage;
                modalCollectibleModelImg.alt = cd.model?.name || gift.name;
                modalCollectibleModelImg.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${generateUniqueId()}`; };

                const ownerName = document.getElementById('profile-name').textContent;
                const ownerAvatar = document.getElementById('profile-avatar').src;

                modalCollectibleInfoTable.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Владелец</span>
                        <span class="info-value">
                            <img src="${ownerAvatar}" alt="" class="owner-avatar">
                            ${ownerName}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Модель</span>
                        <span class="info-value">${cd.model?.name || 'N/A'} <span class="rarity-chip">${(cd.model?.rarityPermille || 0) / 10}%</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Фон</span>
                        <span class="info-value">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${(cd.backdrop?.rarityPermille || 0) / 10}%</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Символ</span>
                        <span class="info-value">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${(cd.pattern?.rarityPermille || 0) / 10}%</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Количество</span>
                        <span class="info-value">#${cd.number} (Уникальный экземпляр)</span>
                    </div>
                `;
                collectibleActionWear.querySelector('.text').textContent = (wornGiftInstanceId === gift.instanceId) ? 'Снять' : 'Надеть';
                collectibleDetailModal.classList.add('active');
            } else { // Non-collectible - "Saved Gift" style
                modalGiftName.textContent = "Сохраненный подарок"; // Static title from screenshot
                modalGiftImage.src = gift.originalImage;
                modalGiftImage.alt = gift.name;
                modalGiftImage.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${generateUniqueId()}`; };
                
                modalGiftDescription1.textContent = `Добавьте «${gift.name}» в свой профиль или улучшите его.`;
                modalGiftDescription2.textContent = "Только вы можете видеть имя отправителя.";


                modalGiftInfo.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Дата</span>
                        <span class="info-value">${new Date(gift.acquiredDate).toLocaleDateString('ru-RU', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Стоимость</span>
                        <span class="info-value"><span class="star-icon">⭐</span> Бесплатно</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Доступность</span>
                        <span class="info-value">Ограничено</span>
                    </div>
                    <div class="info-row" id="uniqueness-row-${gift.instanceId}">
                        <span class="info-label">Уникальность</span>
                        <div class="info-value-with-action">
                            <span id="modal-uniqueness-value-${gift.instanceId}">Стандартный</span>
                            <button id="modal-action-upgrade-gift-${gift.instanceId}" class="button-link-styled" data-instance-id="${gift.instanceId}">Улучшить</button>
                        </div>
                    </div>
                `;
                giftDetailModal.classList.add('active');
                // Add event listener for the new inline upgrade button
                const inlineUpgradeBtn = document.getElementById(`modal-action-upgrade-gift-${gift.instanceId}`);
                if(inlineUpgradeBtn) {
                    inlineUpgradeBtn.addEventListener('click', (e) => handleSingleGiftUpgradeFromModal(e.target.dataset.instanceId));
                }
            }
        }
        
        async function upgradeSingleGiftLogic(giftToUpgrade) {
            if (giftToUpgrade.isCollectible) {
                return { instanceId: giftToUpgrade.instanceId, name: giftToUpgrade.name, status: 'skipped' };
            }

            const giftNameEncoded = encodeURIComponent(giftToUpgrade.name);
            try {
                const [modelsRes, backdropsRes, patternsRes] = await Promise.all([
                    fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`),
                    fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`),
                    fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`)
                ]);

                if (!modelsRes.ok) throw new Error(`Модели (${giftToUpgrade.name}) не найдены.`);
                if (!backdropsRes.ok) throw new Error(`Фоны (${giftToUpgrade.name}) не найдены.`);
                if (!patternsRes.ok) throw new Error(`Символы (${giftToUpgrade.name}) не найдены.`);

                const [modelsData, backdropsData, patternsData] = await Promise.all([
                    modelsRes.json(),
                    backdropsRes.json(),
                    patternsRes.json()
                ]);

                if (!modelsData?.length || !backdropsData?.length || !patternsData?.length) {
                    throw new Error(`Отсутствуют необходимые данные для улучшения "${giftToUpgrade.name}".`);
                }

                const selectedModel = selectWeightedRandom(modelsData);
                const selectedBackdrop = selectWeightedRandom(backdropsData);
                const selectedPattern = selectWeightedRandom(patternsData);
                const randomNumber = Math.floor(Math.random() * 200000) + 1; // Increased range

                const giftIndexInOwned = ownedGifts.findIndex(g => g.instanceId === giftToUpgrade.instanceId);
                if (giftIndexInOwned !== -1) {
                    const newCollectibleData = {
                        model: selectedModel, backdrop: selectedBackdrop, pattern: selectedPattern,
                        number: randomNumber,
                        modelImage: `${CDN_BASE_URL}models/${giftNameEncoded}/png/${encodeURIComponent(selectedModel.name)}.png`,
                        patternImage: `${CDN_BASE_URL}patterns/${giftNameEncoded}/png/${encodeURIComponent(selectedPattern.name)}.png`,
                        backdropColors: selectedBackdrop.hex,
                    };
                    ownedGifts[giftIndexInOwned] = {
                        ...ownedGifts[giftIndexInOwned],
                        isCollectible: true,
                        collectibleData: newCollectibleData
                    };
                    return { instanceId: giftToUpgrade.instanceId, name: giftToUpgrade.name, status: 'success', collectibleData: newCollectibleData, giftNameEncoded: giftNameEncoded };
                } else {
                    throw new Error(`Подарок "${giftToUpgrade.name}" не найден в массиве для обновления.`);
                }
            } catch (error) {
                console.error(`Ошибка улучшения для "${giftToUpgrade.name}" (ID: ${giftToUpgrade.instanceId}):`, error);
                return { instanceId: giftToUpgrade.instanceId, name: giftToUpgrade.name, status: 'failed', error: error.message };
            }
        }

        async function handleSingleGiftUpgradeFromModal(instanceId) {
            const gift = ownedGifts.find(g => g.instanceId === instanceId);
            if (!gift || gift.isCollectible) return;

            const upgradeButton = document.getElementById(`modal-action-upgrade-gift-${instanceId}`);
            const uniquenessValueEl = document.getElementById(`modal-uniqueness-value-${instanceId}`);
            
            if (upgradeButton) {
                upgradeButton.textContent = 'Улучшение...';
                upgradeButton.disabled = true;
            }
            if (uniquenessValueEl) uniquenessValueEl.textContent = 'Обработка...';

            const result = await upgradeSingleGiftLogic(gift);

            if (result.status === 'success' && result.collectibleData) {
                if (uniquenessValueEl) uniquenessValueEl.textContent = `Коллекционный #${result.collectibleData.number}`;
                saveState();
                renderProfileGifts(); // Re-render main grid
                tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => {
                    closeModal(giftDetailModal);
                    openGiftDetailByInstanceId(gift.instanceId); // Re-open as collectible
                }, 1200);
            } else { 
                tg.showAlert(`Не удалось улучшить "${gift.name}". ${result.error || 'Причина неизвестна.'}`);
                if (uniquenessValueEl) uniquenessValueEl.textContent = 'Ошибка';
                if (upgradeButton) {
                    upgradeButton.textContent = 'Улучшить';
                    upgradeButton.disabled = false;
                }
            }
        }
        
        async function handleUpgradeAllGifts() {
            const giftsToUpgrade = ownedGifts.filter(g => !g.isCollectible);
            if (giftsToUpgrade.length === 0) {
                tg.showAlert("Нет подарков для улучшения.");
                return;
            }

            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            
            let successCount = 0;
            let failureCount = 0;

            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `Улучшение (${i + 1}/${giftsToUpgrade.length})...`;
                const result = await upgradeSingleGiftLogic(gift);
                if (result.status === 'success') {
                    successCount++;
                    const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${gift.instanceId}"]`);
                    if (cardElement && result.collectibleData && result.giftNameEncoded) {
                         // Rebuild the card content with new collectible data
                        const updatedCard = createGiftCardDOM(ownedGifts.find(g => g.instanceId === gift.instanceId));
                        cardElement.innerHTML = updatedCard.innerHTML; // Replace content
                        // Re-attach long press as innerHTML replacement might remove old listeners if not careful
                        setupLongPress(cardElement, ownedGifts.find(g => g.instanceId === gift.instanceId));
                    }
                } else if (result.status === 'failed') {
                    failureCount++;
                }
                if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length -1) await new Promise(resolve => setTimeout(resolve, 300)); 
            }

            saveState();
            // renderProfileGifts(); // Full re-render after all individual updates. Or rely on individual updates.
            // Individual updates are done, a final sort might be good if order matters strictly, but pinning is handled.

            let summaryMessage = `Процесс улучшения завершён.\nУспешно: ${successCount}`;
            if (failureCount > 0) {
                summaryMessage += `\nНе удалось: ${failureCount}`;
            }
            tg.showAlert(summaryMessage);
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));

            const स्टिलHasNonCollectible = ownedGifts.some(g => !g.isCollectible);
            upgradeAllGiftsButton.style.display = स्टिलHasNonCollectible ? 'inline-block' : 'none';
            if (स्टिलHasNonCollectible) {
                 upgradeAllGiftsButton.textContent = originalButtonText;
                 upgradeAllGiftsButton.disabled = false;
            }
        }


        function selectWeightedRandom(items) {
            if (!items || items.length === 0) return null;
            let totalWeight = items.reduce((sum, item) => sum + (item.rarityPermille || 1), 0);
            if (totalWeight === 0) return items[Math.floor(Math.random() * items.length)];
            let randomNum = Math.random() * totalWeight;
            for (let item of items) {
                if (randomNum < (item.rarityPermille || 1)) return item;
                randomNum -= (item.rarityPermille || 1);
            }
            return items[items.length - 1];
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('active');
        }

        let currentLongPressGift = null;
        let longPressTimer;

        function setupLongPress(element, gift) { 
            element.addEventListener('touchstart', (e) => {
                clearTimeout(longPressTimer); // Clear any existing timer
                longPressTimer = window.setTimeout(() => {
                    openLongPressMenu(gift, e.touches[0]);
                }, 500);
            }, { passive: false }); // passive: false to allow preventDefault if needed later

            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                clearTimeout(longPressTimer);
                openLongPressMenu(gift, e);
            });
        }
        
        function openLongPressMenu(gift, eventCoords) {
            currentLongPressGift = gift; 
            
            if (!gift.isCollectible) {
                menuPinAction.textContent = 'Закрепить (только коллекционные)';
                menuPinAction.classList.add('disabled');
            } else {
                const isPinned = pinnedGifts.includes(gift.instanceId);
                menuPinAction.textContent = isPinned ? 'Открепить' : 'Закрепить';
                menuPinAction.classList.remove('disabled');
            }
            
            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }
        
        function closeLongPressMenuOnClickOutside(event) {
            if (!longPressMenu.contains(event.target) && event.target !== longPressMenu) {
                longPressMenu.classList.add('hidden');
                currentLongPressGift = null;
            }
        }

        function handlePinAction() {
            if (!currentLongPressGift || menuPinAction.classList.contains('disabled')) {
                longPressMenu.classList.add('hidden');
                if (currentLongPressGift && !currentLongPressGift.isCollectible) {
                    tg.showAlert("Только коллекционные подарки можно закреплять.");
                }
                currentLongPressGift = null;
                return;
            }

            const giftInstanceId = currentLongPressGift.instanceId;
            const isPinned = pinnedGifts.includes(giftInstanceId);

            if (isPinned) {
                pinnedGifts = pinnedGifts.filter(id => id !== giftInstanceId);
            } else {
                if (pinnedGifts.length >= MAX_PINS) {
                    showTooManyPinsModal(); 
                    longPressMenu.classList.add('hidden');
                    return; 
                }
                pinnedGifts.push(giftInstanceId);
            }
            saveState();
            renderProfileGifts();
            longPressMenu.classList.add('hidden');
            tg.HapticFeedback.impactOccurred(isPinned ? 'light' : 'medium');
            currentLongPressGift = null;
        }
        
        function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';
            pinnedGifts.forEach(pinnedInstanceId => {
                const giftToUnpin = ownedGifts.find(g => g.instanceId === pinnedInstanceId);
                if (giftToUnpin) {
                    const card = createGiftCardDOM(giftToUnpin); // Reuse card creation
                    card.addEventListener('click', () => {
                        pinnedGifts = pinnedGifts.filter(id => id !== pinnedInstanceId);
                        if (currentLongPressGift && currentLongPressGift.isCollectible && !pinnedGifts.includes(currentLongPressGift.instanceId)) {
                             pinnedGifts.push(currentLongPressGift.instanceId);
                        }
                        saveState();
                        renderProfileGifts();
                        closeModal(tooManyPinsModal);
                        tg.HapticFeedback.impactOccurred('medium');
                        currentLongPressGift = null;
                    });
                    unpinSelectionGrid.appendChild(card);
                }
            });
            tooManyPinsModal.classList.add('active');
        }

        function handleWearAction() {
            const currentModalInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentModalInstanceId) return;

            if (wornGiftInstanceId === currentModalInstanceId) { // Currently worn, so take off
                wornGiftInstanceId = null;
                collectibleActionWear.querySelector('.text').textContent = 'Надеть';
            } else { // Not worn, or different gift worn
                wornGiftInstanceId = currentModalInstanceId;
                collectibleActionWear.querySelector('.text').textContent = 'Снять';
            }
            applyWornGiftStyles(wornGiftInstanceId);
            saveState();
            tg.HapticFeedback.impactOccurred('light');
        }

        function setupEventListeners() {
            goToBuyGiftsButton.addEventListener('click', () => showPage('buy-gifts-page'));
            if (upgradeAllGiftsButton) {
                 upgradeAllGiftsButton.addEventListener('click', handleUpgradeAllGifts);
            }
            backToProfileBuyButton.addEventListener('click', () => showPage('profile-page'));

            closeGiftDetailModalButton.addEventListener('click', () => closeModal(giftDetailModal));
            
            backFromCollectibleModal.addEventListener('click', () => closeModal(collectibleDetailModal));
            collectibleActionWear.addEventListener('click', handleWearAction);
            closeCollectibleDetailModalButton.addEventListener('click', () => closeModal(collectibleDetailModal));
            
            menuPinAction.addEventListener('click', handlePinAction);
            cancelUnpinModal.addEventListener('click', () => {
                closeModal(tooManyPinsModal);
                currentLongPressGift = null;
            });

            confirmBuyMultipleButton.addEventListener('click', handleConfirmBuyMultiple);
            cancelBuyMultipleButton.addEventListener('click', () => closeModal(buyMultipleModal));

            [giftDetailModal, collectibleDetailModal, tooManyPinsModal, buyMultipleModal].forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
            });
            giftsGrid.addEventListener('scroll', () => { 
                if(!longPressMenu.classList.contains('hidden')) {
                    longPressMenu.classList.add('hidden'); 
                    currentLongPressGift = null;
                }
            });
        }
        
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== undefined) {
             initApp();
        } else {
            console.warn("Telegram WebApp не найден. Используются мок-данные и тема по умолчанию.");
            document.addEventListener('DOMContentLoaded', () => {
                 tg.initDataUnsafe = { user: mockUser };
                 tg.themeParams = {
                    //bg_color: '#18222d', text_color: '#ffffff', hint_color: '#aaa', link_color: '#8774e1', button_color: '#8774e1', button_text_color: '#ffffff', secondary_bg_color: '#222f3c', accent_text_color: '#8774e1', section_header_text_color: '#303d4a'
                 }; 
                 tg.showAlert = (message) => alert(message);
                 tg.HapticFeedback = {
                     impactOccurred: (style) => console.log(`Тактильный отклик: ${style}`),
                     notificationOccurred: (type) => console.log(`Тактильное уведомление: ${type}`),
                 };
                 tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = () => {};
                 initApp();
            });
        }
    </script>
</body>
</html>
