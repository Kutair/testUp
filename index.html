<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Gift Simulator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F3KPE0SD07"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F3KPE0SD07');
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2);
            --app-rarity-chip-text: var(--tg-theme-text-color);
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
            --app-clear-data-color: #ff3b30;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Account Sidebar Styles */
        .account-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 320px;
            background-color: var(--tg-theme-bg-color);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        }
        .account-sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            display: flex;
            align-items: center;
        }
        .sidebar-header img {
            width: 50px; height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-header .name {
            font-size: 1.1em;
            font-weight: 500;
        }
        .accounts-list {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        .accounts-list li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }
        .accounts-list li:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .accounts-list li.active {
            background-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
        }
        .accounts-list li img {
            width: 40px; height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
            overflow-y: auto;
        }
        .sidebar-footer button {
             width: 100%;
             padding: 12px;
             background: none;
             border: none;
             color: var(--tg-theme-link-color);
             text-align: left;
             font-size: 1em;
             cursor: pointer;
             border-radius: 8px;
             display: flex; align-items: center;
        }
        .sidebar-footer button svg {
            margin-right: 12px;
            width: 22px; height: 22px;
            fill: currentColor;
        }
        .sidebar-footer button:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* End Account Sidebar */

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        #profile-page > .page-header {
            background-color: transparent;
            position: absolute;
            top: 0; left:0; right:0;
            z-index: 100;
        }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }

        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .profile-top-section {
            position: relative;
            padding-top: 56px;
            background: var(--app-profile-gradient-fallback);
            transition: background 0.3s ease;
        }
        .profile-header-pattern-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            opacity: 0.07;
            pointer-events: none;
            z-index: 0;
        }
        .profile-header-content-wrapper {
             position: relative; z-index: 1;
             padding: 0 15px;
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 5px 0 8px 0;
            min-height: 30px;
        }
        .profile-top-pinned-gifts .pinned-gift-item {
            width: 30px; height: 30px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
        }
        .profile-main-info {
            display: flex;
            align-items: center;
            padding: 8px 0 20px 0;
        }
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .profile-name-status { display: flex; flex-direction: column; }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.4em; font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon-container {
            width: 24px; height: 24px; margin-left: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .profile-name-status p { font-size: 0.95em; color: var(--tg-theme-text-color); opacity: 0.7; margin-top: 3px; }
        .profile-name-status p.online { opacity: 1; color: var(--tg-theme-link-color); }

        .profile-details-section {
            background-color: var(--tg-theme-bg-color);
            padding: 15px 15px 5px 15px;
        }
        .profile-details .info-block {
            margin-bottom: 16px;
        }
        .profile-details .info-value {
            font-size: 0.95em;
            color: var(--tg-theme-text-color);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .profile-details .info-label {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-bottom: 3px;
            display: block;
        }
        .profile-details .info-value.collectible-value {
            color: var(--tg-theme-link-color);
            cursor: pointer;
        }
        #profile-bio {
             cursor: pointer;
        }
        #collectible-usernames-container {
            margin-top: 4px;
            line-height: 1.5;
        }
        #collectible-usernames-container .also-text {
            color: var(--tg-theme-hint-color);
            margin-right: 6px;
        }
        #collectible-usernames-container .collectible-username-span {
            color: var(--tg-theme-link-color);
            margin-right: 6px;
            cursor: pointer;
        }


        .profile-tabs-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            padding: 5px 0 0 0;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0px; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        .tab-content {
            display: none;
            flex-grow: 1;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }


        .profile-gifts-actions-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            padding: 12px 15px;
        }
        #filter-long-press-target {
            flex-grow: 1; height: 36px; cursor: pointer;
        }
        .profile-gifts-actions {
            display: flex; justify-content: flex-end;
            align-items: center;
            margin-left: 10px;
        }
        .profile-gifts-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        #upgrade-all-gifts-button { background-color: var(--tg-theme-accent-blue); margin-right: 10px; }

        #exit-filter-mode-button, #hide-selected-gifts-button, #exit-selection-mode-button,
        #exit-reorder-mode-button, #transfer-selected-gifts-button {
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .gifts-grid.reordering .gift-card[data-pinned="true"] {
            cursor: grabbing;
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%;
        }

        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }
        .gift-card.is-hidden {
            opacity: 0.5;
            filter: grayscale(80%);
        }
        .buy-gift-item { aspect-ratio: 1/1.1; }
        .gift-card.is-updating { transform: scale(0.95); opacity: 0.7; }
        .sortable-chosen, .sortable-ghost {
            cursor: grabbing !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.05);
            opacity: 0.7;
        }
        .gift-card-bg-pattern, .buy-gift-item-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none; z-index: 0;
        }
        .gift-card-pattern-overlay, .buy-gift-item-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            background-position: center;
            opacity: 0.1;
            pointer-events: none; z-index: 1;
        }
        .image-container {
            width: 70%; height: 70%;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
        }
        .buy-gift-item .image-container {
            width: 65%; max-height: 60px;
            margin-bottom: 8px; height: auto;
        }

        .static-image-fallback {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
        }
        .lottie-animation-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        /* Rotated Label - CORRECTED */
        .gift-card .top-right-label {
            position: absolute;
            top: 10px; /* Adjusted for visual balance */
            right: -28px; /* Adjusted for visual balance */
            transform: rotate(45deg);
            transform-origin: center;
            background-color: rgba(0,0,0,0.35);
            color: var(--tg-theme-text-color);
            font-size: 0.65em;
            padding: 1px 25px;
            z-index: 4;
            font-weight: 500;
            white-space: nowrap;
        }

        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg { width: 18px; height: 18px; fill: var(--tg-theme-link-color); opacity: 0.8; }

        /* Selection Mode Checkbox */
        .gift-card .selection-checkbox {
            position: absolute; top: 5px; right: 5px; /* Moved to right for consistency */
            width: 22px; height: 22px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            border-radius: 50%;
            z-index: 5; /* Higher than label */
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .gift-card.selected .selection-checkbox {
            background-color: var(--tg-theme-button-color);
        }
        .gift-card.selected .selection-checkbox::after {
            content: '✓';
            color: var(--tg-theme-button-text-color);
            font-size: 14px;
            font-weight: bold;
        }

        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            z-index: 2;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .buy-gift-item .gift-price.has-price::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png');
            background-size: 16px 16px;
            background-repeat: repeat;
            opacity: 0.08;
            border-radius: 12px;
            z-index: -1;
        }

        .buy-gift-item .gift-price .star-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .buy-gift-item .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px;
            border-radius: 8px; font-weight: 500; z-index: 3;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transform: translateY(0%); }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }

        .modal-scrollable-content { overflow-y: auto; padding: 15px 20px; flex-grow: 1; }
        .modal-buttons-footer {
            padding: 15px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            position: sticky; bottom: 0; z-index: 1;
            border-top: 1px solid var(--tg-theme-bg-color);
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            text-decoration: none;
            display: inline-block;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }
        .modal-button:disabled {
            background-color: var(--tg-theme-hint-color);
            color: var(--tg-theme-secondary-bg-color);
            cursor: not-allowed;
        }


        #gift-detail-modal .modal-gift-image-container {
            width: 120px; height: 120px;
            margin: 10px auto 15px auto; display: flex;
            align-items: center; justify-content: center;
        }
        #gift-detail-modal .modal-gift-image-static {
             max-width: 100%; max-height: 100%; object-fit: contain;
        }
        #gift-detail-modal .lottie-animation-container {
             width: 100%; height: 100%;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
        }
        #gift-detail-modal .modal-info-table .info-row:not(:last-child) { margin-bottom: 2px; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); }
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }
        #gift-detail-modal .info-value-with-action { display: flex; align-items: center; }
        #gift-detail-modal .info-value-with-action span { margin-right: 10px; color: var(--tg-theme-hint-color); }
        #gift-detail-modal .button-link-styled {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 0.95em; font-weight: 500;
            padding: 5px; cursor: pointer;
        }
        #gift-detail-modal .button-link-styled:disabled { color: var(--tg-theme-hint-color); }

        /* === COLLECTIBLE MODAL REDESIGN === */
        #collectible-detail-modal .modal-content { padding-top: 0; overflow: hidden; }
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }
        #collectible-detail-modal #collectible-menu-button {
            position: absolute; top: 10px; right: 10px; z-index: 3;
            background: rgba(0,0,0,0.2); border-radius: 50%; padding: 0;
            width: 36px; height: 36px;
        }
        #collectible-detail-modal #collectible-menu-button svg { fill: white; }

        .collectible-display-area {
            padding: 40px 0 20px 0; /* Adjusted padding */
            text-align: center;
            position: relative;
            overflow: hidden;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #pattern-container-dynamic {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            pointer-events: none;
        }
        .dynamic-pattern-instance {
            position: absolute;
            opacity: 0.1;
            width: 40px;
            height: auto;
            will-change: transform;
        }

        .modal-collectible-visual {
            width: 45%;
            max-width: 160px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-collectible-visual .static-image-fallback {
             max-width: 100%;
             max-height: 100%;
             object-fit: contain;
        }
        .modal-collectible-visual .lottie-animation-container {
            width: 80%; height: 80%; object-fit: contain; z-index: 4; position: relative;
        }

        .collectible-display-area h3 {
            font-size: 1.6em; font-weight: 600; margin-top: 20px; margin-bottom: 5px;
            color: var(--tg-theme-text-color); position: relative; z-index: 2;
        }
        .collectible-display-area p {
            font-size: 1em; color: var(--tg-theme-hint-color); margin: 0;
            position: relative; z-index: 2;
        }
        .collectible-display-area p a {
            color: var(--tg-theme-link-color); text-decoration: none; cursor: pointer;
        }
        .collectible-display-area p a:hover { text-decoration: underline; }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 20px; /* Moved padding here from display-area */
            background-color: transparent; /* No longer has its own background */
            position: relative; z-index: 2; /* Ensure buttons are on top */
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: rgba(0,0,0,0.25); /* Dark, transparent background */
            color: var(--tg-theme-text-color);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }
        /* === END COLLECTIBLE MODAL REDESIGN === */

        .collectible-info-section { padding: 0 20px; background-color: var(--tg-theme-secondary-bg-color); }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
        }
        .collectible-info-section .info-row:not(:last-child) { border-bottom: 1px solid var(--tg-theme-bg-color); }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value { color: var(--tg-theme-hint-color); display: flex; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .collectible-info-section .info-value a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
        }
        .collectible-info-section .info-value.clickable-info { cursor: pointer; }
        .collectible-info-section .info-value.clickable-info:active { opacity: 0.7; }
        .collectible-info-section .info-value img.owner-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        .rarity-chip .one-in-x {
            font-size: 0.9em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2001; /* Higher than sidebar overlay */
            padding: 6px 0; min-width: 220px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li { padding: 10px 20px; cursor: pointer; color: var(--tg-theme-text-color); font-size: 0.95em; }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li.danger { color: var(--app-clear-data-color); }
        #long-press-menu li:not(.disabled):hover { background-color: rgba(255,255,255,0.05); }

        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number] { -moz-appearance: textfield; }

        .filter-section { margin-bottom: 15px; }
        .filter-section h4 {
            font-size: 0.9em; font-weight: 500; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; padding-left: 5px;
        }
        .filter-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto;
            padding: 5px; background-color: rgba(0,0,0,0.1); border-radius: 8px;
        }
        .filter-option {
            aspect-ratio: 1/1; border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .filter-option img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .filter-option .gradient-square { width: 100%; height: 100%; }

        #filter-popup .clear-data-button {
            background-color: transparent;
            color: var(--app-clear-data-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px;
        }
        #filter-popup .clear-data-button svg { width: 20px; height: 20px; fill: currentColor; margin-right: 8px; }

        #filter-popup .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 5px;
            font-size: 1em;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--app-action-button-bg); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--tg-theme-link-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--tg-theme-link-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        #custom-buy-modal .filter-section, #chances-modal .filter-section { margin-bottom: 20px; }
        #custom-buy-modal .filter-options-grid, #chances-modal .filter-options-grid {
            max-height: 200px; overflow-y: auto; padding: 5px;
            background-color: rgba(0,0,0,0.1); border-radius: 8px;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }
        #custom-buy-modal .filter-option, #chances-modal .filter-option {
            background-color: var(--tg-theme-bg-color); border: 2px solid transparent;
            border-radius: 8px; padding: 5px; flex-direction: column;
            justify-content: flex-start; height: auto; aspect-ratio: auto;
            min-height: 80px;
        }
        #custom-buy-modal .filter-option.selected, #chances-modal .filter-option.selected { border-color: var(--tg-theme-link-color); }
        #custom-buy-modal .filter-option img, #custom-buy-modal .filter-option .gradient-square,
        #chances-modal .filter-option img, #chances-modal .filter-option .gradient-square {
            width: 100%; height: 60px; object-fit: contain;
            border-radius: 4px; margin-bottom: 5px;
        }
        #custom-buy-modal .filter-option .label, #chances-modal .filter-option .label {
            font-size: 0.75em; color: var(--tg-theme-text-color); text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }

        /* --- Custom Buy Clone --- */
        #custom-buy-clone-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--app-action-button-bg);
        }
        #custom-buy-clone-section input {
             width: 100%;
             padding: 12px;
             border-radius: 8px;
             border: 1px solid var(--tg-theme-bg-color);
             background-color: var(--tg-theme-bg-color);
             color: var(--tg-theme-text-color);
             font-size: 1em;
             margin-top: 8px;
        }


        #chances-probability-display {
            background-color: var(--tg-theme-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        #chances-probability-display .prob-value {
            font-size: 1.5em; font-weight: 600; color: var(--tg-theme-link-color);
            display: block; margin-bottom: 5px;
        }
        #chances-probability-display .prob-details {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }

        /* Sell Gift & Transfer Gift Modal Styles */
        #sell-gift-modal .modal-gift-preview,
        #transfer-gift-modal .modal-gift-preview {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        #sell-gift-modal .modal-gift-preview img,
        #transfer-gift-modal .modal-gift-preview img {
            width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;
        }
        #sell-gift-modal .modal-gift-preview h4,
        #transfer-gift-modal .modal-gift-preview h4 {
            font-size: 1.1em; font-weight: 500;
        }

        .price-input-container {
            position: relative;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
        }
        .price-input-container label {
            display: block; font-size: 0.8em; color: var(--tg-theme-link-color);
            margin-bottom: 5px;
        }
        .price-input-wrapper {
            display: flex; align-items: center;
        }
        .price-input-wrapper img {
            width: 24px; height: 24px; margin-right: 10px;
        }
        .price-input-wrapper input {
            background: none; border: none; color: var(--tg-theme-text-color);
            font-size: 1.2em; width: 100%; outline: none;
        }
        .price-input-wrapper input::-webkit-outer-spin-button,
        .price-input-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .price-input-wrapper input[type=number] { -moz-appearance: textfield; }
        .price-details { text-align: center; font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 10px; }

        #transfer-comment-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
            margin-top: 15px;
            resize: vertical;
        }


        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }

        /* Collectible Numbers/Usernames Modal */
        #numbers-modal .collectible-list, #usernames-modal .collectible-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        #numbers-modal .collectible-list-item, #usernames-modal .collectible-list-item {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid var(--tg-theme-bg-color);
            cursor: pointer;
            color: var(--tg-theme-link-color);
            font-family: monospace;
        }
        #usernames-modal .collectible-list-item {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--tg-theme-text-color);
        }
        #usernames-modal .collectible-list-item .at-symbol {
            color: var(--tg-theme-hint-color);
            margin-right: 2px;
        }
        #numbers-modal .collectible-list-item:hover, #usernames-modal .collectible-list-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        #usernames-modal .search-bar-container {
            padding: 10px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        #usernames-modal #username-search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
        }

        /* Settings Modal */
        #settings-modal .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 1em;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        #settings-modal .settings-row:last-of-type { border-bottom: none; }
        #settings-modal .settings-row button {
            background: none; border: none; color: var(--tg-theme-link-color);
            font-size: 1em; cursor: pointer; text-align: left;
            padding: 0; width: auto; font-weight: 400;
        }
        #settings-modal .settings-row.danger button {
            color: var(--app-clear-data-color);
        }
        #settings-modal .settings-row button.full-width { width: 100%; text-align: center; }

        /* --- GIVEAWAY MODAL --- */
        #giveaway-setup-modal .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #giveaway-setup-modal .selection-grid .gift-card {
             border: 2px solid transparent;
        }
        #giveaway-setup-modal .selection-grid .gift-card.selected {
            border-color: var(--tg-theme-link-color);
        }
        #giveaway-setup-modal .winner-rule-section {
            margin-top: 15px;
        }
        #giveaway-setup-modal .winner-rule-section label {
            display: block;
            padding: 12px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        #giveaway-setup-modal .winner-rule-section input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="account-sidebar" id="account-sidebar">
        <div class="sidebar-header">
            <img id="sidebar-current-avatar" src="" alt="Avatar">
            <span id="sidebar-current-name" class="name"></span>
        </div>
        <ul class="accounts-list" id="accounts-list"></ul>
        <div class="sidebar-footer">
            <button id="add-account-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12M5,13.28L1,10.72L2.41,9.31L5,11.9L9.6,7.3L11,8.72L5,14.72Z" /></svg>Add Account</button>
            <button id="open-numbers-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>Numbers</button>
            <button id="open-usernames-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,12C14.21,12 16,10.21 16,8C16,5.79 14.21,4 12,4C9.79,4 8,5.79 8,8C8,10.21 9.79,12 12,12M12,14C9.33,14 4,15.33 4,18V20H20V18C20,15.33 14.67,14 12,14Z" /></svg>@ Usernames</button>
            <button id="create-giveaway-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22,13H20V15H18V13H16V11H18V9H20V11H22M18,3L15,6H11L13,2H9.5C9.09,2 8.75,2.3 8.6,2.65L2,13L8,18H14L21,9V4M12.5,15.5C11.67,15.5 11,14.83 11,14C11,13.17 11.67,12.5 12.5,12.5C13.33,12.5 14,13.17 14,14C14,14.83 13.33,15.5 12.5,15.5Z" /></svg>🏆 Create Giveaway</button>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="app-container">
        <div id="profile-page" class="page active">
             <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
             <div class="page-header">
                <!-- Back button now handled by TG WebApp API -->
            </div>
            <div class="profile-page-content">
                <div id="profile-top-section" class="profile-top-section">
                    <div id="profile-header-pattern-overlay" class="profile-header-pattern-overlay"></div>
                    <div class="profile-header-content-wrapper">
                        <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                        <div id="profile-main-info-block" class="profile-main-info">
                            <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                            <div class="profile-name-status">
                                <div class="name-line">
                                    <h1 id="profile-name">Name</h1>
                                    <div id="worn-gift-icon-container" class="hidden lottie-animation-container"></div>
                                </div>
                                <p id="profile-gift-count-subtext">0 gifts</p>
                                <p id="profile-status" class="online">online</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-details-section">
                    <div id="profile-details" class="profile-details">
                         <div class="info-block">
                            <div class="info-label">Phone</div>
                            <div class="info-value" id="profile-phone"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Bio</div>
                            <div class="info-value" id="profile-bio"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Username</div>
                            <div class="info-value collectible-value" id="profile-username"></div>
                            <div class="info-value" id="collectible-usernames-container"></div>
                        </div>
                    </div>
                </div>
                <div class="profile-tabs-content">
                    <div class="profile-tabs">
                        <button id="posts-tab-button">Posts</button>
                        <button id="archive-tab-button">Archive</button>
                        <button class="active" id="gifts-tab-button">Gifts</button>
                    </div>
                    <div id="posts-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                     <div id="archive-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                    <div id="gifts-content" class="tab-content active">
                        <div class="profile-gifts-actions-wrapper">
                            <div id="filter-long-press-target"></div>
                            <div class="profile-gifts-actions">
                                <!-- Dynamic buttons will be prepended here by JS -->
                                <button id="upgrade-all-gifts-button" class="action-button" style="display: none;">✨ Upgrade All</button>
                                <button id="go-to-buy-gifts" class="action-button">🎁 Buy Gifts</button>
                            </div>
                        </div>
                        <div id="gifts-grid" class="gifts-grid">
                            <div class="spinner hidden" id="gifts-loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <h2>Gift Shop</h2>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <!-- Modals below -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Gift Name</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="modal-gift-image-container" class="modal-gift-image-container">
                        <div id="modal-lottie-gift-original" class="lottie-animation-container"></div>
                        <img id="modal-gift-image-static" class="static-image-fallback" src="" alt="Gift" style="display:none;">
                    </div>
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-gift-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-scrollable-content">
                    <!-- Collectible Display Area - Redesigned -->
                    <div class="collectible-display-area">
                        <button class="menu-button" id="collectible-menu-button">⋮</button>
                        <div id="pattern-container-dynamic"></div>
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-lottie-collectible-model" class="lottie-animation-container"></div>
                            <img id="modal-collectible-model-img-static" class="static-image-fallback" src="" alt="Model" style="display:none;">
                        </div>
                        <h3 id="modal-collectible-main-name">Model Name</h3>
                        <p id="modal-collectible-number-subtext">Collectible #123</p>
                        <div id="modal-collectible-actions" class="modal-action-buttons-row">
                            <button id="collectible-action-wear"><span class="icon"></span><span class="text">Wear</span></button>
                            <button id="collectible-action-sell"><span class="icon"></span><span class="text">Sell</span></button>
                            <button id="collectible-action-transfer"><span class="icon"></span><span class="text">Transfer</span></button>
                        </div>
                    </div>

                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">
                        This gift is visible in your profile. <span id="hide-link-in-modal" class="link">Hide ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Too Many Pinned Gifts</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Select a gift to unpin. You can pin up to 6 collectible gifts.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Buy Gift</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">Quantity:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Buy</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="filter-popup" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Gift Filters</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section" id="filter-collections-section">
                        <h4>Collections</h4>
                        <div class="filter-options-grid" id="filter-options-collections"></div>
                    </div>
                    <div class="filter-section hidden" id="filter-models-section">
                        <h4>Models</h4>
                        <div class="filter-options-grid" id="filter-options-models"></div>
                    </div>
                    <div class="filter-section" id="filter-backdrops-section">
                        <h4>Backdrops</h4>
                        <div class="filter-options-grid" id="filter-options-backdrops"></div>
                    </div>
                    <div class="filter-section" id="filter-patterns-section">
                        <h4>Symbols</h4>
                        <div class="filter-options-grid" id="filter-options-patterns"></div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.1); border-style: solid; border-width: 1px 0 0 0; margin: 20px 0;">
                </div>
                <div class="modal-buttons-footer">
                    <button id="apply-filters-button" class="modal-button">Apply Filters</button>
                    <button id="clear-filters-button" class="modal-button secondary">Reset Filters</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Settings</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="settings-row">
                        <label>Animations</label>
                        <label class="switch">
                            <input type="checkbox" id="animation-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Show hidden gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="show-hidden-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <button id="hide-multiple-button" class="full-width">Hide Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="transfer-multiple-button" class="full-width">Transfer Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="clear-current-account-data-button" class="full-width">Clear Current Account Data</button>
                    </div>
                    <div class="settings-row danger">
                        <button id="clear-all-accounts-data-button" class="full-width">Clear All Accounts Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="chances-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Chance Calculator</h3>
                </div>
                <div class="modal-scrollable-content">
                    <p id="chances-gift-name" style="text-align: center; font-weight: 500; margin-bottom: 15px;"></p>
                    <div id="chances-probability-display"></div>
                    <div class="spinner hidden" id="chances-loading-spinner"></div>
                    <div class="filter-section hidden" id="chances-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="chances-options-models"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="chances-options-backdrops"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="chances-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-chances-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="custom-buy-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Create or Clone Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section">
                        <h4>Select base</h4>
                        <div class="filter-options-grid" id="custom-buy-base-gifts-grid"></div>
                    </div>
                    <div class="filter-section hidden" id="custom-buy-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="custom-buy-models-grid"></div>
                    </div>
                    <div class="filter-section hidden" id="custom-buy-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="custom-buy-backdrops-grid"></div>
                    </div>
                    <div class="filter-section hidden" id="custom-buy-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="custom-buy-patterns-grid"></div>
                    </div>

                    <div id="custom-buy-clone-section">
                        <h4>Or Clone from Link</h4>
                        <input type="url" id="clone-url-input" placeholder="Paste t.me/nft/... link here">
                        <button id="clone-gift-button" class="modal-button secondary" style="margin-top: 10px;">Clone Gift</button>
                    </div>

                    <p style="text-align: center; color: var(--tg-theme-hint-color); font-size: 0.9em; margin-top: 15px;">
                        Gifts are created for free for simulation.
                    </p>
                </div>
                <div class="modal-buttons-footer">
                    <button id="custom-buy-confirm-button" class="modal-button" disabled>Create</button>
                    <button id="custom-buy-cancel-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="generated-image-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Your Gift</h3>
                </div>
                <div class="modal-scrollable-content" style="text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div id="generated-image-container" style="width: 100%; max-width: 300px; aspect-ratio: 3 / 4; border-radius: 12px; overflow: hidden; background-color: var(--tg-theme-bg-color); display: flex; align-items: center; justify-content: center;">
                        <img id="generated-image-preview" src="" alt="Generated Gift" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <p id="generated-image-message" style="margin-top: 15px; color: var(--tg-theme-hint-color); font-size: 0.9em;"></p>
                </div>
                <div class="modal-buttons-footer" id="generated-image-footer">
                    <button id="send-generated-image-button" class="modal-button" disabled>Send to Me</button>
                    <button id="close-generated-image-modal" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="sell-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Price in Stars</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="sell-gift-image" src="" alt="Gift Preview">
                        <h4 id="sell-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter price in Stars (125 - 100,000)</label>
                        <div class="price-input-wrapper">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star">
                            <input type="number" id="sell-price-input" placeholder="125" min="125" max="100000">
                        </div>
                    </div>
                    <div class="price-details">
                        <p id="sell-receive-amount">You will receive 100 Stars.</p>
                        <p id="sell-usd-amount">≈US$1.30</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-sell-button" class="modal-button" disabled>List for Sale</button>
                    <button id="cancel-sell-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="transfer-modal-title">Transfer Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="transfer-gift-image" src="" alt="Gift Preview">
                        <h4 id="transfer-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter recipient's Telegram username</label>
                        <div class="price-input-wrapper">
                            <span style="font-size:1.2em; margin-right:10px; color:var(--tg-theme-text-color);">@</span>
                            <input type="text" id="transfer-username-input" placeholder="username">
                        </div>
                    </div>
                    <textarea id="transfer-comment-input" rows="2" placeholder="Add a comment... (optional)"></textarea>
                    <div class="price-details" id="transfer-status-message">
                        <p>Gift ownership will be transferred to this username.</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-button" class="modal-button" disabled>Confirm Transfer</button>
                    <button id="cancel-transfer-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="numbers-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Anonymous Numbers +888</h3></div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="numbers-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-numbers-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="usernames-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Collectible Usernames</h3></div>
                <div class="search-bar-container">
                    <input type="text" id="username-search-input" placeholder="Search username...">
                </div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="usernames-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-usernames-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="giveaway-setup-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Create a Giveaway</h3></div>
                <div class="modal-scrollable-content">
                    <h4>1. Select Gifts to Give Away</h4>
                    <div id="giveaway-gift-selection-grid" class="selection-grid">
                        <p class="empty-grid-message">You have no collectible gifts to give away.</p>
                    </div>
                    <h4>2. Choose Winner Rule</h4>
                    <div class="winner-rule-section">
                        <label>
                            <input type="radio" name="winner-rule" value="single" checked>
                            One winner gets all gifts
                        </label>
                        <label>
                            <input type="radio" name="winner-rule" value="multiple">
                            One winner per gift
                        </label>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-giveaway-setup" class="modal-button" disabled>Start Setup in Bot</button>
                    <button id="cancel-giveaway-setup" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-reorder-action" class="hidden">Reorder</li>
            <li id="menu-pin-action">Pin</li>
            <li id="menu-hide-action">Hide</li>
            <li id="menu-copy-link-action" class="hidden">Copy Link</li>
            <li id="menu-share-image-action" class="hidden">Share Image</li>
            <li id="menu-delete-action" class="danger">Delete</li>
        </ul>
    </div>
    <script>
        const BACKEND_BASE_URL = "https://upgrade-a57g.onrender.com";

        const APP_VERSION_SUFFIX = '_v14'; // Increment to reset UI preferences on major changes
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const PRICES_JSON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/prices.json";
        const STAR_ICON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png";

        const GIFT_LIMIT_PER_USER = 5000;
        const MAX_COLLECTIBLE_USERNAMES = 10;
        const MIN_SALE_PRICE = 125;
        const MAX_SALE_PRICE = 100000;

        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M5,4H19L12,1.5L5,4ZM6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        const MENU_DOTS_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>dots-vertical</title><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>`;

                // --- CUSTOM GIFT DATA ---
        const CUSTOM_GIFTS_DATA = {
            "Dildo": {
                "id": "custom_dildo",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_003931098.png",
                "models": [
                    {"name": "She Wants", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011319484.png"},
                    {"name": "Anal Games", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004252351.png"},
                    {"name": "Romance", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011244151.png"},
                    {"name": "Ma Boi", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012725065.png"},
                    {"name": "Twins 18", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004029718.png"},
                    {"name": "Golden Sex", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004223973.png"},
                    {"name": "Pixels", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012914349.png"},
                    {"name": "Penis Sword", "rarityPermille": 8, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014719027.png"},
                    {"name": "Water One", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004351728.png"},
                    {"name": "Woman Place", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004416012.png"},
                    {"name": "Volcano", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011343633.png"},
                    {"name": "Telegram", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012648445.png"},
                    {"name": "Pinkie Twinkie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004004128.png"},
                    {"name": "Silver Glass", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004200179.png"},
                    {"name": "Plush", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011552827.png"},
                    {"name": "Plush Cuttie", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011623951.png"},
                    {"name": "Spider Fun", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012003197.png"},
                    {"name": "Horse", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012355663.png"},
                    {"name": "Hand", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_013039090.png"},
                    {"name": "Ancient", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014521352.png"},
                    {"name": "Minion", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014626463.png"},
                    {"name": "Skinny Boi", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004055652.png"},
                    {"name": "Rainbow", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_004125778.png"},
                    {"name": "Russian Wood", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011527878.png"},
                    {"name": "Afterparty", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_011822289.png"},
                    {"name": "Neon", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_012439323.png"},
                    {"name": "Black Jack", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_013144671.png"},
                    {"name": "Galaxy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014555528.png"},
                    {"name": "Hell Red", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_014650858.png"}
                ],
                "backdrops_source": "Astral Shard",
                "patterns_source": "Astral Shard"
            },
            "Skebob": {
                "id": "custom_skebob",
                "defaultImage": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/IMG_20250717_213249_176.jpg",
                "models": [
                    {"name": "Nikitka", "rarityPermille": 1, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012302911-min.png"},
                    {"name": "Gold", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220944840-min.png"},
                    {"name": "Plushy", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221053786-min.png"},
                    {"name": "XXXTentacion", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222249990-min.png"},
                    {"name": "Cactus King", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013002213-min.png"},
                    {"name": "354 KANON", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013042799-min.png"},
                    {"name": "Duck", "rarityPermille": 5, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014036288-min.png"},
                    {"name": "Spider King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220335725-min.png"},
                    {"name": "Bitcoin", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012502725-min.png"},
                    {"name": "Move To Heaven", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012612974-min.png"},
                    {"name": "Frogie", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012824238-min.png"},
                    {"name": "The King", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012931928-min.png"},
                    {"name": "Fire On Fire", "rarityPermille": 10, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013941593-min.png"},
                    {"name": "Icy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220405846-min.png"},
                    {"name": "Pick Me", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_220906007-min.png"},
                    {"name": "Black Bird", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221147963-min.png"},
                    {"name": "Pavel Durov", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_222706006-min.png"},
                    {"name": "Banana", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013851152-min.png"},
                    {"name": "Mummy", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014247708-min.png"},
                    {"name": "Police Man", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014319952-min.png"},
                    {"name": "Electric BDSM", "rarityPermille": 20, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014554522-min.png"},
                    {"name": "Glassy", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250717_221020205-min.png"},
                    {"name": "Ancient", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_012541910-min.png"},
                    {"name": "Business", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013214856-min.png"},
                    {"name": "Spookie", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013308503-min.png"},
                    {"name": "Minion", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013343118-min.png"},
                    {"name": "Oh Shit", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_013417326-min.png"},
                    {"name": "Emo Girl", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014533870-min.png"},
                    {"name": "Minecraft", "rarityPermille": 30, "image": "https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/main/BackgroundEraser_20250718_014750440-min.png"}
                ],
                "backdrops_source": "Snoop Dogg",
                "patterns_source": "Snoop Dogg"
            }
        };


        // --- Global State ---
        let allAvailableGifts = {};
        let giftPrices = {};

        let accounts = [];
        let currentAccountTgId = null;

        let ownedGifts = [];
        let currentlySortedGifts = [];
        let viewingOwnProfile = true;
        let selectionModeActive = false;
        let selectionAction = null;
        let reorderModeActive = false;
        let selectedGiftIds = new Set();

        let animationsEnabled = true;
        let showHiddenGifts = false;
        let activeFilters = { collection: null, model: null, backdrop: null, pattern: null };

        let tg = window.Telegram.WebApp;

        // --- DOM Elements ---
        const appContainer = document.querySelector('.app-container');
        const accountSidebar = document.getElementById('account-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarCurrentAvatar = document.getElementById('sidebar-current-avatar');
        const sidebarCurrentName = document.getElementById('sidebar-current-name');
        const accountsList = document.getElementById('accounts-list');
        const addAccountButton = document.getElementById('add-account-button');
        const openNumbersButton = document.getElementById('open-numbers-button');
        const openUsernamesButton = document.getElementById('open-usernames-button');
        const createGiveawayButton = document.getElementById('create-giveaway-button');

        const profilePage = document.getElementById('profile-page');
        const profileTopSection = document.getElementById('profile-top-section');
        const profileHeaderPatternOverlay = document.getElementById('profile-header-pattern-overlay');
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const profileName = document.getElementById('profile-name');
        const wornGiftIconContainer = document.getElementById('worn-gift-icon-container');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profileDetails = document.getElementById('profile-details');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const collectibleUsernamesContainer = document.getElementById('collectible-usernames-container');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');

        const giftsTabButton = document.getElementById('gifts-tab-button');
        const postsTabButton = document.getElementById('posts-tab-button');
        const archiveTabButton = document.getElementById('archive-tab-button');
        const giftsContent = document.getElementById('gifts-content');
        const postsContent = document.getElementById('posts-content');
        const archiveContent = document.getElementById('archive-content');

        const profileGiftsActions = document.querySelector('.profile-gifts-actions');
        const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        const filterLongPressTarget = document.getElementById('filter-long-press-target');
        const giftsGrid = document.getElementById('gifts-grid');
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');

        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');

        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalLottieGiftOriginal = document.getElementById('modal-lottie-gift-original');
        const modalGiftImageStatic = document.getElementById('modal-gift-image-static');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');

        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const collectibleDisplayArea = collectibleDetailModal.querySelector('.collectible-display-area');
        const patternContainerDynamic = document.getElementById('pattern-container-dynamic');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalLottieCollectibleModel = document.getElementById('modal-lottie-collectible-model');
        const modalCollectibleModelImgStatic = document.getElementById('modal-collectible-model-img-static');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        const collectibleMenuButton = document.getElementById('collectible-menu-button');
        const hideLinkInModal = document.getElementById('hide-link-in-modal');

        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');

        const longPressMenu = document.getElementById('long-press-menu');
        const menuReorderAction = document.getElementById('menu-reorder-action');
        const menuPinAction = document.getElementById('menu-pin-action');
        const menuHideAction = document.getElementById('menu-hide-action');
        const menuCopyLinkAction = document.getElementById('menu-copy-link-action');
        const menuDeleteAction = document.getElementById('menu-delete-action');
        const menuShareImageAction = document.getElementById('menu-share-image-action');

        const filterPopup = document.getElementById('filter-popup');
        const filterModelsSection = document.getElementById('filter-models-section');
        const filterOptionsCollections = document.getElementById('filter-options-collections');
        const filterOptionsModels = document.getElementById('filter-options-models');
        const filterOptionsBackdrops = document.getElementById('filter-options-backdrops');
        const filterOptionsPatterns = document.getElementById('filter-options-patterns');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const clearFiltersButton = document.getElementById('clear-filters-button');

        const settingsModal = document.getElementById('settings-modal');
        const animationToggle = document.getElementById('animation-toggle');
        const showHiddenToggle = document.getElementById('show-hidden-toggle');
        const hideMultipleButton = document.getElementById('hide-multiple-button');
        const transferMultipleButton = document.getElementById('transfer-multiple-button');
        const clearCurrentAccountDataButton = document.getElementById('clear-current-account-data-button');
        const clearAllAccountsDataButton = document.getElementById('clear-all-accounts-data-button');

        const customBuyModal = document.getElementById('custom-buy-modal');
        const customBuyBaseGiftsGrid = document.getElementById('custom-buy-base-gifts-grid');
        const customBuyModelsSection = document.getElementById('custom-buy-models-section');
        const customBuyModelsGrid = document.getElementById('custom-buy-models-grid');
        const customBuyBackdropsSection = document.getElementById('custom-buy-backdrops-section');
        const customBuyBackdropsGrid = document.getElementById('custom-buy-backdrops-grid');
        const customBuyPatternsSection = document.getElementById('custom-buy-patterns-section');
        const customBuyPatternsGrid = document.getElementById('custom-buy-patterns-grid');
        const customBuyConfirmButton = document.getElementById('custom-buy-confirm-button');
        const customBuyCancelButton = document.getElementById('custom-buy-cancel-button');
        const cloneUrlInput = document.getElementById('clone-url-input');
        const cloneGiftButton = document.getElementById('clone-gift-button');

        const generatedImageModal = document.getElementById('generated-image-modal');
        const generatedImageFooter = document.getElementById('generated-image-footer');
        const generatedImagePreview = document.getElementById('generated-image-preview');
        const generatedImageMessage = document.getElementById('generated-image-message');
        const sendGeneratedImageButton = document.getElementById('send-generated-image-button');
        const closeGeneratedImageModalButton = document.getElementById('close-generated-image-modal');

        const chancesModal = document.getElementById('chances-modal');
        const chancesGiftName = document.getElementById('chances-gift-name');
        const chancesLoadingSpinner = document.getElementById('chances-loading-spinner');
        const chancesProbabilityDisplay = document.getElementById('chances-probability-display');
        const chancesModelsSection = document.getElementById('chances-models-section');
        const chancesOptionsModels = document.getElementById('chances-options-models');
        const chancesBackdropsSection = document.getElementById('chances-backdrops-section');
        const chancesOptionsBackdrops = document.getElementById('chances-options-backdrops');
        const chancesPatternsSection = document.getElementById('chances-patterns-section');
        const chancesOptionsPatterns = document.getElementById('chances-options-patterns');
        const closeChancesModalButton = document.getElementById('close-chances-modal');

        const sellGiftModal = document.getElementById('sell-gift-modal');
        const sellGiftImage = document.getElementById('sell-gift-image');
        const sellGiftName = document.getElementById('sell-gift-name');
        const sellPriceInput = document.getElementById('sell-price-input');
        const sellReceiveAmount = document.getElementById('sell-receive-amount');
        const sellUsdAmount = document.getElementById('sell-usd-amount');
        const confirmSellButton = document.getElementById('confirm-sell-button');
        const cancelSellButton = document.getElementById('cancel-sell-button');

        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferModalTitle = document.getElementById('transfer-modal-title');
        const transferGiftImage = document.getElementById('transfer-gift-image');
        const transferGiftName = document.getElementById('transfer-gift-name');
        const transferUsernameInput = document.getElementById('transfer-username-input');
        const transferCommentInput = document.getElementById('transfer-comment-input');
        const transferStatusMessage = document.getElementById('transfer-status-message');
        const confirmTransferButton = document.getElementById('confirm-transfer-button');
        const cancelTransferButton = document.getElementById('cancel-transfer-button');

        const numbersModal = document.getElementById('numbers-modal');
        const numbersList = document.getElementById('numbers-list');

        const usernamesModal = document.getElementById('usernames-modal');
        const usernameSearchInput = document.getElementById('username-search-input');
        const usernamesList = document.getElementById('usernames-list');

        const giveawaySetupModal = document.getElementById('giveaway-setup-modal');
        const giveawayGiftSelectionGrid = document.getElementById('giveaway-gift-selection-grid');
        const confirmGiveawaySetupButton = document.getElementById('confirm-giveaway-setup');

        const exitFilterModeButton = document.createElement('button');
        exitFilterModeButton.id = 'exit-filter-mode-button';
        exitFilterModeButton.className = 'action-button hidden';
        exitFilterModeButton.textContent = 'Exit Filter Mode';
        profileGiftsActions.prepend(exitFilterModeButton);

        const exitReorderModeButton = document.createElement('button');
        exitReorderModeButton.id = 'exit-reorder-mode-button';
        exitReorderModeButton.className = 'action-button hidden';
        exitReorderModeButton.textContent = 'Done Reordering';
        profileGiftsActions.prepend(exitReorderModeButton);

        const exitSelectionModeButton = document.createElement('button');
        exitSelectionModeButton.id = 'exit-selection-mode-button';
        exitSelectionModeButton.className = 'action-button hidden';
        exitSelectionModeButton.textContent = 'Cancel';
        profileGiftsActions.prepend(exitSelectionModeButton);

        const transferSelectedGiftsButton = document.createElement('button');
        transferSelectedGiftsButton.id = 'transfer-selected-gifts-button';
        transferSelectedGiftsButton.className = 'action-button hidden';
        transferSelectedGiftsButton.textContent = 'Transfer';
        profileGiftsActions.prepend(transferSelectedGiftsButton);

        const hideSelectedGiftsButton = document.createElement('button');
        hideSelectedGiftsButton.id = 'hide-selected-gifts-button';
        hideSelectedGiftsButton.className = 'action-button hidden';
        hideSelectedGiftsButton.textContent = 'Hide';
        profileGiftsActions.prepend(hideSelectedGiftsButton);

        const coolNumbers = ["+888 8888 8888", "+888 0000 0001", "+888 1234 5678", "+888 1111 1111", "+888 7777 7777", "+888 0707 6969"];
        const coolUsernames = ["durov", "admin", "king", "wallet", "crypto", "elon", "boss", "premium", "gift", "star", "diamond", "anonymous", "market", "bank", "news", "pessi", "penaldo"];

        let currentGiftToBuyMultiple = null;
        let lottieIntersectionObserver;
        let selectedCustomGift = {};
        let cachedCollectibleParts = {};
        let lastTap = 0;
        let tapCount = 0;
        let currentGiftToSell = null;
        let currentGiftToTransfer = null;
        let longPressAvatarTimer;
        let sortableInstance = null;
        let modalSwipeState = { startX: 0, isSwiping: false };
        let selectedGiveawayGifts = new Set();

        // --- API Utility Function ---
        async function callBackend(endpoint, method = 'GET', data = null) {
            const url = `${BACKEND_BASE_URL}${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: data ? JSON.stringify(data) : null,
            };

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText || 'Unknown error' }));
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorData.error || errorData.message}`);
                }
                return response.status === 204 ? null : await response.json();
            } catch (error) {
                console.error(`Backend API call failed: ${endpoint}`, error);
                tg.showAlert(`Error: ${error.message}`);
                throw error;
            }
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateUniqueId() { return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`; }

        function formatRarity(permille) {
            if (!permille) return 'N/A';
            const percentage = permille / 10;
            const oneInX = Math.round(1000 / percentage);
            return `${percentage}% <span class="one-in-x">(1 of ${oneInX.toLocaleString('en-US')})</span>`;
        }

        function playLottieAnimation(container, path, loop = true, isGridItem = false) {
            if (!animationsEnabled) {
                destroyLottieAnimation(container);
                const parentCard = container.closest('.gift-card, .buy-gift-item, .modal-collectible-visual');
                if (parentCard) {
                    const staticFallback = parentCard.querySelector('.static-image-fallback');
                    if(staticFallback) staticFallback.style.display = 'block';
                    container.style.display = 'none';
                }
                return;
            }
            if (!container || !path) return;
            if (container.lottieInstance) { container.lottieInstance.destroy(); delete container.lottieInstance; }
            container.innerHTML = '';
            const anim = bodymovin.loadAnimation({ container: container, path: path, renderer: 'svg', loop: loop, autoplay: true });
            container.lottieInstance = anim;
            if (isGridItem && !loop) {
                anim.addEventListener('complete', () => { if (container.lottieInstance === anim) container.dataset.playedOnce = 'true'; });
            }
        }
        function destroyLottieAnimation(container) {
            if (container && container.lottieInstance) {
                container.lottieInstance.destroy();
                delete container.lottieInstance; delete container.dataset.playedOnce; container.innerHTML = '';
            }
        }
        function handleLottieIntersection(entries, observer) {
            entries.forEach(entry => {
                const cardElement = entry.target;
                const lottieContainer = cardElement.querySelector('.lottie-animation-container');
                const staticFallback = cardElement.querySelector('.static-image-fallback');
                const lottiePath = cardElement.dataset.lottiePath;
                if (entry.isIntersecting) {
                    if (animationsEnabled && lottiePath && lottieContainer) {
                        if(staticFallback) staticFallback.style.display = 'none';
                        lottieContainer.style.display = 'flex';
                        playLottieAnimation(lottieContainer, lottiePath, false, true);
                    }
                } else {
                    if (lottieContainer) {
                        destroyLottieAnimation(lottieContainer);
                        if(staticFallback) staticFallback.style.display = 'block';
                        lottieContainer.style.display = 'none';
                    }
                }
            });
        }
        function initLottieObserver() {
            lottieIntersectionObserver = new IntersectionObserver(handleLottieIntersection, { root: null, rootMargin: '100px', threshold: 0.01 });
        }
        function observeLottieElement(element) {
            if (lottieIntersectionObserver && element.dataset.lottiePath) lottieIntersectionObserver.observe(element);
        }
        function unobserveLottieElement(element) {
             if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.unobserve(element);
                const lottieContainer = element.querySelector('.lottie-animation-container');
                if(lottieContainer) destroyLottieAnimation(lottieContainer);
            }
        }

        async function initApp() {
            tg.ready(); tg.expand();
            initLottieObserver();

            // collectibleActionCopyLink.querySelector('.icon').innerHTML = LINK_SVG; // Button removed
            collectibleActionWear.querySelector('.icon').innerHTML = CROWN_SVG;
            collectibleActionSell.querySelector('.icon').innerHTML = LABEL_SVG;
            collectibleActionTransfer.querySelector('.icon').innerHTML = DIAMOND_SVG;
            collectibleMenuButton.innerHTML = MENU_DOTS_SVG;

            loadClientSideState();

            const startAppParam = tg.initDataUnsafe?.start_param;
            if (startAppParam) {
                // IMPORTANT: Always initialize our own user first to have a valid currentAccountTgId
                await initializeTelegramUserAccount();
                if (startAppParam.startsWith('user')) {
                    const username = startAppParam.substring(4);
                    await displayUserProfile(username);
                } else if (startAppParam.startsWith('gift')) {
                    const giftString = startAppParam.substring(4);
                    const lastHyphenIndex = giftString.lastIndexOf('-');
                    if (lastHyphenIndex > -1) {
                        const giftTypeId = giftString.substring(0, lastHyphenIndex);
                        const collectibleNumber = parseInt(giftString.substring(lastHyphenIndex + 1), 10);
                        if (giftTypeId && !isNaN(collectibleNumber)) {
                            await displayDeepLinkedGift(giftTypeId, collectibleNumber);
                        } else {
                            tg.showAlert("Invalid gift format in deep link.");
                        }
                    } else {
                         tg.showAlert("Invalid gift format in deep link.");
                    }
                }
            } else {
                await initializeTelegramUserAccount();
            }

            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            tg.SettingsButton.show();
            tg.SettingsButton.onClick(openSettingsModal);

            setupEventListeners();
            await fetchGiftPrices();
            await fetchAvailableGifts();
        }

        async function initializeTelegramUserAccount() {
            manageBackButton(false);
            viewingOwnProfile = true;
            const user = tg.initDataUnsafe?.user;
            let tg_id = user?.id;

            if (!tg_id) {
                let mockAccount = JSON.parse(localStorage.getItem('giftSimMockTgUser' + APP_VERSION_SUFFIX));
                if (!mockAccount) {
                    mockAccount = {
                        tg_id: Math.floor(Math.random() * 1e9) + 1,
                        username: `mockuser_${Math.random().toString(36).substring(2, 6)}`,
                        full_name: `Mock User ${Math.floor(Math.random() * 100)}`,
                        avatar_url: `https://i.pravatar.cc/140?u=mock_${generateUniqueId()}`
                    };
                    localStorage.setItem('giftSimMockTgUser' + APP_VERSION_SUFFIX, JSON.stringify(mockAccount));
                }
                tg_id = mockAccount.tg_id;
            }

            try {
                const accountData = await callBackend('/api/account', 'POST', {
                    tg_id: tg_id,
                    username: user?.username,
                    full_name: user ? [user.first_name, user.last_name].filter(Boolean).join(' ') : 'Original User Name',
                    avatar_url: user?.photo_url || `https://i.pravatar.cc/140?u=${tg_id}`
                });

                currentAccountTgId = accountData.tg_id;
                ownedGifts = accountData.owned_gifts || [];

                let existingAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                if (existingAccount) {
                    Object.assign(existingAccount, accountData);
                } else {
                    accounts.push(accountData);
                }
                saveClientSideAccounts();
                renderAll();
                console.log("Account data loaded successfully.");
            } catch (error) {
                console.error("Failed to initializeTelegramUserAccount:", error);
            }
        }

        async function displayDeepLinkedGift(giftTypeId, collectibleNumber) {
            try {
                const giftData = await callBackend(`/api/gift/${giftTypeId}/${collectibleNumber}`);
                if (giftData) {
                    openModal(collectibleDetailModal, giftData);
                } else {
                    tg.showAlert(`Gift with ID ${giftTypeId} #${collectibleNumber} not found.`);
                }
            } catch (error) {
                console.error("Error fetching deep-linked gift:", error);
            }
        }

        async function displayUserProfile(username) {
             // If we're trying to view our own profile via link, just load it normally
             const ownAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
             if (ownAccount && ownAccount.username && ownAccount.username.toLowerCase() === username.toLowerCase()) {
                 await initializeTelegramUserAccount();
                 return;
             }

             viewingOwnProfile = false;
             try {
                const profileData = await callBackend(`/api/profile/${username}`);
                ownedGifts = profileData.owned_gifts || [];

                profileName.textContent = profileData.full_name || 'User';
                profileAvatar.src = profileData.avatar_url || '';
                profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
                profileUsername.textContent = profileData.username ? `@${profileData.username}` : 'no username';
                profileUsername.onclick = null;
                profileBio.textContent = profileData.bio || "No bio yet";
                profilePhone.textContent = profileData.phone_number || "Not specified";

                collectibleUsernamesContainer.innerHTML = '';
                if (profileData.collectible_usernames && profileData.collectible_usernames.length > 0) {
                    const alsoSpan = document.createElement('span'); alsoSpan.className = 'also-text'; alsoSpan.textContent = 'also';
                    collectibleUsernamesContainer.appendChild(alsoSpan);
                    profileData.collectible_usernames.forEach(uname => {
                        const unameSpan = document.createElement('span'); unameSpan.className = 'collectible-username-span'; unameSpan.textContent = `@${uname}`;
                        collectibleUsernamesContainer.appendChild(unameSpan);
                    });
                }

                manageBackButton(true, () => initializeTelegramUserAccount());

                profileBio.style.cursor = 'default';
                profileBio.onclick = null;
                profileAvatar.style.cursor = 'default';

                renderAll();
            } catch (error) {
                console.error("Error fetching user profile:", error);
                await initializeTelegramUserAccount();
            }
        }

        function manageBackButton(visible, onClickHandler) {
            if (visible) {
                tg.BackButton.show();
                tg.BackButton.onClick(onClickHandler);
            } else {
                tg.BackButton.hide();
                // Always try to remove the last handler to prevent multiple handlers from stacking up.
                if (tg._backButtonCallback) {
                     tg.BackButton.offClick(tg._backButtonCallback);
                     delete tg._backButtonCallback;
                }
                if (onClickHandler) {
                    tg._backButtonCallback = onClickHandler; // Store reference to the new handler
                }
            }
        }

        function applyTheme(themeParams) {
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1');
                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                if (upgradeAllGiftsButton) upgradeAllGiftsButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitFilterModeButton) exitFilterModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitReorderModeButton) exitReorderModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                applyWornGiftStyles();
            } else console.log("Using default CSS variables as themeParams are empty.");
        }

        function loadUserData() {
            const account = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!account) return;

            profileName.textContent = account.full_name || 'User';
            profileAvatar.src = account.avatar_url || '';
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
            profileUsername.textContent = account.username ? `@${account.username}` : 'no username';
            profileUsername.onclick = () => { if(account.username) displayUserProfile(account.username); };
            profileBio.textContent = account.bio || "No bio yet";
            profilePhone.textContent = account.phone_number || "Not specified";
            profileBio.style.cursor = 'pointer';
            profileAvatar.style.cursor = 'pointer';

            collectibleUsernamesContainer.innerHTML = '';
            if (account.collectible_usernames && account.collectible_usernames.length > 0) {
                const alsoSpan = document.createElement('span');
                alsoSpan.className = 'also-text';
                alsoSpan.textContent = 'also';
                collectibleUsernamesContainer.appendChild(alsoSpan);

                account.collectible_usernames.forEach(uname => {
                    const unameSpan = document.createElement('span');
                    unameSpan.className = 'collectible-username-span';
                    unameSpan.textContent = `@${uname}`;
                    unameSpan.dataset.username = uname;
                    unameSpan.addEventListener('click', () => displayUserProfile(uname));
                    unameSpan.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleDeleteCollectibleUsername(uname);
                    });

                    collectibleUsernamesContainer.appendChild(unameSpan);
                });
            }

            // Update sidebar header
            sidebarCurrentAvatar.src = account.avatar_url;
            sidebarCurrentName.textContent = account.full_name;
        }

        // --- Account Management ---
        function loadClientSideState() {
            animationsEnabled = JSON.parse(localStorage.getItem('animationsEnabled' + APP_VERSION_SUFFIX)) ?? true;
            showHiddenGifts = JSON.parse(localStorage.getItem('showHiddenGifts' + APP_VERSION_SUFFIX)) ?? false;
            activeFilters = JSON.parse(localStorage.getItem('activeFilters' + APP_VERSION_SUFFIX)) || { collection: null, model: null, backdrop: null, pattern: null };

            accounts = JSON.parse(localStorage.getItem('giftSimAccounts' + APP_VERSION_SUFFIX)) || [];
            currentAccountTgId = localStorage.getItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX);
        }

        function saveClientSideState() {
            localStorage.setItem('activeFilters' + APP_VERSION_SUFFIX, JSON.stringify(activeFilters));
            localStorage.setItem('animationsEnabled' + APP_VERSION_SUFFIX, JSON.stringify(animationsEnabled));
            localStorage.setItem('showHiddenGifts' + APP_VERSION_SUFFIX, JSON.stringify(showHiddenGifts));
        }

        function saveClientSideAccounts() {
            try {
                const accountsToStore = accounts.map(acc => ({
                    tg_id: acc.tg_id,
                    username: acc.username,
                    full_name: acc.full_name,
                    avatar_url: acc.avatar_url
                }));
                localStorage.setItem('giftSimAccounts' + APP_VERSION_SUFFIX, JSON.stringify(accountsToStore));
                localStorage.setItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX, currentAccountTgId);
            } catch (e) {
                console.error("Error saving client side accounts:", e);
                if (e.name === 'QuotaExceededError') {
                    tg.showAlert("A storage error occurred. Please clear your browser cache or app data if the problem persists.");
                }
            }
        }

        async function handleAddAccount() {
            const newTgId = Math.floor(Math.random() * 1e12) + 1;
            const newAccountData = {
                tg_id: newTgId,
                username: `testuser_${Math.random().toString(36).substring(2, 8)}`,
                full_name: `Test User ${accounts.length + 1}`,
                avatar_url: `https://i.pravatar.cc/140?u=${newTgId}`
            };

            try {
                const createdAccount = await callBackend('/api/account', 'POST', newAccountData);
                accounts.push(createdAccount);
                await switchAccount(createdAccount.tg_id);
                closeSidebar();
            } catch (error) {
                console.error(error);
            }
        }

        async function switchAccount(tgId) {
            if (currentAccountTgId === tgId) return;
            currentAccountTgId = tgId;
            saveClientSideAccounts();
            await initializeTelegramUserAccount();
        }

        function renderAll() {
            if (viewingOwnProfile) {
                loadUserData();
            }
            renderAccountsList();
            animationToggle.checked = animationsEnabled;
            showHiddenToggle.checked = showHiddenGifts;
            applyWornGiftStyles();
            renderProfileGifts();
            displayFilterExitButton();
        }

        function renderAccountsList() {
            accountsList.innerHTML = '';
            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.dataset.accountId = acc.tg_id;
                li.innerHTML = `<img src="${acc.avatar_url}" alt="Avatar"> <span>${acc.full_name}</span>`;
                if (acc.tg_id === currentAccountTgId) {
                    li.classList.add('active');
                }
                li.addEventListener('click', async () => {
                    if (acc.tg_id !== currentAccountTgId) {
                        await switchAccount(acc.tg_id);
                    }
                    closeSidebar();
                });
                accountsList.appendChild(li);
            });
        }

        function openSidebar() {
            manageBackButton(true, closeSidebar);
            renderAccountsList();
            accountSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            manageBackButton(false);
            accountSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }

        function applyWornGiftStyles() {
            const wornGift = ownedGifts.find(g => g.is_worn === true);

            destroyLottieAnimation(wornGiftIconContainer);
            if (wornGift && wornGift.is_collectible && wornGift.collectible_data) {
                const cd = wornGift.collectible_data;
                if (animationsEnabled && cd.lottieModelPath) {
                    playLottieAnimation(wornGiftIconContainer, cd.lottieModelPath, true);
                } else if (cd.modelImage) {
                    wornGiftIconContainer.innerHTML = `<img src="${cd.modelImage}" style="width:100%; height:100%; object-fit:contain;">`;
                }
                wornGiftIconContainer.classList.remove('hidden');
                const colors = cd.backdropColors;
                if (colors) profileTopSection.style.background = `radial-gradient(circle at 50% 0%, ${colors.centerColor} 0%, ${colors.edgeColor} 100%)`;
                else profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                if (cd.patternImage) {
                    profileHeaderPatternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                    profileHeaderPatternOverlay.style.opacity = '0.07';
                } else profileHeaderPatternOverlay.style.backgroundImage = 'none';
            } else {
                wornGiftIconContainer.classList.add('hidden');
                wornGiftIconContainer.innerHTML = '';
                profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                profileHeaderPatternOverlay.style.backgroundImage = 'none';
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId === 'buy-gifts-page') {
                manageBackButton(true, () => showPage('profile-page'));
            } else {
                manageBackButton(false);
            }
        }

        async function fetchGiftPrices() {
            try {
                const response = await fetch(PRICES_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                giftPrices = await response.json();
            } catch (error) {
                console.error("Could not fetch gift prices:", error);
                giftPrices = {};
            }
        }

        async function fetchAvailableGifts() {
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allAvailableGifts = await response.json();

                // Add custom gift to the end of the list
                // Add all custom gifts to the end of the list
                for (const giftName in CUSTOM_GIFTS_DATA) {
                    const customGift = CUSTOM_GIFTS_DATA[giftName];
                    if (customGift && customGift.id) {
                        allAvailableGifts[customGift.id] = giftName;
                    }
                 }

                renderAvailableGifts();
                populateFilterOptions();
            } catch (error) {
                console.error("Could not load available gifts:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Could not load gifts. Please try again later.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }

        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            if (Object.keys(allAvailableGifts).length === 0 && !buyGiftsLoadingSpinner.classList.contains('hidden')) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">No gifts available right now.</p>`; return;
            }
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                let originalImageUrl, lottiePath;

                // --- CORRECTED LOGIC ---
                // Check if the gift's name exists as a key in our custom data object
                if (CUSTOM_GIFTS_DATA[name]) {
                    // If it's a custom gift, get its specific default image
                    originalImageUrl = CUSTOM_GIFTS_DATA[name].defaultImage;
                    lottiePath = null; // Custom gifts in this app don't have a default Lottie
                } else {
                    // Otherwise, it's a standard CDN gift, so build the URL as before
                    originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                    lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
                }

                const price = giftPrices[name];

                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id; item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;
                if (lottiePath) {
                    item.dataset.lottiePath = lottiePath;
                }

                const priceHTML = price
                    ? `<div class="gift-price has-price"><img src="${STAR_ICON_URL}" class="star-icon" alt="Star"/> ${price}</div>`
                    : `<div class="gift-price">Free</div>`;

                item.innerHTML = `
                    <div class="image-container">
                        <div class="lottie-animation-container" style="display:none;"></div>
                        <img class="static-image-fallback" src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.innerHTML = '🖼️';">
                    </div>
                    <div class="gift-name">${name}</div>
                    ${priceHTML}
                    <div class="limited-label">Limited</div>
                `;
                item.addEventListener('click', () => buyGift(id, name, originalImageUrl, lottiePath, 1));

                let buyItemLongPressTimer;
                item.addEventListener('touchstart', (e) => { buyItemLongPressTimer = setTimeout(() => openBuyMultipleModal(id, name, originalImageUrl, lottiePath), 700); }, { passive: true });
                item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('contextmenu', (e) => { e.preventDefault(); openBuyMultipleModal(id, name, originalImageUrl, lottiePath); });

                observeLottieElement(item);
                buyGiftsGrid.appendChild(item);
            }
        }

        function getGiftCountText(count) {
            return count === 1 ? `${count} gift` : `${count} gifts`;
        }

        function updateAllAnimationsState() {
            document.querySelectorAll('.lottie-animation-container').forEach(container => {
                const parentCard = container.closest('[data-lottie-path]');
                const modal = container.closest('.modal-overlay.active');

                if (animationsEnabled) {
                    if (parentCard && parentCard.offsetParent !== null) { observeLottieElement(parentCard); }
                    else if (container.id === 'worn-gift-icon-container') { applyWornGiftStyles(); }
                    else if (modal) {
                         if (container.id === 'modal-lottie-gift-original' && giftDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === giftDetailModal.dataset.instanceId);
                             if (gift && gift.lottie_path) playLottieAnimation(container, gift.lottie_path, true);
                         }
                         if (container.id === 'modal-lottie-collectible-model' && collectibleDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                             if (gift?.collectible_data?.lottieModelPath) playLottieAnimation(container, gift.collectible_data.lottieModelPath, true);
                         }
                    } else if (container.closest('#profile-top-pinned-gifts')) { renderTopPinnedGiftsPreview(); }
                } else {
                    destroyLottieAnimation(container);
                    if (parentCard) {
                        const staticFallback = parentCard.querySelector('.static-image-fallback');
                        if (staticFallback) staticFallback.style.display = 'block';
                        container.style.display = 'none';
                    }
                }
            });
            applyWornGiftStyles();
        }

        function renderProfileGifts() {
            Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
            giftsGrid.innerHTML = '';

            const baseGifts = showHiddenGifts ? ownedGifts : ownedGifts.filter(g => !g.is_hidden);

            const filteredGifts = baseGifts.filter(gift => {
                if (activeFilters.collection && gift.gift_type_id !== activeFilters.collection) return false;
                if (gift.is_collectible && gift.collectible_data) {
                    if (activeFilters.model && gift.collectible_data.model?.name !== activeFilters.model) return false;
                    if (activeFilters.backdrop && gift.collectible_data.backdrop?.name !== activeFilters.backdrop) return false;
                    if (activeFilters.pattern && gift.collectible_data.pattern?.name !== activeFilters.pattern) return false;
                } else if (activeFilters.model || activeFilters.backdrop || activeFilters.pattern) return false;
                return true;
            });

            profileGiftCountSubtext.textContent = getGiftCountText(filteredGifts.length);
            if (ownedGifts.length > 0 && filteredGifts.length !== ownedGifts.length) {
                profileGiftCountSubtext.textContent += ` of ${ownedGifts.length}`;
            }

            currentlySortedGifts = filteredGifts;

            if (currentlySortedGifts.length === 0) {
                giftsGrid.style.display = 'flex'; giftsGrid.style.alignItems = 'center'; giftsGrid.style.justifyContent = 'center';
                let emptyMessage = "You don't have any gifts yet.";
                if (ownedGifts.length > 0) {
                    emptyMessage = "No gifts match the selected filters.";
                    if (!showHiddenGifts && ownedGifts.some(g => g.is_hidden)) {
                        emptyMessage += " Some gifts might be hidden.";
                    }
                } else if (!viewingOwnProfile) {
                     emptyMessage = "This user hasn't received any gifts yet."
                }
                giftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">${emptyMessage}</p>`;
            } else {
                giftsGrid.style.display = 'grid';
                currentlySortedGifts.forEach(gift => {
                    const card = createGiftCardDOM(gift);
                    giftsGrid.appendChild(card);
                    observeLottieElement(card);
                });
            }
            renderTopPinnedGiftsPreview();
            const hasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            if (upgradeAllGiftsButton) {
                upgradeAllGiftsButton.style.display = (hasNonCollectible && viewingOwnProfile && !reorderModeActive && !selectionModeActive) ? 'inline-block' : 'none';
                if (!hasNonCollectible) { upgradeAllGiftsButton.textContent = '✨ Upgrade All'; upgradeAllGiftsButton.disabled = false; }
            }
            if(goToBuyGiftsButton) goToBuyGiftsButton.style.display = (viewingOwnProfile && !reorderModeActive && !selectionModeActive) ? 'inline-block' : 'none';
            displayFilterExitButton();
        }

        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instance_id;
            card.dataset.pinned = gift.is_pinned;

            if (gift.is_hidden) card.classList.add('is-hidden');

            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none';
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
            let lottiePathForCard = null;

            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                staticImage.src = cd.modelImage || gift.original_image_url;
                staticImage.alt = cd.model?.name || gift.gift_name;
                lottiePathForCard = cd.lottieModelPath;

                const labelDiv = document.createElement('div');
                labelDiv.className = 'top-right-label';
                if (gift.is_pinned) {
                    labelDiv.textContent = `#${gift.collectible_number.toLocaleString()}`;
                } else if (cd.supply) {
                    labelDiv.textContent = `1 of ${(cd.supply / 1000).toFixed(1)}K`;
                }
                card.appendChild(labelDiv);

                const bgDiv = document.createElement('div'); bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                else bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                card.appendChild(bgDiv);

                if (cd.patternImage) { const pOverlay = document.createElement('div'); pOverlay.className = 'gift-card-pattern-overlay'; pOverlay.style.backgroundImage = `url('${cd.patternImage}')`; card.appendChild(pOverlay); }
            } else {
                staticImage.src = gift.original_image_url; staticImage.alt = gift.gift_name;
                lottiePathForCard = gift.lottie_path;
            }
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
            staticImage.onerror = function() { this.style.display='none'; lottieContainer.innerHTML = '🖼️';};
            imageContainer.appendChild(lottieContainer); imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
            if (gift.is_pinned && !selectionModeActive) {
                const pinDiv = document.createElement('div'); pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG;
                pinDiv.querySelector('svg').style.transform = 'rotate(25deg)';
                card.appendChild(pinDiv);
            }

            if (selectionModeActive) {
                const checkbox = document.createElement('div');
                checkbox.className = 'selection-checkbox';
                card.appendChild(checkbox);
                if (selectedGiftIds.has(gift.instance_id)) {
                    card.classList.add('selected');
                }
                card.onclick = () => toggleGiftSelection(gift.instance_id);
            } else if (reorderModeActive) {
                card.style.cursor = gift.is_pinned ? 'grab' : 'default';
            } else {
                card.onclick = () => openGiftDetailByInstanceId(gift.instance_id);
                if (viewingOwnProfile) setupLongPress(card, gift);
            }

            return card;
        }

        function renderTopPinnedGiftsPreview() {
            Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => destroyLottieAnimation(childLottieContainer));
            profileTopPinnedGifts.innerHTML = '';

            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden);

            pinnedGifts.slice(0, 7).forEach(gift => {
                const container = document.createElement('div');
                container.className = 'pinned-gift-item';
                container.dataset.instanceId = gift.instance_id;
                container.addEventListener('click', () => openGiftDetailByInstanceId(gift.instance_id));
                let lottiePathForPinned = null, imageForPinned = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    lottiePathForPinned = gift.collectible_data.lottieModelPath;
                    imageForPinned = gift.collectible_data.modelImage || gift.original_image_url;
                } else if (gift.lottie_path) {
                    lottiePathForPinned = gift.lottie_path;
                }
                if (animationsEnabled && lottiePathForPinned) {
                    container.classList.add('lottie-animation-container');
                    playLottieAnimation(container, lottiePathForPinned, true);
                } else {
                     container.innerHTML = `<img src="${imageForPinned}" alt="${gift.gift_name}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.innerHTML = '🎁'">`;
                }
                profileTopPinnedGifts.appendChild(container);
            });
        }

        function openBuyMultipleModal(id, name, originalImage, lottiePath) {
            currentGiftToBuyMultiple = { id, name, originalImage, lottiePath };
            buyMultipleModalTitle.textContent = `Buy "${name}"`;
            buyMultipleGiftName.textContent = `Enter quantity for "${name}"`;
            buyMultipleQuantityInput.value = "1";
            openModal(buyMultipleModal);
            buyMultipleQuantityInput.focus();
        }

        async function buyGift(id, name, originalImage, lottiePath, quantity = 1) {
            if (ownedGifts.length + quantity > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot buy ${quantity} gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            try {
                let lastPinnedIndex = -1;
                for(let i = ownedGifts.length - 1; i >= 0; i--) {
                    if (ownedGifts[i].is_pinned) {
                        lastPinnedIndex = i;
                        break;
                    }
                }
                const insertIndex = lastPinnedIndex + 1;

                for (let i = 0; i < quantity; i++) {
                    const newGiftInstanceId = generateUniqueId();
                    await callBackend('/api/gifts', 'POST', {
                        instance_id: newGiftInstanceId,
                        owner_id: currentAccountTgId,
                        gift_type_id: id,
                        gift_name: name,
                        original_image_url: originalImage,
                        lottie_path: lottiePath
                    });

                    const newGift = {
                        instance_id: newGiftInstanceId,
                        owner_id: currentAccountTgId,
                        gift_type_id: id,
                        gift_name: name,
                        original_image_url: originalImage,
                        lottie_path: lottiePath,
                        is_collectible: false,
                        acquired_date: new Date().toISOString()
                    };
                    ownedGifts.splice(insertIndex, 0, newGift);
                }

                renderProfileGifts();
                tg.HapticFeedback.notificationOccurred('success');
                const message = quantity > 1 ? `Added ${quantity} "${name}" gifts!` : `Added "${name}" gift!`;
                tg.showAlert(message);
                showPage('profile-page');

            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        async function handleConfirmBuyMultiple() {
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) { tg.showAlert("Please enter a valid quantity."); return; }

            confirmBuyMultipleButton.disabled = true;
            confirmBuyMultipleButton.textContent = 'Buying...';

            await buyGift(currentGiftToBuyMultiple.id, currentGiftToBuyMultiple.name, currentGiftToBuyMultiple.originalImage, currentGiftToBuyMultiple.lottiePath, quantity);

            confirmBuyMultipleButton.disabled = false;
            confirmBuyMultipleButton.textContent = 'Buy';
            closeModal(buyMultipleModal);
            currentGiftToBuyMultiple = null;
        }

        function getGiftDeepLink(gift) {
            const botUsername = "upgradeDemoBot";
            const appShortName = "upgrade";
            const giftTypeIdForLink = gift.gift_type_id;
            const numberForLink = gift.collectible_number;
            return `https://t.me/${botUsername}/${appShortName}?startapp=gift${giftTypeIdForLink}-${numberForLink}`;
        }

        function openGiftDetailByInstanceId(instanceId) {
            const gift = currentlySortedGifts.find(g => g.instance_id === instanceId) || ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift) return;
            tapCount = 0;

            if (gift.is_collectible) {
                openModal(collectibleDetailModal, gift);
            } else {
                openModal(giftDetailModal, gift);
            }
        }

        async function upgradeSingleGiftLogic(giftToUpgrade) {
            if (giftToUpgrade.is_collectible) return { instance_id: giftToUpgrade.instance_id, name: giftToUpgrade.gift_name, status: 'skipped' };

            try {
                const upgradedGiftData = await callBackend('/api/gifts/upgrade', 'POST', { instance_id: giftToUpgrade.instance_id });
                if (upgradedGiftData) {
                    const giftIndex = ownedGifts.findIndex(g => g.instance_id === upgradedGiftData.instance_id);
                    if(giftIndex !== -1) {
                        ownedGifts[giftIndex] = upgradedGiftData;
                    }
                    return { ...upgradedGiftData, status: 'success' };
                } else {
                    throw new Error("Backend did not return upgraded gift data.");
                }
            } catch (error) {
                console.error(`Upgrade error for "${giftToUpgrade.gift_name}" (ID: ${giftToUpgrade.instance_id}):`, error);
                return { instance_id: giftToUpgrade.instance_id, name: giftToUpgrade.gift_name, status: 'failed', error: error.message };
            }
        }

        async function handleSingleGiftUpgradeFromModal(instanceId) {
            const gift = ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift || gift.is_collectible) return;

            const upgradeButton = document.getElementById(`modal-action-upgrade-gift-${instanceId}`);
            const uniquenessValueEl = document.getElementById(`modal-uniqueness-value-${instanceId}`);
            if (upgradeButton) { upgradeButton.textContent = 'Upgrading...'; upgradeButton.disabled = true; }
            if (uniquenessValueEl) uniquenessValueEl.textContent = 'Processing...';

            try {
                const result = await upgradeSingleGiftLogic(gift);
                if (result.status === 'success') {
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => { closeModal(giftDetailModal); openGiftDetailByInstanceId(gift.instance_id); }, 1200);
                } else if (result.status === 'failed') {
                    if (uniquenessValueEl) uniquenessValueEl.textContent = 'Error';
                    if (upgradeButton) { upgradeButton.textContent = 'Upgrade'; upgradeButton.disabled = false; }
                }
            } catch (error) {
                console.error("Error during single gift upgrade:", error);
                if (uniquenessValueEl) uniquenessValueEl.textContent = 'Error';
                if (upgradeButton) { upgradeButton.textContent = 'Upgrade'; upgradeButton.disabled = false; }
            }
        }

        async function handleUpgradeAllGifts() {
            const giftsToUpgrade = ownedGifts.filter(g => !g.is_collectible);
            if (giftsToUpgrade.length === 0) { tg.showAlert("No gifts to upgrade."); return; }

            if (ownedGifts.length > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot upgrade all gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            let successCount = 0, failureCount = 0;
            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `Upgrading (${i + 1}/${giftsToUpgrade.length})...`;
                const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${gift.instance_id}"]`);
                if (cardElement) cardElement.classList.add('is-updating');
                const result = await upgradeSingleGiftLogic(gift);
                if (cardElement) cardElement.classList.remove('is-updating');
                if (result.status === 'success') {
                    successCount++;
                    renderProfileGifts();
                } else if (result.status === 'failed') failureCount++;
                if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length - 1) await new Promise(resolve => setTimeout(resolve, 200));
            }

            let summaryMessage = `Upgrade complete.\nSucceeded: ${successCount}`;
            if (failureCount > 0) summaryMessage += `\nFailed: ${failureCount}`;
            tg.showAlert(summaryMessage);
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));
            const stillHasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            upgradeAllGiftsButton.style.display = stillHasNonCollectible ? 'inline-block' : 'none';
            if (stillHasNonCollectible) { upgradeAllGiftsButton.textContent = originalButtonText; upgradeAllGiftsButton.disabled = false; }
        }

        function openModal(modalElement, data = null) {
            if (!modalElement) return;

            if(data) modalElement.dataset.instanceId = data.instance_id;

            if (modalElement.id === 'gift-detail-modal' && data) {
                populateGiftDetailModal(data);
            } else if (modalElement.id === 'collectible-detail-modal' && data) {
                populateCollectibleDetailModal(data);
            } else if (modalElement.id === 'giveaway-setup-modal') {
                 populateGiveawaySetupModal();
            }

            modalElement.classList.add('active');
            manageBackButton(true, () => closeModal(modalElement));
        }

        function closeModal(modalElement) {
            if (!modalElement) return;
            const handler = tg._backButtonCallback;
            manageBackButton(false, handler);

            modalElement.classList.remove('active');

            if (modalElement.id === 'gift-detail-modal') destroyLottieAnimation(modalLottieGiftOriginal);
            if (modalElement.id === 'collectible-detail-modal') {
                destroyLottieAnimation(modalLottieCollectibleModel);
                if (patternContainerDynamic) patternContainerDynamic.innerHTML = '';
            }
            if (modalElement.id === 'custom-buy-modal') selectedCustomGift = {};
            if (modalElement.id === 'giveaway-setup-modal') selectedGiveawayGifts.clear();
        }

        function populateGiftDetailModal(gift) {
            modalGiftName.textContent = "Saved Gift";
            destroyLottieAnimation(modalLottieGiftOriginal);
            modalGiftImageStatic.style.display = 'block'; modalLottieGiftOriginal.style.display = 'none';
            if (animationsEnabled && gift.lottie_path) {
                playLottieAnimation(modalLottieGiftOriginal, gift.lottie_path, true);
                modalGiftImageStatic.style.display = 'none'; modalLottieGiftOriginal.style.display = 'flex';
            } else {
                modalGiftImageStatic.src = gift.original_image_url;
                modalGiftImageStatic.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${generateUniqueId()}`; };
            }
            modalGiftDescription1.textContent = `Add "${gift.gift_name}" to your profile or upgrade it.`;
            modalGiftDescription2.textContent = "Only you can see the sender's name.";
            modalGiftInfo.innerHTML = `
                <div class="info-row"><span class="info-label">Date</span><span class="info-value">${new Date(gift.acquired_date).toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'})}</span></div>
                <div class="info-row"><span class="info-label">Price</span><span class="info-value">Free</span></div>
                <div class="info-row"><span class="info-label">Availability</span><span class="info-value">Limited</span></div>
                <div class="info-row" id="uniqueness-row-${gift.instance_id}"><span class="info-label">Uniqueness</span><div class="info-value-with-action"><span id="modal-uniqueness-value-${gift.instance_id}">Standard</span><button id="modal-action-upgrade-gift-${gift.instance_id}" class="button-link-styled" data-instance-id="${gift.instance_id}">Upgrade</button></div></div>`;

            const upgradeButton = modalGiftInfo.querySelector(`#modal-action-upgrade-gift-${gift.instance_id}`);
            if (upgradeButton) {
                if (gift.owner_id === currentAccountTgId) {
                    upgradeButton.addEventListener('click', (e) => handleSingleGiftUpgradeFromModal(e.target.dataset.instanceId));
                    let upgradeLongPressTimer;
                    upgradeButton.addEventListener('touchstart', (e) => { upgradeLongPressTimer = setTimeout(() => openChancesModal(gift), 700); }, { passive: true });
                    upgradeButton.addEventListener('touchend', () => clearTimeout(upgradeLongPressTimer));
                    upgradeButton.addEventListener('touchmove', () => clearTimeout(upgradeLongPressTimer));
                    upgradeButton.addEventListener('contextmenu', (e) => { e.preventDefault(); openChancesModal(gift); });
                } else {
                    upgradeButton.disabled = true;
                    upgradeButton.textContent = "Cannot Upgrade";
                    upgradeButton.style.cursor = 'not-allowed';
                }
            }
        }

        async function populateCollectibleDetailModal(gift) {
            const cd = gift.collectible_data;
            modalCollectibleMainName.textContent = cd.model?.name || gift.gift_name;

            const numberForLink = gift.collectible_number;
            modalCollectibleNumberSubtext.innerHTML = `<a id="collectible-link-copier" href="#">Collectible #${numberForLink.toLocaleString()}</a>`;
            document.getElementById('collectible-link-copier').onclick = (e) => { e.preventDefault(); copyGiftLink(gift); };

            // Clear previous patterns
            if (patternContainerDynamic) patternContainerDynamic.innerHTML = '';

            // Apply Backdrop Gradient (dynamically from collectible_data.backdrop.hex)
            if (collectibleDisplayArea && cd.backdropColors) {
                collectibleDisplayArea.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            } else {
                collectibleDisplayArea.style.background = 'var(--tg-theme-secondary-bg-color)';
            }

            // Populate Pattern Container with structured layout
            if (cd.patternImage && patternContainerDynamic) {
                // Use a short timeout to ensure the container has dimensions before we calculate positions
                setTimeout(() => {
                    const containerWidth = patternContainerDynamic.offsetWidth;
                    const containerHeight = patternContainerDynamic.offsetHeight;
                    const centerX = containerWidth / 2;
                    const centerY = containerHeight / 2 - 30;

                    const createPattern = (styles) => {
                        const img = document.createElement('img');
                        img.src = cd.patternImage;
                        img.className = 'dynamic-pattern-instance';
                        img.crossOrigin = 'Anonymous';
                        const baseRotation = -25;
                        img.style.transform = `translate(-50%, -50%) rotate(${baseRotation}deg) scale(${styles.scale || 0.9})`;
                        img.style.left = `${styles.left}px`;
                        img.style.top = `${styles.top}px`;
                        patternContainerDynamic.appendChild(img);
                    };

                    const circleRadius = Math.min(containerWidth, containerHeight) / 3.2;
                    const numCirclePatterns = 10;
                    for (let i = 0; i < numCirclePatterns; i++) {
                        const angle = (i / numCirclePatterns) * 2 * Math.PI;
                        const x = centerX + circleRadius * Math.cos(angle);
                        const y = centerY + circleRadius * Math.sin(angle);
                        createPattern({ left: x, top: y, scale: 0.9 });
                    }

                    const leftRowStartX = containerWidth * 0.15;
                    const leftRowStartY = containerHeight * 0.2;
                    const leftRowYStep = containerHeight * 0.18;
                    for (let i = 0; i < 4; i++) {
                        const x = leftRowStartX - (i * 5);
                        const y = leftRowStartY + (i * leftRowYStep);
                        createPattern({ left: x, top: y, scale: 0.85 });
                    }

                    const rightRowStartX = containerWidth * 0.85;
                    const rightRowStartY = containerHeight * 0.2;
                    const rightRowYStep = containerHeight * 0.18;
                    for (let i = 0; i < 4; i++) {
                        const x = rightRowStartX + (i * 5);
                        const y = rightRowStartY + (i * rightRowYStep);
                        createPattern({ left: x, top: y, scale: 0.85 });
                    }
                }, 50);
            }

            // Render main model image/Lottie
            destroyLottieAnimation(modalLottieCollectibleModel);
            modalCollectibleModelImgStatic.style.display = 'block';
            modalLottieCollectibleModel.style.display = 'none';
            if (animationsEnabled && cd.lottieModelPath) {
                playLottieAnimation(modalLottieCollectibleModel, cd.lottieModelPath, true);
                modalCollectibleModelImgStatic.style.display = 'none';
                modalLottieCollectibleModel.style.display = 'flex';
            } else {
                 modalCollectibleModelImgStatic.src = cd.modelImage || gift.original_image_url;
                 modalCollectibleModelImgStatic.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${generateUniqueId()}`; };
            }

            // --- OWNER DISPLAY LOGIC (FIXED) ---
            let ownerName, ownerAvatar, ownerUsername;
            const isOwner = (gift.owner_id === currentAccountTgId);
            if(isOwner) {
                const myAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                ownerName = myAccount.full_name;
                ownerAvatar = myAccount.avatar_url;
                ownerUsername = myAccount.username;
            } else {
                ownerName = gift.owner_name || 'Test Account';
                ownerAvatar = gift.owner_avatar || `https://i.pravatar.cc/140?u=${generateUniqueId()}`;
                ownerUsername = gift.owner_username;
            }

            const ownerDisplayHTML = ownerUsername
                ? `<a href="#" onclick="event.preventDefault(); displayUserProfile('${ownerUsername}')"><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</a>`
                : `<span><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</span>`;

            modalCollectibleInfoTable.innerHTML = `
                <div class="info-row"><span class="info-label">Owner</span><span class="info-value">${ownerDisplayHTML}</span></div>
                <div class="info-row"><span class="info-label">Model</span><span id="collectible-model-value" class="info-value clickable-info">${cd.model?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.model?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Backdrop</span><span id="collectible-backdrop-value" class="info-value clickable-info">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.backdrop?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Symbol</span><span id="collectible-pattern-value" class="info-value clickable-info">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.pattern?.rarityPermille || 0)}</span></span></div>
                <div class="info-row"><span class="info-label">Supply</span><span class="info-value">${cd.supply?.toLocaleString() || 'N/A'} issued</span></div>`;

            // Button visibility
            collectibleActionWear.style.display = isOwner ? 'flex' : 'none';
            collectibleActionSell.style.display = isOwner ? 'flex' : 'none';
            collectibleActionTransfer.style.display = isOwner ? 'flex' : 'none';
            collectibleMenuButton.style.display = isOwner ? 'flex' : 'none';
            hideLinkInModal.style.display = isOwner ? 'inline' : 'none';

            collectibleActionWear.querySelector('.text').textContent = (gift.is_worn === true) ? 'Take Off' : 'Wear';

            const modelValueEl = document.getElementById('collectible-model-value');
            const backdropValueEl = document.getElementById('collectible-backdrop-value');
            const patternValueEl = document.getElementById('collectible-pattern-value');
            if (modelValueEl) modelValueEl.addEventListener('click', (e) => handleTripleTap(e, 'model', gift.collectible_data.model?.name));
            if (backdropValueEl) backdropValueEl.addEventListener('click', (e) => handleTripleTap(e, 'backdrop', gift.collectible_data.backdrop?.name));
            if (patternValueEl) patternValueEl.addEventListener('click', (e) => handleTripleTap(e, 'pattern', gift.collectible_data.pattern?.name));
        }

        let currentLongPressGift = null; let longPressTimer;
        function setupLongPress(element, gift) {
            element.addEventListener('touchstart', (e) => {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => openLongPressMenu(gift, e.touches[0]), 500);
            }, { passive: false });
            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => { e.preventDefault(); clearTimeout(longPressTimer); openLongPressMenu(gift, e); });
        }
        function openLongPressMenu(gift, eventCoords) {
            currentLongPressGift = gift;

            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) {
                menuPinAction.textContent = 'Pin (Collectibles only)';
                menuPinAction.classList.add('disabled');
                menuShareImageAction.classList.add('hidden');
                menuCopyLinkAction.classList.add('hidden');
                menuReorderAction.classList.add('hidden');
            } else {
                const isPinned = gift.is_pinned;
                menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin';
                menuPinAction.classList.toggle('disabled', !isOwner);
                menuShareImageAction.classList.remove('hidden');
                menuCopyLinkAction.classList.add('hidden');
                menuReorderAction.classList.toggle('hidden', !isPinned || !isOwner);
            }

            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);

            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function openCollectibleMenu(gift, eventCoords) {
            currentLongPressGift = gift;
            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) return;

            const isPinned = gift.is_pinned;
            menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin';
            menuPinAction.classList.toggle('disabled', !isOwner);

            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);
            menuShareImageAction.classList.remove('hidden');
            menuCopyLinkAction.classList.add('hidden');
            menuReorderAction.classList.toggle('hidden', !isPinned || !isOwner);

            const menuWidth = longPressMenu.offsetWidth || 220;
            const menuHeight = longPressMenu.offsetHeight || 150;
            let x = window.innerWidth - menuWidth - 20;
            let y = (collectibleMenuButton.getBoundingClientRect().top + collectibleMenuButton.offsetHeight + 10);
            longPressMenu.style.top = `${Math.min(y, window.innerHeight - menuHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(x, window.innerWidth - menuWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function closeLongPressMenuOnClickOutside(event) {
            if (!longPressMenu.contains(event.target) && event.target !== longPressMenu) { longPressMenu.classList.add('hidden'); currentLongPressGift = null; }
        }

        function handlePinAction() {
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) {
                tg.showAlert("Only collectible gifts can be pinned.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }
            if (currentLongPressGift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only pin gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }
            if (currentLongPressGift.is_hidden) {
                tg.showAlert("Cannot pin a hidden gift.");
                longPressMenu.classList.add('hidden'); return;
            }

            const giftInstanceId = currentLongPressGift.instance_id;
            const isCurrentlyPinned = currentLongPressGift.is_pinned;
            const giftToUpdate = ownedGifts.find(g => g.instance_id === giftInstanceId);
            if (!giftToUpdate) return;

            const currentlyPinnedCount = ownedGifts.filter(g => g.is_pinned && g.owner_id === currentAccountTgId).length;

            if (!isCurrentlyPinned && currentlyPinnedCount >= 6) {
                showTooManyPinsModal();
                longPressMenu.classList.add('hidden');
                return;
            }

            longPressMenu.classList.add('hidden');

            giftToUpdate.is_pinned = !isCurrentlyPinned;
            renderProfileGifts();
            tg.HapticFeedback.impactOccurred(isCurrentlyPinned ? 'light' : 'medium');

            callBackend(`/api/gifts/${giftInstanceId}`, 'PUT', { action: 'pin', value: !isCurrentlyPinned })
                .catch(error => {
                    giftToUpdate.is_pinned = isCurrentlyPinned;
                    renderProfileGifts();
                });

            currentLongPressGift = null;
        }

        function handleHideAction() {
            const giftToUpdate = currentLongPressGift || currentlySortedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId) || ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
            if (!giftToUpdate) return;

            if (giftToUpdate.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only hide gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const isCurrentlyHidden = giftToUpdate.is_hidden;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);

            giftToUpdate.is_hidden = !isCurrentlyHidden;
            if (giftToUpdate.is_pinned && giftToUpdate.is_hidden) {
                giftToUpdate.is_pinned = false;
            }
            if (giftToUpdate.is_worn && giftToUpdate.is_hidden) {
                giftToUpdate.is_worn = false;
            }
            renderProfileGifts();
            applyWornGiftStyles();
            tg.HapticFeedback.impactOccurred('light');

            callBackend(`/api/gifts/${giftToUpdate.instance_id}`, 'PUT', { action: 'hide', value: !isCurrentlyHidden })
                .catch(error => {
                    giftToUpdate.is_hidden = isCurrentlyHidden;
                    renderProfileGifts();
                });
            currentLongPressGift = null;
        }

        function handleDeleteAction() {
            if (!currentLongPressGift || currentLongPressGift.owner_id !== currentAccountTgId) {
                if(currentLongPressGift) tg.showAlert("You can only delete gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const giftToDelete = currentLongPressGift;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);

            tg.showConfirm("Are you sure you want to delete this gift? This action cannot be undone.", (confirmed) => {
                if (confirmed) {
                    const giftIndex = ownedGifts.findIndex(g => g.instance_id === giftToDelete.instance_id);
                    if (giftIndex === -1) return;

                    const removedGift = ownedGifts.splice(giftIndex, 1)[0];
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');

                    callBackend(`/api/gifts/${giftToDelete.instance_id}`, 'DELETE')
                        .catch(error => {
                            tg.HapticFeedback.notificationOccurred('error');
                            ownedGifts.splice(giftIndex, 0, removedGift);
                            renderProfileGifts();
                        });
                }
                currentLongPressGift = null;
            });
        }

        function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';

            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden && g.owner_id === currentAccountTgId);

            pinnedGifts.forEach(pinnedGift => {
                const card = createGiftCardDOM(pinnedGift);
                card.addEventListener('click', async () => {
                    try {
                        await callBackend(`/api/gifts/${pinnedGift.instance_id}`, 'PUT', { action: 'pin', value: false });
                        if (currentLongPressGift && currentLongPressGift.is_collectible) {
                             await callBackend(`/api/gifts/${currentLongPressGift.instance_id}`, 'PUT', { action: 'pin', value: true });
                        }
                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.impactOccurred('medium');
                    } catch (error) {
                       console.error(error);
                    } finally {
                        closeModal(tooManyPinsModal);
                        currentLongPressGift = null;
                    }
                });
                unpinSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
            openModal(tooManyPinsModal);
        }

        function handleWearAction() {
            const currentModalInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentModalInstanceId) return;

            const giftToUpdate = ownedGifts.find(g => g.instance_id === currentModalInstanceId);
            if (!giftToUpdate || giftToUpdate.owner_id !== currentAccountTgId) return;
            if (giftToUpdate.is_hidden) { tg.showAlert("Cannot wear a hidden gift."); return; }

            const isCurrentlyWorn = giftToUpdate.is_worn === true;

            const previouslyWornGift = ownedGifts.find(g => g.is_worn);
            if(previouslyWornGift) previouslyWornGift.is_worn = false;

            giftToUpdate.is_worn = !isCurrentlyWorn;
            collectibleActionWear.querySelector('.text').textContent = giftToUpdate.is_worn ? 'Take Off' : 'Wear';
            applyWornGiftStyles();
            tg.HapticFeedback.impactOccurred('light');

            callBackend(`/api/gifts/${currentModalInstanceId}`, 'PUT', { action: 'wear', value: !isCurrentlyWorn })
                .catch(error => {
                    giftToUpdate.is_worn = isCurrentlyWorn;
                    if(previouslyWornGift) previouslyWornGift.is_worn = true;
                    collectibleActionWear.querySelector('.text').textContent = isCurrentlyWorn ? 'Take Off' : 'Wear';
                    applyWornGiftStyles();
                });
        }

        let filterPopupLongPressTimer;
        function setupFilterPopupTrigger() {
            filterLongPressTarget.addEventListener('touchstart', (e) => { filterPopupLongPressTimer = setTimeout(openFilterPopup, 700); }, { passive: true });
            filterLongPressTarget.addEventListener('touchend', () => clearTimeout(filterPopupLongPressTimer));
            filterLongPressTarget.addEventListener('touchmove', () => clearTimeout(filterPopupLongPressTimer));
            filterLongPressTarget.addEventListener('contextmenu', (e) => { e.preventDefault(); openFilterPopup(); });
        }
        function openFilterPopup() { openModal(filterPopup); }
        function populateFilterOptions() {
            const uniqueCollections = [...new Map(ownedGifts.map(item => [item.gift_type_id, {id: item.gift_type_id, name: item.gift_name, image: item.original_image_url}])).values()];
            renderFilterOptions(filterOptionsCollections, uniqueCollections, 'collection', (item) => `<img src="${item.image}" alt="${item.name}">`);

            if (activeFilters.collection) {
                const giftsInCollection = ownedGifts.filter(g => g.gift_type_id === activeFilters.collection && g.is_collectible && g.collectible_data?.model);
                const uniqueModels = [...new Map(giftsInCollection.map(item => [item.collectible_data.model.name, {name: item.collectible_data.model.name, image: item.collectible_data.modelImage}])).values()];
                renderFilterOptions(filterOptionsModels, uniqueModels, 'model', (item) => `<img src="${item.image}" alt="${item.name}">`);
                filterModelsSection.classList.remove('hidden');
            } else { filterModelsSection.classList.add('hidden'); filterOptionsModels.innerHTML = ''; }

            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && g.collectible_data?.backdrop);
            const uniqueBackdrops = [...new Map(collectibleGifts.map(item => [item.collectible_data.backdrop.name, {name: item.collectible_data.backdrop.name, colors: item.collectible_data.backdropColors}])).values()];
            renderFilterOptions(filterOptionsBackdrops, uniqueBackdrops, 'backdrop', (item) => `<div class="gradient-square" style="background: radial-gradient(circle, ${item.colors.centerColor}, ${item.colors.edgeColor});"></div>`);

            const uniquePatterns = [...new Map(ownedGifts.filter(g => g.is_collectible && g.collectible_data && g.collectible_data.pattern).map(item => [item.collectible_data.pattern.name, {name: item.collectible_data.pattern.name, image: item.collectible_data.patternImage}])).values()];
            renderFilterOptions(filterOptionsPatterns, uniquePatterns, 'pattern', (item) => `<img src="${item.image}" alt="${item.name}">`);
        }
        function renderFilterOptions(container, items, filterType, displayFn) {
            container.innerHTML = '';
            items.forEach(item => {
                const optionEl = document.createElement('div'); optionEl.className = 'filter-option';
                optionEl.innerHTML = displayFn(item);
                const valueToCompare = filterType === 'collection' ? item.id : item.name;
                if (activeFilters[filterType] === valueToCompare) optionEl.classList.add('selected');
                optionEl.addEventListener('click', () => {
                    if (activeFilters[filterType] === valueToCompare) {
                        activeFilters[filterType] = null;
                        if (filterType === 'collection') activeFilters.model = null;
                    } else {
                        activeFilters[filterType] = valueToCompare;
                        if (filterType === 'collection') activeFilters.model = null;
                    }
                    populateFilterOptions();
                });
                container.appendChild(optionEl);
            });
        }
        function handleApplyFilters() {
            saveClientSideState();
            renderProfileGifts();
            closeModal(filterPopup);
            displayFilterExitButton();
        }
        function handleClearFilters() {
            activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
            populateFilterOptions(); renderProfileGifts(); saveClientSideState(); displayFilterExitButton();
        }

        async function handleClearCurrentAccountData() {
            if (!currentAccountTgId) return;

            tg.showConfirm(`Are you sure you want to delete all gifts and data for the CURRENT account? This cannot be undone.`, async (confirmed) => {
                if (confirmed) {
                    try {
                        for(const gift of [...ownedGifts]) {
                            await callBackend(`/api/gifts/${gift.instance_id}`, 'DELETE');
                        }

                        const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                        if (currentAccount && currentAccount.collectible_usernames) {
                            for(const uname of [...currentAccount.collectible_usernames]) {
                                await callBackend(`/api/collectible_usernames/${uname}`, 'DELETE', { owner_id: currentAccountTgId });
                            }
                        }

                        await callBackend('/api/account', 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: "Not specified",
                            bio: "My first account!",
                        });

                        await initializeTelegramUserAccount();

                        activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                        animationsEnabled = true; showHiddenGifts = false;

                        saveClientSideState();
                        saveClientSideAccounts();

                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Current account data cleared.");
                        closeModal(settingsModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleClearAllAccountsData() {
            tg.showConfirm("Are you sure you want to delete ALL accounts and data from this simulator? This cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    accounts = [];
                    currentAccountTgId = null;

                    activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                    animationsEnabled = true; showHiddenGifts = false;

                    localStorage.clear();

                    await initApp();
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("All simulator data cleared.");
                    closeModal(settingsModal);
                }
            });
        }

        function handleAnimationToggle() {
            animationsEnabled = animationToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            updateAllAnimationsState();
            saveClientSideState();
        }

        function handleShowHiddenToggle() {
            showHiddenGifts = showHiddenToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            renderProfileGifts();
            saveClientSideState();
        }

        // --- CUSTOM BUY & CLONE ---
        function openCustomBuyModal() {
            selectedCustomGift = {};
            customBuyConfirmButton.disabled = true;
            cloneUrlInput.value = '';
            ['custom-buy-base-gifts-grid', 'custom-buy-models-grid', 'custom-buy-backdrops-grid', 'custom-buy-patterns-grid'].forEach(id => document.getElementById(id).innerHTML = '');
            ['custom-buy-models-section', 'custom-buy-backdrops-section', 'custom-buy-patterns-section'].forEach(id => document.getElementById(id).classList.add('hidden'));

            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const originalImageUrl = (id === CUSTOM_GIFTS_DATA.Dildo.id)
                    ? CUSTOM_GIFTS_DATA.Dildo.defaultImage
                    : `${CDN_BASE_URL}originals/${id}/Original.png`;

                const item = document.createElement('div');
                item.className = 'filter-option'; item.dataset.id = id;
                item.innerHTML = `<img src="${originalImageUrl}" alt="${name}" loading="lazy"><div class="label">${name}</div>`;
                item.addEventListener('click', () => selectCustomBaseGift(id, name, originalImageUrl));
                customBuyBaseGiftsGrid.appendChild(item);
            }
            openModal(customBuyModal);
        }

        async function selectCustomBaseGift(id, name, originalImage) {
            selectedCustomGift = {};
            customBuyModelsGrid.innerHTML = ''; customBuyBackdropsGrid.innerHTML = ''; customBuyPatternsGrid.innerHTML = '';
            customBuyModelsSection.classList.add('hidden'); customBuyBackdropsSection.classList.add('hidden');
            customBuyPatternsSection.classList.add('hidden');
            customBuyConfirmButton.disabled = true;
            Array.from(customBuyBaseGiftsGrid.children).forEach(el => el.classList.remove('selected'));
            document.querySelector(`#custom-buy-base-gifts-grid [data-id="${id}"]`).classList.add('selected');
            selectedCustomGift.id = id; selectedCustomGift.name = name; selectedCustomGift.originalImage = originalImage;
            selectedCustomGift.lottiePath = (id === CUSTOM_GIFTS_DATA.Dildo.id) ? null : `${CDN_BASE_URL}originals/${id}/Original.json`;

            // Handle custom gift "Dildo"
            if (name === 'Dildo') {
                const dildoData = CUSTOM_GIFTS_DATA.Dildo;
                const astralShardName = dildoData.backdrops_source; // "Astral Shard"

                try {
                    const astralParts = await Promise.all([
                        fetch(`${CDN_BASE_URL}backdrops/${encodeURIComponent(astralShardName)}/backdrops.json`).then(res => res.ok ? res.json() : []),
                        fetch(`${CDN_BASE_URL}patterns/${encodeURIComponent(astralShardName)}/patterns.json`).then(res => res.ok ? res.json() : [])
                    ]);
                    cachedCollectibleParts[id] = {
                        models: dildoData.models,
                        backdrops: astralParts[0],
                        patterns: astralParts[1]
                    };
                } catch (error) {
                    console.error(`Failed to fetch Astral Shard parts for Dildo:`, error);
                    cachedCollectibleParts[id] = { models: dildoData.models, backdrops: [], patterns: [] };
                }
            } else { // Handle standard CDN gifts
                if (!cachedCollectibleParts[id]) {
                    try {
                        const giftNameEncoded = encodeURIComponent(name);
                        const partsData = await Promise.all([
                            fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : []),
                            fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : [])
                        ]);
                        cachedCollectibleParts[id] = {
                            models: partsData[0],
                            backdrops: partsData[1],
                            patterns: partsData[2]
                        };
                    } catch (error) { console.error(`Failed to fetch collectible parts for ${name}:`, error); cachedCollectibleParts[id] = { models: [], backdrops: [], patterns: [] }; }
                }
            }

            // Populate options from cached data
            const { models, backdrops, patterns } = cachedCollectibleParts[id];
            const backdropSourceName = (name === 'Dildo') ? CUSTOM_GIFTS_DATA.Dildo.backdrops_source : name;
            const patternSourceName = (name === 'Dildo') ? CUSTOM_GIFTS_DATA.Dildo.patterns_source : name;

            if (models.length > 0) {
                customBuyModelsSection.classList.remove('hidden');
                models.forEach(model => {
                    const item = document.createElement('div'); item.className = 'filter-option'; item.dataset.name = model.name;
                    const modelImage = model.image || `${CDN_BASE_URL}models/${encodeURIComponent(name)}/png/${encodeURIComponent(model.name)}.png`;
                    item.innerHTML = `<img src="${modelImage}" alt="${model.name}" loading="lazy"><div class="label">${model.name}</div>`;
                    item.addEventListener('click', () => selectCustomPart('model', model, modelImage));
                    customBuyModelsGrid.appendChild(item);
                });
            }
            if (backdrops.length > 0) {
                customBuyBackdropsSection.classList.remove('hidden');
                backdrops.forEach(backdrop => {
                    const item = document.createElement('div'); item.className = 'filter-option'; item.dataset.name = backdrop.name;
                    item.innerHTML = `<div class="gradient-square" style="background: radial-gradient(circle, ${backdrop.hex.centerColor}, ${backdrop.hex.edgeColor});"></div><div class="label">${backdrop.name}</div>`;
                    item.addEventListener('click', () => selectCustomPart('backdrop', backdrop));
                    customBuyBackdropsGrid.appendChild(item);
                });
            }
            if (patterns.length > 0) {
                customBuyPatternsSection.classList.remove('hidden');
                patterns.forEach(pattern => {
                    const item = document.createElement('div'); item.className = 'filter-option'; item.dataset.name = pattern.name;
                    const patternImage = `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(pattern.name)}.png`;
                    item.innerHTML = `<img src="${patternImage}" alt="${pattern.name}" loading="lazy"><div class="label">${pattern.name}</div>`;
                    item.addEventListener('click', () => selectCustomPart('pattern', pattern, patternImage));
                    customBuyPatternsGrid.appendChild(item);
                });
            }
            checkCustomBuyCompleteness();
        }


        async function handleCloneGift() {
            const url = cloneUrlInput.value.trim();
            if (!url) { tg.showAlert("Please paste a valid Telegram NFT link."); return; }
            if (ownedGifts.length >= GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot clone gift. Your inventory is full (${GIFT_LIMIT_PER_USER} gifts).`);
                return;
            }
            cloneGiftButton.disabled = true;
            cloneGiftButton.textContent = "Cloning...";
            try {
                await callBackend('/api/gifts/clone', 'POST', {
                    url: url,
                    owner_id: currentAccountTgId
                });
                await initializeTelegramUserAccount();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Gift cloned successfully!");
                closeModal(customBuyModal);
                showPage('profile-page');
            } catch (error) {
                // Error is shown by callBackend
            } finally {
                cloneGiftButton.disabled = false;
                cloneGiftButton.textContent = "Clone Gift";
            }
        }

        function checkCustomBuyCompleteness() {
            if (!selectedCustomGift.id) { customBuyConfirmButton.disabled = true; return; }
            const partsInfo = cachedCollectibleParts[selectedCustomGift.id];
            if (!partsInfo) { customBuyConfirmButton.disabled = true; return; }
            const needsModel = partsInfo.models.length > 0, hasModel = !!selectedCustomGift.model;
            const needsBackdrop = partsInfo.backdrops.length > 0, hasBackdrop = !!selectedCustomGift.backdrop;
            const needsPattern = partsInfo.patterns.length > 0, hasPattern = !!selectedCustomGift.pattern;
            customBuyConfirmButton.disabled = !((!needsModel || hasModel) && (!needsBackdrop || hasBackdrop) && (!needsPattern || hasPattern));
        }

        function selectCustomPart(type, data, imagePath = null) {
            const container = document.getElementById(`custom-buy-${type}s-grid`);
            Array.from(container.children).forEach(el => el.classList.remove('selected'));
            const selectedElement = container.querySelector(`[data-name="${data.name}"]`);
            if(selectedElement) selectedElement.classList.add('selected');
            selectedCustomGift[type] = data;
            if (type === 'model') {
                selectedCustomGift.modelImage = imagePath;
                // For custom gift, lottie path is based on its own name, not the model name
                selectedCustomGift.lottieModelPath = data.image ? null : `${CDN_BASE_URL}models/${encodeURIComponent(selectedCustomGift.name)}/lottie/${encodeURIComponent(data.name)}.json`;
            } else if (type === 'pattern') { selectedCustomGift.patternImage = imagePath; }
            else if (type === 'backdrop') { selectedCustomGift.backdropColors = data.hex; }
            checkCustomBuyCompleteness();
        }

        async function handleCustomBuyConfirm() {
            if (customBuyConfirmButton.disabled) return;

            if (ownedGifts.length >= GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot create gift. Your inventory is full.`);
                return;
            }

            customBuyConfirmButton.disabled = true;
            customBuyConfirmButton.textContent = 'Creating...';

            const newGiftInstanceId = generateUniqueId();
            try {
                await callBackend('/api/gifts', 'POST', {
                    instance_id: newGiftInstanceId,
                    owner_id: currentAccountTgId,
                    gift_type_id: selectedCustomGift.id,
                    gift_name: selectedCustomGift.name,
                    original_image_url: selectedCustomGift.originalImage,
                    lottie_path: selectedCustomGift.lottiePath,
                });

                const upgradedGift = await callBackend('/api/gifts/upgrade', 'POST', {
                    instance_id: newGiftInstanceId,
                    custom_model: selectedCustomGift.model,
                    custom_backdrop: selectedCustomGift.backdrop,
                    custom_pattern: selectedCustomGift.pattern
                });

                await initializeTelegramUserAccount();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Collectible "${upgradedGift.gift_name}" created!`);
                closeModal(customBuyModal); showPage('profile-page');
            } catch (error) {
                 // Error handled by callBackend
            } finally {
                customBuyConfirmButton.disabled = false;
                customBuyConfirmButton.textContent = 'Create';
            }
        }

        function handleTripleTap(e, filterType, value) {
            const now = Date.now(); const DURATION = 300;
            if (now - lastTap < DURATION) tapCount++; else tapCount = 1;
            lastTap = now;
            if (tapCount === 3) {
                tapCount = 0; tg.HapticFeedback.impactOccurred('medium');
                activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                if (value) { activeFilters[filterType] = value; tg.showAlert(`Showing gifts with ${filterType}: "${value}"`); }
                else { tg.showAlert(`Cannot apply filter: ${filterType} is undefined.`); return; }
                saveClientSideState(); renderProfileGifts(); displayFilterExitButton(); closeModal(collectibleDetailModal);
            }
        }
        function displayFilterExitButton() {
            const hasActiveFilter = Object.values(activeFilters).some(f => f !== null);
            exitFilterModeButton.classList.toggle('hidden', !hasActiveFilter);
        }
        async function preloadImage(url) {
            return new Promise((resolve) => {
                if (!url) { resolve(); return; }
                const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = url;
                img.onload = resolve;
                img.onerror = () => { console.warn(`Failed to preload image: ${url}`); resolve(); };
            });
        }

        async function handleShareImageAction() {
            longPressMenu.classList.add('hidden');
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) { tg.showAlert("Cannot share an image for this gift."); return; }

            const giftForImage = currentLongPressGift;

            sendGeneratedImageButton.disabled = true;
            sendGeneratedImageButton.textContent = "Send to Me";
            generatedImageMessage.textContent = 'Generating image...';
            generatedImagePreview.src = '';
            openModal(generatedImageModal);

            const imageDataUrl = await generateGiftImage(giftForImage);

            if (imageDataUrl) {
                generatedImagePreview.src = imageDataUrl;
                generatedImageMessage.textContent = 'Image is ready. Click "Send to Me" to receive it via bot.';
                sendGeneratedImageButton.disabled = false;
                sendGeneratedImageButton.onclick = () => sendGeneratedImage(imageDataUrl, giftForImage);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                generatedImageMessage.textContent = 'Failed to generate image.';
                tg.HapticFeedback.notificationOccurred('error');
            }
            currentLongPressGift = null;
        }

        async function sendGeneratedImage(imageDataUrl, gift) {
            sendGeneratedImageButton.disabled = true;
            sendGeneratedImageButton.textContent = "Sending...";
            try {
                await callBackend('/api/gifts/send_image', 'POST', {
                    imageDataUrl: imageDataUrl,
                    userId: currentAccountTgId,
                    caption: `Your generated image for ${gift.gift_name} #${gift.collectible_number.toLocaleString()}`
                });
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Image sent! Check your chat with the bot.");
                closeModal(generatedImageModal);
            } catch (error) {
                sendGeneratedImageButton.disabled = false;
                sendGeneratedImageButton.textContent = "Send to Me";
            }
        }

        async function generateGiftImage(gift) {
            const cd = gift.collectible_data; if (!cd) return null;
            await Promise.all([ preloadImage(cd.modelImage || gift.original_image_url), preloadImage(cd.patternImage) ]);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '-9999px';
            tempContainer.style.width = '450px'; tempContainer.style.height = '600px';
            tempContainer.style.display = 'flex'; tempContainer.style.flexDirection = 'column';
            tempContainer.style.alignItems = 'center'; tempContainer.style.justifyContent = 'flex-start';
            tempContainer.style.padding = '30px'; tempContainer.style.boxSizing = 'border-box';
            tempContainer.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            if (cd.backdropColors) tempContainer.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            else tempContainer.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
            const textColor = '#ffffff';
            if (cd.patternImage) {
                const patternOverlay = document.createElement('div');
                patternOverlay.style.position = 'absolute'; patternOverlay.style.top = '0'; patternOverlay.style.left = '0';
                patternOverlay.style.width = '100%'; patternOverlay.style.height = '100%';
                patternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                patternOverlay.style.backgroundRepeat = 'repeat'; patternOverlay.style.backgroundSize = '30% auto';
                patternOverlay.style.opacity = '0.07'; tempContainer.appendChild(patternOverlay);
            }
            const giftModelContainer = document.createElement('div');
            giftModelContainer.style.width = '70%'; giftModelContainer.style.height = 'auto'; giftModelContainer.style.aspectRatio = '1 / 1';
            giftModelContainer.style.display = 'flex'; giftModelContainer.style.alignItems = 'center'; giftModelContainer.style.justifyContent = 'center';
            giftModelContainer.style.position = 'relative'; giftModelContainer.style.zIndex = '10'; giftModelContainer.style.marginBottom = '20px';
            const modelImageEl = document.createElement('img'); modelImageEl.src = cd.modelImage || gift.original_image_url;
            modelImageEl.style.maxWidth = '100%'; modelImageEl.style.maxHeight = '100%'; modelImageEl.style.objectFit = 'contain';
            giftModelContainer.appendChild(modelImageEl); tempContainer.appendChild(giftModelContainer);
            const upgradedGiftText = document.createElement('div');
            upgradedGiftText.textContent = 'Upgraded Gift'; upgradedGiftText.style.fontSize = '2.2em'; upgradedGiftText.style.fontWeight = '600';
            upgradedGiftText.style.color = textColor; upgradedGiftText.style.marginBottom = '10px'; upgradedGiftText.style.position = 'relative';
            upgradedGiftText.style.zIndex = '10'; tempContainer.appendChild(upgradedGiftText);
            const giftNameAndNumber = document.createElement('div');
            giftNameAndNumber.textContent = `${gift.gift_name} #${gift.collectible_number}`; giftNameAndNumber.style.fontSize = '1.8em'; giftNameAndNumber.style.fontWeight = '500';
            giftNameAndNumber.style.color = textColor; giftNameAndNumber.style.opacity = '0.9'; giftNameAndNumber.style.marginBottom = '25px';
            giftNameAndNumber.style.position = 'relative'; giftNameAndNumber.style.zIndex = '10'; tempContainer.appendChild(giftNameAndNumber);
            const infoSection = document.createElement('div');
            infoSection.style.display = 'flex'; infoSection.style.flexDirection = 'column'; infoSection.style.alignItems = 'flex-start';
            infoSection.style.width = '80%'; infoSection.style.position = 'relative'; infoSection.style.zIndex = '10';
            const createInfoRow = (label, value) => {
                const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between';
                row.style.width = '100%'; row.style.marginBottom = '10px';
                const labelEl = document.createElement('span'); labelEl.textContent = label; labelEl.style.fontSize = '1.2em';
                labelEl.style.fontWeight = 'normal'; labelEl.style.color = textColor; row.appendChild(labelEl);
                const valueEl = document.createElement('span'); valueEl.textContent = value; valueEl.style.fontSize = '1.2em';
                valueEl.style.fontWeight = '500'; valueEl.style.color = textColor; valueEl.style.opacity = '0.7'; row.appendChild(valueEl);
                return row;
            };
            infoSection.appendChild(createInfoRow('Model', cd.model?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Backdrop', cd.backdrop?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Symbol', cd.pattern?.name || 'N/A'));
            tempContainer.appendChild(infoSection); document.body.appendChild(tempContainer);
            let dataUrl = null;
            try {
                const canvas = await html2canvas(tempContainer, { backgroundColor: null, scale: 1.5, useCORS: true });
                dataUrl = canvas.toDataURL('image/png');
            } catch (error) { console.error("Error generating image:", error); }
            finally { document.body.removeChild(tempContainer); }
            return dataUrl;
        }

        let currentGiftForChances = null; let selectedChances = { model: null, backdrop: null, pattern: null };
        async function openChancesModal(gift) {
            closeModal(giftDetailModal); currentGiftForChances = gift;
            selectedChances = { model: null, backdrop: null, pattern: null };
            chancesGiftName.textContent = `For gift: "${gift.gift_name}"`;
            chancesLoadingSpinner.classList.remove('hidden');
            chancesModelsSection.classList.add('hidden'); chancesBackdropsSection.classList.add('hidden');
            chancesPatternsSection.classList.add('hidden'); chancesProbabilityDisplay.innerHTML = '';
            openModal(chancesModal); calculateAndDisplayChances();

            if (!cachedCollectibleParts[gift.gift_type_id]) {
                await selectCustomBaseGift(gift.gift_type_id, gift.gift_name); // Re-use this logic to fetch/load parts
            }
            chancesLoadingSpinner.classList.add('hidden');
            populateChancesOptions(gift.gift_type_id, gift.gift_name);
        }

        function populateChancesOptions(giftTypeId, giftName) {
            const { models, backdrops, patterns } = cachedCollectibleParts[giftTypeId];
            if (models.length > 0) { renderChanceOptions(chancesOptionsModels, models, 'model', giftName); chancesModelsSection.classList.remove('hidden'); }
            if (backdrops.length > 0) { renderChanceOptions(chancesOptionsBackdrops, backdrops, 'backdrop', giftName); chancesBackdropsSection.classList.remove('hidden'); }
            if (patterns.length > 0) { renderChanceOptions(chancesOptionsPatterns, patterns, 'pattern', giftName); chancesPatternsSection.classList.remove('hidden'); }
        }
        function renderChanceOptions(container, items, type, giftName) {
            container.innerHTML = '';
            const patternSourceName = (giftName === 'Dildo') ? CUSTOM_GIFTS_DATA.Dildo.patterns_source : giftName;

            items.forEach(itemData => {
                const optionEl = document.createElement('div');
                optionEl.className = 'filter-option';
                let innerHTML = '';
                if (type === 'model') {
                     const modelImage = itemData.image || `${CDN_BASE_URL}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${modelImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                } else if (type === 'backdrop') {
                     innerHTML = `<div class="gradient-square" style="background: radial-gradient(circle, ${itemData.hex.centerColor}, ${itemData.hex.edgeColor});"></div><div class="label">${itemData.name}</div>`;
                } else if (type === 'pattern') {
                     const patternImage = `${CDN_BASE_URL}patterns/${encodeURIComponent(patternSourceName)}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${patternImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                }
                optionEl.innerHTML = innerHTML;
                optionEl.addEventListener('click', () => handleChanceSelection(optionEl, container, type, itemData));
                container.appendChild(optionEl);
            });
        }

        function handleChanceSelection(element, container, type, data) {
            const isSelected = element.classList.contains('selected');
            Array.from(container.children).forEach(el => el.classList.remove('selected'));

            if(isSelected) {
                selectedChances[type] = null;
            } else {
                element.classList.add('selected');
                selectedChances[type] = data;
            }
            calculateAndDisplayChances();
        }

        function calculateAndDisplayChances() {
            let totalProbability = 1.0;
            const selectedParts = [];

            if (selectedChances.model) {
                totalProbability *= ((selectedChances.model.rarityPermille || 1) / 1000); // Permille is 1 in 1000
                selectedParts.push(`Model: ${selectedChances.model.name}`);
            }
             if (selectedChances.backdrop) {
                totalProbability *= ((selectedChances.backdrop.rarityPermille || 1) / 1000);
                selectedParts.push(`Backdrop: ${selectedChances.backdrop.name}`);
            }
             if (selectedChances.pattern) {
                totalProbability *= ((selectedChances.pattern.rarityPermille || 1) / 1000);
                selectedParts.push(`Symbol: ${selectedChances.pattern.name}`);
            }

            if (selectedParts.length === 0) {
                 chancesProbabilityDisplay.innerHTML = `<span class="prob-details">Select one or more parts to calculate the chance of getting them together.</span>`;
            } else {
                const probabilityPercent = totalProbability * 100;
                const oneInX = Math.round(1 / totalProbability);
                let displayPercent = probabilityPercent.toExponential(2);
                if (probabilityPercent > 0.0001) {
                    displayPercent = probabilityPercent.toPrecision(3) + '%';
                } else {
                    displayPercent += '%';
                }

                chancesProbabilityDisplay.innerHTML = `
                    <span class="prob-value">${displayPercent}</span>
                    <span class="prob-details">1 in ${oneInX.toLocaleString('en-US')}<br>${selectedParts.join('<br>')}</span>`;
            }
        }

        function openSellModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) return;
            currentGiftToSell = gift;
            closeModal(collectibleDetailModal);

            sellGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            sellGiftName.textContent = `${gift.gift_name} #${gift.collectible_number}`;
            sellPriceInput.value = '';
            sellReceiveAmount.textContent = 'You will receive...';
            sellUsdAmount.textContent = '';
            confirmSellButton.disabled = true;

            openModal(sellGiftModal);
            setTimeout(() => sellPriceInput.focus(), 250);
        }

        function updateSellPriceDetails() {
            const price = parseInt(sellPriceInput.value, 10);
            if (!isNaN(price) && price >= MIN_SALE_PRICE && price <= MAX_SALE_PRICE) {
                const commission = 0.20;
                const received = Math.floor(price * (1 - commission));
                const usdEquivalent = (price * 0.013).toFixed(2);

                sellReceiveAmount.textContent = `You will receive ${received} Stars.`;
                sellUsdAmount.textContent = `≈US$${usdEquivalent}`;
                confirmSellButton.disabled = false;
            } else {
                sellReceiveAmount.textContent = 'You will receive...';
                sellUsdAmount.textContent = '';
                confirmSellButton.disabled = true;
            }
        }

        function handleConfirmSell() {
            if (!currentGiftToSell || confirmSellButton.disabled) return;
            const price = parseInt(sellPriceInput.value, 10);

            const giftIndex = ownedGifts.findIndex(g => g.instance_id === currentGiftToSell.instance_id);
            if (giftIndex === -1) return;

            const removedGift = ownedGifts.splice(giftIndex, 1)[0];
            renderProfileGifts();
            closeModal(sellGiftModal);
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(`Gift "${currentGiftToSell.gift_name}" listed for sale. It will be removed from your profile until sold or cancelled.`);

            callBackend('/api/gifts/sell', 'POST', {
                instance_id: currentGiftToSell.instance_id,
                price: price,
                owner_id: currentAccountTgId
            }).catch(error => {
                tg.HapticFeedback.notificationOccurred('error');
                ownedGifts.splice(giftIndex, 0, removedGift);
                renderProfileGifts();
            });
        }

        function openTransferModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) return;
            currentGiftToTransfer = gift;
            closeModal(collectibleDetailModal);

            transferModalTitle.textContent = "Transfer Gift";
            transferGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            transferGiftImage.classList.remove('hidden');
            transferGiftName.classList.remove('hidden');
            transferUsernameInput.value = '';
            transferCommentInput.value = '';
            confirmTransferButton.disabled = true;
            transferStatusMessage.innerHTML = '<p>Gift ownership will be transferred to this username.</p>';

            openModal(transferGiftModal);
            setTimeout(() => transferUsernameInput.focus(), 250);
        }

        function handleConfirmTransfer() {
            if (!currentGiftToTransfer || confirmTransferButton.disabled) return;
            const receiverUsername = transferUsernameInput.value.trim();
            const comment = transferCommentInput.value.trim();

            if (!receiverUsername) { transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>'; return; }
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (receiverUsername.toLowerCase() === currentAccount?.username.toLowerCase()) {
                transferStatusMessage.innerHTML = '<p style="color:red;">Cannot transfer to yourself.</p>';
                return;
            }

            confirmTransferButton.disabled = true;
            confirmTransferButton.textContent = 'Transferring...';

            const giftIndex = ownedGifts.findIndex(g => g.instance_id === currentGiftToTransfer.instance_id);
            if (giftIndex === -1) {
                confirmTransferButton.disabled = false;
                confirmTransferButton.textContent = 'Confirm Transfer';
                return;
            }

            const removedGift = ownedGifts.splice(giftIndex, 1)[0];
            renderProfileGifts();
            closeModal(transferGiftModal);

            callBackend('/api/gifts/transfer', 'POST', {
                instance_id: currentGiftToTransfer.instance_id,
                receiver_username: receiverUsername,
                sender_id: currentAccountTgId,
                comment: comment
            }).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Gift transferred to @${receiverUsername}!`);
            }).catch(error => {
                tg.HapticFeedback.notificationOccurred('error');
                ownedGifts.splice(giftIndex, 0, removedGift);
                renderProfileGifts();
            });
        }

        // --- Collectible Numbers & Usernames ---
        function generateRandom888Number() {
            const part1 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            const part2 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `+888 ${part1} ${part2}`;
        }

        async function handleOpenNumbersModal() {
            numbersList.innerHTML = '';
            const allPossibleNumbers = [...coolNumbers];
            for (let i = 0; i < 20; i++) { allPossibleNumbers.push(generateRandom888Number()); }

            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            const userPhoneNumber = currentAccount?.phone_number;
            const availableNumbers = [...new Set(allPossibleNumbers)].filter(n => n !== userPhoneNumber);

            if (availableNumbers.length === 0) {
                numbersList.innerHTML = '<p class="empty-grid-message">No numbers available.</p>';
            } else {
                availableNumbers.forEach(num => {
                    const li = document.createElement('li');
                    li.className = 'collectible-list-item';
                    li.textContent = num;
                    li.addEventListener('click', () => buyNumber(num));
                    numbersList.appendChild(li);
                });
            }
            closeSidebar();
            openModal(numbersModal);
        }

        async function buyNumber(number) {
            tg.showConfirm(`Are you sure you want to purchase the number ${number}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/account`, 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: number
                        });

                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Number ${number} purchased successfully!`);
                        closeModal(numbersModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleOpenUsernamesModal() {
            await populateUsernamesList();
            usernameSearchInput.value = '';
            closeSidebar();
            openModal(usernamesModal);
        }

        async function populateUsernamesList(searchTerm = '') {
            usernamesList.innerHTML = '';
            let listToShow = [];

            if (searchTerm) {
                listToShow = [searchTerm.toLowerCase().replace(/[^a-z0-9_]/g, '')].filter(Boolean);
            } else {
                const shuffled = [...coolUsernames].sort(() => 0.5 - Math.random());
                listToShow = shuffled.slice(0, 25);
            }

            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            const ownedUsernames = currentAccount?.collectible_usernames || [];
            const filteredList = listToShow.filter(uname => !ownedUsernames.includes(uname));

            if (filteredList.length === 0) {
                usernamesList.innerHTML = '<p class="empty-grid-message">No usernames available.</p>';
            } else {
                filteredList.forEach(uname => {
                    const li = document.createElement('li');
                    li.className = 'collectible-list-item';
                    li.innerHTML = `<span class="at-symbol">@</span>${uname}`;
                    li.addEventListener('click', () => buyUsername(uname));
                    usernamesList.appendChild(li);
                });
            }
        }

        async function buyUsername(username) {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount || currentAccount.collectible_usernames.length >= MAX_COLLECTIBLE_USERNAMES) {
                tg.showAlert(`Username limit reached (${MAX_COLLECTIBLE_USERNAMES}).`);
                return;
            }

            tg.showConfirm(`Are you sure you want to purchase the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend('/api/collectible_usernames', 'POST', {
                            owner_id: currentAccountTgId,
                            username: username
                        });

                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} purchased successfully!`);
                        closeModal(usernamesModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleDeleteCollectibleUsername(username) {
             tg.showConfirm(`Are you sure you want to delete the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/collectible_usernames/${username}`, 'DELETE', { owner_id: currentAccountTgId });
                        await initializeTelegramUserAccount();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} has been deleted.`);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            });
        }

        async function handleEditBio() {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount) return;
            const newBio = prompt("Enter your new bio:", currentAccount.bio);
            if (newBio !== null) {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, bio: newBio });
                    await initializeTelegramUserAccount();
                } catch (error) {
                    console.error(error);
                }
            }
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, avatar_url: e.target.result });
                    await initializeTelegramUserAccount();
                } catch (error) {
                    console.error(error);
                }
            };
            reader.readAsDataURL(file);
        }

        function switchTab(tabName) {
            [giftsTabButton, postsTabButton, archiveTabButton].forEach(btn => btn.classList.remove('active'));
            [giftsContent, postsContent, archiveContent].forEach(content => content.classList.remove('active'));

            if (tabName === 'gifts') {
                giftsTabButton.classList.add('active');
                giftsContent.classList.add('active');
            } else if (tabName === 'posts') {
                postsTabButton.classList.add('active');
                postsContent.classList.add('active');
            } else if (tabName === 'archive') {
                archiveTabButton.classList.add('active');
                archiveContent.classList.add('active');
            }
        }

        function openSettingsModal() { openModal(settingsModal); }

        function copyGiftLink(gift) {
            const link = getGiftDeepLink(gift);
            navigator.clipboard.writeText(link).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert('Link copied to clipboard!');
            }, () => {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert('Failed to copy link.');
            });
            longPressMenu.classList.add('hidden');
        }

        // --- Reorder Logic ---
        function enterReorderMode() {
            if (!viewingOwnProfile) return;
            reorderModeActive = true;
            longPressMenu.classList.add('hidden');
            exitReorderModeButton.classList.remove('hidden');
            goToBuyGiftsButton.classList.add('hidden');
            upgradeAllGiftsButton.classList.add('hidden');
            giftsGrid.classList.add('reordering');
            renderProfileGifts();

            sortableInstance = new Sortable(giftsGrid, {
                animation: 150,
                filter: '.gift-card:not([data-pinned="true"])',
                preventOnFilter: true,
                onEnd: handleReorderEnd,
            });
        }

        async function exitReorderMode() {
            reorderModeActive = false;
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = null;

            const newOrderIds = Array.from(giftsGrid.querySelectorAll('.gift-card[data-pinned="true"]')).map(el => el.dataset.instanceId);

            newOrderIds.forEach((id, index) => {
                const gift = ownedGifts.find(g => g.instance_id === id);
                if (gift) gift.pin_order = index;
            });

            try {
                await callBackend('/api/gifts/reorder', 'POST', {
                    owner_id: currentAccountTgId,
                    ordered_instance_ids: newOrderIds
                });
            } catch (error) {
                await initializeTelegramUserAccount();
            }

            exitReorderModeButton.classList.add('hidden');
            giftsGrid.classList.remove('reordering');
            renderProfileGifts();
        }

        function handleReorderEnd(evt) { }

        // --- Selection Mode Logic ---
        function enterSelectionMode(action) {
            closeModal(settingsModal);
            if (!viewingOwnProfile) return;
            selectionModeActive = true;
            selectionAction = action;
            selectedGiftIds.clear();

            goToBuyGiftsButton.classList.add('hidden');
            upgradeAllGiftsButton.classList.add('hidden');
            exitSelectionModeButton.classList.remove('hidden');
            if (action === 'hide') hideSelectedGiftsButton.classList.remove('hidden');
            else if (action === 'transfer') transferSelectedGiftsButton.classList.remove('hidden');
            renderProfileGifts();
        }

        function exitSelectionMode() {
            selectionModeActive = false;
            selectionAction = null;
            selectedGiftIds.clear();

            exitSelectionModeButton.classList.add('hidden');
            hideSelectedGiftsButton.classList.add('hidden');
            transferSelectedGiftsButton.classList.add('hidden');
            const hasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            goToBuyGiftsButton.style.display = viewingOwnProfile ? 'inline-block' : 'none';
            upgradeAllGiftsButton.style.display = (hasNonCollectible && viewingOwnProfile) ? 'inline-block' : 'none';

            renderProfileGifts();
        }

        function toggleGiftSelection(instanceId) {
            const card = giftsGrid.querySelector(`.gift-card[data-instance-id="${instanceId}"]`);
            if (!card) return;

            if (selectedGiftIds.has(instanceId)) {
                selectedGiftIds.delete(instanceId);
                card.classList.remove('selected');
            } else {
                selectedGiftIds.add(instanceId);
                card.classList.add('selected');
            }
            const count = selectedGiftIds.size;
            if (selectionAction === 'hide') {
                hideSelectedGiftsButton.textContent = `Hide (${count})`;
                hideSelectedGiftsButton.disabled = count === 0;
            } else if (selectionAction === 'transfer') {
                transferSelectedGiftsButton.textContent = `Transfer (${count})`;
                transferSelectedGiftsButton.disabled = count === 0;
            }
        }

        async function handleHideMultiple() {
            if (selectedGiftIds.size === 0) return;
            const idsToHide = Array.from(selectedGiftIds);

            exitSelectionMode();
            tg.showConfirm(`Are you sure you want to hide ${idsToHide.length} selected gifts?`, async (confirmed) => {
                if (confirmed) {
                    const originalGifts = JSON.parse(JSON.stringify(ownedGifts));
                    ownedGifts.forEach(g => {
                        if (idsToHide.includes(g.instance_id)) g.is_hidden = true;
                    });
                    renderProfileGifts();
                    tg.HapticFeedback.notificationOccurred('success');

                    try {
                        await callBackend('/api/gifts/batch_action', 'POST', {
                            action: 'hide',
                            instance_ids: idsToHide,
                            owner_id: currentAccountTgId
                        });
                        await initializeTelegramUserAccount();
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        ownedGifts = originalGifts;
                        renderProfileGifts();
                    }
                }
            });
        }

        function handleTransferMultiple() {
            if (selectedGiftIds.size === 0) return;

            openModal(transferGiftModal);
            transferModalTitle.textContent = `Transfer ${selectedGiftIds.size} Gifts`;
            transferGiftImage.classList.add('hidden');
            transferGiftName.classList.add('hidden');

            confirmTransferButton.onclick = async () => {
                 if (confirmTransferButton.disabled) return;
                 const receiverUsername = transferUsernameInput.value.trim();
                 const comment = transferCommentInput.value.trim();
                 const idsToTransfer = Array.from(selectedGiftIds);

                 if (!receiverUsername) { transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>'; return; }

                 confirmTransferButton.disabled = true;
                 confirmTransferButton.textContent = 'Transferring...';

                 try {
                     await callBackend('/api/gifts/batch_action', 'POST', {
                         action: 'transfer',
                         instance_ids: idsToTransfer,
                         owner_id: currentAccountTgId,
                         receiver_username: receiverUsername,
                         comment: comment
                     });
                     tg.HapticFeedback.notificationOccurred('success');
                     tg.showAlert(`${idsToTransfer.length} gifts transferred successfully!`);
                     await initializeTelegramUserAccount();
                 } catch (error) {
                     console.error(error);
                 } finally {
                     closeModal(transferGiftModal);
                     exitSelectionMode();
                 }
            };
        }

        // --- GIVEAWAY ---
        function openGiveawaySetupModal() {
            closeSidebar();
            openModal(giveawaySetupModal);
        }
        function populateGiveawaySetupModal() {
            giveawayGiftSelectionGrid.innerHTML = '';
            selectedGiveawayGifts.clear();
            confirmGiveawaySetupButton.disabled = true;

            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && !g.is_hidden);
            if (collectibleGifts.length === 0) {
                giveawayGiftSelectionGrid.innerHTML = '<p class="empty-grid-message">You have no collectible gifts to give away.</p>';
                return;
            }

            collectibleGifts.forEach(gift => {
                const card = createGiftCardDOM(gift);
                card.onclick = () => {
                    const id = gift.instance_id;
                    if (selectedGiveawayGifts.has(id)) {
                        selectedGiveawayGifts.delete(id);
                        card.classList.remove('selected');
                    } else {
                        selectedGiveawayGifts.add(id);
                        card.classList.add('selected');
                    }
                    confirmGiveawaySetupButton.disabled = selectedGiveawayGifts.size === 0;
                };
                giveawayGiftSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
        }
        async function handleConfirmGiveawaySetup() {
            if (selectedGiveawayGifts.size === 0) return;
            const winnerRule = document.querySelector('input[name="winner-rule"]:checked').value;

            confirmGiveawaySetupButton.disabled = true;
            confirmGiveawaySetupButton.textContent = "Initiating...";

            try {
                await callBackend('/api/giveaways/create', 'POST', {
                    creator_id: currentAccountTgId,
                    gift_instance_ids: Array.from(selectedGiveawayGifts),
                    winner_rule: winnerRule
                });
                closeModal(giveawaySetupModal);
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("Giveaway saved! Please return to your chat with the bot to complete the setup.");
            } catch (error) {
                // Error handled by callBackend
            } finally {
                confirmGiveawaySetupButton.disabled = false;
                confirmGiveawaySetupButton.textContent = "Start Setup in Bot";
            }
        }

        // --- Swipe Navigation Logic ---
        function handleModalSwipe(direction) {
            const currentInstanceId = collectibleDetailModal.dataset.instanceId;
            if (!currentInstanceId) return;

            const swipableGifts = currentlySortedGifts.filter(g => g.is_collectible);
            if (swipableGifts.length < 2) return;

            let currentIndex = swipableGifts.findIndex(g => g.instance_id === currentInstanceId);
            if (currentIndex === -1) return;

            let nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;

            if (nextIndex >= swipableGifts.length) nextIndex = 0;
            if (nextIndex < 0) nextIndex = swipableGifts.length - 1;

            const nextGift = swipableGifts[nextIndex];
            if (nextGift && nextGift.instance_id !== currentInstanceId) {
                closeModal(collectibleDetailModal);
                setTimeout(() => openGiftDetailByInstanceId(nextGift.instance_id), 50);
            }
        }


        function setupEventListeners() {
            giftsTabButton.addEventListener('click', () => switchTab('gifts'));
            postsTabButton.addEventListener('click', () => switchTab('posts'));
            archiveTabButton.addEventListener('click', () => switchTab('archive'));

            goToBuyGiftsButton.addEventListener('click', () => showPage('buy-gifts-page'));
            if (upgradeAllGiftsButton) upgradeAllGiftsButton.addEventListener('click', handleUpgradeAllGifts);

            profileBio.addEventListener('click', () => { if (viewingOwnProfile) handleEditBio(); });
            profileAvatar.addEventListener('contextmenu', (e) => { e.preventDefault(); if (viewingOwnProfile) avatarUploadInput.click(); });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal);
                });
            });
            document.getElementById('close-gift-detail-modal').addEventListener('click', () => closeModal(giftDetailModal));
            document.getElementById('close-collectible-detail-modal').addEventListener('click', () => closeModal(collectibleDetailModal));
            document.getElementById('cancel-unpin-modal').addEventListener('click', () => closeModal(tooManyPinsModal));
            document.getElementById('cancel-buy-multiple').addEventListener('click', () => closeModal(buyMultipleModal));
            document.getElementById('close-chances-modal').addEventListener('click', () => closeModal(chancesModal));
            document.getElementById('close-generated-image-modal').addEventListener('click', () => closeModal(generatedImageModal));
            document.getElementById('cancel-sell-button').addEventListener('click', () => closeModal(sellGiftModal));
            document.getElementById('cancel-transfer-button').addEventListener('click', () => closeModal(transferGiftModal));
            document.getElementById('close-numbers-modal').addEventListener('click', () => closeModal(numbersModal));
            document.getElementById('close-usernames-modal').addEventListener('click', () => closeModal(usernamesModal));
            document.getElementById('cancel-giveaway-setup').addEventListener('click', () => closeModal(giveawaySetupModal));
            document.getElementById('custom-buy-cancel-button').addEventListener('click', () => closeModal(customBuyModal));

            collectibleActionWear.addEventListener('click', handleWearAction);
            collectibleActionSell.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openSellModal(gift);
            });
            collectibleActionTransfer.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openTransferModal(gift);
            });
            collectibleMenuButton.addEventListener('click', (e) => {
                const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                if (gift) openCollectibleMenu(gift, e);
            });
            hideLinkInModal.addEventListener('click', () => {
                const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                currentLongPressGift = gift;
                handleHideAction();
            });

            menuPinAction.addEventListener('click', handlePinAction);
            menuHideAction.addEventListener('click', handleHideAction);
            menuCopyLinkAction.addEventListener('click', () => { if(currentLongPressGift) copyGiftLink(currentLongPressGift); });
            menuDeleteAction.addEventListener('click', handleDeleteAction);
            menuShareImageAction.addEventListener('click', handleShareImageAction);
            menuReorderAction.addEventListener('click', enterReorderMode);

            confirmBuyMultipleButton.addEventListener('click', handleConfirmBuyMultiple);

            setupFilterPopupTrigger();
            applyFiltersButton.addEventListener('click', handleApplyFilters);
            clearFiltersButton.addEventListener('click', handleClearFilters);
            exitFilterModeButton.addEventListener('click', handleClearFilters);
            exitReorderModeButton.addEventListener('click', exitReorderMode);

            exitSelectionModeButton.addEventListener('click', exitSelectionMode);
            hideSelectedGiftsButton.addEventListener('click', handleHideMultiple);
            transferSelectedGiftsButton.addEventListener('click', handleTransferMultiple);

            settingsModal.querySelector('.modal-button.secondary')?.addEventListener('click', () => closeModal(settingsModal));
            animationToggle.addEventListener('change', handleAnimationToggle);
            showHiddenToggle.addEventListener('change', handleShowHiddenToggle);
            hideMultipleButton.addEventListener('click', () => enterSelectionMode('hide'));
            transferMultipleButton.addEventListener('click', () => enterSelectionMode('transfer'));
            clearCurrentAccountDataButton.addEventListener('click', handleClearCurrentAccountData);
            clearAllAccountsDataButton.addEventListener('click', handleClearAllAccountsData);

            customBuyConfirmButton.addEventListener('click', handleCustomBuyConfirm);
            cloneGiftButton.addEventListener('click', handleCloneGift);
            document.querySelector('#buy-gifts-page .page-header h2').addEventListener('contextmenu', (e) => { e.preventDefault(); openCustomBuyModal(); });

            sellPriceInput.addEventListener('input', updateSellPriceDetails);
            confirmSellButton.addEventListener('click', handleConfirmSell);

            transferUsernameInput.addEventListener('input', () => { confirmTransferButton.disabled = transferUsernameInput.value.trim() === ''; });
            confirmTransferButton.addEventListener('click', handleConfirmTransfer);

            avatarUploadInput.addEventListener('change', handleAvatarUpload);

            wornGiftIconContainer.addEventListener('click', () => {
                const wornGift = ownedGifts.find(g => g.is_worn);
                if (wornGift) openGiftDetailByInstanceId(wornGift.instance_id);
            });

            openNumbersButton.addEventListener('click', handleOpenNumbersModal);
            openUsernamesButton.addEventListener('click', handleOpenUsernamesModal);
            usernameSearchInput.addEventListener('input', (e) => populateUsernamesList(e.target.value));

            createGiveawayButton.addEventListener('click', openGiveawaySetupModal);
            confirmGiveawaySetupButton.addEventListener('click', handleConfirmGiveawaySetup);

            let touchStartX = 0; const swipeEdgeThreshold = 50;
            appContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            appContainer.addEventListener('touchend', e => {
                if (e.target.closest('.account-sidebar')) return;
                const touchEndX = e.changedTouches[0].screenX;
                if (touchStartX < swipeEdgeThreshold && touchEndX - touchStartX > swipeEdgeThreshold) { openSidebar(); }
            }, { passive: true });

            sidebarOverlay.addEventListener('click', closeSidebar);
            addAccountButton.addEventListener('click', handleAddAccount);

            collectibleDetailModal.addEventListener('touchstart', (e) => {
                modalSwipeState.startX = e.touches[0].clientX;
                modalSwipeState.isSwiping = true;
            }, { passive: true });
            collectibleDetailModal.addEventListener('touchend', (e) => {
                if (!modalSwipeState.isSwiping) return;
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - modalSwipeState.startX;
                const swipeThreshold = 50;
                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX < 0) handleModalSwipe('next');
                    else handleModalSwipe('prev');
                }
                modalSwipeState.isSwiping = false;
            }, { passive: true });
        }

        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== undefined) {
            initApp();
        } else {
            console.warn("Telegram WebApp not found. Running in mock mode.");
            document.addEventListener('DOMContentLoaded', () => {
                tg.initDataUnsafe = {
                    user: {
                        id: 123456789,
                        first_name: "Mock",
                        last_name: "User",
                        username: "mock_user",
                        photo_url: "https://i.pravatar.cc/140?img=1"
                    }
                };
                tg.themeParams = {};
                tg.showAlert = (message) => alert(message);
                tg.showConfirm = (message, callback) => callback(confirm(message));
                tg.HapticFeedback = {
                    impactOccurred: (style) => console.log(`Haptic: ${style}`),
                    notificationOccurred: (type) => console.log(`Haptic Notification: ${type}`),
                };
                tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = () => {};
                tg.SettingsButton = { isVisible: false, onClick: (cb) => {tg._settingsCb = cb}, show: () => console.log("Settings Button Show"), hide: () => console.log("Settings Button Hide") };
                tg.BackButton = { isVisible: false, onClick: (cb) => {tg._backCb = cb}, offClick: (cb) => {}, show: () => console.log("Back button shown"), hide: () => console.log("Back button hidden") };

                initApp();
            });
        }
    </script>
</body>
</html>
