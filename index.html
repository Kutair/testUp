<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Симулятор Подарков Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-header-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1; /* Used for "Upgrade All" button */
            --tg-theme-border-color: #232d36;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: #2b3540;
            --app-rarity-chip-text: #a3b6c9;
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-header-bg-color);
            border-bottom: 1px solid var(--tg-theme-border-color);
            min-height: 56px;
        }
        .page-header .back-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 1.8em;
            margin-right: 15px;
            cursor: pointer;
            padding: 5px;
        }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }
        .page-header .menu-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 1.5em;
            margin-left: auto;
            cursor: pointer;
            padding: 5px;
        }

        /* Profile Page */
        .profile-header-area {
            background-color: var(--tg-theme-header-bg-color);
            padding: 15px;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: flex-start;
            gap: 6px;
            margin-bottom: 8px;
            padding-left: 70px;
            min-height: 24px;
        }
        .profile-top-pinned-gifts img {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            object-fit: contain;
            background-color: var(--tg-theme-secondary-bg-color);
        }

        .profile-main-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid var(--tg-theme-bg-color);
        }
        .profile-name-status h1 {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .profile-name-status p {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
        }
        .profile-name-status p.online {
             color: var(--tg-theme-link-color);
        }
        
        .profile-action-icons {
            margin-left: auto; display: flex; gap: 20px;
            font-size: 1.4em; color: var(--tg-theme-link-color);
        }
        .profile-action-icons span { cursor: pointer; }

        .profile-details p {
            margin-bottom: 8px; font-size: 0.95em;
        }
        .profile-details p strong {
            display: block; color: var(--tg-theme-hint-color);
            font-weight: normal; font-size: 0.85em; margin-bottom: 2px;
        }
        .profile-details p span#profile-username { color: var(--tg-theme-link-color); }

        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-header-bg-color);
            padding: 0;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
        }
        .profile-tabs button.active {
            color: var(--tg-theme-link-color);
            font-weight: 500;
        }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        
        .profile-gifts-actions {
            display: flex; justify-content: flex-end;
            align-items: center; padding: 12px 15px;
            background-color: var(--tg-theme-bg-color);
        }
        .profile-gifts-actions .buy-gifts-button { /* General style for buttons in this row */
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        /* Specific style for "Upgrade All" can be set via JS or more specific CSS if needed */
        #upgrade-all-gifts-button {
            /* background-color: var(--tg-theme-accent-blue); /* This is set in inline style now */
            margin-right: 10px; /* Spacing between buttons */
        }


        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
            gap: 8px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color);
            text-align: center;
            padding: 20px 40px; 
            font-size: 0.95em;
            line-height: 1.5;
            width: 100%; 
        }


        .gift-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
        }
        
        .gift-card-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none;
        }
        .gift-card-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 25% auto;
            background-position: center;
            opacity: 0.1;
            pointer-events: none;
        }

        .gift-card img.gift-image {
            max-width: 75%; max-height: 75%;
            object-fit: contain; z-index: 1;
        }
        
        .gift-card .collectible-number-badge {
            position: absolute; top: 6px; right: 6px;
            background-color: rgba(0,0,0,0.3);
            color: var(--tg-theme-text-color);
            font-size: 0.7em; padding: 2px 6px;
            border-radius: 8px; z-index: 2; font-weight: 500;
        }

        .gift-card .pin-indicator {
            position: absolute; top: 6px; left: 6px;
            font-size: 1.1em;
            z-index: 2;
        }

        /* Buy Gifts Page */
        .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; position: relative;
        }
        .buy-gift-item img {
            width: 60%; 
            height: auto; max-height: 70px; 
            object-fit: contain; margin-bottom: 10px;
        }
        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }
        .buy-gift-item .gift-price .star-icon { color: #f5a623; margin-right: 3px;}

        .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.65em; padding: 3px 8px;
            border-radius: 10px; font-weight: 500;
        }

        /* Modals Generic */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active {
            opacity: 1; visibility: visible;
            transform: translateY(0%);
        }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 10px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 10px 20px 15px 20px; text-align: center;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }
        
        .modal-scrollable-content {
            overflow-y: auto; padding: 20px; flex-grow: 1;
        }
        .modal-buttons-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--tg-theme-border-color);
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }

        /* Gift Detail Modal (Non-Collectible) */
        #gift-detail-modal .modal-gift-image {
            width: 100px; height: 100px; object-fit: contain;
            margin: 0 auto 20px auto; display: block;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between;
            padding: 10px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        #gift-detail-modal .modal-info-table .info-row:last-child { border-bottom: none; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-hint-color); }

        /* Collectible Detail Modal Specific Styles */
        #collectible-detail-modal .modal-content {
             padding-top: 0;
        }
        #collectible-detail-modal .page-header {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        #collectible-detail-modal .modal-scrollable-content {
            padding: 0;
        }
        .collectible-display-area {
            background-color: var(--tg-theme-bg-color);
            padding: 20px; text-align: center;
        }
        .collectible-display-area h3 {
            font-size: 1.4em; font-weight: 600; margin-top: 10px;
        }
        .collectible-display-area p {
            font-size: 0.9em; color: var(--tg-theme-hint-color); margin-bottom: 20px;
        }
        .modal-collectible-visual {
            width: 70%; max-width: 280px;
            aspect-ratio: 1/1; margin: 0 auto;
            border-radius: 12px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-collectible-visual .collectible-bg-gradient {
            position: absolute; top:0;left:0;right:0;bottom:0; z-index: 1;
        }
        .modal-collectible-visual .collectible-pattern-tile {
            position: absolute; top:0;left:0;right:0;bottom:0;
            background-size: 25% auto; 
            background-repeat: repeat; opacity: 0.15; 
            z-index: 2;
        }
        .modal-collectible-visual .collectible-model-img {
            max-width: 80%; max-height: 80%;
            object-fit: contain; z-index: 3; position: relative;
        }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: var(--app-action-button-bg);
            color: var(--app-action-button-text);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { font-size: 1.3em; margin-bottom: 4px; }

        .collectible-info-section { padding: 0 20px; }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        .collectible-info-section .info-row:last-child { border-bottom: none; }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value {
            color: var(--tg-theme-hint-color); display: flex; align-items: center;
        }
        .collectible-info-section .info-value img.owner-avatar {
            width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;
        }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 3px 8px; border-radius: 12px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        
        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        /* Long Press Menu */
        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001; padding: 6px 0; min-width: 180px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li {
            padding: 10px 20px; cursor: pointer;
            color: var(--tg-theme-text-color); font-size: 0.95em;
        }
        #long-press-menu li.disabled {
            color: var(--tg-theme-hint-color);
            cursor: default;
        }
        #long-press-menu li:not(.disabled):hover { background-color: var(--tg-theme-border-color); }
        
        /* Input for buy multiple */
        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px; 
            background-color: var(--tg-theme-bg-color); 
            color: var(--tg-theme-text-color); 
            border: 1px solid var(--tg-theme-border-color); 
            border-radius: 8px;
            font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #buy-multiple-quantity[type=number] {
            -moz-appearance: textfield;
        }

        /* Spinner */
        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }
        
    </style>
</head>
<body>
    <div id="global-spinner-overlay" class="spinner-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="app-container">
        <!-- Profile Page (could be own or other's) -->
        <div id="profile-page" class="page">
            <div class="page-header hidden" id="profile-page-header"> <!-- Header for public profile view -->
                <button id="back-to-my-profile" class="back-button">←</button>
                <h2 id="profile-page-header-title">Профиль</h2>
            </div>
            <div class="profile-header-area">
                <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                <div class="profile-main-info">
                    <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                    <div class="profile-name-status">
                        <h1 id="profile-name">Загрузка...</h1>
                        <p id="profile-gift-count-subtext">0 подарков</p>
                        <p id="profile-status" class="online">в сети</p>
                    </div>
                </div>
                <div id="profile-details" class="profile-details">
                     <p><strong>Имя пользователя</strong><span id="profile-username"></span></p>
                </div>
            </div>

            <div class="profile-tabs">
                <button data-tab="publications">Публикации</button> <!-- Dummy -->
                <button data-tab="archive">Архив</button> <!-- Dummy -->
                <button data-tab="gifts" class="active">Подарки</button>
            </div>
            
            <div id="profile-gifts-actions-bar" class="profile-gifts-actions">
                <button id="upgrade-all-gifts-button" class="action-button" style="display: none;">✨ Улучшить все</button>
                <button id="go-to-buy-gifts" class="action-button">🎁 Купить подарки</button>
            </div>

            <div id="gifts-grid" class="gifts-grid">
                 <div class="page-loading-spinner-container"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Buy Gifts Page (Store) -->
        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <button id="back-to-profile-from-store" class="back-button">←</button>,
                <h2>Магазин подарков</h2>
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                 <div class="page-loading-spinner-container"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Modals -->
        <div id="gift-detail-modal" class="modal-overlay"> <!-- Non-collectible detail -->
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Название подарка</h3>
                </div>
                <div class="modal-scrollable-content">
                    <img id="modal-gift-image" class="modal-gift-image" src="" alt="Подарок">
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="upgrade-gift-button" class="modal-button">Улучшить</button>
                    <button class="modal-button secondary close-modal-button">ОК</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="page-header" id="collectible-modal-header">
                    <button class="back-button close-modal-button">←</button>
                    <h2 id="modal-collectible-header-title">Коллекционный</h2>
                    <button class="menu-button" id="collectible-menu-button">⋮</button>
                </div>
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-collectible-bg" class="collectible-bg-gradient"></div>
                            <div id="modal-collectible-pattern" class="collectible-pattern-tile"></div>
                            <img id="modal-collectible-model-img" class="collectible-model-img" src="" alt="Модель">
                        </div>
                        <h3 id="modal-collectible-main-name">Название Модели</h3>
                        <p id="modal-collectible-number-subtext">Коллекционный #0</p>
                    </div>

                    <div id="modal-collectible-actions" class="modal-action-buttons-row">
                        <button data-action="transfer"><span class="icon">💎</span>Передать</button>
                        <!-- <button data-action="wear"><span class="icon">👑</span>Надеть</button> -->
                        <!-- <button data-action="sell"><span class="icon">💰</span>Продать</button> -->
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div id="modal-collectible-footer-message" class="modal-footer-message hidden">
                        Этот подарок виден в вашем профиле. <span class="link" data-action="hide-from-modal">Скрыть ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button class="modal-button close-modal-button">ОК</button>
                </div>
            </div>
        </div>
        
        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="transfer-gift-modal-title">Передать подарок</h3></div>
                <div class="modal-scrollable-content">
                    <p id="transfer-gift-name" style="text-align:center; margin-bottom: 20px;"></p>
                    <div class="modal-input-group">
                        <label for="transfer-recipient-identifier">Имя пользователя (без @) или Telegram ID</label>
                        <input type="text" id="transfer-recipient-identifier" placeholder="например, vasiliy939 или 123456789">
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-gift" class="modal-button">Передать</button>
                    <button class="modal-button secondary close-modal-button">Отмена</button>
                </div>
            </div>
        </div>


        <div id="too-many-pins-modal" class="modal-overlay">
             <div class="modal-content">
                <div class="modal-header-bar"><h3>Слишком много закреплённых подарков</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Выберите подарок для открепления. Можно закрепить до 6 коллекционных подарков.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button class="modal-button secondary close-modal-button">Отмена</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Купить подарок</h3></div>
                <div class="modal-scrollable-content modal-input-group">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity">Количество:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Купить</button>
                    <button class="modal-button secondary close-modal-button">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div id="long-press-menu" class="hidden"> <!-- For gift cards on profile -->
        <ul>
            <li data-action="pin">Закрепить</li>
            <li data-action="hide">Скрыть</li>
            <!-- Add other actions here if needed -->
        </ul>
    </div>
    <div id="collectible-modal-menu" class="hidden"> <!-- For 3-dot menu in collectible modal -->
         <ul>
            <li data-action="copy-link">Копировать ссылку</li>
            <!-- Other actions for modal if needed -->
        </ul>
    </div>


    <script>
        const API_BASE_URL = "https://upgrade-a57g.onrender.com/api"; // Your Render backend URL
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/"; // Example, adjust if you use your own
        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--tg-theme-link-color)" width="16px" height="16px" style="opacity:0.7;"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 2.99.71-.71L12 2z"/></svg>`;
        const HIDDEN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--tg-theme-text-color)" width="18px" height="18px"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 10c-2.48 0-4.5-2.02-4.5-4.5S9.52 5.5 12 5.5s4.5 2.02 4.5 4.5-2.02 4.5-4.5 4.5zm0-7c-1.38 0-2.5 1.12-2.5 2.5S10.62 12.5 12 12.5s2.5-1.12 2.5-2.5S13.38 7.5 12 7.5z M22.53 7.47l-2.06-2.06c-.2-.2-.51-.2-.71 0l-1.93 1.93C16.5 6.42 14.36 5.5 12 5.5c-3.1 0-5.85 1.55-7.58 3.88L2.56 7.47c-.2-.2-.51-.2-.71 0l-1.18 1.18c-.2.2-.2.51 0 .71l2.52 2.52C2.17 12.83 1.5 13.86 1.5 15c0 .28.02.55.05.82l-1.2 1.2c-.2.2-.2.51 0 .71l1.18 1.18c-.2.2-.51.2-.71 0L.37 16.53c-.2-.2-.2-.51 0-.71l2.06-2.06c.2-.2.51-.2.71 0l1.93-1.93C6.5 13.08 8.64 14.5 12 14.5c3.1 0 5.85-1.55 7.58-3.88l1.86 1.86c.2.2.51.2.71 0l1.18-1.18c.2-.2.2-.51 0-.71l-2.52-2.52c.96-.96 1.63-2.09 1.63-3.18 0-.28-.02-.55-.05-.82l1.2-1.2c.2-.2.2-.51 0-.71z"/></svg>`; // Simplified crossed eye
        const MAX_PINS = 6;

        let tg = window.Telegram.WebApp;
        let currentOpenGift = null; // For long-press menu context
        let currentOpenCollectibleModalGift = null; // For collectible modal menu context
        let currentProfileData = null; // Holds data for the currently viewed profile
        let myProfileData = null; // Specifically holds the authenticated user's profile data
        let currentProfileIsMe = true; // Flag to check if displayed profile is the logged-in user

        // DOM Elements
        const globalSpinner = document.getElementById('global-spinner-overlay');

        const profilePage = document.getElementById('profile-page');
        const profilePageHeader = document.getElementById('profile-page-header');
        const backToMyProfileButton = document.getElementById('back-to-my-profile');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status'); // Consider making dynamic
        const profileUsername = document.getElementById('profile-username');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');
        const giftsGrid = document.getElementById('gifts-grid');
        const profileGiftsActionsBar = document.getElementById('profile-gifts-actions-bar');
        const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        
        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const backToProfileFromStoreButton = document.getElementById('back-to-profile-from-store');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');

        const giftDetailModal = document.getElementById('gift-detail-modal'); // Non-collectible
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalGiftImage = document.getElementById('modal-gift-image');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const upgradeGiftButton = document.getElementById('upgrade-gift-button');

        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const collectibleModalHeader = document.getElementById('collectible-modal-header');
        const modalCollectibleHeaderTitle = document.getElementById('modal-collectible-header-title');
        const collectibleMenuButton = document.getElementById('collectible-menu-button');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalCollectibleBg = document.getElementById('modal-collectible-bg');
        const modalCollectiblePattern = document.getElementById('modal-collectible-pattern');
        const modalCollectibleModelImg = document.getElementById('modal-collectible-model-img');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleActions = document.getElementById('modal-collectible-actions');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const modalCollectibleFooterMessage = document.getElementById('modal-collectible-footer-message');
        
        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferGiftModalTitle = document.getElementById('transfer-gift-modal-title');
        const transferGiftName = document.getElementById('transfer-gift-name');
        const transferRecipientIdentifierInput = document.getElementById('transfer-recipient-identifier');
        const confirmTransferGiftButton = document.getElementById('confirm-transfer-gift');
        let giftToTransferInstanceId = null;


        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');

        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        let currentGiftToBuyMultiple = null;

        const longPressMenu = document.getElementById('long-press-menu');
        const collectibleModalMenu = document.getElementById('collectible-modal-menu');
        
        const allModals = document.querySelectorAll('.modal-overlay');
        const closeModalsButtons = document.querySelectorAll('.close-modal-button');

        // --- THEME & INIT ---
        function applyTheme(themeParams) {
            const root = document.documentElement;
            const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
            
            setVar('--tg-theme-bg-color', themeParams.bg_color);
            setVar('--tg-theme-text-color', themeParams.text_color);
            setVar('--tg-theme-hint-color', themeParams.hint_color);
            setVar('--tg-theme-link-color', themeParams.link_color);
            setVar('--tg-theme-button-color', themeParams.button_color);
            setVar('--tg-theme-button-text-color', themeParams.button_text_color);
            setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
            // Header often matches secondary_bg_color or bg_color
            setVar('--tg-theme-header-bg-color', themeParams.secondary_bg_color || themeParams.bg_color); 
            // Accent color might be link_color or a specific accent_text_color if provided
            setVar('--tg-theme-accent-blue', themeParams.accent_text_color || themeParams.link_color || '#5288c1');
            
            document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
            document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';

            if (upgradeAllGiftsButton) {
                upgradeAllGiftsButton.style.backgroundColor = 'var(--tg-theme-accent-blue)';
            }
        }

        async function authenticatedFetch(url, options = {}) {
            showGlobalSpinner(true);
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `tma ${tg.initData}`
            };
            options.headers = { ...defaultHeaders, ...options.headers };

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: "Unknown error", details: response.statusText }));
                    console.error("API Error:", response.status, errorData);
                    tg.showAlert(errorData.error || `Ошибка сервера: ${response.status}`);
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                if (response.headers.get("content-type")?.includes("application/json")) {
                    return await response.json();
                }
                return await response.text(); // Or handle other content types
            } catch (error) {
                console.error("Fetch error:", error);
                // tg.showAlert(`Ошибка сети или сервера: ${error.message}`); // Already shown in most cases
                throw error; // Re-throw to be caught by caller
            } finally {
                showGlobalSpinner(false);
            }
        }
        
        function showGlobalSpinner(show) {
            globalSpinner.classList.toggle('hidden', !show);
        }

        async functioninitializeApp() {
            tg.ready();
            tg.expand();
            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            setupEventListeners();

            const startParam = tg.initDataUnsafe?.start_param;
            if (startParam) {
                if (startParam.startsWith('@') || /^\d+$/.test(startParam)) { // User profile link
                    await loadProfileData(startParam);
                } else if (startParam.includes('-') && startParam.split('-').pop().match(/^\d+$/)) { // Gift link: GiftNameSlug-Number
                    await loadAndShowGiftByDeepLink(startParam);
                } else {
                    await loadProfileData(); // Default to my profile
                }
            } else {
                await loadProfileData(); // Default to my profile (no specific start_param)
            }
        }

        // --- PROFILE & DATA LOADING ---
        async function loadProfileData(identifier = null) { // identifier can be username or telegram_id or null for 'me'
            showPage('profile-page');
            giftsGrid.innerHTML = `<div class="page-loading-spinner-container"><div class="spinner"></div></div>`;
            profileGiftsActionsBar.classList.add('hidden'); // Hide actions until we know whose profile
            profilePageHeader.classList.add('hidden'); // Hide back button for my profile

            try {
                let url = `${API_BASE_URL}/me/profile`;
                let isViewingOtherProfile = false;
                if (identifier) {
                    url = `${API_BASE_URL}/public/profile/${identifier}`;
                    isViewingOtherProfile = true;
                }
                
                const data = await authenticatedFetch(url); // authenticatedFetch handles spinner

                currentProfileData = data; // Store the fetched profile data (could be 'me' or other)
                if (!identifier && !myProfileData) { // If loading 'me' for the first time
                    myProfileData = data;
                }
                
                currentProfileIsMe = !isViewingOtherProfile || (myProfileData && myProfileData.profile.telegram_id === data.profile.telegram_id);

                renderProfileHeader(data.profile);
                renderProfileGifts(data.gifts, data.pinned_gift_ids);
                
                if (currentProfileIsMe) {
                    profileGiftsActionsBar.classList.remove('hidden');
                    profilePageHeader.classList.add('hidden');
                    backToMyProfileButton.classList.add('hidden');
                    // Check if "Upgrade All" should be visible
                    const hasNonCollectible = data.gifts.some(g => !g.is_collectible);
                    upgradeAllGiftsButton.style.display = hasNonCollectible ? 'inline-block' : 'none';
                } else {
                    profileGiftsActionsBar.classList.add('hidden'); // No actions on others' profiles
                    profilePageHeader.classList.remove('hidden');
                    backToMyProfileButton.classList.remove('hidden');
                    document.getElementById('profile-page-header-title').textContent = data.profile.first_name || data.profile.username || "Профиль";
                }

            } catch (error) {
                giftsGrid.innerHTML = `<p class="empty-grid-message">Не удалось загрузить профиль.</p>`;
                console.error("Failed to load profile data:", error);
            }
        }
        
        async function loadAndShowGiftByDeepLink(giftIdentifier) {
            // Default to showing profile page in background while modal loads
            showPage('profile-page'); 
            giftsGrid.innerHTML = `<div class="page-loading-spinner-container"><div class="spinner"></div></div>`; // Spinner on profile page

            try {
                const giftData = await authenticatedFetch(`${API_BASE_URL}/public/gift/${giftIdentifier}`);
                if (giftData && giftData.is_collectible) {
                    currentOpenCollectibleModalGift = giftData; // Set context for modal
                    populateCollectibleDetailModal(giftData, true); // true for public view
                    openModal(collectibleDetailModal);
                    // After modal is shown, load the owner's profile in the background
                    // This way, if user closes modal, profile page is ready
                    await loadProfileData(String(giftData.owner_telegram_id));
                } else {
                    tg.showAlert("Коллекционный подарок не найден по этой ссылке.");
                    await loadProfileData(); // Fallback to my profile
                }
            } catch (error) {
                console.error("Failed to load gift by deep link:", error);
                tg.showAlert("Не удалось загрузить подарок по ссылке.");
                await loadProfileData(); // Fallback to my profile
            }
        }


        function renderProfileHeader(profile) {
            profileName.textContent = profile.first_name || profile.username || "Пользователь";
            profileAvatar.src = profile.photo_url || `https://i.pravatar.cc/120?u=${profile.telegram_id}`;
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/120?u=fallback${profile.telegram_id}`; };
            profileUsername.textContent = profile.username ? `@${profile.username}` : "скрыто";
            // profileStatus - can be 'online' or based on last_seen_at from backend
        }

        function renderProfileGifts(gifts, pinnedGiftIds = []) {
            giftsGrid.innerHTML = ''; // Clear previous gifts or spinner
            profileGiftCountSubtext.textContent = getGiftCountText(gifts.length);

            // Create a set for quick pinned lookup
            const pinnedSet = new Set(pinnedGiftIds.map(id => String(id))); // Ensure comparison with string instance_id

            const sortedGifts = [...gifts].sort((a, b) => {
                const aIsPinned = pinnedSet.has(String(a.instance_id));
                const bIsPinned = pinnedSet.has(String(b.instance_id));
                if (aIsPinned && !bIsPinned) return -1;
                if (!aIsPinned && bIsPinned) return 1;
                // Add secondary sort by acquired_at if needed, API already sorts by acquired_at desc
                return new Date(b.acquired_at) - new Date(a.acquired_at);
            });
            
            if (sortedGifts.length === 0) {
                giftsGrid.style.display = 'flex'; // For centering empty message
                giftsGrid.innerHTML = `<p class="empty-grid-message">У этого пользователя пока нет подарков.</p>`;
                if (currentProfileIsMe) {
                     giftsGrid.innerHTML = `<p class="empty-grid-message">У вас пока нет подарков. Время что-нибудь купить!</p>`;
                }
            } else {
                giftsGrid.style.display = 'grid'; // Revert to grid
                sortedGifts.forEach(gift => {
                    const card = createGiftCard(gift, pinnedSet.has(String(gift.instance_id)));
                    giftsGrid.appendChild(card);
                });
            }
            renderTopPinnedGiftsPreview(gifts, pinnedGiftIds);
        }

        function createGiftCard(gift, isPinnedOnProfile) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            card.dataset.instanceId = gift.instance_id;

            const giftImageEl = document.createElement('img');
            giftImageEl.className = 'gift-image';
            
            if (gift.is_collectible) {
                giftImageEl.src = gift.model_image_url ? `${CDN_BASE_URL}${gift.cdn_path_prefix || ''}${gift.model_image_url}` : gift.gift_original_image_url; // Fallback
                giftImageEl.alt = gift.model_name || gift.gift_name;

                const bgDiv = document.createElement('div');
                bgDiv.className = 'gift-card-bg-pattern';
                if (gift.backdrop_center_color && gift.backdrop_edge_color) {
                     bgDiv.style.background = `radial-gradient(circle, ${gift.backdrop_center_color}, ${gift.backdrop_edge_color})`;
                } else {
                    bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)'; // Default
                }
                card.appendChild(bgDiv);

                if (gift.pattern_image_url) {
                    const patternOverlayDiv = document.createElement('div');
                    patternOverlayDiv.className = 'gift-card-pattern-overlay';
                    patternOverlayDiv.style.backgroundImage = `url('${CDN_BASE_URL}${gift.cdn_path_prefix || ''}${gift.pattern_image_url}')`;
                    card.appendChild(patternOverlayDiv);
                }
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'collectible-number-badge';
                numberDiv.textContent = `#${gift.collectible_number}`;
                card.appendChild(numberDiv);
            } else {
                giftImageEl.src = gift.gift_original_image_url;
                giftImageEl.alt = gift.gift_name;
            }
            
            giftImageEl.onerror = function() { this.parentNode.replaceChild(createPlaceholderImage(true), this); };
            card.appendChild(giftImageEl);

            if (isPinnedOnProfile) {
                const pinDiv = document.createElement('div');
                pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG; 
                card.appendChild(pinDiv);
            }
            if (gift.is_hidden && currentProfileIsMe) { // Show hidden indicator only to owner
                 const hiddenDiv = document.createElement('div');
                 hiddenDiv.className = 'hidden-indicator';
                 hiddenDiv.innerHTML = HIDDEN_ICON_SVG;
                 card.appendChild(hiddenDiv);
            }

            card.addEventListener('click', () => openGiftDetail(gift.instance_id));
            if (currentProfileIsMe) { // Long press only on own gifts
                setupLongPress(card, gift);
            }
            return card;
        }

        function renderTopPinnedGiftsPreview(allGifts, pinnedGiftIds) {
            profileTopPinnedGifts.innerHTML = '';
            const pinnedSet = new Set(pinnedGiftIds.map(id => String(id)));
            
            const giftsToDisplayInPreview = allGifts
                .filter(g => pinnedSet.has(String(g.instance_id)))
                .sort((a,b) => pinnedGiftIds.indexOf(String(a.instance_id)) - pinnedGiftIds.indexOf(String(b.instance_id))) // Sort by original pin order
                .slice(0, 5); // Max 5 in preview

            giftsToDisplayInPreview.forEach(gift => {
                const img = document.createElement('img');
                img.src = gift.is_collectible && gift.model_image_url ? 
                          `${CDN_BASE_URL}${gift.cdn_path_prefix || ''}${gift.model_image_url}` : 
                          gift.gift_original_image_url;
                img.alt = gift.gift_name;
                img.onerror = function() { this.src = `https://i.pravatar.cc/48?u=pin${gift.instance_id}`; };
                profileTopPinnedGifts.appendChild(img);
            });
        }

        function getGiftCountText(count) {
            if (count % 10 === 1 && count % 100 !== 11) return `${count} подарок`;
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return `${count} подарка`;
            return `${count} подарков`;
        }
        
        function createPlaceholderImage(isCardPlaceholder = false) {
            const placeholder = document.createElement('div');
            placeholder.className = 'placeholder-image';
            if (isCardPlaceholder) {
                placeholder.style.width = '75%'; placeholder.style.height = '75%';
            }
            placeholder.textContent = '🖼️';
            return placeholder;
        }

        // --- STORE (BUY GIFTS) ---
        async function loadStoreGifts() {
            showPage('buy-gifts-page');
            buyGiftsGrid.innerHTML = `<div class="page-loading-spinner-container"><div class="spinner"></div></div>`;
            try {
                const availableGifts = await authenticatedFetch(`${API_BASE_URL}/store/gifts`);
                renderAvailableGiftsInStore(availableGifts);
            } catch (error) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message">Не удалось загрузить подарки из магазина.</p>`;
            }
        }

        function renderAvailableGiftsInStore(gifts) {
            buyGiftsGrid.innerHTML = '';
            if (!gifts || gifts.length === 0) {
                 buyGiftsGrid.innerHTML = `<p class="empty-grid-message">В магазине пока нет подарков.</p>`;
                 return;
            }
            gifts.forEach(giftDef => {
                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = giftDef.id; // gift_definition_id
                item.dataset.name = giftDef.name;
                item.dataset.originalImage = giftDef.original_image_url;

                item.innerHTML = `
                    <img src="${giftDef.original_image_url || ''}" alt="${giftDef.name}" loading="lazy" onerror="this.parentNode.replaceChild(createPlaceholderImage(), this);">
                    <div class="gift-name">${giftDef.name}</div>
                    <div class="gift-price"><span class="star-icon">⭐</span> Бесплатно</div> 
                    ${giftDef.is_limited ? '<div class="limited-label">Ограничено</div>' : ''}
                `;
                item.addEventListener('click', () => {
                     handleBuyGift(giftDef.id, 1); // Buy one on click
                });
                
                let buyItemLongPressTimer; // For "Buy Multiple"
                const startLongPress = () => {
                    clearTimeout(buyItemLongPressTimer); // Clear any existing timer
                    buyItemLongPressTimer = setTimeout(() => {
                        currentGiftToBuyMultiple = giftDef;
                        buyMultipleModalTitle.textContent = `Купить "${giftDef.name}"`;
                        buyMultipleGiftName.textContent = `Укажите количество для "${giftDef.name}"`;
                        buyMultipleQuantityInput.value = "1";
                        openModal(buyMultipleModal);
                    }, 700);
                };
                const cancelLongPress = () => clearTimeout(buyItemLongPressTimer);

                item.addEventListener('touchstart', startLongPress, { passive: true });
                item.addEventListener('touchend', cancelLongPress);
                item.addEventListener('touchmove', cancelLongPress);
                item.addEventListener('contextmenu', (e) => { 
                    e.preventDefault();
                    startLongPress(); // Trigger immediately for context menu
                    cancelLongPress(); // Then clear (as it's not a timed press)
                });
                buyGiftsGrid.appendChild(item);
            });
        }

        async function handleBuyGift(giftDefinitionId, quantity) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/gifts/buy`, {
                    method: 'POST',
                    body: JSON.stringify({ gift_definition_id: giftDefinitionId, quantity: quantity })
                });
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(response.message || `Куплено ${quantity} шт.`);
                
                // Add new gifts to currentProfileData.gifts if it's my profile
                if (currentProfileIsMe && myProfileData && response.new_gifts) {
                    myProfileData.gifts.unshift(...response.new_gifts); // Add to start
                     // Re-render only if currently viewing own profile
                    if (currentProfileData === myProfileData) {
                         renderProfileGifts(myProfileData.gifts, myProfileData.pinned_gift_ids || []);
                         // Update "Upgrade All" button visibility
                        const hasNonCollectible = myProfileData.gifts.some(g => !g.is_collectible);
                        upgradeAllGiftsButton.style.display = hasNonCollectible ? 'inline-block' : 'none';
                    }
                }
                showPage('profile-page'); // Switch back to profile page
            } catch (error) {
                // Error already shown by authenticatedFetch
            }
        }
        
        confirmBuyMultipleButton.addEventListener('click', () => {
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) {
                tg.showAlert("Пожалуйста, введите корректное количество.");
                return;
            }
            handleBuyGift(currentGiftToBuyMultiple.id, quantity);
            closeModal(buyMultipleModal);
            currentGiftToBuyMultiple = null;
        });

        // --- GIFT DETAILS & ACTIONS (MODALS) ---
        function findGiftByInstanceId(instanceId) {
            if (!currentProfileData || !currentProfileData.gifts) return null;
            return currentProfileData.gifts.find(g => String(g.instance_id) === String(instanceId));
        }

        function openGiftDetail(instanceId) {
            const gift = findGiftByInstanceId(instanceId);
            if (!gift) {
                tg.showAlert("Информация о подарке не найдена.");
                return;
            }
            currentOpenGift = gift; // Set context for potential actions

            if (gift.is_collectible) {
                currentOpenCollectibleModalGift = gift;
                populateCollectibleDetailModal(gift, !currentProfileIsMe || (myProfileData && myProfileData.profile.telegram_id !== gift.owner_telegram_id) ); // isPublicView if not my gift
                openModal(collectibleDetailModal);
            } else {
                modalGiftName.textContent = gift.gift_name;
                modalGiftImage.src = gift.gift_original_image_url || '';
                modalGiftImage.alt = gift.gift_name;
                modalGiftImage.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${gift.instance_id}`; };

                modalGiftInfo.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Дата получения</span>
                        <span class="info-value">${new Date(gift.acquired_at).toLocaleDateString('ru-RU')}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Статус</span>
                        <span class="info-value" id="modal-uniqueness-value">Стандартный</span>
                    </div>
                `;
                upgradeGiftButton.dataset.instanceId = gift.instance_id;
                upgradeGiftButton.disabled = !currentProfileIsMe; // Can only upgrade own gifts
                upgradeGiftButton.textContent = 'Улучшить';
                openModal(giftDetailModal);
            }
        }
        
        function populateCollectibleDetailModal(giftData, isPublicView = false) {
            // giftData can come from profile list or direct deep link API call
            const giftName = giftData.gift_name || giftData.model_name || "Коллекционный";
            modalCollectibleHeaderTitle.textContent = giftName;
            modalCollectibleMainName.textContent = giftData.model_name || giftName;
            modalCollectibleNumberSubtext.textContent = `Коллекционный #${giftData.collectible_number}`;
            
            modalCollectibleBg.style.background = (giftData.backdrop_center_color && giftData.backdrop_edge_color) ?
                `radial-gradient(circle, ${giftData.backdrop_center_color}, ${giftData.backdrop_edge_color})` :
                'linear-gradient(45deg, #333, #111)'; // Default gradient
            modalCollectiblePattern.style.backgroundImage = giftData.pattern_image_url ?
                `url('${CDN_BASE_URL}${giftData.cdn_path_prefix || ''}${giftData.pattern_image_url}')` : 'none';
            modalCollectibleModelImg.src = giftData.model_image_url ?
                 `${CDN_BASE_URL}${giftData.cdn_path_prefix || ''}${giftData.model_image_url}` :
                 (giftData.gift_original_image_url || '');
            modalCollectibleModelImg.alt = giftData.model_name || giftName;
            modalCollectibleModelImg.onerror = function() { this.src = `https://i.pravatar.cc/200?u=errColl${giftData.instance_id}`; };

            // Determine if the current authenticated user is the owner
            const isOwner = myProfileData && String(myProfileData.profile.telegram_id) === String(giftData.owner_telegram_id);
            
            // Show/hide action buttons based on ownership and if it's a public view
            if (isOwner && !isPublicView) {
                modalCollectibleActions.classList.remove('hidden');
                modalCollectibleActions.querySelector('[data-action="transfer"]').disabled = false;
            } else {
                modalCollectibleActions.classList.add('hidden'); // Or disable buttons
            }
            collectibleMenuButton.style.display = isOwner ? 'block' : 'none'; // 3-dot menu only for owner

            const ownerName = giftData.owner_first_name || giftData.owner_username || `User ${giftData.owner_telegram_id}`;
            const ownerAvatar = giftData.owner_photo_url || `https://i.pravatar.cc/48?u=${giftData.owner_telegram_id}`;
            
            const ownerLinkClass = giftData.is_hidden && !isOwner ? "owner-link disabled" : "owner-link";
            const ownerLinkAction = giftData.is_hidden && !isOwner ? "" : `onclick="handleOwnerLinkClick('${giftData.owner_telegram_id}')"`;

            modalCollectibleInfoTable.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Владелец</span>
                    <span class="info-value">
                        <img src="${ownerAvatar}" alt="" class="owner-avatar">
                        <span class="${ownerLinkClass}" ${ownerLinkAction}>${ownerName}</span>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Модель</span>
                    <span class="info-value">${giftData.model_name || 'N/A'} 
                        ${giftData.model_rarity_permille ? `<span class="rarity-chip">${giftData.model_rarity_permille / 10}%</span>` : ''}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Фон</span>
                    <span class="info-value">${giftData.backdrop_name || 'N/A'}
                        ${giftData.backdrop_rarity_permille ? `<span class="rarity-chip">${giftData.backdrop_rarity_permille / 10}%</span>` : ''}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Символ</span>
                    <span class="info-value">${giftData.pattern_name || 'N/A'}
                         ${giftData.pattern_rarity_permille ? `<span class="rarity-chip">${giftData.pattern_rarity_permille / 10}%</span>` : ''}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Номер</span>
                    <span class="info-value">#${giftData.collectible_number}</span>
                </div>
            `;

            // Footer message for owner
            modalCollectibleFooterMessage.classList.toggle('hidden', !isOwner);
            if(isOwner) {
                const hideLink = modalCollectibleFooterMessage.querySelector('.link');
                hideLink.textContent = giftData.is_hidden ? "Сделать видимым" : "Скрыть из профиля";
                hideLink.dataset.action = giftData.is_hidden ? "unhide-from-modal" : "hide-from-modal";
            }
        }
        
        async function handleOwnerLinkClick(ownerTelegramId) {
            closeAllModals(); // Close current modal before navigating
            await loadProfileData(String(ownerTelegramId));
            showPage('profile-page');
        }

        upgradeGiftButton.addEventListener('click', async (e) => {
            const instanceId = e.target.dataset.instanceId;
            if (!instanceId || !currentProfileIsMe) return;

            e.target.textContent = 'Улучшение...';
            e.target.disabled = true;
            document.getElementById('modal-uniqueness-value').textContent = 'Обработка...';

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/gifts/${instanceId}/upgrade`, { method: 'POST' });
                tg.HapticFeedback.notificationOccurred('success');
                
                // Update local data
                if (myProfileData && myProfileData.gifts) {
                    const giftIndex = myProfileData.gifts.findIndex(g => String(g.instance_id) === String(instanceId));
                    if (giftIndex !== -1) {
                        myProfileData.gifts[giftIndex] = { ...myProfileData.gifts[giftIndex], ...response.gift };
                    }
                    if (currentProfileData === myProfileData) { // If viewing own profile
                         renderProfileGifts(myProfileData.gifts, myProfileData.pinned_gift_ids || []);
                    }
                }
                
                closeModal(giftDetailModal);
                openGiftDetail(instanceId); // Open as collectible
                
            } catch (error) {
                // Error already shown
                e.target.textContent = 'Улучшить';
                document.getElementById('modal-uniqueness-value').textContent = 'Ошибка улучшения';
            } finally {
                 if (currentProfileIsMe) e.target.disabled = false; // Re-enable only if it was owner
            }
        });
        
        upgradeAllGiftsButton.addEventListener('click', async () => {
            if (!myProfileData || !myProfileData.gifts) return;
            const giftsToUpgrade = myProfileData.gifts.filter(g => !g.is_collectible);

            if (giftsToUpgrade.length === 0) {
                tg.showAlert("Нет подарков для улучшения.");
                return;
            }
            
            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            let successCount = 0;
            let failureCount = 0;

            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `Улучшение (${i + 1}/${giftsToUpgrade.length})...`;
                try {
                    const response = await authenticatedFetch(`${API_BASE_URL}/gifts/${gift.instance_id}/upgrade`, { method: 'POST' });
                    // Update this specific gift in myProfileData.gifts
                    const giftIndex = myProfileData.gifts.findIndex(g => String(g.instance_id) === String(gift.instance_id));
                    if (giftIndex !== -1) {
                        myProfileData.gifts[giftIndex] = { ...myProfileData.gifts[giftIndex], ...response.gift };
                    }
                    successCount++;
                } catch (err) {
                    failureCount++;
                    // If one fails, we continue with others for "Upgrade All"
                }
                 if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length -1) await new Promise(resolve => setTimeout(resolve, 200)); // Small delay
            }
            
            if (currentProfileData === myProfileData) { // Re-render if viewing own profile
                 renderProfileGifts(myProfileData.gifts, myProfileData.pinned_gift_ids || []);
            }
            
            let summaryMessage = `Улучшение завершено.\nУспешно: ${successCount}`;
            if (failureCount > 0) summaryMessage += `\nНе удалось: ${failureCount}`;
            tg.showAlert(summaryMessage);
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));

            upgradeAllGiftsButton.textContent = originalButtonText;
            const स्टिलNonCollectible = myProfileData.gifts.some(g => !g.is_collectible);
            upgradeAllGiftsButton.style.display = स्टिलNonCollectible ? 'inline-block' : 'none';
            upgradeAllGiftsButton.disabled = ! स्टिलNonCollectible;
        });

        // Transfer gift logic
        modalCollectibleActions.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || !currentOpenCollectibleModalGift) return;
            const action = button.dataset.action;

            if (action === 'transfer') {
                giftToTransferInstanceId = currentOpenCollectibleModalGift.instance_id;
                transferGiftModalTitle.textContent = `Передать "${currentOpenCollectibleModalGift.gift_name || currentOpenCollectibleModalGift.model_name}"`;
                transferGiftName.textContent = `Кому передать подарок #${currentOpenCollectibleModalGift.collectible_number}?`;
                transferRecipientIdentifierInput.value = '';
                openModal(transferGiftModal);
            }
        });
        
        confirmTransferGiftButton.addEventListener('click', async () => {
            const recipient = transferRecipientIdentifierInput.value.trim();
            if (!recipient || !giftToTransferInstanceId) return;

            confirmTransferGiftButton.disabled = true;
            confirmTransferGiftButton.textContent = 'Передача...';

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/gifts/${giftToTransferInstanceId}/transfer`, {
                    method: 'POST',
                    body: JSON.stringify({ recipient_identifier: recipient })
                });
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(response.message || "Подарок успешно передан!");
                
                // Refresh my profile data as the gift is gone
                if (myProfileData) { // Remove from local cache
                     myProfileData.gifts = myProfileData.gifts.filter(g => String(g.instance_id) !== String(giftToTransferInstanceId));
                     myProfileData.pinned_gift_ids = (myProfileData.pinned_gift_ids || []).filter(id => String(id) !== String(giftToTransferInstanceId));
                }
                if (currentProfileIsMe && currentProfileData === myProfileData) { // If currently viewing own profile, re-render
                     renderProfileGifts(myProfileData.gifts, myProfileData.pinned_gift_ids || []);
                }
                
                closeModal(transferGiftModal);
                closeModal(collectibleDetailModal); // Close the collectible modal too
                giftToTransferInstanceId = null;

            } catch (error) {
                // Error already shown
            } finally {
                confirmTransferGiftButton.disabled = false;
                confirmTransferGiftButton.textContent = 'Передать';
            }
        });

        // --- PINNING & HIDING (LONG PRESS & MODAL FOOTER) ---
        let longPressTimer;
        function setupLongPress(element, gift) {
            const startLongPress = (event) => {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => {
                    currentOpenGift = gift; // Set context
                    const menu = longPressMenu; // Assuming one general long press menu
                    
                    const pinActionItem = menu.querySelector('[data-action="pin"]');
                    const isPinned = myProfileData && myProfileData.pinned_gift_ids && myProfileData.pinned_gift_ids.includes(String(gift.instance_id));
                    pinActionItem.textContent = isPinned ? 'Открепить' : 'Закрепить';
                    pinActionItem.classList.toggle('disabled', !gift.is_collectible && !isPinned); // Can't pin non-collectible, can always unpin
                    if(!gift.is_collectible) pinActionItem.textContent = 'Закрепить (коллекц.)';


                    const hideActionItem = menu.querySelector('[data-action="hide"]');
                    hideActionItem.textContent = gift.is_hidden ? 'Сделать видимым' : 'Скрыть';
                    
                    const coords = event.touches ? event.touches[0] : event;
                    positionAndShowMenu(menu, coords);
                }, 500);
            };
            const cancelLongPress = () => clearTimeout(longPressTimer);

            element.addEventListener('touchstart', startLongPress, { passive: false });
            element.addEventListener('touchend', cancelLongPress);
            element.addEventListener('touchmove', cancelLongPress);
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                startLongPress(e);
            });
        }
        
        longPressMenu.addEventListener('click', async (e) => {
            const actionItem = e.target.closest('li');
            if (!actionItem || !currentOpenGift || actionItem.classList.contains('disabled')) {
                hideAllContextMenus();
                return;
            }
            const action = actionItem.dataset.action;
            const giftInstanceId = currentOpenGift.instance_id;
            hideAllContextMenus();

            if (action === 'pin') {
                if (!currentOpenGift.is_collectible) {
                     tg.showAlert("Только коллекционные подарки можно закреплять."); return;
                }
                await handlePinAction(giftInstanceId);
            } else if (action === 'hide') {
                await handleVisibilityAction(giftInstanceId, !currentOpenGift.is_hidden);
            }
        });

        async function handlePinAction(giftInstanceIdToToggle) {
            if (!myProfileData) return;
            let currentPins = myProfileData.pinned_gift_ids ? [...myProfileData.pinned_gift_ids] : [];
            const isCurrentlyPinned = currentPins.includes(String(giftInstanceIdToToggle));

            if (isCurrentlyPinned) {
                currentPins = currentPins.filter(id => String(id) !== String(giftInstanceIdToToggle));
            } else {
                if (currentPins.length >= MAX_PINS) {
                    currentOpenGift = findGiftByInstanceId(giftInstanceIdToToggle); // Ensure context for unpin modal
                    showTooManyPinsModal(currentPins, giftInstanceIdToToggle);
                    return; // Stop here, modal will handle the rest
                }
                currentPins.push(String(giftInstanceIdToToggle));
            }
            await updatePinsOnServer(currentPins);
        }
        
        async function updatePinsOnServer(newPinnedIdsArray) {
             try {
                await authenticatedFetch(`${API_BASE_URL}/gifts/pins`, {
                    method: 'POST',
                    body: JSON.stringify({ pinned_ids: newPinnedIdsArray })
                });
                if (myProfileData) {
                    myProfileData.pinned_gift_ids = newPinnedIdsArray;
                }
                if (currentProfileIsMe && currentProfileData === myProfileData) {
                    renderProfileGifts(myProfileData.gifts, newPinnedIdsArray);
                }
                tg.HapticFeedback.impactOccurred('light');
            } catch (error) {
                // error already shown
            }
        }
        
        function showTooManyPinsModal(currentPinnedIds, giftAttemptingToPinId) {
            unpinSelectionGrid.innerHTML = '';
            currentPinnedIds.forEach(pinnedInstanceIdStr => {
                const giftToUnpin = myProfileData.gifts.find(g => String(g.instance_id) === pinnedInstanceIdStr);
                if (giftToUnpin) {
                    const card = createGiftCard(giftToUnpin, true); // It's pinned
                    card.style.cursor = 'pointer'; // Ensure clickable
                    card.addEventListener('click', async () => {
                        // Unpin the clicked gift, then pin the new one
                        const newPins = currentPinnedIds.filter(id => id !== pinnedInstanceIdStr);
                        newPins.push(String(giftAttemptingToPinId)); // Add the one we originally wanted to pin
                        await updatePinsOnServer(newPins);
                        closeModal(tooManyPinsModal);
                    });
                    unpinSelectionGrid.appendChild(card);
                }
            });
            openModal(tooManyPinsModal);
        }

        async function handleVisibilityAction(giftInstanceId, shouldHide) {
             try {
                const response = await authenticatedFetch(`${API_BASE_URL}/gifts/${giftInstanceId}/visibility`, {
                    method: 'POST',
                    body: JSON.stringify({ hide: shouldHide })
                });
                if (myProfileData && myProfileData.gifts) {
                    const giftIndex = myProfileData.gifts.findIndex(g => String(g.instance_id) === String(giftInstanceId));
                    if (giftIndex !== -1) {
                        myProfileData.gifts[giftIndex].is_hidden = shouldHide;
                    }
                }
                if (currentProfileIsMe && currentProfileData === myProfileData) {
                    renderProfileGifts(myProfileData.gifts, myProfileData.pinned_gift_ids || []);
                }
                tg.HapticFeedback.impactOccurred(shouldHide ? 'light' : 'medium');
                // If collectible modal is open for this gift, update its footer message
                if (collectibleDetailModal.classList.contains('active') && currentOpenCollectibleModalGift && String(currentOpenCollectibleModalGift.instance_id) === String(giftInstanceId)) {
                    currentOpenCollectibleModalGift.is_hidden = shouldHide; // Update the object for modal context
                    const hideLink = modalCollectibleFooterMessage.querySelector('.link');
                    hideLink.textContent = shouldHide ? "Сделать видимым" : "Скрыть из профиля";
                    hideLink.dataset.action = shouldHide ? "unhide-from-modal" : "hide-from-modal";
                }
            } catch (error) {
                // error already shown
            }
        }
        
        // Hide/Unhide from Collectible Modal Footer
        modalCollectibleFooterMessage.addEventListener('click', async (e) => {
            if (e.target.classList.contains('link') && currentOpenCollectibleModalGift) {
                const action = e.target.dataset.action;
                const giftInstanceId = currentOpenCollectibleModalGift.instance_id;
                const shouldHide = action === 'hide-from-modal';
                await handleVisibilityAction(giftInstanceId, shouldHide);
            }
        });

        // --- MODAL & MENU UTILITIES ---
        function openModal(modalElement) {
            modalElement.classList.add('active');
            // tg.BackButton.show(); // Consider context for back button
        }
        function closeModal(modalElement) {
            modalElement.classList.remove('active');
            // if (!document.querySelector('.modal-overlay.active')) {
            //     tg.BackButton.hide();
            // }
        }
        function closeAllModals() {
            allModals.forEach(modal => closeModal(modal));
            hideAllContextMenus();
        }
        
        closeModalsButtons.forEach(btn => btn.addEventListener('click', () => {
            const modalToClose = btn.closest('.modal-overlay');
            if (modalToClose) closeModal(modalToClose);
        }));
        
        allModals.forEach(modal => { // Click on backdrop to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal);
            });
        });

        function positionAndShowMenu(menuElement, coords) {
            menuElement.style.top = `${Math.min(coords.clientY, window.innerHeight - menuElement.offsetHeight - 10)}px`;
            menuElement.style.left = `${Math.min(coords.clientX, window.innerWidth - menuElement.offsetWidth - 10)}px`;
            menuElement.classList.remove('hidden');
            document.addEventListener('click', handleClickOutsideMenu, { once: true, capture: true });
        }
        
        function handleClickOutsideMenu(event) {
            if (!longPressMenu.classList.contains('hidden') && !longPressMenu.contains(event.target)) {
                longPressMenu.classList.add('hidden');
            }
            if (!collectibleModalMenu.classList.contains('hidden') && !collectibleModalMenu.contains(event.target)) {
                 collectibleModalMenu.classList.add('hidden');
            }
        }
        function hideAllContextMenus() {
            longPressMenu.classList.add('hidden');
            collectibleModalMenu.classList.add('hidden');
            currentOpenGift = null; // Clear context
            // currentOpenCollectibleModalGift context is managed by its modal lifecycle
        }

        // Collectible Modal 3-dot menu
        collectibleMenuButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent modal from closing if menu is part of it
            if (!currentOpenCollectibleModalGift) return;
            // Position menu near the button
            const rect = collectibleMenuButton.getBoundingClientRect();
            collectibleModalMenu.style.top = `${rect.bottom + 5}px`;
            collectibleModalMenu.style.left = `${Math.max(10, rect.right - collectibleModalMenu.offsetWidth)}px`;
            collectibleModalMenu.classList.remove('hidden');
            document.addEventListener('click', handleClickOutsideMenu, { once: true, capture: true });
        });

        collectibleModalMenu.addEventListener('click', async (e) => {
            const actionItem = e.target.closest('li');
            if (!actionItem || !currentOpenCollectibleModalGift) {
                hideAllContextMenus(); return;
            }
            const action = actionItem.dataset.action;
            hideAllContextMenus();

            if (action === 'copy-link') {
                const giftSlug = currentOpenCollectibleModalGift.gift_slug || currentOpenCollectibleModalGift.gift_name.toLowerCase().replace(/\s+/g, '-');
                const link = `${tg.WebApp.url}?startapp=${giftSlug}-${currentOpenCollectibleModalGift.collectible_number}`;
                try {
                    await navigator.clipboard.writeText(link);
                    tg.showAlert("Ссылка скопирована!");
                } catch (err) {
                    tg.showAlert("Не удалось скопировать ссылку.");
                    console.error('Failed to copy link: ', err);
                }
            }
        });


        // --- PAGE NAVIGATION & EVENT LISTENERS ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            // Reset scroll position for grids when switching pages
            if (pageId === 'profile-page' && giftsGrid) giftsGrid.scrollTop = 0;
            if (pageId === 'buy-gifts-page' && buyGiftsGrid) buyGiftsGrid.scrollTop = 0;
        }

        function setupEventListeners() {
            goToBuyGiftsButton.addEventListener('click', loadStoreGifts);
            backToProfileFromStoreButton.addEventListener('click', () => {
                // If myProfileData is loaded, go there. Otherwise, it implies an issue or deep link scenario.
                if (myProfileData) {
                    loadProfileData(); // Reload my profile to ensure freshness
                } else {
                    showPage('profile-page'); // Fallback, should ideally not happen if app starts correctly
                }
            });
            
            backToMyProfileButton.addEventListener('click', async () => {
                await loadProfileData(); // Load my profile (null identifier)
            });

            // Tab switching (dummy for now, only gifts tab works)
            document.querySelectorAll('.profile-tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.profile-tabs button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    if (button.dataset.tab === 'gifts') {
                        giftsGrid.classList.remove('hidden');
                        // Hide other tab content if they exist
                    } else {
                        giftsGrid.innerHTML = `<p class="empty-grid-message">Раздел "${button.textContent}" в разработке.</p>`;
                        // Show relevant tab content
                    }
                });
            });
            
            // Global scroll listener to hide context menus
            window.addEventListener('scroll', () => {
                if (!longPressMenu.classList.contains('hidden')) hideAllContextMenus();
            }, true); // Use capture phase

            // Telegram back button (use cautiously, might conflict with modal back buttons)
            // tg.BackButton.onClick(() => {
            //     const activeModal = document.querySelector('.modal-overlay.active');
            //     if (activeModal) {
            //         closeModal(activeModal);
            //     } else if (profilePage.classList.contains('active') && !currentProfileIsMe) {
            //         loadProfileData(); // Go back to my profile
            //     } else if (buyGiftsPage.classList.contains('active')) {
            //         loadProfileData(); // Go back to my profile
            //     } else {
            //         // tg.close(); // Or other default back action
            //     }
            // });
        }
        
        // --- START APP ---
        if (tg.initData && tg.initDataUnsafe) {
             initializeApp();
        } else {
            // Fallback for local development if Telegram WebApp script fails or not in TG env
            console.warn("Telegram WebApp not fully initialized. Using mock init or limited functionality.");
            tg.initData = "mock_init_data_string_for_dev_if_needed_for_auth_header"; // For API calls
            tg.initDataUnsafe = { user: { id: 0, first_name: "DevUser", username: "devuser" } }; // Mock user
            tg.themeParams = { /* default theme from CSS */ };
            tg.showAlert = (message) => alert(message);
            tg.HapticFeedback = {
                impactOccurred: (style) => console.log(`Haptic: ${style}`),
                notificationOccurred: (type) => console.log(`Haptic notification: ${type}`),
            };
            tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = ()=>{};
            tg.WebApp = {url: "http://localhost:8080/index.html"}; // mock URL

            document.addEventListener('DOMContentLoaded', initializeApp);
        }

    </script>
</body>
</html>
