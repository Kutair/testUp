<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Gift Simulator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- ADDED: SortableJS for drag-and-drop reordering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F3KPE0SD07"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-F3KPE0SD07');
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-blue: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2); 
            --app-rarity-chip-text: var(--tg-theme-text-color);
            --app-action-button-bg: #232e3a;
            --app-action-button-text: var(--tg-theme-link-color);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
            --app-clear-data-color: #ff3b30;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            line-height: 1.4;
            font-size: 16px;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Account Sidebar Styles */
        .account-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 320px;
            background-color: var(--tg-theme-bg-color);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        }
        .account-sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            display: flex;
            align-items: center;
        }
        .sidebar-header img {
            width: 50px; height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-header .name {
            font-size: 1.1em;
            font-weight: 500;
        }
        .accounts-list {
            list-style: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        .accounts-list li {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }
        .accounts-list li:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .accounts-list li.active {
            background-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
        }
        .accounts-list li img {
            width: 40px; height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .sidebar-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
        }
        .sidebar-footer button {
             width: 100%;
             padding: 12px;
             background: none;
             border: none;
             color: var(--tg-theme-link-color);
             text-align: left;
             font-size: 1em;
             cursor: pointer;
             border-radius: 8px;
        }
        .sidebar-footer button:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* End Account Sidebar */

        .page {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--tg-theme-bg-color);
        }

        .page.active {
            display: flex;
        }

        .page-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px;
            position: sticky; top: 0; z-index: 10;
        }
        #profile-page > .page-header { 
            background-color: transparent; 
            position: absolute;
            top: 0; left:0; right:0;
            z-index: 100;
        }
        .page-header .back-button {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            padding: 5px; margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
        }
        #profile-page > .page-header .back-button { color: var(--tg-theme-text-color); }
        .page-header h2 {
            font-size: 1.15em;
            color: var(--tg-theme-text-color);
            font-weight: 500;
        }
        .page-header .menu-button {
            background: none; 
            border: none;
            color: var(--tg-theme-link-color);
            margin-left: auto;
            cursor: pointer;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
            box-sizing: border-box;
        }
        .page-header .menu-button svg {
            width: 24px;
            height: 24px;
            fill: var(--tg-theme-link-color);
        }

        .profile-page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .profile-top-section {
            position: relative;
            padding-top: 56px;
            background: var(--app-profile-gradient-fallback);
            transition: background 0.3s ease;
        }
        .profile-header-pattern-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            opacity: 0.07;
            pointer-events: none;
            z-index: 0;
        }
        .profile-header-content-wrapper {
             position: relative; z-index: 1;
             padding: 0 15px;
        }
        .profile-top-pinned-gifts {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 5px 0 8px 0;
            min-height: 30px;
        }
        .profile-top-pinned-gifts .pinned-gift-item {
            width: 30px; height: 30px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
        }
        .profile-main-info {
            display: flex;
            align-items: center;
            padding: 8px 0 20px 0;
        }
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background-color: var(--tg-theme-hint-color);
            margin-right: 15px;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .profile-name-status { display: flex; flex-direction: column; }
        .profile-name-status .name-line { display: flex; align-items: center; }
        .profile-name-status h1 {
            font-size: 1.4em; font-weight: 600;
            color: var(--tg-theme-text-color);
        }
        #worn-gift-icon-container {
            width: 24px; height: 24px; margin-left: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .profile-name-status p { font-size: 0.95em; color: var(--tg-theme-text-color); opacity: 0.7; margin-top: 3px; }
        .profile-name-status p.online { opacity: 1; color: var(--tg-theme-link-color); }
        
        .profile-details-section {
            background-color: var(--tg-theme-bg-color);
            padding: 15px 15px 5px 15px;
        }
        .profile-details .info-block {
            margin-bottom: 16px;
        }
        .profile-details .info-value {
            font-size: 0.95em;
            color: var(--tg-theme-text-color);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .profile-details .info-label {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-bottom: 3px;
            display: block;
        }
        .profile-details .info-value.collectible-value {
            color: var(--tg-theme-link-color);
        }
        #profile-bio {
             cursor: pointer;
        }
        #collectible-usernames-container {
            margin-top: 4px;
            line-height: 1.5;
        }
        #collectible-usernames-container .also-text {
            color: var(--tg-theme-hint-color);
            margin-right: 6px;
        }
        #collectible-usernames-container .collectible-username-span {
            color: var(--tg-theme-link-color);
            margin-right: 6px;
            cursor: pointer;
        }


        .profile-tabs-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .profile-tabs {
            display: flex; justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            padding: 5px 0 0 0;
        }
        .profile-tabs button {
            background: none; border: none;
            color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em;
            cursor: pointer; flex-grow: 1;
            border-bottom: 3px solid transparent; position: relative;
            font-weight: 500;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); }
        .profile-tabs button.active::after {
            content: ''; position: absolute;
            bottom: 0px; left: 0; right: 0;
            height: 3px; background-color: var(--tg-theme-link-color);
        }
        .tab-content {
            display: none;
            flex-grow: 1;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        
        .profile-gifts-actions-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            padding: 12px 15px;
        }
        #filter-long-press-target {
            flex-grow: 1; height: 36px; cursor: pointer;
        }
        .profile-gifts-actions {
            display: flex; justify-content: flex-end;
            align-items: center;
            margin-left: 10px;
        }
        .profile-gifts-actions .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 8px 18px;
            border-radius: 20px; font-size: 0.9em; cursor: pointer;
            font-weight: 500;
        }
        #upgrade-all-gifts-button { background-color: var(--tg-theme-accent-blue); margin-right: 10px; }

        #exit-filter-mode-button, #hide-selected-gifts-button, #exit-selection-mode-button {
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--tg-theme-bg-color);
        }
        .empty-grid-message {
            color: var(--tg-theme-hint-color); text-align: center;
            padding: 30px 40px; font-size: 0.95em; line-height: 1.5; width: 100%; 
        }

        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 10px;
            padding: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out, opacity 0.2s;
        }
        .gift-card.is-hidden {
            opacity: 0.5;
            filter: grayscale(80%);
        }
        .buy-gift-item { aspect-ratio: 1/1.1; }
        .gift-card.is-updating { transform: scale(0.95); opacity: 0.7; }
        .gift-card.reordering {
            cursor: grabbing;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        .gift-card-bg-pattern, .buy-gift-item-bg-pattern {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; pointer-events: none; z-index: 0;
        }
        .gift-card-pattern-overlay, .buy-gift-item-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-repeat: repeat;
            background-size: 30% auto;
            background-position: center;
            opacity: 0.1;
            pointer-events: none; z-index: 1;
        }
        .image-container {
            width: 70%; height: 70%;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2;
        }
        .buy-gift-item .image-container {
            width: 65%; max-height: 60px;
            margin-bottom: 8px; height: auto;
        }
        
        .static-image-fallback {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
        }
        .lottie-animation-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        .gift-card .collectible-number-badge {
            position: absolute; top: 5px; right: 5px;
            background-color: rgba(0,0,0,0.35);
            color: var(--tg-theme-text-color);
            font-size: 0.65em; padding: 2px 5px;
            border-radius: 8px; z-index: 3; font-weight: 500;
        }
        .gift-card .gift-rarity-badge {
            position: absolute; bottom: 5px; left:0; right: 0;
            text-align: center;
            background-color: rgba(0,0,0,0.25);
            color: var(--tg-theme-text-color);
            font-size: 0.6em; padding: 2px 0;
            z-index: 3; font-weight: 400;
        }
        .gift-card .pin-indicator {
            position: absolute; top: 5px; left: 5px;
            z-index: 3; display: flex; align-items: center; justify-content: center;
        }
        .gift-card .pin-indicator svg { width: 18px; height: 18px; fill: var(--tg-theme-link-color); opacity: 0.8; }
        
        /* Selection Mode Checkbox */
        .gift-card .selection-checkbox {
            position: absolute; top: 5px; left: 5px;
            width: 22px; height: 22px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            border-radius: 50%;
            z-index: 4;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .gift-card.selected .selection-checkbox {
            background-color: var(--tg-theme-button-color);
        }
        .gift-card.selected .selection-checkbox::after {
            content: '✓';
            color: var(--tg-theme-button-text-color);
            font-size: 14px;
            font-weight: bold;
        }

        .buy-gift-item .gift-name {
            font-size: 0.8em; text-align: center;
            color: var(--tg-theme-text-color); margin-bottom: 6px;
            min-height: 2.4em; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            z-index: 2;
        }
        .buy-gift-item .gift-price {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .buy-gift-item .gift-price.has-price::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png');
            background-size: 16px 16px;
            background-repeat: repeat;
            opacity: 0.08;
            border-radius: 12px;
            z-index: -1;
        }

        .buy-gift-item .gift-price .star-icon {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .buy-gift-item .limited-label {
            position: absolute; top: 6px; right: 6px;
            background-color: var(--tg-theme-accent-blue);
            color: var(--tg-theme-button-text-color);
            font-size: 0.6em; padding: 2px 6px;
            border-radius: 8px; font-weight: 500; z-index: 3;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end;
            justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(100%);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transform: translateY(0%); }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding-top: 0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            width: 100%; max-width: 600px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal-header-bar {
            padding: 15px 20px; text-align: center;
            position: sticky; top: 0; background-color: var(--tg-theme-secondary-bg-color); z-index: 1;
        }
        .modal-header-bar h3 { font-size: 1.1em; font-weight: 500; }
        
        .modal-scrollable-content { overflow-y: auto; padding: 15px 20px; flex-grow: 1; }
        .modal-buttons-footer {
            padding: 15px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            position: sticky; bottom: 0; z-index: 1;
        }
        .modal-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            text-decoration: none;
            display: inline-block;
        }
        .modal-button.secondary {
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-link-color);
            margin-top: 10px;
        }

        #gift-detail-modal .modal-gift-image-container {
            width: 120px; height: 120px;
            margin: 10px auto 15px auto; display: flex;
            align-items: center; justify-content: center;
        }
        #gift-detail-modal .modal-gift-image-static {
             max-width: 100%; max-height: 100%; object-fit: contain;
        }
        #gift-detail-modal .lottie-animation-container {
             width: 100%; height: 100%;
        }
        #gift-detail-modal .modal-gift-description {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-align: center; line-height: 1.5;
        }
        #gift-detail-modal .modal-info-table .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.95em;
        }
        #gift-detail-modal .modal-info-table .info-row:not(:last-child) { margin-bottom: 2px; }
        #gift-detail-modal .modal-info-table .info-label { color: var(--tg-theme-text-color); }
        #gift-detail-modal .modal-info-table .info-value { color: var(--tg-theme-hint-color); }
        #gift-detail-modal .info-value-with-action { display: flex; align-items: center; }
        #gift-detail-modal .info-value-with-action span { margin-right: 10px; color: var(--tg-theme-hint-color); }
        #gift-detail-modal .button-link-styled {
            background: none; border: none;
            color: var(--tg-theme-link-color);
            font-size: 0.95em; font-weight: 500;
            padding: 5px; cursor: pointer;
        }
        #gift-detail-modal .button-link-styled:disabled { color: var(--tg-theme-hint-color); }

        #collectible-detail-modal .modal-content { padding-top: 0; }
        #collectible-detail-modal .page-header {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        #collectible-detail-modal .modal-scrollable-content { padding: 0; }
        .collectible-display-area {
            background-color: var(--tg-theme-bg-color);
            padding: 20px; text-align: center;
        }
        .collectible-display-area h3 {
            font-size: 1.4em; font-weight: 600; margin-top: 15px;
            color: var(--tg-theme-text-color);
        }
        .collectible-display-area p {
            font-size: 0.95em; color: var(--tg-theme-hint-color); margin-bottom: 10px;
        }
        .collectible-display-area p a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
            cursor: pointer;
        }
        .collectible-display-area p a:hover {
            text-decoration: underline;
        }
        .modal-collectible-visual {
            width: 60%; max-width: 220px;
            aspect-ratio: 1/1; margin: 0 auto;
            border-radius: 12px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        .modal-collectible-visual .collectible-bg-gradient { position: absolute; top:0;left:0;right:0;bottom:0; z-index: 1; }
        .modal-collectible-visual .collectible-pattern-tile {
            position: absolute; top:0;left:0;right:0;bottom:0;
            background-size: 25% auto; 
            background-repeat: repeat; opacity: 0.15; 
            z-index: 2;
        }
        .modal-collectible-visual .static-image-fallback {
             max-width: 80%; max-height: 80%; object-fit: contain; z-index: 3; position: relative;
        }
        .modal-collectible-visual .lottie-animation-container {
            width: 80%; height: 80%; object-fit: contain; z-index: 4; position: relative;
        }

        .modal-action-buttons-row {
            display: flex; justify-content: space-around; gap: 10px;
            padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-action-buttons-row button {
            flex-grow: 1; padding: 10px 5px; font-size: 0.9em;
            background-color: var(--app-action-button-bg);
            color: var(--tg-theme-text-color);
            border: none; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center;
            font-weight: 500;
        }
        .modal-action-buttons-row button .icon { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-action-buttons-row button .icon svg { width: 22px; height: 22px; fill: var(--tg-theme-link-color); }
        .modal-action-buttons-row button .text { font-size: 0.9em; }

        .collectible-info-section { padding: 0 20px; background-color: var(--tg-theme-secondary-bg-color); }
        .collectible-info-section .info-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 0.95em;
        }
        .collectible-info-section .info-row:not(:last-child) { margin-bottom: 2px; }
        .collectible-info-section .info-label { color: var(--tg-theme-text-color); }
        .collectible-info-section .info-value { color: var(--tg-theme-hint-color); display: flex; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .collectible-info-section .info-value.clickable-info { cursor: pointer; }
        .collectible-info-section .info-value.clickable-info:active { opacity: 0.7; }
        .collectible-info-section .info-value img.owner-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .collectible-info-section .info-value .rarity-chip {
            background-color: var(--app-rarity-chip-bg);
            color: var(--app-rarity-chip-text);
            padding: 2px 7px; border-radius: 8px;
            font-size: 0.8em; margin-left: 8px; font-weight: 500;
        }
        .rarity-chip .one-in-x {
            font-size: 0.9em;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        .modal-footer-message {
            text-align: center; font-size: 0.85em;
            color: var(--tg-theme-hint-color); padding: 15px 20px;
            background-color: var(--tg-theme-bg-color);
        }
        .modal-footer-message .link { color: var(--tg-theme-link-color); cursor: pointer; }

        #long-press-menu {
            position: fixed;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2001; /* Higher than sidebar overlay */
            padding: 6px 0; min-width: 220px;
        }
        #long-press-menu ul { list-style: none; }
        #long-press-menu li { padding: 10px 20px; cursor: pointer; color: var(--tg-theme-text-color); font-size: 0.95em; }
        #long-press-menu li.disabled { color: var(--tg-theme-hint-color); cursor: default; }
        #long-press-menu li.danger { color: var(--app-clear-data-color); }
        #long-press-menu li:not(.disabled):hover { background-color: rgba(255,255,255,0.05); }
        
        #buy-multiple-quantity {
            width: 80px; padding: 10px; text-align: center; margin-bottom:15px; 
            background-color: var(--tg-theme-bg-color); 
            color: var(--tg-theme-text-color); 
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; font-size: 1em;
        }
        #buy-multiple-quantity::-webkit-outer-spin-button,
        #buy-multiple-quantity::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #buy-multiple-quantity[type=number] { -moz-appearance: textfield; }

        .filter-section { margin-bottom: 15px; }
        .filter-section h4 {
            font-size: 0.9em; font-weight: 500; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; padding-left: 5px;
        }
        .filter-options-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; max-height: 150px; overflow-y: auto;
            padding: 5px; background-color: rgba(0,0,0,0.1); border-radius: 8px;
        }
        .filter-option {
            aspect-ratio: 1/1; border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .filter-option img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .filter-option .gradient-square { width: 100%; height: 100%; }
        
        #filter-popup .clear-data-button {
            background-color: transparent;
            color: var(--app-clear-data-color);
            border: none; padding: 13px; border-radius: 8px;
            font-size: 1em; cursor: pointer; text-align: center;
            font-weight: 500; width: 100%;
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px;
        }
        #filter-popup .clear-data-button svg { width: 20px; height: 20px; fill: currentColor; margin-right: 8px; }

        #filter-popup .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 5px;
            font-size: 1em;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--app-action-button-bg); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--tg-theme-link-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--tg-theme-link-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }

        #custom-buy-modal .filter-section, #chances-modal .filter-section { margin-bottom: 20px; }
        #custom-buy-modal .filter-options-grid, #chances-modal .filter-options-grid {
            max-height: 200px; overflow-y: auto; padding: 5px;
            background-color: rgba(0,0,0,0.1); border-radius: 8px;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        }
        #custom-buy-modal .filter-option, #chances-modal .filter-option {
            background-color: var(--tg-theme-bg-color); border: 2px solid transparent;
            border-radius: 8px; padding: 5px; flex-direction: column;
            justify-content: flex-start; height: auto; aspect-ratio: auto;
            min-height: 80px;
        }
        #custom-buy-modal .filter-option.selected, #chances-modal .filter-option.selected { border-color: var(--tg-theme-link-color); }
        #custom-buy-modal .filter-option img, #custom-buy-modal .filter-option .gradient-square,
        #chances-modal .filter-option img, #chances-modal .filter-option .gradient-square {
            width: 100%; height: 60px; object-fit: contain;
            border-radius: 4px; margin-bottom: 5px;
        }
        #custom-buy-modal .filter-option .label, #chances-modal .filter-option .label {
            font-size: 0.75em; color: var(--tg-theme-text-color); text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }

        #chances-probability-display {
            background-color: var(--tg-theme-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        #chances-probability-display .prob-value {
            font-size: 1.5em; font-weight: 600; color: var(--tg-theme-link-color);
            display: block; margin-bottom: 5px;
        }
        #chances-probability-display .prob-details {
            font-size: 0.9em; color: var(--tg-theme-hint-color);
        }

        /* Sell Gift & Transfer Gift Modal Styles */
        #sell-gift-modal .modal-gift-preview,
        #transfer-gift-modal .modal-gift-preview {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
        }
        #sell-gift-modal .modal-gift-preview img,
        #transfer-gift-modal .modal-gift-preview img {
            width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;
        }
        #sell-gift-modal .modal-gift-preview h4,
        #transfer-gift-modal .modal-gift-preview h4 {
            font-size: 1.1em; font-weight: 500;
        }
        
        .price-input-container {
            position: relative;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color);
        }
        .price-input-container label {
            display: block; font-size: 0.8em; color: var(--tg-theme-link-color);
            margin-bottom: 5px;
        }
        .price-input-wrapper {
            display: flex; align-items: center;
        }
        .price-input-wrapper img {
            width: 24px; height: 24px; margin-right: 10px;
        }
        .price-input-wrapper input {
            background: none; border: none; color: var(--tg-theme-text-color);
            font-size: 1.2em; width: 100%; outline: none;
        }
        .price-input-wrapper input::-webkit-outer-spin-button,
        .price-input-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .price-input-wrapper input[type=number] { -moz-appearance: textfield; }
        .price-details { text-align: center; font-size: 0.85em; color: var(--tg-theme-hint-color); margin-top: 10px; }
        
        #transfer-comment-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
            margin-top: 15px;
            resize: vertical;
        }


        .spinner {
            border: 4px solid var(--tg-theme-hint-color);
            border-top: 4px solid var(--tg-theme-link-color);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .placeholder-image {
            background-color: var(--tg-theme-hint-color); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-theme-bg-color); font-size: 0.8em; border-radius: 8px;
        }

        /* Collectible Numbers/Usernames Modal */
        #numbers-modal .collectible-list, #usernames-modal .collectible-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        #numbers-modal .collectible-list-item, #usernames-modal .collectible-list-item {
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid var(--tg-theme-bg-color);
            cursor: pointer;
            color: var(--tg-theme-link-color);
            font-family: monospace;
        }
        #usernames-modal .collectible-list-item {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--tg-theme-text-color);
        }
        #usernames-modal .collectible-list-item .at-symbol {
            color: var(--tg-theme-hint-color);
            margin-right: 2px;
        }
        #numbers-modal .collectible-list-item:hover, #usernames-modal .collectible-list-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        #usernames-modal .search-bar-container {
            padding: 10px 20px;
            background-color: var(--tg-theme-secondary-bg-color);
        }
        #usernames-modal #username-search-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-bg-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-size: 1em;
        }

        /* Settings Modal */
        #settings-modal .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; font-size: 1em;
            border-bottom: 1px solid var(--tg-theme-bg-color);
        }
        #settings-modal .settings-row:last-of-type { border-bottom: none; }
        #settings-modal .settings-row button {
            background: none; border: none; color: var(--tg-theme-link-color);
            font-size: 1em; cursor: pointer; text-align: left;
            padding: 0; width: auto; font-weight: 400;
        }
        #settings-modal .settings-row.danger button {
            color: var(--app-clear-data-color);
        }
        #settings-modal .settings-row button.full-width { width: 100%; text-align: center; }

    </style>
</head>
<body>
    <div class="account-sidebar" id="account-sidebar">
        <div class="sidebar-header">
            <img id="sidebar-current-avatar" src="" alt="Avatar">
            <span id="sidebar-current-name" class="name"></span>
        </div>
        <ul class="accounts-list" id="accounts-list"></ul>
        <div class="sidebar-footer">
            <button id="add-account-button">+ Add Account</button>
            <button id="open-numbers-button">📞 Numbers</button>
            <button id="open-usernames-button">@ Usernames</button>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="app-container">
        <div id="profile-page" class="page active">
             <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
             <div class="page-header">
                <button id="profile-back-button" class="back-button hidden"></button>
            </div>
            <div class="profile-page-content">
                <div id="profile-top-section" class="profile-top-section">
                    <div id="profile-header-pattern-overlay" class="profile-header-pattern-overlay"></div>
                    <div class="profile-header-content-wrapper">
                        <div id="profile-top-pinned-gifts" class="profile-top-pinned-gifts"></div>
                        <div id="profile-main-info-block" class="profile-main-info">
                            <img id="profile-avatar" class="profile-avatar" src="" alt="Avatar">
                            <div class="profile-name-status">
                                <div class="name-line">
                                    <h1 id="profile-name">Name</h1>
                                    <div id="worn-gift-icon-container" class="hidden lottie-animation-container"></div>
                                </div>
                                <p id="profile-gift-count-subtext">0 gifts</p>
                                <p id="profile-status" class="online">online</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-details-section">
                    <div id="profile-details" class="profile-details">
                         <div class="info-block">
                            <div class="info-label">Phone</div>
                            <div class="info-value" id="profile-phone"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Bio</div>
                            <div class="info-value" id="profile-bio"></div>
                        </div>
                         <div class="info-block">
                            <div class="info-label">Username</div>
                            <div class="info-value collectible-value" id="profile-username"></div>
                            <div class="info-value" id="collectible-usernames-container"></div>
                        </div>
                    </div>
                </div>
                <div class="profile-tabs-content">
                    <div class="profile-tabs">
                        <button id="posts-tab-button">Posts</button>
                        <button id="archive-tab-button">Archive</button>
                        <button class="active" id="gifts-tab-button">Gifts</button>
                    </div>
                    <div id="posts-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                     <div id="archive-content" class="tab-content">
                        <p class="empty-grid-message">Nothing to see here yet.</p>
                    </div>
                    <div id="gifts-content" class="tab-content active">
                        <div class="profile-gifts-actions-wrapper">
                            <div id="filter-long-press-target"></div>
                            <div class="profile-gifts-actions">
                                <!-- Dynamic buttons will be prepended here by JS -->
                                <button id="upgrade-all-gifts-button" class="action-button" style="display: none;">✨ Upgrade All</button>
                                <button id="go-to-buy-gifts" class="action-button">🎁 Buy Gifts</button>
                            </div>
                        </div>
                        <div id="gifts-grid" class="gifts-grid">
                            <div class="spinner hidden" id="gifts-loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="buy-gifts-page" class="page">
            <div class="page-header">
                <button id="back-to-profile-buy" class="back-button"></button>
                <h2>Gift Shop</h2> <!-- Long-press target for custom buy -->
            </div>
            <div id="buy-gifts-grid" class="gifts-grid">
                <div class="spinner" id="buy-gifts-loading-spinner"></div>
            </div>
        </div>

        <!-- Modals below -->
        <div id="gift-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3 id="modal-gift-name">Gift Name</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div id="modal-gift-image-container" class="modal-gift-image-container">
                        <div id="modal-lottie-gift-original" class="lottie-animation-container"></div>
                        <img id="modal-gift-image-static" class="static-image-fallback" src="" alt="Gift" style="display:none;">
                    </div>
                    <p id="modal-gift-description1" class="modal-gift-description"></p>
                    <p id="modal-gift-description2" class="modal-gift-description"></p>
                    <div id="modal-gift-info" class="modal-info-table"></div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-gift-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="collectible-detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="page-header">
                    <button id="back-from-collectible-modal" class="back-button"></button>
                    <h2 id="modal-collectible-header-title">Collectible</h2>
                    <button class="menu-button" id="collectible-menu-button">⋮</button>
                </div>
                <div class="modal-scrollable-content">
                    <div class="collectible-display-area">
                        <div id="modal-collectible-visual" class="modal-collectible-visual">
                            <div id="modal-collectible-bg" class="collectible-bg-gradient"></div>
                            <div id="modal-collectible-pattern" class="collectible-pattern-tile"></div>
                            <div id="modal-lottie-collectible-model" class="lottie-animation-container"></div>
                            <img id="modal-collectible-model-img-static" class="static-image-fallback" src="" alt="Model" style="display:none;">
                        </div>
                        <h3 id="modal-collectible-main-name">Model Name</h3>
                        <p id="modal-collectible-number-subtext">Collectible #123</p>
                    </div>

                    <div id="modal-collectible-actions" class="modal-action-buttons-row">
                        <button id="collectible-action-copy-link"><span class="icon"></span><span class="text">Copy Link</span></button>
                        <button id="collectible-action-wear"><span class="icon"></span><span class="text">Wear</span></button>
                        <button id="collectible-action-sell"><span class="icon"></span><span class="text">Sell</span></button>
                        <button id="collectible-action-transfer"><span class="icon"></span><span class="text">Transfer</span></button>
                    </div>
                    <div class="collectible-info-section">
                        <div id="modal-collectible-info-table" class="modal-info-table"></div>
                    </div>
                    <div class="modal-footer-message">
                        This gift is visible in your profile. <span id="hide-link-in-modal" class="link">Hide ></span>
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="close-collectible-detail-modal" class="modal-button">OK</button>
                </div>
            </div>
        </div>

        <div id="too-many-pins-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Too Many Pinned Gifts</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p style="margin-bottom:15px; color: var(--tg-theme-hint-color);">Select a gift to unpin. You can pin up to 6 collectible gifts.</p>
                    <div id="unpin-selection-grid" class="gifts-grid" style="grid-template-columns: repeat(3, 1fr); max-height: 200px; overflow-y: auto; padding:0 10px;">
                    </div>
                </div>
                 <div class="modal-buttons-footer">
                    <button id="cancel-unpin-modal" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="buy-multiple-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3 id="buy-multiple-modal-title">Buy Gift</h3></div>
                <div class="modal-scrollable-content" style="text-align: center;">
                    <p id="buy-multiple-gift-name" style="margin-bottom: 15px;"></p>
                    <label for="buy-multiple-quantity" style="display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color);">Quantity:</label>
                    <input type="number" id="buy-multiple-quantity" min="1" value="1">
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-buy-multiple" class="modal-button">Buy</button>
                    <button id="cancel-buy-multiple" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="filter-popup" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Gift Filters</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section" id="filter-collections-section">
                        <h4>Collections</h4>
                        <div class="filter-options-grid" id="filter-options-collections"></div>
                    </div>
                    <div class="filter-section hidden" id="filter-models-section">
                        <h4>Models</h4>
                        <div class="filter-options-grid" id="filter-options-models"></div>
                    </div>
                    <div class="filter-section" id="filter-backdrops-section">
                        <h4>Backdrops</h4>
                        <div class="filter-options-grid" id="filter-options-backdrops"></div>
                    </div>
                    <div class="filter-section" id="filter-patterns-section">
                        <h4>Symbols</h4>
                        <div class="filter-options-grid" id="filter-options-patterns"></div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.1); border-style: solid; border-width: 1px 0 0 0; margin: 20px 0;">
                </div>
                <div class="modal-buttons-footer">
                    <button id="apply-filters-button" class="modal-button">Apply Filters</button>
                    <button id="clear-filters-button" class="modal-button secondary">Reset Filters</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Settings</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="settings-row">
                        <label>Animations</label>
                        <label class="switch">
                            <input type="checkbox" id="animation-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <label>Show hidden gifts</label>
                        <label class="switch">
                            <input type="checkbox" id="show-hidden-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <button id="hide-multiple-button" class="full-width">Hide Multiple</button>
                    </div>
                    <div class="settings-row">
                        <button id="clear-current-account-data-button" class="full-width">Clear Current Account Data</button>
                    </div>
                    <div class="settings-row danger">
                        <button id="clear-all-accounts-data-button" class="full-width">Clear All Accounts Data</button>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-settings-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>
        
        <div id="chances-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Chance Calculator</h3>
                </div>
                <div class="modal-scrollable-content">
                    <p id="chances-gift-name" style="text-align: center; font-weight: 500; margin-bottom: 15px;"></p>
                    <div id="chances-probability-display"></div>
                    <div class="spinner hidden" id="chances-loading-spinner"></div>
                    <div class="filter-section hidden" id="chances-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="chances-options-models"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="chances-options-backdrops"></div>
                    </div>
                    <div class="filter-section hidden" id="chances-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="chances-options-patterns"></div>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-chances-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="custom-buy-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Create Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="filter-section">
                        <h4>Select base</h4>
                        <div class="filter-options-grid" id="custom-buy-base-gifts-grid"></div>
                    </div>
                    <div class="filter-section hidden" id="custom-buy-models-section">
                        <h4>Select model</h4>
                        <div class="filter-options-grid" id="custom-buy-models-grid"></div>
                    </div>
                    <div class="filter-section hidden" id="custom-buy-backdrops-section">
                        <h4>Select backdrop</h4>
                        <div class="filter-options-grid" id="custom-buy-backdrops-grid"></div>
                    </div>
                    <div class="filter-section hidden" id="custom-buy-patterns-section">
                        <h4>Select symbol</h4>
                        <div class="filter-options-grid" id="custom-buy-patterns-grid"></div>
                    </div>
                    <p style="text-align: center; color: var(--tg-theme-hint-color); font-size: 0.9em; margin-top: 15px;">
                        Gifts are created for free for simulation.
                    </p>
                </div>
                <div class="modal-buttons-footer">
                    <button id="custom-buy-confirm-button" class="modal-button" disabled>Create</button>
                    <button id="custom-buy-cancel-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="generated-image-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Your Gift</h3>
                </div>
                <div class="modal-scrollable-content" style="text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                    <div id="generated-image-container" style="width: 100%; max-width: 300px; aspect-ratio: 3 / 4; border-radius: 12px; overflow: hidden; background-color: var(--tg-theme-bg-color); display: flex; align-items: center; justify-content: center;">
                        <img id="generated-image-preview" src="" alt="Generated Gift" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <p id="generated-image-message" style="margin-top: 15px; color: var(--tg-theme-hint-color); font-size: 0.9em;"></p>
                </div>
                <div class="modal-buttons-footer" id="generated-image-footer">
                    <button id="send-generated-image-button" class="modal-button">Send to Me</button>
                    <button id="close-generated-image-modal" class="modal-button secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="sell-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Price in Stars</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="sell-gift-image" src="" alt="Gift Preview">
                        <h4 id="sell-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter price in Stars (125 - 100,000)</label>
                        <div class="price-input-wrapper">
                            <img src="https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png" alt="Star">
                            <input type="number" id="sell-price-input" placeholder="125" min="125" max="100000">
                        </div>
                    </div>
                    <div class="price-details">
                        <p id="sell-receive-amount">You will receive 100 Stars.</p>
                        <p id="sell-usd-amount">≈US$1.30</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-sell-button" class="modal-button" disabled>List for Sale</button>
                    <button id="cancel-sell-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="transfer-gift-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar">
                    <h3>Transfer Gift</h3>
                </div>
                <div class="modal-scrollable-content">
                    <div class="modal-gift-preview">
                        <img id="transfer-gift-image" src="" alt="Gift Preview">
                        <h4 id="transfer-gift-name"></h4>
                    </div>
                    <div class="price-input-container">
                        <label>Enter recipient's Telegram username</label>
                        <div class="price-input-wrapper">
                            <span style="font-size:1.2em; margin-right:10px; color:var(--tg-theme-text-color);">@</span>
                            <input type="text" id="transfer-username-input" placeholder="username">
                        </div>
                    </div>
                    <textarea id="transfer-comment-input" rows="2" placeholder="Add a comment... (optional)"></textarea>
                    <div class="price-details" id="transfer-status-message">
                        <p>Gift ownership will be transferred to this username.</p>
                    </div>
                </div>
                <div class="modal-buttons-footer">
                    <button id="confirm-transfer-button" class="modal-button" disabled>Confirm Transfer</button>
                    <button id="cancel-transfer-button" class="modal-button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="numbers-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Anonymous Numbers +888</h3></div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="numbers-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-numbers-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>

        <div id="usernames-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header-bar"><h3>Collectible Usernames</h3></div>
                <div class="search-bar-container">
                    <input type="text" id="username-search-input" placeholder="Search username...">
                </div>
                <div class="modal-scrollable-content" style="padding: 0;">
                    <ul class="collectible-list" id="usernames-list">
                    </ul>
                </div>
                <div class="modal-buttons-footer">
                    <button id="close-usernames-modal" class="modal-button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="long-press-menu" class="hidden">
        <ul>
            <li id="menu-reorder-action" class="hidden">Reorder</li>
            <li id="menu-pin-action">Pin</li>
            <li id="menu-hide-action">Hide</li>
            <li id="menu-copy-link-action" class="hidden">Copy Link</li>
            <li id="menu-share-image-action" class="hidden">Share Image</li>
            <li id="menu-delete-action" class="danger">Delete</li>
        </ul>
    </div>
    <script>
        const BACKEND_BASE_URL = "https://upgrade-a57g.onrender.com";

        const APP_VERSION_SUFFIX = '_v12'; // Increment to reset UI preferences in localStorage on major changes
        const CDN_BASE_URL = "https://cdn.changes.tg/gifts/";
        const GIFTS_JSON_URL = `${CDN_BASE_URL}id-to-name.json`;
        const PRICES_JSON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/prices.json";
        const STAR_ICON_URL = "https://raw.githubusercontent.com/Vasiliy-katsyka/upgrade/refs/heads/main/DMJTGStarsEmoji_AgADUhMAAk9WoVI.png";
        
        // Backend now handles limit, but client-side visual reminder
        const GIFT_LIMIT_PER_USER = 5000; 
        const MAX_COLLECTIBLE_USERNAMES = 10; // Backend also enforces this
        const MIN_SALE_PRICE = 125;
        const MAX_SALE_PRICE = 100000;

        const PIN_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>pin</title><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
        const BACK_ARROW_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>arrow-left-bold</title><path d="M20,9V15H12V19.84L4.16,12L12,4.16V9H20Z" /></svg>`;
        const DIAMOND_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>diamond-stone</title><path d="M16,9H19L14,16M10,9H14L12,17M5,9H8L10,16M5,4H19L12,1.5L5,4ZM6,2L2,8L12,22L22,8L18,2H6Z" /></svg>`;
        const CROWN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>crown</title><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5M19 19C19 19.6 18.6 20 18 20H6C5.4 20 5 19.6 5 19V18H19V19Z" /></svg>`;
        const LABEL_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>label</title><path d="M17.63,5.84C17.27,5.33 16.67,5 16,5H5A2,2 0 0,0 3,7V17A2,2 0 0,0 5,19H16C16.67,19 17.27,18.66 17.63,18.15L22,12L17.63,5.84Z" /></svg>`;
        const LINK_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>link-variant</title><path d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83L5.64,11.3C4.86,10.52 4.86,9.27 5.64,8.48L9.17,5.03C9.56,4.64 10.2,4.64 10.59,5.03C11,5.42 11,6.06 10.59,6.45L7.05,9.9C6.66,10.29 6.66,10.93 7.05,11.32L10.59,14.86M13.41,9.17C13,8.78 13,8.14 13.41,7.75L16.95,4.32C17.73,3.54 18.98,3.54 19.77,4.32L23.3,7.85C24.08,8.63 24.08,9.88 23.3,10.67L19.77,14.19C19.38,14.58 18.74,14.58 18.35,14.19C17.96,13.8 17.96,13.16 18.35,12.77L21.88,9.24C22.27,8.85 22.27,8.21 21.88,7.82L18.35,4.29C17.96,3.9 17.32,3.9 16.93,4.29L13.41,7.72C13,8.11 13,8.75 13.41,9.14" /></svg>`;
        const MENU_DOTS_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>dots-vertical</title><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>`;
        
        // --- Global State ---
        let allAvailableGifts = {};
        let giftPrices = {};
        
        // Simulated multiple accounts - stored client-side
        let accounts = []; 
        let currentAccountTgId = null;

        // --- Per-account state (in-memory, fetched from backend) ---
        let ownedGifts = []; // Gifts for the current active account
        let viewingOwnProfile = true; // Flag to check if we are viewing our own profile or someone else's
        let selectionModeActive = false; // Flag for "Hide Multiple" mode
        let selectedGiftIds = new Set(); // Stores instance_ids of gifts selected for hiding
        
        // Per-account UI state preferences (stored client-side in localStorage)
        let animationsEnabled = true;
        let showHiddenGifts = false;
        let activeFilters = { collection: null, model: null, backdrop: null, pattern: null };

        let tg = window.Telegram.WebApp;

        // --- DOM Elements ---
        const appContainer = document.querySelector('.app-container');
        const accountSidebar = document.getElementById('account-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarCurrentAvatar = document.getElementById('sidebar-current-avatar');
        const sidebarCurrentName = document.getElementById('sidebar-current-name');
        const accountsList = document.getElementById('accounts-list');
        const addAccountButton = document.getElementById('add-account-button');
        const openNumbersButton = document.getElementById('open-numbers-button');
        const openUsernamesButton = document.getElementById('open-usernames-button');

        const profilePage = document.getElementById('profile-page');
        const profileBackButton = document.getElementById('profile-back-button');
        const profileTopSection = document.getElementById('profile-top-section');
        const profileHeaderPatternOverlay = document.getElementById('profile-header-pattern-overlay');
        const profileAvatar = document.getElementById('profile-avatar');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const profileName = document.getElementById('profile-name');
        const wornGiftIconContainer = document.getElementById('worn-gift-icon-container');
        const profileGiftCountSubtext = document.getElementById('profile-gift-count-subtext');
        const profileStatus = document.getElementById('profile-status');
        const profileDetails = document.getElementById('profile-details');
        const profilePhone = document.getElementById('profile-phone');
        const profileBio = document.getElementById('profile-bio');
        const profileUsername = document.getElementById('profile-username');
        const collectibleUsernamesContainer = document.getElementById('collectible-usernames-container');
        const profileTopPinnedGifts = document.getElementById('profile-top-pinned-gifts');
        
        const giftsTabButton = document.getElementById('gifts-tab-button');
        const postsTabButton = document.getElementById('posts-tab-button');
        const archiveTabButton = document.getElementById('archive-tab-button');
        const giftsContent = document.getElementById('gifts-content');
        const postsContent = document.getElementById('posts-content');
        const archiveContent = document.getElementById('archive-content');
        
        const profileGiftsActions = document.querySelector('.profile-gifts-actions');
        const goToBuyGiftsButton = document.getElementById('go-to-buy-gifts');
        const upgradeAllGiftsButton = document.getElementById('upgrade-all-gifts-button');
        const filterLongPressTarget = document.getElementById('filter-long-press-target');
        const giftsGrid = document.getElementById('gifts-grid');
        const giftsLoadingSpinner = document.getElementById('gifts-loading-spinner');
        
        const buyGiftsPage = document.getElementById('buy-gifts-page');
        const backToProfileBuyButton = document.getElementById('back-to-profile-buy');
        const buyGiftsGrid = document.getElementById('buy-gifts-grid');
        const buyGiftsLoadingSpinner = document.getElementById('buy-gifts-loading-spinner');
        
        const giftDetailModal = document.getElementById('gift-detail-modal');
        const modalGiftName = document.getElementById('modal-gift-name');
        const modalLottieGiftOriginal = document.getElementById('modal-lottie-gift-original');
        const modalGiftImageStatic = document.getElementById('modal-gift-image-static');
        const modalGiftDescription1 = document.getElementById('modal-gift-description1');
        const modalGiftDescription2 = document.getElementById('modal-gift-description2');
        const modalGiftInfo = document.getElementById('modal-gift-info');
        const closeGiftDetailModalButton = document.getElementById('close-gift-detail-modal');
        
        const collectibleDetailModal = document.getElementById('collectible-detail-modal');
        const backFromCollectibleModal = document.getElementById('back-from-collectible-modal');
        const modalCollectibleHeaderTitle = document.getElementById('modal-collectible-header-title');
        const modalCollectibleVisual = document.getElementById('modal-collectible-visual');
        const modalCollectibleBg = document.getElementById('modal-collectible-bg');
        const modalCollectiblePattern = document.getElementById('modal-collectible-pattern');
        const modalLottieCollectibleModel = document.getElementById('modal-lottie-collectible-model');
        const modalCollectibleModelImgStatic = document.getElementById('modal-collectible-model-img-static');
        const modalCollectibleMainName = document.getElementById('modal-collectible-main-name');
        const modalCollectibleNumberSubtext = document.getElementById('modal-collectible-number-subtext');
        const modalCollectibleInfoTable = document.getElementById('modal-collectible-info-table');
        const collectibleActionCopyLink = document.getElementById('collectible-action-copy-link');
        const collectibleActionTransfer = document.getElementById('collectible-action-transfer');
        const collectibleActionWear = document.getElementById('collectible-action-wear');
        const collectibleActionSell = document.getElementById('collectible-action-sell');
        const closeCollectibleDetailModalButton = document.getElementById('close-collectible-detail-modal');
        const collectibleMenuButton = document.getElementById('collectible-menu-button'); 
        const hideLinkInModal = document.getElementById('hide-link-in-modal');

        const tooManyPinsModal = document.getElementById('too-many-pins-modal');
        const unpinSelectionGrid = document.getElementById('unpin-selection-grid');
        const cancelUnpinModal = document.getElementById('cancel-unpin-modal');
        
        const buyMultipleModal = document.getElementById('buy-multiple-modal');
        const buyMultipleModalTitle = document.getElementById('buy-multiple-modal-title');
        const buyMultipleGiftName = document.getElementById('buy-multiple-gift-name');
        const buyMultipleQuantityInput = document.getElementById('buy-multiple-quantity');
        const confirmBuyMultipleButton = document.getElementById('confirm-buy-multiple');
        const cancelBuyMultipleButton = document.getElementById('cancel-buy-multiple');
        
        const longPressMenu = document.getElementById('long-press-menu');
        const menuReorderAction = document.getElementById('menu-reorder-action');
        const menuPinAction = document.getElementById('menu-pin-action');
        const menuHideAction = document.getElementById('menu-hide-action');
        const menuCopyLinkAction = document.getElementById('menu-copy-link-action');
        const menuDeleteAction = document.getElementById('menu-delete-action');
        const menuShareImageAction = document.getElementById('menu-share-image-action');
        
        const filterPopup = document.getElementById('filter-popup');
        const filterModelsSection = document.getElementById('filter-models-section');
        const filterOptionsCollections = document.getElementById('filter-options-collections');
        const filterOptionsModels = document.getElementById('filter-options-models');
        const filterOptionsBackdrops = document.getElementById('filter-options-backdrops');
        const filterOptionsPatterns = document.getElementById('filter-options-patterns');
        const applyFiltersButton = document.getElementById('apply-filters-button');
        const clearFiltersButton = document.getElementById('clear-filters-button');
        
        const settingsModal = document.getElementById('settings-modal');
        const animationToggle = document.getElementById('animation-toggle');
        const showHiddenToggle = document.getElementById('show-hidden-toggle');
        const hideMultipleButton = document.getElementById('hide-multiple-button');
        const clearCurrentAccountDataButton = document.getElementById('clear-current-account-data-button');
        const clearAllAccountsDataButton = document.getElementById('clear-all-accounts-data-button');
        const closeSettingsModal = document.getElementById('close-settings-modal');

        const customBuyModal = document.getElementById('custom-buy-modal');
        const customBuyBaseGiftsGrid = document.getElementById('custom-buy-base-gifts-grid');
        const customBuyModelsSection = document.getElementById('custom-buy-models-section');
        const customBuyModelsGrid = document.getElementById('custom-buy-models-grid');
        const customBuyBackdropsSection = document.getElementById('custom-buy-backdrops-section');
        const customBuyBackdropsGrid = document.getElementById('custom-buy-backdrops-grid');
        const customBuyPatternsSection = document.getElementById('custom-buy-patterns-section');
        const customBuyPatternsGrid = document.getElementById('custom-buy-patterns-grid');
        const customBuyConfirmButton = document.getElementById('custom-buy-confirm-button');
        const customBuyCancelButton = document.getElementById('custom-buy-cancel-button');
        
        const generatedImageModal = document.getElementById('generated-image-modal');
        const generatedImageFooter = document.getElementById('generated-image-footer');
        const generatedImagePreview = document.getElementById('generated-image-preview');
        const generatedImageMessage = document.getElementById('generated-image-message');
        const sendGeneratedImageButton = document.getElementById('send-generated-image-button');
        const closeGeneratedImageModalButton = document.getElementById('close-generated-image-modal');
        
        const chancesModal = document.getElementById('chances-modal');
        const chancesGiftName = document.getElementById('chances-gift-name');
        const chancesLoadingSpinner = document.getElementById('chances-loading-spinner');
        const chancesProbabilityDisplay = document.getElementById('chances-probability-display');
        const chancesModelsSection = document.getElementById('chances-models-section');
        const chancesOptionsModels = document.getElementById('chances-options-models');
        const chancesBackdropsSection = document.getElementById('chances-backdrops-section');
        const chancesOptionsBackdrops = document.getElementById('chances-options-backdrops');
        const chancesPatternsSection = document.getElementById('chances-patterns-section');
        const chancesOptionsPatterns = document.getElementById('chances-options-patterns');
        const closeChancesModalButton = document.getElementById('close-chances-modal');
        
        const sellGiftModal = document.getElementById('sell-gift-modal');
        const sellGiftImage = document.getElementById('sell-gift-image');
        const sellGiftName = document.getElementById('sell-gift-name');
        const sellPriceInput = document.getElementById('sell-price-input');
        const sellReceiveAmount = document.getElementById('sell-receive-amount');
        const sellUsdAmount = document.getElementById('sell-usd-amount');
        const confirmSellButton = document.getElementById('confirm-sell-button');
        const cancelSellButton = document.getElementById('cancel-sell-button');

        const transferGiftModal = document.getElementById('transfer-gift-modal');
        const transferGiftImage = document.getElementById('transfer-gift-image');
        const transferGiftName = document.getElementById('transfer-gift-name');
        const transferUsernameInput = document.getElementById('transfer-username-input');
        const transferCommentInput = document.getElementById('transfer-comment-input');
        const transferStatusMessage = document.getElementById('transfer-status-message');
        const confirmTransferButton = document.getElementById('confirm-transfer-button');
        const cancelTransferButton = document.getElementById('cancel-transfer-button');
        
        const numbersModal = document.getElementById('numbers-modal');
        const numbersList = document.getElementById('numbers-list');
        const closeNumbersModal = document.getElementById('close-numbers-modal');
        
        const usernamesModal = document.getElementById('usernames-modal');
        const usernameSearchInput = document.getElementById('username-search-input');
        const usernamesList = document.getElementById('usernames-list');
        const closeUsernamesModal = document.getElementById('close-usernames-modal');

        const exitFilterModeButton = document.createElement('button');
        exitFilterModeButton.id = 'exit-filter-mode-button';
        exitFilterModeButton.className = 'action-button hidden';
        exitFilterModeButton.textContent = 'Exit Filter Mode';
        profileGiftsActions.prepend(exitFilterModeButton);
        
        const coolNumbers = ["+888 8888 8888", "+888 0000 0001", "+888 1234 5678", "+888 1111 1111", "+888 7777 7777", "+888 0707 6969"];
        const coolUsernames = ["durov", "admin", "king", "wallet", "crypto", "elon", "boss", "premium", "gift", "star", "diamond", "anonymous", "market", "bank", "news", "pessi", "penaldo"];
        
        let currentGiftToBuyMultiple = null;
        let lottieIntersectionObserver;
        let selectedCustomGift = {};
        let cachedCollectibleParts = {};
        let lastTap = 0;
        let tapCount = 0;
        let currentGiftToSell = null;
        let currentGiftToTransfer = null;
        let longPressAvatarTimer;
        let sortableInstance = null;

        // --- API Utility Function ---
        async function callBackend(endpoint, method = 'GET', data = null) {
            const url = `${BACKEND_BASE_URL}${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: data ? JSON.stringify(data) : null,
            };

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // Try to parse JSON error message, fallback to status text
                    const errorData = await response.json().catch(() => ({ message: response.statusText || 'Unknown error' }));
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorData.error || errorData.message}`);
                }
                // Handle 204 No Content for successful deletions/updates without a body
                return response.status === 204 ? null : await response.json();
            } catch (error) {
                console.error(`Backend API call failed: ${endpoint}`, error);
                throw error;
            }
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function generateUniqueId() { return `${Date.now().toString(36)}-${Math.random().toString(36).substring(2, 9)}`; }
        
        function formatRarity(permille) {
            if (!permille) return 'N/A';
            const percentage = permille / 1000;
            const oneInX = Math.round(100000 / permille); // Rarity is permille per 100,000. So 100,000 / permille
            return `${percentage}% <span class="one-in-x">(1 of ${oneInX.toLocaleString('en-US')})</span>`;
        }
        
        function playLottieAnimation(container, path, loop = true, isGridItem = false) {
            if (!animationsEnabled) {
                destroyLottieAnimation(container);
                const parentCard = container.closest('.gift-card, .buy-gift-item');
                if (parentCard) {
                    const staticFallback = parentCard.querySelector('.static-image-fallback');
                    if(staticFallback) staticFallback.style.display = 'block';
                    container.style.display = 'none';
                }
                return;
            }
            if (!container || !path) return;
            if (container.lottieInstance) { container.lottieInstance.destroy(); delete container.lottieInstance; }
            container.innerHTML = '';
            const anim = bodymovin.loadAnimation({ container: container, path: path, renderer: 'svg', loop: loop, autoplay: true });
            container.lottieInstance = anim;
            if (isGridItem && !loop) {
                anim.addEventListener('complete', () => { if (container.lottieInstance === anim) container.dataset.playedOnce = 'true'; });
            }
        }
        function destroyLottieAnimation(container) {
            if (container && container.lottieInstance) {
                container.lottieInstance.destroy();
                delete container.lottieInstance; delete container.dataset.playedOnce; container.innerHTML = '';
            }
        }
        function handleLottieIntersection(entries, observer) {
            entries.forEach(entry => {
                const cardElement = entry.target;
                const lottieContainer = cardElement.querySelector('.lottie-animation-container');
                const staticFallback = cardElement.querySelector('.static-image-fallback');
                const lottiePath = cardElement.dataset.lottiePath;
                if (entry.isIntersecting) {
                    if (animationsEnabled && lottiePath && lottieContainer) {
                        if(staticFallback) staticFallback.style.display = 'none';
                        lottieContainer.style.display = 'flex';
                        playLottieAnimation(lottieContainer, lottiePath, false, true);
                    }
                } else {
                    if (lottieContainer) {
                        destroyLottieAnimation(lottieContainer);
                        if(staticFallback) staticFallback.style.display = 'block';
                        lottieContainer.style.display = 'none';
                    }
                }
            });
        }
        function initLottieObserver() {
            lottieIntersectionObserver = new IntersectionObserver(handleLottieIntersection, { root: null, rootMargin: '100px', threshold: 0.01 });
        }
        function observeLottieElement(element) {
            if (lottieIntersectionObserver && element.dataset.lottiePath) lottieIntersectionObserver.observe(element);
        }
        function unobserveLottieElement(element) {
             if (lottieIntersectionObserver && element.dataset.lottiePath) {
                lottieIntersectionObserver.unobserve(element);
                const lottieContainer = element.querySelector('.lottie-animation-container');
                if(lottieContainer) destroyLottieAnimation(lottieContainer);
            }
        }
        
        async function initApp() {
            tg.ready(); tg.expand();
            initLottieObserver();
        
            profileBackButton.innerHTML = BACK_ARROW_SVG;
            backToProfileBuyButton.innerHTML = BACK_ARROW_SVG;
            backFromCollectibleModal.innerHTML = BACK_ARROW_SVG;
            collectibleActionCopyLink.querySelector('.icon').innerHTML = LINK_SVG;
            collectibleActionTransfer.querySelector('.icon').innerHTML = DIAMOND_SVG;
            collectibleActionWear.querySelector('.icon').innerHTML = CROWN_SVG;
            collectibleActionSell.querySelector('.icon').innerHTML = LABEL_SVG;
            collectibleMenuButton.innerHTML = MENU_DOTS_SVG;
        
            loadClientSideState();

            const startAppParam = tg.initDataUnsafe?.start_param;
            if (startAppParam) {
                if (startAppParam.startsWith('user')) {
                    const username = startAppParam.substring(4);
                    await displayUserProfile(username);
                } else if (startAppParam.startsWith('gift')) {
                    const giftString = startAppParam.substring(4);
                    const lastHyphenIndex = giftString.lastIndexOf('-');
                    if (lastHyphenIndex > -1) {
                        const giftTypeId = giftString.substring(0, lastHyphenIndex);
                        const collectibleNumber = parseInt(giftString.substring(lastHyphenIndex + 1), 10);
                        if (giftTypeId && !isNaN(collectibleNumber)) {
                            await initializeTelegramUserAccount(); // Initialize self first
                            await displayDeepLinkedGift(giftTypeId, collectibleNumber);
                        } else {
                            tg.showAlert("Invalid gift format in deep link.");
                            await initializeTelegramUserAccount();
                        }
                    } else {
                         tg.showAlert("Invalid gift format in deep link.");
                         await initializeTelegramUserAccount();
                    }
                } else {
                    await initializeTelegramUserAccount();
                }
            } else {
                await initializeTelegramUserAccount();
            }

            applyTheme(tg.themeParams);
            tg.onEvent('themeChanged', () => applyTheme(tg.themeParams));
            tg.SettingsButton.show();
            tg.SettingsButton.onClick(openSettingsModal);

            setupEventListeners();
            await fetchGiftPrices();
            await fetchAvailableGifts();
        }

        async function initializeTelegramUserAccount() {
            viewingOwnProfile = true; // Set flag that we are loading our own profile
            const user = tg.initDataUnsafe?.user;
            let tg_id = user?.id;

            if (!tg_id) {
                let mockAccount = JSON.parse(localStorage.getItem('giftSimMockTgUser' + APP_VERSION_SUFFIX));
                if (!mockAccount) {
                    mockAccount = {
                        tg_id: Math.floor(Math.random() * 1e9) + 1,
                        username: `mockuser_${Math.random().toString(36).substring(2, 6)}`,
                        full_name: `Mock User ${Math.floor(Math.random() * 100)}`,
                        avatar_url: `https://i.pravatar.cc/140?u=mock_${generateUniqueId()}`
                    };
                    localStorage.setItem('giftSimMockTgUser' + APP_VERSION_SUFFIX, JSON.stringify(mockAccount));
                }
                tg_id = mockAccount.tg_id;
            }

            try {
                const accountData = await callBackend('/api/account', 'POST', {
                    tg_id: tg_id,
                    username: user?.username,
                    full_name: user ? [user.first_name, user.last_name].filter(Boolean).join(' ') : 'Original User Name',
                    avatar_url: user?.photo_url || `https://i.pravatar.cc/140?u=${tg_id}`
                });

                currentAccountTgId = accountData.tg_id;
                ownedGifts = accountData.owned_gifts || [];

                let existingAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                if (existingAccount) {
                    Object.assign(existingAccount, accountData);
                } else {
                    accounts.push(accountData);
                }
                saveClientSideAccounts();
                renderAll();
                console.log("Account data loaded successfully.");
            } catch (error) {
                console.error("Failed to initialize Telegram user account:", error);
                tg.showAlert(`Failed to load your profile: ${error.message}. Please try again.`);
            }
        }

        async function displayDeepLinkedGift(giftTypeId, collectibleNumber) {
            try {
                const giftData = await callBackend(`/api/gift/${giftTypeId}/${collectibleNumber}`);
                if (giftData) {
                    const existingGift = ownedGifts.find(g => g.instance_id === giftData.instance_id);
                    if (!existingGift) {
                        ownedGifts.push(giftData); 
                    }
                    openGiftDetailByInstanceId(giftData.instance_id);
                } else {
                    tg.showAlert(`Gift with ID ${giftTypeId} #${collectibleNumber} not found.`);
                }
            } catch (error) {
                console.error("Error fetching deep-linked gift:", error);
                tg.showAlert(`Could not load gift ${giftTypeId} #${collectibleNumber}: ${error.message}`);
            }
        }
        
        async function displayUserProfile(username) {
             viewingOwnProfile = false; // Set flag that we are viewing someone else's profile
             try {
                const profileData = await callBackend(`/api/profile/${username}`);
                ownedGifts = profileData.owned_gifts || [];
                
                // Populate the UI with the fetched profile data
                profileName.textContent = profileData.full_name || 'User';
                profileAvatar.src = profileData.avatar_url || '';
                profileUsername.textContent = profileData.username ? `@${profileData.username}` : 'no username';
                profileBio.textContent = profileData.bio || "No bio yet";
                profilePhone.textContent = profileData.phone_number || "Not specified";

                collectibleUsernamesContainer.innerHTML = '';
                if (profileData.collectible_usernames && profileData.collectible_usernames.length > 0) {
                    const alsoSpan = document.createElement('span'); alsoSpan.className = 'also-text'; alsoSpan.textContent = 'also';
                    collectibleUsernamesContainer.appendChild(alsoSpan);
                    profileData.collectible_usernames.forEach(uname => {
                        const unameSpan = document.createElement('span'); unameSpan.className = 'collectible-username-span'; unameSpan.textContent = `@${uname}`;
                        collectibleUsernamesContainer.appendChild(unameSpan);
                    });
                }
                
                // Show a back button to return to own profile
                profileBackButton.classList.remove('hidden');
                profileBackButton.onclick = () => {
                    profileBackButton.classList.add('hidden');
                    initializeTelegramUserAccount();
                };

                // Disable editing for other profiles
                profileBio.style.cursor = 'default';
                profileBio.onclick = null;
                profileAvatar.style.cursor = 'default';

                renderAll(); // Re-render everything with the new user's data
            } catch (error) {
                console.error("Error fetching user profile:", error);
                tg.showAlert(`Could not load profile for @${username}: ${error.message}`);
                // Fallback to loading own profile
                await initializeTelegramUserAccount();
            }
        }
        
        function applyTheme(themeParams) { 
            if (themeParams && Object.keys(themeParams).length > 0) {
                const root = document.documentElement;
                const setVar = (varName, value) => { if (value) root.style.setProperty(varName, value); };
                setVar('--tg-theme-bg-color', themeParams.bg_color);
                setVar('--tg-theme-text-color', themeParams.text_color);
                setVar('--tg-theme-hint-color', themeParams.hint_color);
                setVar('--tg-theme-link-color', themeParams.link_color);
                setVar('--tg-theme-button-color', themeParams.button_color);
                setVar('--tg-theme-button-text-color', themeParams.button_text_color);
                setVar('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                setVar('--tg-theme-accent-blue', themeParams.accent_text_color || '#5288c1');
                document.body.style.backgroundColor = themeParams.bg_color || 'var(--tg-theme-bg-color)';
                document.body.style.color = themeParams.text_color || 'var(--tg-theme-text-color)';
                if (upgradeAllGiftsButton) upgradeAllGiftsButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                if (exitFilterModeButton) exitFilterModeButton.style.backgroundColor = themeParams.accent_text_color || 'var(--tg-theme-accent-blue)';
                applyWornGiftStyles();
            } else console.log("Using default CSS variables as themeParams are empty.");
        }
        
        function loadUserData() {
            const account = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!account) return;

            profileName.textContent = account.full_name || 'User';
            profileAvatar.src = account.avatar_url || '';
            profileAvatar.onerror = () => { profileAvatar.src = `https://i.pravatar.cc/140?u=fallback${generateUniqueId()}`; };
            profileUsername.textContent = account.username ? `@${account.username}` : 'no username';
            profileBio.textContent = account.bio || "No bio yet";
            profilePhone.textContent = account.phone_number || "Not specified";
            profileBio.style.cursor = 'pointer';
            profileAvatar.style.cursor = 'pointer';
            profileBackButton.classList.add('hidden'); // Hide back button on own profile

            collectibleUsernamesContainer.innerHTML = '';
            if (account.collectible_usernames && account.collectible_usernames.length > 0) {
                const alsoSpan = document.createElement('span');
                alsoSpan.className = 'also-text';
                alsoSpan.textContent = 'also';
                collectibleUsernamesContainer.appendChild(alsoSpan);

                account.collectible_usernames.forEach(uname => {
                    const unameSpan = document.createElement('span');
                    unameSpan.className = 'collectible-username-span';
                    unameSpan.textContent = `@${uname}`;
                    unameSpan.dataset.username = uname;
                    
                    unameSpan.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleDeleteCollectibleUsername(uname);
                    });

                    collectibleUsernamesContainer.appendChild(unameSpan);
                });
            }

            // Update sidebar header
            sidebarCurrentAvatar.src = account.avatar_url;
            sidebarCurrentName.textContent = account.full_name;
        }

        // --- Account Management (Client-side simulation of multiple accounts) ---
        function loadClientSideState() {
            // Load UI preferences
            animationsEnabled = JSON.parse(localStorage.getItem('animationsEnabled' + APP_VERSION_SUFFIX)) ?? true;
            showHiddenGifts = JSON.parse(localStorage.getItem('showHiddenGifts' + APP_VERSION_SUFFIX)) ?? false;
            activeFilters = JSON.parse(localStorage.getItem('activeFilters' + APP_VERSION_SUFFIX)) || { collection: null, model: null, backdrop: null, pattern: null };
            
            // Load simulated accounts list (should be lightweight)
            accounts = JSON.parse(localStorage.getItem('giftSimAccounts' + APP_VERSION_SUFFIX)) || [];
            currentAccountTgId = localStorage.getItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX);
        }

        function saveClientSideState() { 
            // Save UI preferences
            localStorage.setItem('activeFilters' + APP_VERSION_SUFFIX, JSON.stringify(activeFilters));
            localStorage.setItem('animationsEnabled' + APP_VERSION_SUFFIX, JSON.stringify(animationsEnabled));
            localStorage.setItem('showHiddenGifts' + APP_VERSION_SUFFIX, JSON.stringify(showHiddenGifts));
        }

        // CRITICAL FIX: Only store a lightweight version of accounts in localStorage
        function saveClientSideAccounts() {
            try {
                // Create a lightweight version of accounts for storage, stripping out heavy data.
                const accountsToStore = accounts.map(acc => {
                    return {
                        tg_id: acc.tg_id,
                        username: acc.username,
                        full_name: acc.full_name,
                        avatar_url: acc.avatar_url
                        // DO NOT include owned_gifts or collectible_usernames here
                    };
                });
                localStorage.setItem('giftSimAccounts' + APP_VERSION_SUFFIX, JSON.stringify(accountsToStore));
                localStorage.setItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX, currentAccountTgId);
            } catch (e) {
                // Catch potential quota errors and provide a better message.
                if (e.name === 'QuotaExceededError') {
                    console.error("LocalStorage quota exceeded even after trying to save lightweight data. This is unexpected.");
                    tg.showAlert("A storage error occurred. Please clear your browser cache or app data if the problem persists.");
                } else {
                    console.error("Error saving client side accounts:", e);
                }
            }
        }


        async function handleAddAccount() {
            const newTgId = Math.floor(Math.random() * 1e12) + 1; // Simulate a new unique Telegram ID
            const newAccountData = {
                tg_id: newTgId,
                username: `mockuser_${Math.random().toString(36).substring(2, 8)}`,
                full_name: `Test User ${accounts.length + 1}`,
                avatar_url: `https://i.pravatar.cc/140?u=${newTgId}`
            };

            try {
                const createdAccount = await callBackend('/api/account', 'POST', newAccountData);
                accounts.push(createdAccount);
                await switchAccount(createdAccount.tg_id);
                closeSidebar();
            } catch (error) {
                tg.showAlert(`Failed to add account: ${error.message}`);
            }
        }

        async function switchAccount(tgId) {
            currentAccountTgId = tgId;
            saveClientSideAccounts(); // Save the new current ID

            try {
                // Fetch the selected account's full data (including gifts) from the backend
                const accountData = await callBackend('/api/account', 'POST', { tg_id: tgId });
                
                // Update the in-memory account object
                let existingAccount = accounts.find(acc => acc.tg_id === tgId);
                if (existingAccount) {
                    Object.assign(existingAccount, accountData);
                } else {
                    accounts.push(accountData); // Should not happen if tgId exists in accounts array
                }
                
                // **CRITICAL**: Update the global 'ownedGifts' variable with the new data.
                ownedGifts = accountData.owned_gifts || []; 

                renderAll();
            } catch (error) {
                tg.showAlert(`Failed to switch account: ${error.message}`);
                // Revert to previous account or handle error gracefully
                currentAccountTgId = localStorage.getItem('giftSimCurrentAccountTgId' + APP_VERSION_SUFFIX); // Try to restore
                renderAll(); // Render with previous data
            }
        }

        function renderAll() {
            if (viewingOwnProfile) {
                loadUserData();
            }
            renderAccountsList();
            animationToggle.checked = animationsEnabled;
            showHiddenToggle.checked = showHiddenGifts;
            applyWornGiftStyles(); // Re-apply current worn gift styling
            renderProfileGifts();
            displayFilterExitButton();
        }

        function renderAccountsList() {
            accountsList.innerHTML = '';
            accounts.forEach(acc => {
                const li = document.createElement('li');
                li.dataset.accountId = acc.tg_id;
                li.innerHTML = `<img src="${acc.avatar_url}" alt="Avatar"> <span>${acc.full_name}</span>`;
                if (acc.tg_id === currentAccountTgId) {
                    li.classList.add('active');
                }
                li.addEventListener('click', async () => {
                    if (acc.tg_id !== currentAccountTgId) {
                        await switchAccount(acc.tg_id);
                    }
                    closeSidebar();
                });
                accountsList.appendChild(li);
            });
        }

        function openSidebar() {
            renderAccountsList();
            accountSidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        }

        function closeSidebar() {
            accountSidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }
        
        function applyWornGiftStyles() {
            // Uses the global `ownedGifts` variable now
            const wornGift = ownedGifts.find(g => g.is_worn === true);

            destroyLottieAnimation(wornGiftIconContainer);
            if (wornGift && wornGift.is_collectible && wornGift.collectible_data) {
                const cd = wornGift.collectible_data;
                if (animationsEnabled && cd.lottieModelPath) {
                    playLottieAnimation(wornGiftIconContainer, cd.lottieModelPath, true);
                } else if (cd.modelImage) {
                    wornGiftIconContainer.innerHTML = `<img src="${cd.modelImage}" style="width:100%; height:100%; object-fit:contain;">`;
                }
                wornGiftIconContainer.classList.remove('hidden');
                const colors = cd.backdropColors;
                if (colors) profileTopSection.style.background = `radial-gradient(circle at 50% 0%, ${colors.centerColor} 0%, ${colors.edgeColor} 100%)`;
                else profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                if (cd.patternImage) {
                    profileHeaderPatternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                    profileHeaderPatternOverlay.style.opacity = '0.07';
                } else profileHeaderPatternOverlay.style.backgroundImage = 'none';
            } else {
                wornGiftIconContainer.classList.add('hidden');
                wornGiftIconContainer.innerHTML = '';
                profileTopSection.style.background = 'var(--app-profile-gradient-fallback)';
                profileHeaderPatternOverlay.style.backgroundImage = 'none';
            }
        }
        
        function showPage(pageId) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        async function fetchGiftPrices() {
            try {
                const response = await fetch(PRICES_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                giftPrices = await response.json();
            } catch (error) {
                console.error("Could not fetch gift prices:", error);
                giftPrices = {};
            }
        }

        async function fetchAvailableGifts() { 
            buyGiftsLoadingSpinner.classList.remove('hidden');
            buyGiftsGrid.innerHTML = '';
            try {
                const response = await fetch(GIFTS_JSON_URL, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                allAvailableGifts = await response.json();
                renderAvailableGifts();
                populateFilterOptions();
            } catch (error) {
                console.error("Could not load available gifts:", error);
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">Could not load gifts. Please try again later.</p>`;
            } finally {
                buyGiftsLoadingSpinner.classList.add('hidden');
            }
        }
        
        function renderAvailableGifts() {
            buyGiftsGrid.innerHTML = '';
            if (Object.keys(allAvailableGifts).length === 0 && !buyGiftsLoadingSpinner.classList.contains('hidden')) {
                buyGiftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">No gifts available right now.</p>`; return;
            }
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                const lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
                const price = giftPrices[name];

                const item = document.createElement('div');
                item.className = 'buy-gift-item';
                item.dataset.id = id; item.dataset.name = name;
                item.dataset.originalImage = originalImageUrl;
                item.dataset.lottiePath = lottiePath;
                
                const priceHTML = price
                    ? `<div class="gift-price has-price"><img src="${STAR_ICON_URL}" class="star-icon" alt="Star"/> ${price}</div>`
                    : `<div class="gift-price">Free</div>`;
        
                item.innerHTML = `
                    <div class="image-container">
                        <div class="lottie-animation-container" style="display:none;"></div>
                        <img class="static-image-fallback" src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.innerHTML = '🖼️';">
                    </div>
                    <div class="gift-name">${name}</div>
                    ${priceHTML}
                    <div class="limited-label">Limited</div>
                `;
                item.addEventListener('click', () => buyGift(id, name, originalImageUrl, lottiePath, 1));
                
                let buyItemLongPressTimer;
                item.addEventListener('touchstart', (e) => { buyItemLongPressTimer = setTimeout(() => openBuyMultipleModal(id, name, originalImageUrl, lottiePath), 700); }, { passive: true });
                item.addEventListener('touchend', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(buyItemLongPressTimer));
                item.addEventListener('contextmenu', (e) => { e.preventDefault(); openBuyMultipleModal(id, name, originalImageUrl, lottiePath); });
                
                observeLottieElement(item);
                buyGiftsGrid.appendChild(item);
            }
        }
        
        function getGiftCountText(count) { 
            return count === 1 ? `${count} gift` : `${count} gifts`;
        }

        function updateAllAnimationsState() {
            document.querySelectorAll('.lottie-animation-container').forEach(container => {
                const parentCard = container.closest('[data-lottie-path]');
                const modal = container.closest('.modal-overlay.active');
                
                if (animationsEnabled) {
                    if (parentCard && parentCard.offsetParent !== null) { observeLottieElement(parentCard); } 
                    else if (container.id === 'worn-gift-icon-container') { applyWornGiftStyles(); } 
                    else if (modal) {
                         if (container.id === 'modal-lottie-gift-original' && giftDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === giftDetailModal.dataset.instanceId);
                             if (gift && gift.lottie_path) playLottieAnimation(container, gift.lottie_path, true);
                         }
                         if (container.id === 'modal-lottie-collectible-model' && collectibleDetailModal.classList.contains('active')) {
                             const gift = ownedGifts.find(g => g.instance_id === collectibleDetailModal.dataset.instanceId);
                             if (gift?.collectible_data?.lottieModelPath) playLottieAnimation(container, gift.collectible_data.lottieModelPath, true);
                         }
                    } else if (container.closest('#profile-top-pinned-gifts')) { renderTopPinnedGiftsPreview(); }
                } else {
                    destroyLottieAnimation(container);
                    if (parentCard) {
                        const staticFallback = parentCard.querySelector('.static-image-fallback');
                        if (staticFallback) staticFallback.style.display = 'block';
                        container.style.display = 'none';
                    }
                }
            });
            applyWornGiftStyles();
        }

        function renderProfileGifts() {
            Array.from(giftsGrid.children).forEach(child => unobserveLottieElement(child));
            giftsGrid.innerHTML = '';
            
            const baseGifts = showHiddenGifts ? ownedGifts : ownedGifts.filter(g => !g.is_hidden);

            const filteredGifts = baseGifts.filter(gift => { 
                if (activeFilters.collection && gift.gift_type_id !== activeFilters.collection) return false;
                if (gift.is_collectible && gift.collectible_data) {
                    if (activeFilters.model && gift.collectible_data.model?.name !== activeFilters.model) return false;
                    if (activeFilters.backdrop && gift.collectible_data.backdrop?.name !== activeFilters.backdrop) return false;
                    if (activeFilters.pattern && gift.collectible_data.pattern?.name !== activeFilters.pattern) return false;
                } else if (activeFilters.model || activeFilters.backdrop || activeFilters.pattern) return false;
                return true;
            });

            profileGiftCountSubtext.textContent = getGiftCountText(filteredGifts.length);
            if (ownedGifts.length > 0 && filteredGifts.length !== ownedGifts.length) {
                profileGiftCountSubtext.textContent += ` of ${ownedGifts.length}`;
            }
            
            const sortedGifts = [...filteredGifts].sort((a, b) => { 
                // Pinned gifts first
                if (a.is_pinned && !b.is_pinned) return -1; 
                if (!a.is_pinned && b.is_pinned) return 1;
                // Then by acquired date (newest first)
                return (new Date(b.acquired_date || 0)) - (new Date(a.acquired_date || 0));
            });

            if (sortedGifts.length === 0) { 
                giftsGrid.style.display = 'flex'; giftsGrid.style.alignItems = 'center'; giftsGrid.style.justifyContent = 'center';
                let emptyMessage = "You don't have any gifts yet.";
                if (ownedGifts.length > 0) {
                    emptyMessage = "No gifts match the selected filters.";
                    if (!showHiddenGifts && ownedGifts.some(g => g.is_hidden)) {
                        emptyMessage += " Some gifts might be hidden.";
                    }
                }
                giftsGrid.innerHTML = `<p class="empty-grid-message" style="width:100%;">${emptyMessage}</p>`;
            } else {
                giftsGrid.style.display = 'grid';
                sortedGifts.forEach(gift => {
                    const card = createGiftCardDOM(gift);
                    giftsGrid.appendChild(card);
                    observeLottieElement(card);
                });
            }
            renderTopPinnedGiftsPreview();
            const hasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            if (upgradeAllGiftsButton) { 
                upgradeAllGiftsButton.style.display = (hasNonCollectible && viewingOwnProfile) ? 'inline-block' : 'none';
                if (!hasNonCollectible) { upgradeAllGiftsButton.textContent = '✨ Upgrade All'; upgradeAllGiftsButton.disabled = false; }
            }
            if(goToBuyGiftsButton) goToBuyGiftsButton.style.display = viewingOwnProfile ? 'inline-block' : 'none';
            displayFilterExitButton();
        }
        
        function createGiftCardDOM(gift) {
            const card = document.createElement('div');
            card.className = 'gift-card';
            if (gift.is_hidden) {
                card.classList.add('is-hidden');
            }
            card.dataset.instanceId = gift.instance_id;
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            const lottieContainer = document.createElement('div');
            lottieContainer.className = 'lottie-animation-container';
            lottieContainer.style.display = 'none';
            const staticImage = document.createElement('img');
            staticImage.className = 'static-image-fallback';
            staticImage.loading = 'lazy';
            let lottiePathForCard = null;
        
            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                staticImage.src = cd.modelImage || gift.original_image_url;
                staticImage.alt = cd.model?.name || gift.gift_name;
                lottiePathForCard = cd.lottieModelPath;
                const bgDiv = document.createElement('div'); bgDiv.className = 'gift-card-bg-pattern';
                if (cd.backdropColors) bgDiv.style.background = `radial-gradient(circle, ${cd.backdropColors.centerColor}, ${cd.backdropColors.edgeColor})`;
                else bgDiv.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
                card.appendChild(bgDiv);
                if (cd.patternImage) { const pOverlay = document.createElement('div'); pOverlay.className = 'gift-card-pattern-overlay'; pOverlay.style.backgroundImage = `url('${cd.patternImage}')`; card.appendChild(pOverlay); }
                const numDiv = document.createElement('div'); numDiv.className = 'collectible-number-badge'; numDiv.textContent = `#${gift.collectible_number}`; card.appendChild(numDiv);
                if (cd.supply) { 
                    const rBadge = document.createElement('div'); 
                    rBadge.className = 'gift-rarity-badge'; 
                    rBadge.textContent = `1 of ${(cd.supply / 1000).toFixed(1)}K`; 
                    card.appendChild(rBadge); 
                }
            } else {
                staticImage.src = gift.original_image_url; staticImage.alt = gift.gift_name;
                lottiePathForCard = gift.lottie_path;
            }
            if (lottiePathForCard) card.dataset.lottiePath = lottiePathForCard;
            staticImage.onerror = function() { this.style.display='none'; lottieContainer.innerHTML = '🖼️';};
            imageContainer.appendChild(lottieContainer); imageContainer.appendChild(staticImage);
            card.appendChild(imageContainer);
            if (gift.is_pinned) { 
                const pinDiv = document.createElement('div'); pinDiv.className = 'pin-indicator';
                pinDiv.innerHTML = PIN_ICON_SVG; pinDiv.querySelector('svg').style.fill = 'var(--tg-theme-link-color)';
                card.appendChild(pinDiv);
            }

            if (selectionModeActive) {
                const checkbox = document.createElement('div');
                checkbox.className = 'selection-checkbox';
                card.appendChild(checkbox);
                if (selectedGiftIds.has(gift.instance_id)) {
                    card.classList.add('selected');
                }
                card.onclick = () => toggleGiftSelection(gift.instance_id);
            } else {
                card.onclick = () => openGiftDetailByInstanceId(gift.instance_id);
                setupLongPress(card, gift);
            }

            return card;
        }
        
        function renderTopPinnedGiftsPreview() {
            Array.from(profileTopPinnedGifts.children).forEach(childLottieContainer => destroyLottieAnimation(childLottieContainer));
            profileTopPinnedGifts.innerHTML = '';

            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden);

            pinnedGifts.slice(0, 7).forEach(gift => {
                const container = document.createElement('div');
                container.className = 'pinned-gift-item';
                container.dataset.instanceId = gift.instance_id;
                container.addEventListener('click', () => openGiftDetailByInstanceId(gift.instance_id));
                let lottiePathForPinned = null, imageForPinned = gift.original_image_url;
                if (gift.is_collectible && gift.collectible_data) {
                    lottiePathForPinned = gift.collectible_data.lottieModelPath;
                    imageForPinned = gift.collectible_data.modelImage || gift.original_image_url;
                } else if (gift.lottie_path) {
                    lottiePathForPinned = gift.lottie_path;
                }
                if (animationsEnabled && lottiePathForPinned) {
                    container.classList.add('lottie-animation-container');
                    playLottieAnimation(container, lottiePathForPinned, true);
                } else {
                     container.innerHTML = `<img src="${imageForPinned}" alt="${gift.gift_name}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.innerHTML = '🎁'">`;
                }
                profileTopPinnedGifts.appendChild(container);
            });
        }
        
        function openBuyMultipleModal(id, name, originalImage, lottiePath) {
            currentGiftToBuyMultiple = { id, name, originalImage, lottiePath };
            buyMultipleModalTitle.textContent = `Buy "${name}"`;
            buyMultipleGiftName.textContent = `Enter quantity for "${name}"`;
            buyMultipleQuantityInput.value = "1";
            buyMultipleModal.classList.add('active');
            buyMultipleQuantityInput.focus();
        }

        async function buyGift(id, name, originalImage, lottiePath, quantity = 1) {
            if (ownedGifts.length + quantity > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot buy ${quantity} gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            try {
                for (let i = 0; i < quantity; i++) {
                    const newGiftInstanceId = generateUniqueId();
                    await callBackend('/api/gifts', 'POST', {
                        instance_id: newGiftInstanceId,
                        owner_id: currentAccountTgId,
                        gift_type_id: id,
                        gift_name: name,
                        original_image_url: originalImage,
                        lottie_path: lottiePath
                    });
                    
                    // Add gift to local state for immediate feedback
                    ownedGifts.unshift({
                        instance_id: newGiftInstanceId,
                        owner_id: currentAccountTgId,
                        gift_type_id: id,
                        gift_name: name,
                        original_image_url: originalImage,
                        lottie_path: lottiePath,
                        is_collectible: false,
                        acquired_date: new Date().toISOString()
                    });
                }
                
                // Refresh UI
                renderProfileGifts();
                tg.HapticFeedback.notificationOccurred('success');
                const message = quantity > 1 ? `Added ${quantity} "${name}" gifts!` : `Added "${name}" gift!`;
                tg.showAlert(message); 
                showPage('profile-page');
                
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert(`Failed to buy gifts: ${error.message}`);
            }
        }
        
        async function handleConfirmBuyMultiple() {
            if (!currentGiftToBuyMultiple) return;
            const quantity = parseInt(buyMultipleQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) { tg.showAlert("Please enter a valid quantity."); return; }
            
            // Temporarily disable the button
            confirmBuyMultipleButton.disabled = true;
            confirmBuyMultipleButton.textContent = 'Buying...';

            await buyGift(currentGiftToBuyMultiple.id, currentGiftToBuyMultiple.name, currentGiftToBuyMultiple.originalImage, currentGiftToBuyMultiple.lottiePath, quantity);
            
            confirmBuyMultipleButton.disabled = false;
            confirmBuyMultipleButton.textContent = 'Buy';
            closeModal(buyMultipleModal);
            currentGiftToBuyMultiple = null;
        }
        
        function getGiftDeepLink(gift) {
            const botUsername = "upgradeDemoBot"; // Replace with your bot username
            const appShortName = "upgrade"; // Replace with your Mini App short name
            
            // CRITICAL FIX: Always use the gift_type_id (the number string)
            const giftTypeIdForLink = gift.gift_type_id; 
            const numberForLink = gift.collectible_number;
            
            return `https://t.me/${botUsername}/${appShortName}?startapp=gift${giftTypeIdForLink}-${numberForLink}`;
        }
        
        function openGiftDetailByInstanceId(instanceId) {
            const gift = ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift) return;
            tapCount = 0; // Reset triple tap counter
            giftDetailModal.dataset.instanceId = gift.instance_id;
            collectibleDetailModal.dataset.instanceId = gift.instance_id;
        
            if (gift.is_collectible && gift.collectible_data) {
                const cd = gift.collectible_data;
                modalCollectibleHeaderTitle.textContent = gift.gift_name;
                modalCollectibleMainName.textContent = cd.model?.name || gift.gift_name;

                const numberForLink = gift.collectible_number;
                modalCollectibleNumberSubtext.innerHTML = `<a id="collectible-link-copier" href="#">Collectible #${numberForLink.toLocaleString()}</a>`;

                modalCollectibleBg.style.background = `radial-gradient(circle, ${cd.backdropColors?.centerColor || '#555'}, ${cd.backdropColors?.edgeColor || '#333'})`;
                modalCollectiblePattern.style.backgroundImage = cd.patternImage ? `url('${cd.patternImage}')` : 'none';
                destroyLottieAnimation(modalLottieCollectibleModel);
                modalCollectibleModelImgStatic.style.display = 'block';
                modalLottieCollectibleModel.style.display = 'none';
                if (animationsEnabled && cd.lottieModelPath) { 
                    playLottieAnimation(modalLottieCollectibleModel, cd.lottieModelPath, true); 
                    modalCollectibleModelImgStatic.style.display = 'none'; modalLottieCollectibleModel.style.display = 'flex';
                } else { 
                     modalCollectibleModelImgStatic.src = cd.modelImage || gift.original_image_url; 
                     modalCollectibleModelImgStatic.onerror = function() { this.src = `https://i.pravatar.cc/200?u=err${generateUniqueId()}`; }; 
                }
                const account = accounts.find(acc => acc.tg_id === gift.owner_id);
                const ownerName = account?.full_name || 'Test Account'; 
                const ownerAvatar = account?.avatar_url || `https://i.pravatar.cc/140?u=${generateUniqueId()}`; // Fallback avatar

                modalCollectibleInfoTable.innerHTML = `
                    <div class="info-row"><span class="info-label">Owner</span><span class="info-value"><img src="${ownerAvatar}" alt="" class="owner-avatar">${ownerName}</span></div>
                    <div class="info-row"><span class="info-label">Model</span><span id="collectible-model-value" class="info-value clickable-info">${cd.model?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.model?.rarityPermille || 0)}</span></span></div>
                    <div class="info-row"><span class="info-label">Backdrop</span><span id="collectible-backdrop-value" class="info-value clickable-info">${cd.backdrop?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.backdrop?.rarityPermille || 0)}</span></span></div>
                    <div class="info-row"><span class="info-label">Symbol</span><span id="collectible-pattern-value" class="info-value clickable-info">${cd.pattern?.name || 'N/A'} <span class="rarity-chip">${formatRarity(cd.pattern?.rarityPermille || 0)}</span></span></div>
                    <div class="info-row"><span class="info-label">Number</span><span class="info-value">#${gift.collectible_number.toLocaleString()} of ${cd.supply?.toLocaleString() || 'N/A'}</span></div>`;
                
                // Check if current user is owner to enable actions
                const isOwner = (gift.owner_id === currentAccountTgId);
                collectibleActionCopyLink.style.display = 'flex'; // Always show copy link
                collectibleActionTransfer.style.display = isOwner ? 'flex' : 'none';
                collectibleActionWear.style.display = isOwner ? 'flex' : 'none';
                collectibleActionSell.style.display = isOwner ? 'flex' : 'none';
                collectibleMenuButton.style.display = isOwner ? 'flex' : 'none';
                hideLinkInModal.style.display = isOwner ? 'inline' : 'none';

                collectibleActionWear.querySelector('.text').textContent = (gift.is_worn === true) ? 'Take Off' : 'Wear';
                collectibleDetailModal.classList.add('active');

                document.getElementById('collectible-link-copier').onclick = (e) => {
                    e.preventDefault();
                    copyGiftLink(gift);
                };

                const modelValueEl = document.getElementById('collectible-model-value');
                const backdropValueEl = document.getElementById('collectible-backdrop-value');
                const patternValueEl = document.getElementById('collectible-pattern-value');
                if (modelValueEl) modelValueEl.addEventListener('click', (e) => handleTripleTap(e, 'model', gift.collectible_data.model?.name));
                if (backdropValueEl) backdropValueEl.addEventListener('click', (e) => handleTripleTap(e, 'backdrop', gift.collectible_data.backdrop?.name));
                if (patternValueEl) patternValueEl.addEventListener('click', (e) => handleTripleTap(e, 'pattern', gift.collectible_data.pattern?.name));

            } else {
                modalGiftName.textContent = "Saved Gift";
                destroyLottieAnimation(modalLottieGiftOriginal);
                modalGiftImageStatic.style.display = 'block'; modalLottieGiftOriginal.style.display = 'none';
                if (animationsEnabled && gift.lottie_path) { 
                    playLottieAnimation(modalLottieGiftOriginal, gift.lottie_path, true); 
                    modalGiftImageStatic.style.display = 'none'; modalLottieGiftOriginal.style.display = 'flex';
                } else { 
                    modalGiftImageStatic.src = gift.original_image_url; 
                    modalGiftImageStatic.onerror = function() { this.src = `https://i.pravatar.cc/100?u=err${generateUniqueId()}`; };
                }
                modalGiftDescription1.textContent = `Add "${gift.gift_name}" to your profile or upgrade it.`;
                modalGiftDescription2.textContent = "Only you can see the sender's name.";
                modalGiftInfo.innerHTML = `
                    <div class="info-row"><span class="info-label">Date</span><span class="info-value">${new Date(gift.acquired_date).toLocaleDateString('en-US', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'})}</span></div>
                    <div class="info-row"><span class="info-label">Price</span><span class="info-value">Free</span></div>
                    <div class="info-row"><span class="info-label">Availability</span><span class="info-value">Limited</span></div>
                    <div class="info-row" id="uniqueness-row-${gift.instance_id}"><span class="info-label">Uniqueness</span><div class="info-value-with-action"><span id="modal-uniqueness-value-${gift.instance_id}">Standard</span><button id="modal-action-upgrade-gift-${gift.instance_id}" class="button-link-styled" data-instance-id="${gift.instance_id}">Upgrade</button></div></div>`;
                
                const upgradeButton = modalGiftInfo.querySelector(`#modal-action-upgrade-gift-${gift.instance_id}`);
                if (upgradeButton) {
                    if (viewingOwnProfile) {
                        upgradeButton.addEventListener('click', (e) => handleSingleGiftUpgradeFromModal(e.target.dataset.instanceId));
                        let upgradeLongPressTimer;
                        upgradeButton.addEventListener('touchstart', (e) => { upgradeLongPressTimer = setTimeout(() => openChancesModal(gift), 700); }, { passive: true });
                        upgradeButton.addEventListener('touchend', () => clearTimeout(upgradeLongPressTimer));
                        upgradeButton.addEventListener('touchmove', () => clearTimeout(upgradeLongPressTimer));
                        upgradeButton.addEventListener('contextmenu', (e) => { e.preventDefault(); openChancesModal(gift); });
                    } else {
                        upgradeButton.disabled = true;
                        upgradeButton.textContent = "Cannot Upgrade";
                        upgradeButton.style.cursor = 'not-allowed';
                    }
                }

                giftDetailModal.classList.add('active');
            }
        }

        async function upgradeSingleGiftLogic(giftToUpgrade) {
            if (giftToUpgrade.is_collectible) return { instance_id: giftToUpgrade.instance_id, name: giftToUpgrade.gift_name, status: 'skipped' };
            
            try {
                const upgradedGiftData = await callBackend('/api/gifts/upgrade', 'POST', { instance_id: giftToUpgrade.instance_id });
                if (upgradedGiftData) {
                    // Update the gift in the main ownedGifts array
                    const giftIndex = ownedGifts.findIndex(g => g.instance_id === upgradedGiftData.instance_id);
                    if(giftIndex !== -1) {
                        ownedGifts[giftIndex] = upgradedGiftData;
                    } else {
                        ownedGifts.push(upgradedGiftData); // Should not happen, but a fallback
                    }
                    return { ...upgradedGiftData, status: 'success' };
                } else {
                    throw new Error("Backend did not return upgraded gift data.");
                }
            } catch (error) {
                console.error(`Upgrade error for "${giftToUpgrade.gift_name}" (ID: ${giftToUpgrade.instance_id}):`, error);
                return { instance_id: giftToUpgrade.instance_id, name: giftToUpgrade.gift_name, status: 'failed', error: error.message };
            }
        }

        async function handleSingleGiftUpgradeFromModal(instanceId) {
            const gift = ownedGifts.find(g => g.instance_id === instanceId);
            if (!gift || gift.is_collectible) return;

            const upgradeButton = document.getElementById(`modal-action-upgrade-gift-${instanceId}`);
            const uniquenessValueEl = document.getElementById(`modal-uniqueness-value-${instanceId}`);
            if (upgradeButton) { upgradeButton.textContent = 'Upgrading...'; upgradeButton.disabled = true; }
            if (uniquenessValueEl) uniquenessValueEl.textContent = 'Processing...';

            try {
                const result = await upgradeSingleGiftLogic(gift);
                if (result.status === 'success') {
                    // Refresh UI immediately
                    renderProfileGifts();
                    if (uniquenessValueEl) uniquenessValueEl.textContent = `Collectible #${result.collectible_number}`;
                    tg.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => { closeModal(giftDetailModal); openGiftDetailByInstanceId(gift.instance_id); }, 1200);
                } else if (result.status === 'failed') {
                    tg.showAlert(`Failed to upgrade "${gift.gift_name}". ${result.error || ''}`);
                    if (uniquenessValueEl) uniquenessValueEl.textContent = 'Error';
                    if (upgradeButton) { upgradeButton.textContent = 'Upgrade'; upgradeButton.disabled = false; }
                } else { // Skipped or cancelled if logic was more complex
                    if (uniquenessValueEl) uniquenessValueEl.textContent = 'Standard';
                    if (upgradeButton) { upgradeButton.textContent = 'Upgrade'; upgradeButton.disabled = false; }
                }
            } catch (error) {
                console.error("Error during single gift upgrade:", error);
                tg.showAlert(`An unexpected error occurred: ${error.message}`);
                if (uniquenessValueEl) uniquenessValueEl.textContent = 'Error';
                if (upgradeButton) { upgradeButton.textContent = 'Upgrade'; upgradeButton.disabled = false; }
            }
        }

        async function handleUpgradeAllGifts() {
            const giftsToUpgrade = ownedGifts.filter(g => !g.is_collectible);
            if (giftsToUpgrade.length === 0) { tg.showAlert("No gifts to upgrade."); return; }

            // Check limit against backend's limit. Client-side check for user feedback.
            if (ownedGifts.length > GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot upgrade all gifts. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            const originalButtonText = upgradeAllGiftsButton.textContent;
            upgradeAllGiftsButton.disabled = true;
            let successCount = 0, failureCount = 0;
            for (let i = 0; i < giftsToUpgrade.length; i++) {
                const gift = giftsToUpgrade[i];
                upgradeAllGiftsButton.textContent = `Upgrading (${i + 1}/${giftsToUpgrade.length})...`;
                const cardElement = giftsGrid.querySelector(`.gift-card[data-instance-id="${gift.instance_id}"]`);
                if (cardElement) cardElement.classList.add('is-updating');
                const result = await upgradeSingleGiftLogic(gift);
                if (cardElement) cardElement.classList.remove('is-updating');
                if (result.status === 'success') {
                    successCount++;
                    // LIVE UPGRADE: Immediately re-render the grid to show the change
                    renderProfileGifts();
                } else if (result.status === 'failed') failureCount++;
                if (giftsToUpgrade.length > 1 && i < giftsToUpgrade.length - 1) await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            let summaryMessage = `Upgrade complete.\nSucceeded: ${successCount}`;
            if (failureCount > 0) summaryMessage += `\nFailed: ${failureCount}`;
            tg.showAlert(summaryMessage);
            tg.HapticFeedback.notificationOccurred(successCount > 0 ? 'success' : (failureCount > 0 ? 'error' : 'warning'));
            const stillHasNonCollectible = ownedGifts.some(g => !g.is_collectible);
            upgradeAllGiftsButton.style.display = stillHasNonCollectible ? 'inline-block' : 'none';
            if (stillHasNonCollectible) { upgradeAllGiftsButton.textContent = originalButtonText; upgradeAllGiftsButton.disabled = false; }
        }

        function closeModal(modalElement) {
            if (!modalElement) return;
            if (modalElement.id === 'gift-detail-modal') destroyLottieAnimation(modalLottieGiftOriginal);
            if (modalElement.id === 'collectible-detail-modal') destroyLottieAnimation(modalLottieCollectibleModel);
            if (modalElement.id === 'custom-buy-modal') {
                selectedCustomGift = {}; customBuyConfirmButton.disabled = true;
            }
            if (modalElement.id === 'generated-image-modal') {
                const sendButton = document.getElementById('send-generated-image-button');
                if (sendButton) sendButton.disabled = true;
            }
            if (modalElement.id === 'chances-modal') currentGiftForChances = null;
            if (modalElement.id === 'sell-gift-modal') currentGiftToSell = null;
            if (modalElement.id === 'transfer-gift-modal') {
                currentGiftToTransfer = null;
                transferUsernameInput.value = '';
                transferCommentInput.value = '';
                confirmTransferButton.disabled = true;
                transferStatusMessage.innerHTML = '<p>Gift ownership will be transferred to this username.</p>';
            }
            modalElement.classList.remove('active');
        }
        let currentLongPressGift = null; let longPressTimer;
        function setupLongPress(element, gift) { 
            element.addEventListener('touchstart', (e) => {
                clearTimeout(longPressTimer);
                longPressTimer = setTimeout(() => openLongPressMenu(gift, e.touches[0]), 500);
            }, { passive: false });
            element.addEventListener('touchend', () => clearTimeout(longPressTimer));
            element.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            element.addEventListener('contextmenu', (e) => { e.preventDefault(); clearTimeout(longPressTimer); openLongPressMenu(gift, e); });
        }
        function openLongPressMenu(gift, eventCoords) {
            currentLongPressGift = gift;
            
            // Determine if the current user is the owner
            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) { 
                menuPinAction.textContent = 'Pin (Collectibles only)'; 
                menuPinAction.classList.add('disabled'); 
                menuShareImageAction.classList.add('hidden');
                menuCopyLinkAction.classList.add('hidden');
                menuReorderAction.classList.add('hidden');
            } else { 
                const isPinned = gift.is_pinned; 
                menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin'; 
                menuPinAction.classList.toggle('disabled', !isOwner);
                menuShareImageAction.classList.remove('hidden');
                menuCopyLinkAction.classList.remove('hidden');
                menuReorderAction.classList.toggle('hidden', !isPinned); // Only show reorder for pinned gifts
            }
            
            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner); // Only owner can hide/unhide
            menuDeleteAction.classList.toggle('disabled', !isOwner); // Only owner can delete

            longPressMenu.style.top = `${Math.min(eventCoords.clientY, window.innerHeight - longPressMenu.offsetHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(eventCoords.clientX, window.innerWidth - longPressMenu.offsetWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function openCollectibleMenu(gift, eventCoords) { // For the "⋮" button in collectible modal
            currentLongPressGift = gift;
            const isOwner = (gift.owner_id === currentAccountTgId);

            if (!gift.is_collectible) { /* This function should only be called for collectibles */ return; }
            
            const isPinned = gift.is_pinned; 
            menuPinAction.textContent = isPinned ? 'Unpin' : 'Pin'; 
            menuPinAction.classList.toggle('disabled', !isOwner);
            
            menuHideAction.textContent = gift.is_hidden ? 'Unhide' : 'Hide';
            menuHideAction.classList.toggle('disabled', !isOwner);
            menuDeleteAction.classList.toggle('disabled', !isOwner);
            menuShareImageAction.classList.remove('hidden');
            menuCopyLinkAction.classList.remove('hidden');
            menuReorderAction.classList.toggle('hidden', !isPinned);

            const menuWidth = longPressMenu.offsetWidth || 220;
            const menuHeight = longPressMenu.offsetHeight || 150;
            let x = window.innerWidth - menuWidth - 20;
            let y = (collectibleMenuButton.getBoundingClientRect().top + collectibleMenuButton.offsetHeight + 10);
            longPressMenu.style.top = `${Math.min(y, window.innerHeight - menuHeight - 10)}px`;
            longPressMenu.style.left = `${Math.min(x, window.innerWidth - menuWidth - 10)}px`;
            longPressMenu.classList.remove('hidden');
            document.addEventListener('click', closeLongPressMenuOnClickOutside, { once: true, capture: true });
        }

        function closeLongPressMenuOnClickOutside(event) {
            if (!longPressMenu.contains(event.target) && event.target !== longPressMenu) { longPressMenu.classList.add('hidden'); currentLongPressGift = null; }
        }

        async function handlePinAction() {
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) {
                tg.showAlert("Only collectible gifts can be pinned.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }
            if (currentLongPressGift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only pin gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }
            if (currentLongPressGift.is_hidden) {
                tg.showAlert("Cannot pin a hidden gift.");
                longPressMenu.classList.add('hidden'); return;
            }

            const giftInstanceId = currentLongPressGift.instance_id;
            const isPinned = currentLongPressGift.is_pinned;
            
            const currentlyPinnedCount = ownedGifts.filter(g => g.is_pinned && g.owner_id === currentAccountTgId).length;

            if (!isPinned && currentlyPinnedCount >= 6) { 
                showTooManyPinsModal(); 
                longPressMenu.classList.add('hidden'); 
                return; 
            } 
            
            try {
                await callBackend(`/api/gifts/${giftInstanceId}`, 'PUT', { action: 'pin', value: !isPinned });
                await initializeTelegramUserAccount(); // Re-fetch all user data including updated gift state
                tg.HapticFeedback.impactOccurred(isPinned ? 'light' : 'medium'); 
            } catch (error) {
                tg.showAlert(`Failed to ${isPinned ? 'unpin' : 'pin'} gift: ${error.message}`);
            } finally {
                longPressMenu.classList.add('hidden');
                currentLongPressGift = null;
            }
        }
        
        async function handleHideAction() {
            if (!currentLongPressGift) return;
            if (currentLongPressGift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only hide gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const gift = currentLongPressGift;
            try {
                await callBackend(`/api/gifts/${gift.instance_id}`, 'PUT', { action: 'hide', value: !gift.is_hidden });
                await initializeTelegramUserAccount(); // Re-fetch all user data including updated gift state
                tg.HapticFeedback.impactOccurred('light');
            } catch (error) {
                tg.showAlert(`Failed to ${gift.is_hidden ? 'unhide' : 'hide'} gift: ${error.message}`);
            } finally {
                longPressMenu.classList.add('hidden');
                currentLongPressGift = null;
                closeModal(collectibleDetailModal); // Close if open as its state changed
            }
        }

        async function handleDeleteAction() {
            if (!currentLongPressGift) return;
            if (currentLongPressGift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only delete gifts you own.");
                longPressMenu.classList.add('hidden'); currentLongPressGift = null; return;
            }

            const giftToDelete = currentLongPressGift;
            longPressMenu.classList.add('hidden');
            closeModal(collectibleDetailModal);
            
            tg.showConfirm("Are you sure you want to delete this gift? This action cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    try {
                        await callBackend(`/api/gifts/${giftToDelete.instance_id}`, 'DELETE');
                        await initializeTelegramUserAccount(); // Re-fetch all user data
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Gift deleted.");
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        tg.showAlert(`Failed to delete gift: ${error.message}`);
                    }
                }
                currentLongPressGift = null;
            });
        }

        function showTooManyPinsModal() {
            unpinSelectionGrid.innerHTML = '';
            
            const pinnedGifts = ownedGifts.filter(g => g.is_pinned && !g.is_hidden && g.owner_id === currentAccountTgId);

            pinnedGifts.forEach(pinnedGift => {
                const card = createGiftCardDOM(pinnedGift);
                card.addEventListener('click', async () => {
                    // Unpin this one, then try to pin the new one
                    try {
                        await callBackend(`/api/gifts/${pinnedGift.instance_id}`, 'PUT', { action: 'pin', value: false });
                        if (currentLongPressGift && currentLongPressGift.is_collectible) {
                             await callBackend(`/api/gifts/${currentLongPressGift.instance_id}`, 'PUT', { action: 'pin', value: true });
                        }
                        await initializeTelegramUserAccount(); // Re-fetch all user data
                        tg.HapticFeedback.impactOccurred('medium'); 
                        tg.showAlert(`Gift unpinned. New gift ${currentLongPressGift ? 'pinned.' : ''}`);
                    } catch (error) {
                        tg.showAlert(`Failed to update pins: ${error.message}`);
                    } finally {
                        closeModal(tooManyPinsModal);
                        currentLongPressGift = null;
                    }
                });
                unpinSelectionGrid.appendChild(card);
                observeLottieElement(card);
            });
            tooManyPinsModal.classList.add('active');
        }

        async function handleWearAction() {
            const currentModalInstanceId = collectibleDetailModal.dataset.instanceId; 
            if (!currentModalInstanceId) return;

            const gift = ownedGifts.find(g => g.instance_id === currentModalInstanceId);
            if (!gift) return;

            if (gift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only wear gifts you own.");
                return;
            }
            if (gift.is_hidden) {
                tg.showAlert("Cannot wear a hidden gift.");
                return;
            }

            const isCurrentlyWorn = gift.is_worn === true;
            try {
                await callBackend(`/api/gifts/${currentModalInstanceId}`, 'PUT', { action: 'wear', value: !isCurrentlyWorn });
                await initializeTelegramUserAccount(); // Re-fetch all user data
                collectibleActionWear.querySelector('.text').textContent = (!isCurrentlyWorn) ? 'Take Off' : 'Wear'; // Optimistic update
                tg.HapticFeedback.impactOccurred('light');
            } catch (error) {
                tg.showAlert(`Failed to ${isCurrentlyWorn ? 'take off' : 'wear'} gift: ${error.message}`);
            }
        }

        let filterPopupLongPressTimer;
        function setupFilterPopupTrigger() {
            filterLongPressTarget.addEventListener('touchstart', (e) => { filterPopupLongPressTimer = setTimeout(openFilterPopup, 700); }, { passive: true });
            filterLongPressTarget.addEventListener('touchend', () => clearTimeout(filterPopupLongPressTimer));
            filterLongPressTarget.addEventListener('touchmove', () => clearTimeout(filterPopupLongPressTimer));
            filterLongPressTarget.addEventListener('contextmenu', (e) => { e.preventDefault(); openFilterPopup(); });
        }
        function openFilterPopup() { populateFilterOptions(); filterPopup.classList.add('active'); }
        function populateFilterOptions() {
            const uniqueCollections = [...new Map(ownedGifts.map(item => [item.gift_type_id, {id: item.gift_type_id, name: item.gift_name, image: item.original_image_url}])).values()];
            renderFilterOptions(filterOptionsCollections, uniqueCollections, 'collection', (item) => `<img src="${item.image}" alt="${item.name}">`);
            
            if (activeFilters.collection) {
                const giftsInCollection = ownedGifts.filter(g => g.gift_type_id === activeFilters.collection && g.is_collectible && g.collectible_data?.model);
                const uniqueModels = [...new Map(giftsInCollection.map(item => [item.collectible_data.model.name, {name: item.collectible_data.model.name, image: item.collectible_data.modelImage}])).values()];
                renderFilterOptions(filterOptionsModels, uniqueModels, 'model', (item) => `<img src="${item.image}" alt="${item.name}">`);
                filterModelsSection.classList.remove('hidden');
            } else { filterModelsSection.classList.add('hidden'); filterOptionsModels.innerHTML = ''; }
            
            const collectibleGifts = ownedGifts.filter(g => g.is_collectible && g.collectible_data?.backdrop);
            const uniqueBackdrops = [...new Map(collectibleGifts.map(item => [item.collectible_data.backdrop.name, {name: item.collectible_data.backdrop.name, colors: item.collectible_data.backdropColors}])).values()];
            renderFilterOptions(filterOptionsBackdrops, uniqueBackdrops, 'backdrop', (item) => `<div class="gradient-square" style="background: radial-gradient(circle, ${item.colors.centerColor}, ${item.colors.edgeColor});"></div>`);
            
            const uniquePatterns = [...new Map(ownedGifts.filter(g => g.is_collectible && g.collectible_data && g.collectible_data.pattern).map(item => [item.collectible_data.pattern.name, {name: item.collectible_data.pattern.name, image: item.collectible_data.patternImage}])).values()];
            renderFilterOptions(filterOptionsPatterns, uniquePatterns, 'pattern', (item) => `<img src="${item.image}" alt="${item.name}">`);
        }
        function renderFilterOptions(container, items, filterType, displayFn) {
            container.innerHTML = '';
            items.forEach(item => {
                const optionEl = document.createElement('div'); optionEl.className = 'filter-option';
                optionEl.innerHTML = displayFn(item);
                const valueToCompare = filterType === 'collection' ? item.id : item.name;
                if (activeFilters[filterType] === valueToCompare) optionEl.classList.add('selected');
                optionEl.addEventListener('click', () => {
                    if (activeFilters[filterType] === valueToCompare) {
                        activeFilters[filterType] = null;
                        if (filterType === 'collection') activeFilters.model = null;
                    } else {
                        activeFilters[filterType] = valueToCompare;
                        if (filterType === 'collection') activeFilters.model = null;
                    }
                    populateFilterOptions();
                });
                container.appendChild(optionEl);
            });
        }
        function handleApplyFilters() { 
            saveClientSideState(); // Save UI preferences only
            renderProfileGifts(); 
            closeModal(filterPopup); 
            displayFilterExitButton(); 
        }
        function handleClearFilters() {
            activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
            populateFilterOptions(); renderProfileGifts(); saveClientSideState(); displayFilterExitButton();
        }
        
        async function handleClearCurrentAccountData() {
            if (!currentAccountTgId) return;

            tg.showConfirm(`Are you sure you want to delete all gifts and data for the CURRENT account? This cannot be undone.`, async (confirmed) => {
                if (confirmed) {
                    try {
                        // Delete all gifts for current user
                        for(const gift of [...ownedGifts]) { // Use a copy as ownedGifts will be modified by initializeTelegramUserAccount
                            await callBackend(`/api/gifts/${gift.instance_id}`, 'DELETE');
                        }
                        
                        // Clear collectible usernames for this account
                        const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
                        if (currentAccount && currentAccount.collectible_usernames) {
                            for(const uname of [...currentAccount.collectible_usernames]) {
                                await callBackend(`/api/collectible_usernames/${uname}`, 'DELETE', { owner_id: currentAccountTgId });
                            }
                        }
                        
                        // Reset account's profile data
                        await callBackend('/api/account', 'PUT', { 
                            tg_id: currentAccountTgId, 
                            phone_number: "Not specified",
                            bio: "My first account!",
                        });

                        // Re-initialize to get a fresh state from backend, which should now have no gifts/usernames
                        await initializeTelegramUserAccount();
                        
                        // Reset UI preferences for this account (client-side)
                        activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                        animationsEnabled = true;
                        showHiddenGifts = false;

                        saveClientSideState();
                        saveClientSideAccounts(); // Update the accounts list in local storage

                        applyWornGiftStyles(); 
                        renderProfileGifts(); 
                        populateFilterOptions(); // Re-populate filters as gifts are gone
                        tg.HapticFeedback.notificationOccurred('success'); 
                        tg.showAlert("Current account data cleared.");
                        closeModal(settingsModal);
                        displayFilterExitButton();
                        loadUserData(); // Reload profile display
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        tg.showAlert(`Failed to clear account data: ${error.message}`);
                    }
                }
            });
        }
        
        async function handleClearAllAccountsData() {
            tg.showConfirm("Are you sure you want to delete ALL accounts and data from this simulator? This cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    // This is a client-side function to reset the *simulator's* state (local storage).
                    // It does NOT delete data from the backend database for all accounts.
                    
                    // Clear all client-side accounts references
                    accounts = [];
                    currentAccountTgId = null;
                    
                    // Clear all UI preferences
                    activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                    animationsEnabled = true;
                    showHiddenGifts = false;

                    localStorage.clear(); // Wipe all local storage for the app domain
                    
                    // Re-initialize app to create a fresh user and state
                    await initApp(); 
                    tg.HapticFeedback.notificationOccurred('success'); 
                    tg.showAlert("All simulator data cleared.");
                    closeModal(settingsModal);
                    displayFilterExitButton();
                }
            });
        }

        function handleAnimationToggle() {
            animationsEnabled = animationToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            updateAllAnimationsState();
            saveClientSideState();
        }
        
        function handleShowHiddenToggle() {
            showHiddenGifts = showHiddenToggle.checked;
            tg.HapticFeedback.impactOccurred('light');
            renderProfileGifts();
            saveClientSideState();
        }

        function checkCustomBuyCompleteness() {
            if (!selectedCustomGift.id) { customBuyConfirmButton.disabled = true; return; }
            const partsInfo = cachedCollectibleParts[selectedCustomGift.id];
            if (!partsInfo) { customBuyConfirmButton.disabled = true; return; }
            const needsModel = partsInfo.models.length > 0, hasModel = !!selectedCustomGift.model;
            const needsBackdrop = partsInfo.backdrops.length > 0, hasBackdrop = !!selectedCustomGift.backdrop;
            const needsPattern = partsInfo.patterns.length > 0, hasPattern = !!selectedCustomGift.pattern;
            customBuyConfirmButton.disabled = !((!needsModel || hasModel) && (!needsBackdrop || hasBackdrop) && (!needsPattern || hasPattern));
        }
        function openCustomBuyModal() {
            selectedCustomGift = {}; customBuyConfirmButton.disabled = true;
            customBuyBaseGiftsGrid.innerHTML = ''; customBuyModelsGrid.innerHTML = '';
            customBuyBackdropsGrid.innerHTML = ''; customBuyPatternsGrid.innerHTML = '';
            customBuyModelsSection.classList.add('hidden'); customBuyBackdropsSection.classList.add('hidden');
            customBuyPatternsSection.classList.add('hidden');
            for (const id in allAvailableGifts) {
                const name = allAvailableGifts[id];
                const originalImageUrl = `${CDN_BASE_URL}originals/${id}/Original.png`;
                const item = document.createElement('div');
                item.className = 'filter-option'; item.dataset.id = id;
                item.innerHTML = `<img src="${originalImageUrl}" alt="${name}" loading="lazy" onerror="this.onerror=null;this.src='${originalImageUrl}';"><div class="label">${name}</div>`;
                item.addEventListener('click', () => selectCustomBaseGift(id, name, originalImageUrl));
                customBuyBaseGiftsGrid.appendChild(item);
            }
            customBuyModal.classList.add('active');
        }
        async function selectCustomBaseGift(id, name, originalImage) {
            selectedCustomGift = { model: null, backdrop: null, pattern: null };
            customBuyModelsGrid.innerHTML = ''; customBuyBackdropsGrid.innerHTML = ''; customBuyPatternsGrid.innerHTML = '';
            customBuyModelsSection.classList.add('hidden'); customBuyBackdropsSection.classList.add('hidden');
            customBuyPatternsSection.classList.add('hidden');
            customBuyConfirmButton.disabled = true;
            Array.from(customBuyBaseGiftsGrid.children).forEach(el => el.classList.remove('selected'));
            document.querySelector(`#custom-buy-base-gifts-grid [data-id="${id}"]`).classList.add('selected');
            selectedCustomGift.id = id; selectedCustomGift.name = name; selectedCustomGift.originalImage = originalImage;
            selectedCustomGift.lottiePath = `${CDN_BASE_URL}originals/${id}/Original.json`;
            const giftNameEncoded = encodeURIComponent(name);
            
            if (!cachedCollectibleParts[id]) {
                try {
                    const partsData = await Promise.all([
                        fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : []),
                        fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : []),
                        fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : [])
                    ]);
                    cachedCollectibleParts[id] = {
                        models: partsData[0],
                        backdrops: partsData[1],
                        patterns: partsData[2]
                    };
                } catch (error) { console.error(`Failed to fetch collectible parts for ${name}:`, error); cachedCollectibleParts[id] = { models: [], backdrops: [], patterns: [] }; }
            }
            const { models, backdrops, patterns } = cachedCollectibleParts[id];
            if (models.length > 0) {
                customBuyModelsSection.classList.remove('hidden');
                models.forEach(model => {
                    const item = document.createElement('div'); item.className = 'filter-option'; item.dataset.name = model.name;
                    const modelImage = `${CDN_BASE_URL}models/${giftNameEncoded}/png/${encodeURIComponent(model.name)}.png`;
                    item.innerHTML = `<img src="${modelImage}" alt="${model.name}" loading="lazy"><div class="label">${model.name}</div>`;
                    item.addEventListener('click', () => selectCustomPart('model', model, modelImage));
                    customBuyModelsGrid.appendChild(item);
                });
            }
            if (backdrops.length > 0) {
                customBuyBackdropsSection.classList.remove('hidden');
                backdrops.forEach(backdrop => {
                    const item = document.createElement('div'); item.className = 'filter-option'; item.dataset.name = backdrop.name;
                    item.innerHTML = `<div class="gradient-square" style="background: radial-gradient(circle, ${backdrop.hex.centerColor}, ${backdrop.hex.edgeColor});"></div><div class="label">${backdrop.name}</div>`;
                    item.addEventListener('click', () => selectCustomPart('backdrop', backdrop));
                    customBuyBackdropsGrid.appendChild(item);
                });
            }
            if (patterns.length > 0) {
                customBuyPatternsSection.classList.remove('hidden');
                patterns.forEach(pattern => {
                    const item = document.createElement('div'); item.className = 'filter-option'; item.dataset.name = pattern.name;
                    const patternImage = `${CDN_BASE_URL}patterns/${giftNameEncoded}/png/${encodeURIComponent(pattern.name)}.png`;
                    item.innerHTML = `<img src="${patternImage}" alt="${pattern.name}" loading="lazy"><div class="label">${pattern.name}</div>`;
                    item.addEventListener('click', () => selectCustomPart('pattern', pattern, patternImage));
                    customBuyPatternsGrid.appendChild(item);
                });
            }
            checkCustomBuyCompleteness();
        }
        function selectCustomPart(type, data, imagePath = null) {
            const container = document.getElementById(`custom-buy-${type}s-grid`);
            Array.from(container.children).forEach(el => el.classList.remove('selected'));
            const selectedElement = container.querySelector(`[data-name="${data.name}"]`);
            if(selectedElement) selectedElement.classList.add('selected');
            selectedCustomGift[type] = data;
            if (type === 'model') {
                selectedCustomGift.modelImage = imagePath;
                selectedCustomGift.lottieModelPath = `${CDN_BASE_URL}models/${encodeURIComponent(selectedCustomGift.name)}/lottie/${encodeURIComponent(data.name)}.json`;
            } else if (type === 'pattern') { selectedCustomGift.patternImage = imagePath; } 
            else if (type === 'backdrop') { selectedCustomGift.backdropColors = data.hex; }
            checkCustomBuyCompleteness();
        }
        async function handleCustomBuyConfirm() {
            if (customBuyConfirmButton.disabled) return;
            
            if (ownedGifts.length >= GIFT_LIMIT_PER_USER) {
                tg.showAlert(`Cannot create gift. You have ${ownedGifts.length} gifts and the limit is ${GIFT_LIMIT_PER_USER}.`);
                return;
            }

            customBuyConfirmButton.disabled = true;
            customBuyConfirmButton.textContent = 'Creating...';

            const newGiftInstanceId = generateUniqueId();
            try {
                // First, create the "base" gift.
                await callBackend('/api/gifts', 'POST', {
                    instance_id: newGiftInstanceId,
                    owner_id: currentAccountTgId,
                    gift_type_id: selectedCustomGift.id,
                    gift_name: selectedCustomGift.name,
                    original_image_url: selectedCustomGift.originalImage,
                    lottie_path: selectedCustomGift.lottiePath,
                });

                // Then, upgrade it with the custom parts.
                const upgradedGift = await callBackend('/api/gifts/upgrade', 'POST', {
                    instance_id: newGiftInstanceId,
                    custom_model: selectedCustomGift.model,
                    custom_backdrop: selectedCustomGift.backdrop,
                    custom_pattern: selectedCustomGift.pattern
                });


                await initializeTelegramUserAccount(); // Re-fetch all user data including new gifts
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Collectible "${upgradedGift.gift_name}" created and added!`);
                closeModal(customBuyModal); showPage('profile-page');
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert(`Failed to create custom gift: ${error.message}`);
            } finally {
                customBuyConfirmButton.disabled = false;
                customBuyConfirmButton.textContent = 'Create';
            }
        }

        function handleTripleTap(e, filterType, value) {
            const now = Date.now(); const DURATION = 300;
            if (now - lastTap < DURATION) tapCount++; else tapCount = 1;
            lastTap = now;
            if (tapCount === 3) {
                tapCount = 0; tg.HapticFeedback.impactOccurred('medium');
                activeFilters = { collection: null, model: null, backdrop: null, pattern: null };
                if (value) { activeFilters[filterType] = value; tg.showAlert(`Showing gifts with ${filterType}: "${value}"`); } 
                else { tg.showAlert(`Cannot apply filter: ${filterType} is undefined.`); return; }
                saveClientSideState(); renderProfileGifts(); displayFilterExitButton(); closeModal(collectibleDetailModal);
            }
        }
        function displayFilterExitButton() {
            const hasActiveFilter = Object.values(activeFilters).some(f => f !== null);
            exitFilterModeButton.classList.toggle('hidden', !hasActiveFilter);
        }
        async function preloadImage(url) {
            return new Promise((resolve) => {
                if (!url) { resolve(); return; }
                const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = url;
                img.onload = resolve;
                img.onerror = () => { console.warn(`Failed to preload image: ${url}`); resolve(); };
            });
        }
        
        async function handleShareImageAction() {
            longPressMenu.classList.add('hidden');
            if (!currentLongPressGift || !currentLongPressGift.is_collectible) { tg.showAlert("Cannot share an image for this gift."); return; }
            
            const sendButton = document.getElementById('send-generated-image-button');
            generatedImageMessage.textContent = 'Generating image...';
            generatedImagePreview.src = '';
            if (sendButton) sendButton.disabled = true;

            generatedImageModal.classList.add('active');
            
            const imageDataUrl = await generateGiftImage(currentLongPressGift);
            
            if (imageDataUrl) {
                generatedImagePreview.src = imageDataUrl;
                generatedImageMessage.textContent = 'Image is ready. Click "Send to Me" to receive it via bot.';
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.onclick = async () => {
                        sendButton.disabled = true;
                        sendButton.textContent = "Sending...";
                        try {
                            await callBackend('/api/gifts/send_image', 'POST', {
                                imageDataUrl: imageDataUrl,
                                userId: currentAccountTgId,
                                caption: `Your generated image for ${currentLongPressGift.gift_name} #${currentLongPressGift.collectible_number.toLocaleString()}`
                            });
                            tg.HapticFeedback.notificationOccurred('success');
                            tg.showAlert("Image sent! Check your chat with the bot.");
                            closeModal(generatedImageModal);
                        } catch (error) {
                            tg.HapticFeedback.notificationOccurred('error');
                            tg.showAlert(`Failed to send image: ${error.message}`);
                        } finally {
                            sendButton.disabled = false;
                            sendButton.textContent = "Send to Me";
                        }
                    };
                }

                tg.HapticFeedback.notificationOccurred('success');
            } else {
                generatedImageMessage.textContent = 'Failed to generate image.';
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        async function generateGiftImage(gift) {
            const cd = gift.collectible_data; if (!cd) return null;
            await Promise.all([ preloadImage(cd.modelImage || gift.original_image_url), preloadImage(cd.patternImage) ]);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px'; tempContainer.style.top = '-9999px';
            tempContainer.style.width = '450px'; tempContainer.style.height = '600px';
            tempContainer.style.display = 'flex'; tempContainer.style.flexDirection = 'column';
            tempContainer.style.alignItems = 'center'; tempContainer.style.justifyContent = 'flex-start';
            tempContainer.style.padding = '30px'; tempContainer.style.boxSizing = 'border-box';
            tempContainer.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            if (cd.backdropColors) tempContainer.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdropColors.centerColor} 0%, ${cd.backdropColors.edgeColor} 100%)`;
            else tempContainer.style.background = 'linear-gradient(45deg, #2a3745, #17212b)';
            const textColor = '#ffffff';
            if (cd.patternImage) {
                const patternOverlay = document.createElement('div');
                patternOverlay.style.position = 'absolute'; patternOverlay.style.top = '0'; patternOverlay.style.left = '0';
                patternOverlay.style.width = '100%'; patternOverlay.style.height = '100%';
                patternOverlay.style.backgroundImage = `url('${cd.patternImage}')`;
                patternOverlay.style.backgroundRepeat = 'repeat'; patternOverlay.style.backgroundSize = '30% auto';
                patternOverlay.style.opacity = '0.07'; tempContainer.appendChild(patternOverlay);
            }
            const giftModelContainer = document.createElement('div');
            giftModelContainer.style.width = '70%'; giftModelContainer.style.height = 'auto'; giftModelContainer.style.aspectRatio = '1 / 1';
            giftModelContainer.style.display = 'flex'; giftModelContainer.style.alignItems = 'center'; giftModelContainer.style.justifyContent = 'center';
            giftModelContainer.style.position = 'relative'; giftModelContainer.style.zIndex = '10'; giftModelContainer.style.marginBottom = '20px';
            const modelImageEl = document.createElement('img'); modelImageEl.src = cd.modelImage || gift.original_image_url;
            modelImageEl.style.maxWidth = '100%'; modelImageEl.style.maxHeight = '100%'; modelImageEl.style.objectFit = 'contain';
            giftModelContainer.appendChild(modelImageEl); tempContainer.appendChild(giftModelContainer);
            const upgradedGiftText = document.createElement('div');
            upgradedGiftText.textContent = 'Upgraded Gift'; upgradedGiftText.style.fontSize = '2.2em'; upgradedGiftText.style.fontWeight = '600';
            upgradedGiftText.style.color = textColor; upgradedGiftText.style.marginBottom = '10px'; upgradedGiftText.style.position = 'relative';
            upgradedGiftText.style.zIndex = '10'; tempContainer.appendChild(upgradedGiftText);
            const giftNameAndNumber = document.createElement('div');
            giftNameAndNumber.textContent = `${gift.gift_name} #${gift.collectible_number}`; giftNameAndNumber.style.fontSize = '1.8em'; giftNameAndNumber.style.fontWeight = '500';
            giftNameAndNumber.style.color = textColor; giftNameAndNumber.style.opacity = '0.9'; giftNameAndNumber.style.marginBottom = '25px';
            giftNameAndNumber.style.position = 'relative'; giftNameAndNumber.style.zIndex = '10'; tempContainer.appendChild(giftNameAndNumber);
            const infoSection = document.createElement('div');
            infoSection.style.display = 'flex'; infoSection.style.flexDirection = 'column'; infoSection.style.alignItems = 'flex-start';
            infoSection.style.width = '80%'; infoSection.style.position = 'relative'; infoSection.style.zIndex = '10';
            const createInfoRow = (label, value) => {
                const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between';
                row.style.width = '100%'; row.style.marginBottom = '10px';
                const labelEl = document.createElement('span'); labelEl.textContent = label; labelEl.style.fontSize = '1.2em';
                labelEl.style.fontWeight = 'normal'; labelEl.style.color = textColor; row.appendChild(labelEl);
                const valueEl = document.createElement('span'); valueEl.textContent = value; valueEl.style.fontSize = '1.2em';
                valueEl.style.fontWeight = '500'; valueEl.style.color = textColor; valueEl.style.opacity = '0.7'; row.appendChild(valueEl);
                return row;
            };
            infoSection.appendChild(createInfoRow('Model', cd.model?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Backdrop', cd.backdrop?.name || 'N/A'));
            infoSection.appendChild(createInfoRow('Symbol', cd.pattern?.name || 'N/A'));
            tempContainer.appendChild(infoSection); document.body.appendChild(tempContainer);
            let dataUrl = null;
            try {
                const canvas = await html2canvas(tempContainer, { backgroundColor: null, scale: 1.5, useCORS: true });
                dataUrl = canvas.toDataURL('image/png');
            } catch (error) { console.error("Error generating image:", error); tg.showAlert(`Failed to generate image: ${error.message}`); } 
            finally { document.body.removeChild(tempContainer); }
            return dataUrl;
        }

        let currentGiftForChances = null; let selectedChances = { model: null, backdrop: null, pattern: null };
        async function openChancesModal(gift) {
            closeModal(giftDetailModal); currentGiftForChances = gift;
            selectedChances = { model: null, backdrop: null, pattern: null };
            chancesGiftName.textContent = `For gift: "${gift.gift_name}"`;
            chancesLoadingSpinner.classList.remove('hidden');
            chancesModelsSection.classList.add('hidden'); chancesBackdropsSection.classList.add('hidden');
            chancesPatternsSection.classList.add('hidden'); chancesProbabilityDisplay.innerHTML = '';
            chancesModal.classList.add('active'); calculateAndDisplayChances();
            const giftNameEncoded = encodeURIComponent(gift.gift_name);
            
            if (!cachedCollectibleParts[gift.gift_type_id]) { // Use gift_type_id for caching
                 try {
                    const partsData = await Promise.all([
                        fetch(`${CDN_BASE_URL}models/${giftNameEncoded}/models.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : []),
                        fetch(`${CDN_BASE_URL}backdrops/${giftNameEncoded}/backdrops.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : []),
                        fetch(`${CDN_BASE_URL}patterns/${giftNameEncoded}/patterns.json`, { cache: 'no-cache' }).then(res => res.ok ? res.json() : [])
                    ]);
                    cachedCollectibleParts[gift.gift_type_id] = {
                        models: partsData[0],
                        backdrops: partsData[1],
                        patterns: partsData[2]
                    };
                } catch (error) { console.error(`Failed to fetch parts for ${gift.gift_name}:`, error); cachedCollectibleParts[gift.gift_type_id] = { models: [], backdrops: [], patterns: [] }; }
            }
            chancesLoadingSpinner.classList.add('hidden');
            populateChancesOptions(gift.gift_type_id, giftNameEncoded);
        }
        function populateChancesOptions(giftTypeId, giftNameEncoded) {
            const { models, backdrops, patterns } = cachedCollectibleParts[giftTypeId];
            if (models.length > 0) { renderChanceOptions(chancesOptionsModels, models, 'model', giftNameEncoded); chancesModelsSection.classList.remove('hidden'); }
            if (backdrops.length > 0) { renderChanceOptions(chancesOptionsBackdrops, backdrops, 'backdrop', giftNameEncoded); chancesBackdropsSection.classList.remove('hidden'); }
            if (patterns.length > 0) { renderChanceOptions(chancesOptionsPatterns, patterns, 'pattern', giftNameEncoded); chancesPatternsSection.classList.remove('hidden'); }
        }
        function renderChanceOptions(container, items, type, giftNameEncoded) {
            container.innerHTML = '';
            items.forEach(itemData => {
                const optionEl = document.createElement('div');
                optionEl.className = 'filter-option';
                let innerHTML = '';
                if (type === 'model') {
                     const modelImage = `${CDN_BASE_URL}models/${giftNameEncoded}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${modelImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                } else if (type === 'backdrop') {
                     innerHTML = `<div class="gradient-square" style="background: radial-gradient(circle, ${itemData.hex.centerColor}, ${itemData.hex.edgeColor});"></div><div class="label">${itemData.name}</div>`;
                } else if (type === 'pattern') {
                     const patternImage = `${CDN_BASE_URL}patterns/${giftNameEncoded}/png/${encodeURIComponent(itemData.name)}.png`;
                     innerHTML = `<img src="${patternImage}" alt="${itemData.name}" loading="lazy"><div class="label">${itemData.name}</div>`;
                }
                optionEl.innerHTML = innerHTML;
                optionEl.addEventListener('click', () => handleChanceSelection(optionEl, container, type, itemData));
                container.appendChild(optionEl);
            });
        }

        function handleChanceSelection(element, container, type, data) {
            const isSelected = element.classList.contains('selected');
            Array.from(container.children).forEach(el => el.classList.remove('selected'));
            
            if(isSelected) {
                selectedChances[type] = null;
            } else {
                element.classList.add('selected');
                selectedChances[type] = data;
            }
            calculateAndDisplayChances();
        }

        function calculateAndDisplayChances() {
            let totalProbability = 1.0;
            const selectedParts = [];

            if (selectedChances.model) {
                totalProbability *= ((selectedChances.model.rarityPermille || 1) / 100000);
                selectedParts.push(`Model: ${selectedChances.model.name}`);
            }
             if (selectedChances.backdrop) {
                totalProbability *= ((selectedChances.backdrop.rarityPermille || 1) / 100000);
                selectedParts.push(`Backdrop: ${selectedChances.backdrop.name}`);
            }
             if (selectedChances.pattern) {
                totalProbability *= ((selectedChances.pattern.rarityPermille || 1) / 100000);
                selectedParts.push(`Symbol: ${selectedChances.pattern.name}`);
            }

            if (selectedParts.length === 0) {
                 chancesProbabilityDisplay.innerHTML = `<span class="prob-details">Select one or more parts to calculate the chance of getting them together.</span>`;
            } else {
                const probabilityPercent = totalProbability * 100;
                const oneInX = Math.round(1 / totalProbability);
                let displayPercent = probabilityPercent.toExponential(2);
                if (probabilityPercent > 0.0001) {
                    displayPercent = probabilityPercent.toPrecision(3) + '%';
                } else {
                    displayPercent += '%';
                }

                chancesProbabilityDisplay.innerHTML = `
                    <span class="prob-value">${displayPercent}</span>
                    <span class="prob-details">1 in ${oneInX.toLocaleString('en-US')}<br>${selectedParts.join('<br>')}</span>`;
            }
        }

        function openSellModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only sell gifts you own.");
                return;
            }
            currentGiftToSell = gift;
            closeModal(collectibleDetailModal);

            sellGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            sellGiftName.textContent = `${gift.gift_name} #${gift.collectible_number}`;
            sellPriceInput.value = '';
            sellReceiveAmount.textContent = 'You will receive...';
            sellUsdAmount.textContent = '';
            confirmSellButton.disabled = true;

            sellGiftModal.classList.add('active');
            setTimeout(() => sellPriceInput.focus(), 250);
        }

        function updateSellPriceDetails() {
            const price = parseInt(sellPriceInput.value, 10);
            if (!isNaN(price) && price >= MIN_SALE_PRICE && price <= MAX_SALE_PRICE) {
                const commission = 0.20;
                const received = Math.floor(price * (1 - commission));
                const usdEquivalent = (price * 0.013).toFixed(2);

                sellReceiveAmount.textContent = `You will receive ${received} Stars.`;
                sellUsdAmount.textContent = `≈US$${usdEquivalent}`;
                confirmSellButton.disabled = false;
            } else {
                sellReceiveAmount.textContent = 'You will receive...';
                sellUsdAmount.textContent = '';
                confirmSellButton.disabled = true;
            }
        }

        async function handleConfirmSell() {
            if (!currentGiftToSell || confirmSellButton.disabled) return;
            const price = parseInt(sellPriceInput.value, 10);
            
            confirmSellButton.disabled = true;
            confirmSellButton.textContent = "Listing...";

            try {
                await callBackend('/api/gifts/sell', 'POST', {
                    instance_id: currentGiftToSell.instance_id,
                    price: price,
                    owner_id: currentAccountTgId
                });
                // Optimistically remove from local state
                ownedGifts = ownedGifts.filter(g => g.instance_id !== currentGiftToSell.instance_id);
                renderProfileGifts();

                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Gift "${currentGiftToSell.gift_name}" listed for sale. It has been removed from your inventory and you will be notified by the bot when it's sold!`);
                closeModal(sellGiftModal);
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert(`Failed to list gift for sale: ${error.message}`);
            } finally {
                confirmSellButton.disabled = false;
                confirmSellButton.textContent = "List for Sale";
            }
        }

        function openTransferModal(gift) {
            if (!gift || !gift.is_collectible) return;
            if (gift.owner_id !== currentAccountTgId) {
                tg.showAlert("You can only transfer gifts you own.");
                return;
            }
            currentGiftToTransfer = gift;
            closeModal(collectibleDetailModal);

            transferGiftImage.src = gift.collectible_data.modelImage || gift.original_image_url;
            transferGiftName.textContent = `${gift.gift_name} #${gift.collectible_number.toLocaleString()}`;
            transferUsernameInput.value = '';
            transferCommentInput.value = '';
            confirmTransferButton.disabled = true;
            transferStatusMessage.innerHTML = '<p>Gift ownership will be transferred to this username.</p>';

            transferGiftModal.classList.add('active');
            setTimeout(() => transferUsernameInput.focus(), 250);
        }

        async function handleConfirmTransfer() {
            if (!currentGiftToTransfer || confirmTransferButton.disabled) return;
            const receiverUsername = transferUsernameInput.value.trim();
            const comment = transferCommentInput.value.trim();

            if (!receiverUsername) {
                transferStatusMessage.innerHTML = '<p style="color:red;">Please enter a username.</p>';
                return;
            }
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (receiverUsername.toLowerCase() === currentAccount?.username.toLowerCase()) {
                transferStatusMessage.innerHTML = '<p style="color:red;">Cannot transfer to yourself.</p>';
                return;
            }

            confirmTransferButton.disabled = true;
            confirmTransferButton.textContent = 'Transferring...';

            try {
                await callBackend('/api/gifts/transfer', 'POST', {
                    instance_id: currentGiftToTransfer.instance_id,
                    receiver_username: receiverUsername,
                    sender_id: currentAccountTgId, // Pass sender ID for notification
                    comment: comment // Pass optional comment
                });
                
                await initializeTelegramUserAccount(); // Re-fetch current user's gifts after transfer
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Gift "${currentGiftToTransfer.gift_name}" successfully transferred to @${receiverUsername}!`);
                closeModal(transferGiftModal);
            } catch (error) {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert(`Transfer failed: ${error.message}`);
                confirmTransferButton.disabled = false;
                confirmTransferButton.textContent = 'Confirm Transfer';
                transferStatusMessage.innerHTML = `<p style="color:red;">Transfer failed: ${error.message}</p>`;
            }
        }

        // --- Collectible Numbers & Usernames ---
        function generateRandom888Number() {
            const part1 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            const part2 = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `+888 ${part1} ${part2}`;
        }

        async function handleOpenNumbersModal() {
            numbersList.innerHTML = '';
            const allPossibleNumbers = [...coolNumbers];
            // Generate some random numbers to show variety
            for (let i = 0; i < 20; i++) {
                allPossibleNumbers.push(generateRandom888Number());
            }

            // Client-side filter: Remove numbers already assigned to the current user's phone_number
            // In a real app, you'd fetch available numbers from the backend directly.
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            const userPhoneNumber = currentAccount?.phone_number;
            const availableNumbers = [...new Set(allPossibleNumbers)].filter(n => n !== userPhoneNumber);

            if (availableNumbers.length === 0) {
                numbersList.innerHTML = '<p class="empty-grid-message">No numbers available.</p>';
            } else {
                availableNumbers.forEach(num => {
                    const li = document.createElement('li');
                    li.className = 'collectible-list-item';
                    li.textContent = num;
                    li.addEventListener('click', () => buyNumber(num));
                    numbersList.appendChild(li);
                });
            }
            closeSidebar();
            numbersModal.classList.add('active');
        }

        async function buyNumber(number) {
            tg.showConfirm(`Are you sure you want to purchase the number ${number}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/account`, 'PUT', {
                            tg_id: currentAccountTgId,
                            phone_number: number
                        });
                        
                        await initializeTelegramUserAccount(); // Re-fetch account data
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Number ${number} purchased successfully!`);
                        closeModal(numbersModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        tg.showAlert(`Failed to purchase number: ${error.message}`);
                    }
                }
            });
        }
        
        async function handleOpenUsernamesModal() {
            await populateUsernamesList();
            usernameSearchInput.value = '';
            closeSidebar();
            usernamesModal.classList.add('active');
        }

        async function populateUsernamesList(searchTerm = '') {
            usernamesList.innerHTML = '';
            let listToShow = [];

            // Client-side simulation of available usernames
            if (searchTerm) {
                listToShow = [searchTerm.toLowerCase().replace(/[^a-z0-9_]/g, '')].filter(Boolean);
            } else {
                const shuffled = [...coolUsernames].sort(() => 0.5 - Math.random());
                listToShow = shuffled.slice(0, 25);
            }

            // Filter out usernames already owned by the current account
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            const ownedUsernames = currentAccount?.collectible_usernames || [];
            const filteredList = listToShow.filter(uname => !ownedUsernames.includes(uname));

            if (filteredList.length === 0) {
                usernamesList.innerHTML = '<p class="empty-grid-message">No usernames available.</p>';
            } else {
                filteredList.forEach(uname => {
                    const li = document.createElement('li');
                    li.className = 'collectible-list-item';
                    li.innerHTML = `<span class="at-symbol">@</span>${uname}`;
                    li.addEventListener('click', () => buyUsername(uname));
                    usernamesList.appendChild(li);
                });
            }
        }
        
        async function buyUsername(username) {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount) { tg.showAlert("Current account not found."); return; }

            if (currentAccount.collectible_usernames.length >= MAX_COLLECTIBLE_USERNAMES) {
                tg.showAlert(`You can only have a maximum of ${MAX_COLLECTIBLE_USERNAMES} collectible usernames.`);
                return;
            }

            tg.showConfirm(`Are you sure you want to purchase the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend('/api/collectible_usernames', 'POST', {
                            owner_id: currentAccountTgId,
                            username: username
                        });
                        
                        await initializeTelegramUserAccount(); // Re-fetch account data
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} purchased successfully!`);
                        closeModal(usernamesModal);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        tg.showAlert(`Failed to purchase username: ${error.message}`);
                    }
                }
            });
        }
        
        async function handleDeleteCollectibleUsername(username) {
             tg.showConfirm(`Are you sure you want to delete the username @${username}?`, async (confirmed) => {
                if(confirmed) {
                    try {
                        await callBackend(`/api/collectible_usernames/${username}`, 'DELETE', { owner_id: currentAccountTgId });
                        await initializeTelegramUserAccount(); // Re-fetch account data
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Username @${username} has been deleted.`);
                    } catch (error) {
                        tg.HapticFeedback.notificationOccurred('error');
                        tg.showAlert(`Failed to delete username: ${error.message}`);
                    }
                }
            });
        }

        async function handleEditBio() {
            const currentAccount = accounts.find(acc => acc.tg_id === currentAccountTgId);
            if (!currentAccount) return;
            const newBio = prompt("Enter your new bio:", currentAccount.bio);
            if (newBio !== null) { // User clicked OK, even if it's empty
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, bio: newBio });
                    await initializeTelegramUserAccount(); // Re-fetch account data
                } catch (error) {
                    tg.showAlert(`Failed to update bio: ${error.message}`);
                }
            }
        }
        
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await callBackend('/api/account', 'PUT', { tg_id: currentAccountTgId, avatar_url: e.target.result });
                    await initializeTelegramUserAccount(); // Re-fetch account data
                } catch (error) {
                    tg.showAlert(`Failed to update avatar: ${error.message}`);
                }
            };
            reader.readAsDataURL(file);
        }

        function switchTab(tabName) {
            [giftsTabButton, postsTabButton, archiveTabButton].forEach(btn => btn.classList.remove('active'));
            [giftsContent, postsContent, archiveContent].forEach(content => content.classList.remove('active'));

            if (tabName === 'gifts') {
                giftsTabButton.classList.add('active');
                giftsContent.classList.add('active');
            } else if (tabName === 'posts') {
                postsTabButton.classList.add('active');
                postsContent.classList.add('active');
            } else if (tabName === 'archive') {
                archiveTabButton.classList.add('active');
                archiveContent.classList.add('active');
            }
        }

        function openSettingsModal() {
            animationToggle.checked = animationsEnabled;
            showHiddenToggle.checked = showHiddenGifts;
            settingsModal.classList.add('active');
        }

        function copyGiftLink(gift) {
            const link = getGiftDeepLink(gift);
            navigator.clipboard.writeText(link).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert('Link copied to clipboard!');
            }, () => {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert('Failed to copy link.');
            });
            longPressMenu.classList.add('hidden');
        }

        function setupEventListeners() {
            // TABS
            giftsTabButton.addEventListener('click', () => switchTab('gifts'));
            postsTabButton.addEventListener('click', () => switchTab('posts'));
            archiveTabButton.addEventListener('click', () => switchTab('archive'));

            // Main App
            goToBuyGiftsButton.addEventListener('click', () => showPage('buy-gifts-page'));
            if (upgradeAllGiftsButton) upgradeAllGiftsButton.addEventListener('click', handleUpgradeAllGifts);
            backToProfileBuyButton.addEventListener('click', () => showPage('profile-page'));
            
            // Profile Interactions
            profileBio.addEventListener('click', handleEditBio);
            profileAvatar.addEventListener('touchstart', (e) => {
                clearTimeout(longPressAvatarTimer);
                longPressAvatarTimer = setTimeout(() => avatarUploadInput.click(), 500);
            }, { passive: false });
            profileAvatar.addEventListener('touchend', () => clearTimeout(longPressAvatarTimer));
            profileAvatar.addEventListener('touchmove', () => clearTimeout(longPressAvatarTimer));
            
            // Modals Close
            const allModals = document.querySelectorAll('.modal-overlay');
            allModals.forEach(modal => {
                 modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
                 const closeButton = modal.querySelector('.modal-button.secondary, #close-' + modal.id);
                 if (closeButton) {
                     closeButton.addEventListener('click', () => closeModal(modal));
                 }
            });

            // Collectible Detail Modal
            backFromCollectibleModal.addEventListener('click', () => closeModal(collectibleDetailModal));
            collectibleActionCopyLink.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                if (gift) copyGiftLink(gift);
            });
            collectibleActionWear.addEventListener('click', handleWearAction);
            collectibleActionSell.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openSellModal(gift);
            });
            collectibleActionTransfer.addEventListener('click', () => {
                const giftInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === giftInstanceId);
                openTransferModal(gift);
            });
            collectibleMenuButton.addEventListener('click', (e) => {
                const currentModalInstanceId = collectibleDetailModal.dataset.instanceId;
                const gift = ownedGifts.find(g => g.instance_id === currentModalInstanceId);
                if (gift) { openCollectibleMenu(gift, e); }
            });
            hideLinkInModal.addEventListener('click', handleHideAction);
            
            // Long Press Menu
            menuPinAction.addEventListener('click', handlePinAction);
            menuHideAction.addEventListener('click', handleHideAction);
            menuCopyLinkAction.addEventListener('click', () => {
                if(currentLongPressGift) copyGiftLink(currentLongPressGift);
            });
            menuDeleteAction.addEventListener('click', handleDeleteAction);
            menuShareImageAction.addEventListener('click', handleShareImageAction);

            // Buy Multiple
            confirmBuyMultipleButton.addEventListener('click', handleConfirmBuyMultiple);

            // Filters
            setupFilterPopupTrigger();
            applyFiltersButton.addEventListener('click', handleApplyFilters);
            clearFiltersButton.addEventListener('click', handleClearFilters);
            exitFilterModeButton.addEventListener('click', handleClearFilters);

            // Settings Modal
            closeSettingsModal.addEventListener('click', () => closeModal(settingsModal));
            animationToggle.addEventListener('change', handleAnimationToggle);
            showHiddenToggle.addEventListener('change', handleShowHiddenToggle);
            hideMultipleButton.addEventListener('click', () => { /* Logic to be added */ });
            clearCurrentAccountDataButton.addEventListener('click', handleClearCurrentAccountData);
            clearAllAccountsDataButton.addEventListener('click', handleClearAllAccountsData);

            // Custom Buy
            customBuyConfirmButton.addEventListener('click', handleCustomBuyConfirm);
            document.querySelector('#buy-gifts-page .page-header h2').addEventListener('contextmenu', (e) => { e.preventDefault(); openCustomBuyModal(); });

            // Sell Gift
            sellPriceInput.addEventListener('input', updateSellPriceDetails);
            confirmSellButton.addEventListener('click', handleConfirmSell);

            // Transfer Gift
            transferUsernameInput.addEventListener('input', () => {
                confirmTransferButton.disabled = transferUsernameInput.value.trim() === '';
            });
            confirmTransferButton.addEventListener('click', handleConfirmTransfer);
            cancelTransferButton.addEventListener('click', () => closeModal(transferGiftModal));


            // Avatar Upload
            avatarUploadInput.addEventListener('change', handleAvatarUpload);

            // Other
            wornGiftIconContainer.addEventListener('click', () => {
                const wornGift = ownedGifts.find(g => g.is_worn);
                if (wornGift) openGiftDetailByInstanceId(wornGift.instance_id);
            });

            // Sidebar & Collectibles
            openNumbersButton.addEventListener('click', handleOpenNumbersModal);
            openUsernamesButton.addEventListener('click', handleOpenUsernamesModal);
            usernameSearchInput.addEventListener('input', (e) => populateUsernamesList(e.target.value));

            // Sidebar Swipe
            let touchStartX = 0;
            const swipeThreshold = 50;
            const swipeEdge = 50;

            appContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            appContainer.addEventListener('touchend', e => {
                if (e.target.closest('.account-sidebar')) return;
                const touchEndX = e.changedTouches[0].screenX;
                if (touchStartX < swipeEdge && touchEndX - touchStartX > swipeThreshold) { openSidebar(); }
            }, { passive: true });
            
            sidebarOverlay.addEventListener('click', closeSidebar);
            addAccountButton.addEventListener('click', handleAddAccount);
        }
        
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== undefined) {
            initApp();
        } else {
            console.warn("Telegram WebApp not found. Using mock data and default theme.");
            document.addEventListener('DOMContentLoaded', () => {
                tg.initDataUnsafe = { 
                    user: { 
                        id: 123456789, 
                        first_name: "Mock", 
                        last_name: "User", 
                        username: "mock_user", 
                        photo_url: "https://i.pravatar.cc/140?img=1" 
                    } 
                };
                tg.themeParams = {};
                tg.showAlert = (message) => alert(message);
                tg.showConfirm = (message, callback) => callback(confirm(message));
                tg.HapticFeedback = {
                    impactOccurred: (style) => console.log(`Haptic: ${style}`),
                    notificationOccurred: (type) => console.log(`Haptic Notification: ${type}`),
                };
                tg.ready = () => {}; tg.expand = () => {}; tg.onEvent = () => {};
                tg.SettingsButton = {
                    isVisible: false,
                    onClick: (callback) => tg._settingsButtonCallback = callback,
                    offClick: (callback) => { if(tg._settingsButtonCallback === callback) delete tg._settingsButtonCallback; },
                    show: () => { tg.SettingsButton.isVisible = true; console.log("Settings Button Show"); },
                    hide: () => { tg.SettingsButton.isVisible = false; console.log("Settings Button Hide"); },
                };
                // Simulate Settings Button click for local dev
                setTimeout(() => {
                    if (tg.SettingsButton.isVisible && tg._settingsButtonCallback) {
                        console.log("Simulating Settings Button Click");
                        // tg._settingsButtonCallback(); // Uncomment to auto-open settings on dev load
                    }
                }, 1000);

                initApp();
            });
        }
    </script>
</body>
</html>